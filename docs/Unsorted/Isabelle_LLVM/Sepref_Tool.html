<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Sepref_Tool</title>
</head>


<body>
<div class="head">
<h1>Theory Sepref_Tool</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>section</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Sepref Tool›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="Sepref_Tool.html"><span>Sepref_Tool</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> </span><a href="Sepref_Translate.html"><span>Sepref_Translate</span></a><span> </span><a href="Sepref_Definition.html"><span>Sepref_Definition</span></a><span> </span><a href="Sepref_Combinator_Setup.html"><span>Sepref_Combinator_Setup</span></a><span> </span><a href="Sepref_Intf_Util.html"><span>Sepref_Intf_Util</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹In this theory, we set up the sepref tool.›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Sepref Method›</span></span></span><span>


</span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_213..218">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.CONS_init|fact"><span class="entity_def" id="Sepref_Tool.CONS_init|thm"><span>CONS_init</span></span></span><span class="main"><span>:</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>Γ'</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>CP</span></span><span> </span><span class="free"><span>a</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>Γ'</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span>Γc'</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>c</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>c</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>Rc</span></span><span> </span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>c</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>r</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="Sepref_Conc_Post.html#Sepref_Conc_Post.CP_assm|const"><span>CP_assm</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>CP</span></span><span> </span><span class="bound"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Conc_Post.html#Sepref_Conc_Post.CP_cond|const"><span>CP_cond</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>CP'</span></span><span> </span><span class="bound"><span>r</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>Γc'</span></span><span> </span><span class="free"><span>Rc</span></span><span> </span><span class="free"><span>CP'</span></span><span> </span><span class="free"><span>a</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine_cons_cp|fact"><span>hn_refine_cons_cp</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails_refl|fact"><span>entails_refl</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Tool.html#offset_213..218"><span>assms</span></a><span class="main"><span class="main"><span>[</span></span></span><span class="operator"><span>unfolded</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><span>hn_ctxt_def</span></a></a></a></a><span class="main"><span class="main"><span>]</span></span></span><span class="main"><span>)</span></span><span class="main"><span class="keyword3"><span>+</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#offset_213..218"><span>assms</span></a><span class="main"><span>(</span></span><span>4</span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Conc_Post.html#Sepref_Conc_Post.CP_defs|fact"><span class="dynamic"><span class="dynamic"><span>CP_defs</span></span></span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.ID_init|fact"><span class="entity_def" id="Sepref_Tool.ID_init|thm"><span>ID_init</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>a</span></span><span> </span><span class="free"><span>a'</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>Γ'</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>CP</span></span><span> </span><span class="free"><span>a'</span></span><span class="main"><span>⟧</span></span><span> 
  </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>Γ'</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>CP</span></span><span> </span><span class="free"><span>a</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.TRANS_init|fact"><span class="entity_def" id="Sepref_Tool.TRANS_init|thm"><span>TRANS_init</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>Γ'</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>CP</span></span><span> </span><span class="free"><span>a</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>c'</span></span><span> </span><span class="main"><span>⟧</span></span><span> 
  </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>c'</span></span><span> </span><span class="free"><span>Γ'</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>CP</span></span><span> </span><span class="free"><span>a</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.infer_post_triv|fact"><span class="entity_def" id="Sepref_Tool.infer_post_triv|thm"><span>infer_post_triv</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails_refl|fact"><span>entails_refl</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sepref</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>sepref_preproc_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Thms</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_preproc|attribute"><span class="entity_def" id="Sepref_Tool.sepref_preproc|fact"><span>sepref_preproc</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Sepref: Preprocessor simplifications"</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>sepref_opt_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Thms</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_opt_simps|attribute"><span class="entity_def" id="Sepref_Tool.sepref_opt_simps|fact"><span>sepref_opt_simps</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Sepref: Post-Translation optimizations, phase 1"</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>sepref_opt_simps2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Thms</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_opt_simps2|attribute"><span class="entity_def" id="Sepref_Tool.sepref_opt_simps2|fact"><span>sepref_opt_simps2</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Sepref: Post-Translation optimizations, phase 2"</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cons_init_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Frame.weaken_post_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.CONS_init|fact"><span>CONS_init</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cons_solve_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dbgSOLVED'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOLVED'</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>dbgSOLVED'</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.infer_post_triv|fact"><span>infer_post_triv</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span>ORELSE'</span><span> </span><span class="entity"><span>Sepref_Translate.side_frame_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cons_solve_cp_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dbgSOLVED'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOLVED'</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>dbgSOLVED'</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>apply_method_noargs</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>method</span></span><span> </span><a class="entity_ref" href="Sepref_Conc_Post.html#Sepref_Conc_Post.cp_solve_cond|method"><span>cp_solve_cond</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preproc_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sepref_preproc_simps.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>  
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Sepref_Rules.prepare_hfref_synth_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
      </span><span class="entity"><span>Simplifier.simp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>id_tac</span></span><span> </span><span class="entity"><span>determ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.ID_init|fact"><span>ID_init</span></a><span class="antiquote"><span>}</span></span></span></span><span> 
      </span><span>THEN'</span><span> </span><span>CONVERSION</span><span> </span><span>Thm.eta_conversion</span><span>
      </span><span>THEN'</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>determ</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>DETERM</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Id_Op.id_tac</span></span><span> </span><span class="entity"><span>Id_Op.Normal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>id_init_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.ID_init|fact"><span>ID_init</span></a><span class="antiquote"><span>}</span></span></span></span><span> 
      </span><span>THEN'</span><span> </span><span>CONVERSION</span><span> </span><span>Thm.eta_conversion</span><span>
      </span><span>THEN'</span><span> </span><span class="entity"><span>Id_Op.id_tac</span></span><span> </span><span class="entity"><span>Id_Op.Init</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>id_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>Id_Op.id_tac</span></span><span> </span><span class="entity"><span>Id_Op.Step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>id_solve_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>Id_Op.id_tac</span></span><span> </span><span class="entity"><span>Id_Op.Solve</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="comment1"><span>(*fun id_param_tac ctxt = CONVERSION (Refine_Util.HOL_concl_conv 
      (K (Sepref_Param.id_param_conv ctxt)) ctxt)*)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>monadify_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Monadify.monadify_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="comment1"><span>(*fun lin_ana_tac ctxt = Sepref_Lin_Ana.lin_ana_tac ctxt*)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trans_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Translate.trans_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>opt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt1_ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span>addsimps</span><span> </span><span class="entity"><span>sepref_opt_simps.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span>addsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>simproc</span></span><span> "</span><span>HOL.let_simp</span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Monadify.html#Sepref_Monadify.SP_cong|fact"><span>SP_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Monadify.html#Sepref_Monadify.PR_CONST_cong|fact"><span>PR_CONST_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unsp_ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Monadify.html#Sepref_Monadify.SP_def|fact"><span>SP_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt2_ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span>addsimps</span><span> </span><span class="entity"><span>sepref_opt_simps2.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span>addsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>simproc</span></span><span> "</span><span>HOL.let_simp</span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="entity"><span>opt1_ss</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="entity"><span>unsp_ss</span></span><span> </span><span>THEN'</span><span>
      </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="entity"><span>opt2_ss</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="entity"><span>unsp_ss</span></span><span> </span><span>THEN'</span><span>
      </span><span>CONVERSION</span><span> </span><span>Thm.eta_conversion</span><span> </span><span>THEN'</span><span>
      </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV_I|fact"><span>CNV_I</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sepref_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Sepref_Constraints.ensure_slot_tac</span></span><span class="main"><span>)</span></span><span> 
      </span><span>THEN'</span><span>
      </span><span class="entity"><span>Sepref_Basic.PHASES'</span></span><span>
        </span><span class="main"><span>[</span></span><span> 
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"preproc"</span></span><span class="main"><span>,</span></span><span class="entity"><span>preproc_tac</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cons_init"</span></span><span class="main"><span>,</span></span><span class="entity"><span>cons_init_tac</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"id"</span></span><span class="main"><span>,</span></span><span class="entity"><span>id_tac</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"monadify"</span></span><span class="main"><span>,</span></span><span class="entity"><span>monadify_tac</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"opt_init"</span></span><span class="main"><span>,</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.TRANS_init|fact"><span>TRANS_init</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"trans"</span></span><span class="main"><span>,</span></span><span class="entity"><span>trans_tac</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"opt"</span></span><span class="main"><span>,</span></span><span class="entity"><span>opt_tac</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cons_solve1"</span></span><span class="main"><span>,</span></span><span class="entity"><span>cons_solve_tac</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cons_solve2"</span></span><span class="main"><span>,</span></span><span class="entity"><span>cons_solve_tac</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cons_solve3"</span></span><span class="main"><span>,</span></span><span class="entity"><span>cons_solve_cp_tac</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"constraints"</span></span><span class="main"><span>,</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Constraints.solve_constraint_slot</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>Sepref_Constraints.remove_slot_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Basic.flag_phases_ctrl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>dbg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span>#&gt;</span><span> </span><span class="entity"><span>sepref_preproc_simps.setup</span></span><span> 
      </span><span>#&gt;</span><span> </span><span class="entity"><span>sepref_opt_simps.setup</span></span><span> 
      </span><span>#&gt;</span><span> </span><span class="entity"><span>sepref_opt_simps2.setup</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="entity"><span>Sepref.setup</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref|method"><span>sepref</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="entity"><span>SIMPLE_METHOD</span></span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span class="main"><span>(</span></span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IF_EXGOAL</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>Sepref.sepref_tac</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>ctxt</span></span><span>  
    </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Automatic refinement to Imperative/HOL›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_keep|method"><span>sepref_dbg_keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(*val ctxt = Config.put Id_Op.cfg_id_debug true ctxt*)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>SIMPLE_METHOD</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IF_EXGOAL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref.sepref_tac</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Automatic refinement to Imperative/HOL, debug mode›</span></span><span>

</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Default Optimizer Setup›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_opt_simps|attribute"><span class="operator"><span>sepref_opt_simps</span></span></a><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.M_monad_laws|fact"><span>M_monad_laws</span></a><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹We allow the synthesized function to contain tagged function applications.
  This is important to avoid higher-order unification problems when synthesizing
  generic algorithms, for example the to-list algorithm for foreach-loops.›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_opt_simps|attribute"><span class="operator"><span>sepref_opt_simps</span></span></a><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP_def|fact"><span>Autoref_Tagging.APP_def</span></a><span>


</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ Revert case-pulling done by monadify ›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.case_prod_return_opt|fact"><span class="entity_def" id="Sepref_Tool.case_prod_return_opt|thm"><span>case_prod_return_opt</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_opt_simps|attribute"><span class="operator"><span>sepref_opt_simps</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>b</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>p</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>p</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>split</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod.split|fact"><span>prod.split</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.case_option_return_opt|fact"><span class="entity_def" id="Sepref_Tool.case_option_return_opt|thm"><span>case_option_return_opt</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_opt_simps|attribute"><span class="operator"><span>sepref_opt_simps</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.option.case_option|const"><span>case_option</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="free"><span>fn</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>s</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>fs</span></span><span> </span><span class="bound"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>v</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.option.case_option|const"><span>case_option</span></a><span> </span><span class="free"><span>fn</span></span><span> </span><span class="free"><span>fs</span></span><span> </span><span class="free"><span>v</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>split</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.option.split|fact"><span>option.split</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.case_list_return|fact"><span class="entity_def" id="Sepref_Tool.case_list_return|thm"><span>case_list_return</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_opt_simps|attribute"><span class="operator"><span>sepref_opt_simps</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/List.html#List.list.case_list|const"><span>case_list</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="free"><span>fn</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>xs</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>fc</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>l</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/List.html#List.list.case_list|const"><span>case_list</span></a><span> </span><span class="free"><span>fn</span></span><span> </span><span class="free"><span>fc</span></span><span> </span><span class="free"><span>l</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>split</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/List.html#List.list.split|fact"><span>list.split</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.if_return|fact"><span class="entity_def" id="Sepref_Tool.if_return|thm"><span>if_return</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_opt_simps|attribute"><span class="operator"><span>sepref_opt_simps</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>If</span></a><span> </span><span class="free"><span>b</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="free"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="free"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>If</span></a><span> </span><span class="free"><span>b</span></span><span> </span><span class="free"><span>t</span></span><span> </span><span class="free"><span>e</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ In some cases, pushing in the returns is more convenient ›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.case_prod_opt2|fact"><span class="entity_def" id="Sepref_Tool.case_prod_opt2|thm"><span>case_prod_opt2</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_opt_simps2|attribute"><span class="operator"><span>sepref_opt_simps2</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span>case</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="keyword1"><span>of</span></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>a</span></span><span class="main"><span>,</span></span><span class="bound"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
  </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="main"><span>(</span></span><span class="bound"><span>a</span></span><span class="main"><span>,</span></span><span class="bound"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>



</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Debugging Methods›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_preproc|method"><span>sepref_dbg_preproc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Constraints.ensure_slot_tac</span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>Sepref.preproc_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Preprocessing phase›</span></span><span>
</span><span class="comment1"><span>(*method_setup sepref_dbg_id_param = ‹SIMPLE_METHOD_NOPARAM' Sepref.id_param_tac›
  ‹Sepref debug: Identify parameters phase›*)</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_cons_init|method"><span>sepref_dbg_cons_init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>Sepref.cons_init_tac</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Initialize consequence reasoning›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_id|method"><span>sepref_dbg_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref.id_tac</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Identify operations phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_id_keep|method"><span>sepref_dbg_id_keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span class="entity"><span>Id_Op.cfg_id_debug</span></span><span> </span><span>true</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>Sepref.id_tac</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Identify operations phase. Debug mode, keep intermediate subgoals on failure.›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_monadify|method"><span>sepref_dbg_monadify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref.monadify_tac</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Monadify phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_monadify_keep|method"><span>sepref_dbg_monadify_keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref.monadify_tac</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Monadify phase›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_monadify_arity|method"><span>sepref_dbg_monadify_arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Monadify.arity_tac</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Monadify phase: Arity phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_monadify_comb|method"><span>sepref_dbg_monadify_comb</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Monadify.comb_tac</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Monadify phase: Comb phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_monadify_check_EVAL|method"><span>sepref_dbg_monadify_check_EVAL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>Sepref_Monadify.contains_eval</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Monadify phase: check_EVAL phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_monadify_mark_params|method"><span>sepref_dbg_monadify_mark_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Monadify.mark_params_tac</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Monadify phase: mark_params phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_monadify_dup|method"><span>sepref_dbg_monadify_dup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Monadify.dup_tac</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Monadify phase: dup phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_monadify_remove_pass|method"><span>sepref_dbg_monadify_remove_pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Monadify.remove_pass_tac</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Monadify phase: remove_pass phase›</span></span><span>

</span><span class="comment1"><span>(*method_setup sepref_dbg_lin_ana = ‹SIMPLE_METHOD_NOPARAM' (Sepref.lin_ana_tac true)›
  ‹Sepref debug: Linearity analysis phase›*)</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_opt_init|method"><span>sepref_dbg_opt_init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.TRANS_init|fact"><span>TRANS_init</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Translation phase initialization›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_trans|method"><span>sepref_dbg_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>Sepref.trans_tac</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Translation phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_opt|method"><span>sepref_dbg_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
  </span><span class="entity"><span>Sepref.opt_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>THEN'</span><span> </span><span>CONVERSION</span><span> </span><span>Thm.eta_conversion</span><span>
  </span><span>THEN'</span><span> </span><span>TRY</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV_I|fact"><span>CNV_I</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Optimization phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_cons_solve|method"><span>sepref_dbg_cons_solve</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref.cons_solve_tac</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Solve post-consequences›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_cons_solve_keep|method"><span>sepref_dbg_cons_solve_keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref.cons_solve_tac</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Solve post-consequences, keep intermediate results›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_cons_solve_cp|method"><span>sepref_dbg_cons_solve_cp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref.cons_solve_cp_tac</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Solve post-consequences concrete postcond›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_cons_solve_cp_keep|method"><span>sepref_dbg_cons_solve_cp_keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref.cons_solve_cp_tac</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Solve post-consequences concrete postcond, keep intermediate results›</span></span><span>
  
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_constraints|method"><span>sepref_dbg_constraints</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IF_EXGOAL</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="entity"><span>Sepref_Constraints.solve_constraint_slot</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>THEN</span><span> </span><span class="entity"><span>Sepref_Constraints.remove_slot_tac</span></span><span>
  </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Solve accumulated constraints›</span></span><span>

</span><span class="comment1"><span>(*
  apply sepref_dbg_preproc
  apply sepref_dbg_cons_init
  apply sepref_dbg_id
  apply sepref_dbg_monadify
  apply sepref_dbg_opt_init
  apply sepref_dbg_trans
  apply sepref_dbg_opt
  apply sepref_dbg_cons_solve
  apply sepref_dbg_cons_solve
  apply sepref_dbg_cons_solve_cp
  apply sepref_dbg_constraints

*)</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_id_init|method"><span>sepref_dbg_id_init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>Sepref.id_init_tac</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Initialize operation identification phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_id_step|method"><span>sepref_dbg_id_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>Sepref.id_step_tac</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Single step operation identification phase›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_id_solve|method"><span>sepref_dbg_id_solve</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>Sepref.id_solve_tac</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Complete current operation identification goal›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_trans_keep|method"><span>sepref_dbg_trans_keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>Sepref_Translate.trans_keep_tac</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Translation phase, stop at failed subgoal›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_trans_step|method"><span>sepref_dbg_trans_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>Sepref_Translate.trans_step_tac</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Translation step›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_trans_step_keep|method"><span>sepref_dbg_trans_step_keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>Sepref_Translate.trans_step_keep_tac</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Translation step, keep unsolved subgoals›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_side|method"><span>sepref_dbg_side</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>REPEAT_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Translate.side_cond_dispatch_tac</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_side_unfold|method"><span>sepref_dbg_side_unfold</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Translate.side_unfold_tac</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_side_keep|method"><span>sepref_dbg_side_keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>REPEAT_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Translate.side_cond_dispatch_tac</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_side_bounds|method"><span>sepref_dbg_side_bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Translate.bounds_tac</span></span><span class="main"><span>)</span></span><span>›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_prepare_frame|method"><span>sepref_dbg_prepare_frame</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>Sepref_Frame.prepare_frame_tac</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Prepare frame inference›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_frame|method"><span>sepref_dbg_frame</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Frame.frame_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Translate.side_fallback_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Frame inference›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_merge|method"><span>sepref_dbg_merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Frame.merge_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Translate.side_fallback_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Frame inference, merge›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_frame_step|method"><span>sepref_dbg_frame_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Frame.frame_step_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Translate.side_fallback_tac</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Frame inference, single-step›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_dbg_frame_step_keep|method"><span>sepref_dbg_frame_step_keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Frame.frame_step_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Translate.side_fallback_tac</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref debug: Frame inference, single-step, keep partially solved side conditions›</span></span><span>


</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Utilities›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Manual hfref-proofs›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_to_hnr|method"><span>sepref_to_hnr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
  </span><span class="entity"><span>Sepref.preproc_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>Sepref_Frame.weaken_post_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Sepref: Convert to hnr-goal and weaken postcondition›</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.sepref_to_hoare|method"><span>sepref_to_hoare</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sepref_to_hoare_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><span>hn_ctxt_def</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure_def|fact"><span>pure_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Sepref.preproc_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
      </span><span>THEN'</span><span> </span><span class="entity"><span>Sepref_Frame.weaken_post_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
      </span><span>THEN'</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refineI|fact"><span>hn_refineI</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>THEN'</span><span> </span><span class="entity"><span>asm_full_simp_tac</span></span><span> </span><span class="entity"><span>ss</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>SIMPLE_METHOD_NOPARAM'</span></span><span> </span><span class="entity"><span>sepref_to_hoare_tac</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span> </span><span class="quoted"><span>‹Sepref: Convert to hoare-triple›</span></span><span>



</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Copying of Parameters›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.fold_COPY|fact"><span class="entity_def" id="Sepref_Tool.fold_COPY|thm"><span>fold_COPY</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="Sepref_Monadify.html#Sepref_Monadify.COPY|const"><span>COPY</span></a><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Tool.COPY.itype|fact"><span class="entity_def" id="Sepref_Tool.COPY.itype|thm"><span>sepref_register</span></span></span></span></span><span> </span><span class="quoted"><a class="entity_ref" href="Sepref_Monadify.html#Sepref_Monadify.COPY|const"><span>COPY</span></a></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Copy is treated as normal operator, and one can just declare rules for it! ›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.hnr_pure_COPY|fact"><span class="entity_def" id="Sepref_Tool.hnr_pure_COPY|thm"><span>hnr_pure_COPY</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Translate.html#Sepref_Translate.sepref_fr_rules|attribute"><span class="operator"><span>sepref_fr_rules</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure|const"><span>is_pure</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.comp|const"><span>o</span></a></span><span> </span><a class="entity_ref" href="Sepref_Monadify.html#Sepref_Monadify.COPY|const"><span>COPY</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="free"><span>R</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfkeep|const"><span><span class="hidden">⇧</span><sup>k</sup></span></a></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfreftt|const"><span>→<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="main"><span class="bound"><span>_</span></span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>R</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>intro</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfrefI|fact"><span>hfrefI</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refineI|fact"><span>hn_refineI</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure_conv|fact"><span>is_pure_conv</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure_def|fact"><span>pure_def</span></a><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="Basic_VCG.html#Basic_VCG.vcg|method"><span class="operator"><span>vcg</span></span></a><span>
  

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.hn_id|fact"><span class="entity_def" id="Sepref_Tool.hn_id|thm"><span>hn_id</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Translate.html#Sepref_Translate.sepref_fr_rules|attribute"><span class="operator"><span>sepref_fr_rules</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="bound"><span>x</span></span><span class="main"><span>,</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.comp|const"><span>o</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.id|const"><span>id</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfrefptnd|const"><span>[</span></a></span><span class="main"><span>λ</span></span><span class="main"><span class="bound"><span>_</span></span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfrefptnd|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><span class="free"><span>A</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfdrop|const"><span><span class="hidden">⇧</span><sup>d</sup></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfrefptnd|const"><span>→</span></a></span><span> </span><span class="free"><span>A</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfrefptnd|const"><span>[</span></a></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>r</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>r</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span class="bound"><span>x</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfrefptnd|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_to_hoare|method"><span class="operator"><span>sepref_to_hoare</span></span></a><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="Basic_VCG.html#Basic_VCG.vcg|method"><span class="operator"><span>vcg</span></span></a><span>
  
</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Destructors›</span></span></span><span>  
  
</span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_13382..13387">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.hn_MK_FREEI|fact"><span class="entity_def" id="Sepref_Tool.hn_MK_FREEI|thm"><span>hn_MK_FREEI</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>free</span></span><span class="main"><span>,</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.comp|const"><span>o</span></a></span><span> </span><span class="free"><span>freea</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="free"><span>A</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfdrop|const"><span><span class="hidden">⇧</span><sup>d</sup></span></a></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfreftt|const"><span>→<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="main"><span class="bound"><span>_</span></span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.unit_assn|const"><span>unit_assn</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MK_FREE|const"><span>MK_FREE</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>free</span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>proof</span></span></span><span> </span><span class="operator"><span>-</span></span><span>  
  </span><span class="keyword1"><span class="command"><span>note</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Basic_VCG.html#Basic_VCG.vcg_rules|attribute"><span class="operator"><span>vcg_rules</span></span></a><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#offset_13382..13387"><span>assms</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.to_hnr|attribute"><span class="operator"><span>to_hnr</span></span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refineD|fact"><span>hn_refineD</span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>unfolded</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><span>hn_ctxt_def</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.invalid_assn_def|fact"><span>invalid_assn_def</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure_def|fact"><span>pure_def</span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>simplified</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword3"><span class="command"><span>show</span></span></span><span> </span><span class="var"><span class="quoted"><span class="var"><span>?thesis</span></span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Basic_VCG.html#Basic_VCG.vcg|method"><span class="operator"><span>vcg</span></span></a><span>
</span><span class="keyword1"><span class="command"><span>qed</span></span></span><span>  
  
</span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_13650..13655">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.MK_FREE_hrcompI|fact"><span class="entity_def" id="Sepref_Tool.MK_FREE_hrcompI|thm"><span>MK_FREE_hrcompI</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.sepref_frame_free_rules|attribute"><span class="operator"><span>sepref_frame_free_rules</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MK_FREE|const"><span>MK_FREE</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>f</span></span><span>"</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MK_FREE|const"><span>MK_FREE</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hr_comp|const"><span>hr_comp</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>f</span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>proof</span></span></span><span> </span><span class="operator"><span>-</span></span><span>
  </span><span class="keyword1"><span class="command"><span>note</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Basic_VCG.html#Basic_VCG.vcg_rules|attribute"><span class="operator"><span>vcg_rules</span></span></a><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#offset_13650..13655"><span>assms</span></a><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MK_FREED|fact"><span>MK_FREED</span></a><span class="main"><span>]</span></span><span>
  </span><span class="keyword3"><span class="command"><span>show</span></span></span><span> </span><span class="var"><span class="quoted"><span class="var"><span>?thesis</span></span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hr_comp_def|fact"><span>hr_comp_def</span></a><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="Basic_VCG.html#Basic_VCG.vcg|method"><span class="operator"><span>vcg</span></span></a><span>
</span><span class="keyword1"><span class="command"><span>qed</span></span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_13879..13884">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.MK_FREE_hrrcompI|fact"><span class="entity_def" id="Sepref_Tool.MK_FREE_hrrcompI|thm"><span>MK_FREE_hrrcompI</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.sepref_frame_free_rules|attribute"><span class="operator"><span>sepref_frame_free_rules</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MK_FREE|const"><span>MK_FREE</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>A</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>f</span></span><span>"</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MK_FREE|const"><span>MK_FREE</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrr_comp|const"><span>hrr_comp</span></a><span> </span><span class="free"><span>S</span></span><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>f</span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>proof</span></span></span><span> </span><span class="operator"><span>-</span></span><span>
  </span><span class="keyword1"><span class="command"><span>note</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Basic_VCG.html#Basic_VCG.vcg_rules|attribute"><span class="operator"><span>vcg_rules</span></span></a><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Sepref_Tool.html#offset_13879..13884"><span>assms</span></a><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MK_FREED|fact"><span>MK_FREED</span></a><span class="main"><span>]</span></span><span>
  </span><span class="keyword3"><span class="command"><span>show</span></span></span><span> </span><span class="var"><span class="quoted"><span class="var"><span>?thesis</span></span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrr_comp_def|fact"><span>hrr_comp_def</span></a><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hr_comp_def|fact"><span>hr_comp_def</span></a><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span class="main"><span class="keyword3"><span>;</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.safe|method"><span class="operator"><span>safe</span></span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><a class="entity_ref" href="Basic_VCG.html#Basic_VCG.vcg|method"><span class="operator"><span>vcg</span></span></a><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span>qed</span></span></span><span>


</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Short-Circuit Boolean Evaluation›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Convert boolean operators to short-circuiting. 
  When applied before monadify, this will generate a short-circuit execution.›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.short_circuit_conv|fact"><span class="entity_def" id="Sepref_Tool.short_circuit_conv(3)|thm"><span class="entity_def" id="Sepref_Tool.short_circuit_conv(2)|thm"><span class="entity_def" id="Sepref_Tool.short_circuit_conv(1)|thm"><span>short_circuit_conv</span></span></span></span></span><span class="main"><span>:</span></span><span>  
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>a</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.iff|const"><span>⟷</span></a></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>if</span></a></span><span> </span><span class="free"><span>a</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>then</span></a></span><span> </span><span class="free"><span>b</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>else</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.False|const"><span>False</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>a</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="free"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.iff|const"><span>⟷</span></a></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>if</span></a></span><span> </span><span class="free"><span>a</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>then</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>else</span></a></span><span> </span><span class="free"><span>b</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>a</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span class="free"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.iff|const"><span>⟷</span></a></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>if</span></a></span><span> </span><span class="free"><span>a</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>then</span></a></span><span> </span><span class="free"><span>b</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>else</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Eliminating higher-order›</span></span></span><span>
  </span><span class="comment1"><span>(* TODO: Add similar rules for other cases! *)</span></span><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Tool.ho_prod_move|fact"><span class="entity_def" id="Sepref_Tool.ho_prod_move|thm"><span>ho_prod_move</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_preproc|attribute"><span class="operator"><span>sepref_preproc</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>b</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>p</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="bound"><span>p</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.ext|fact"><span>ext</span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span>declare</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.o_apply|fact"><span>o_apply</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Tool.html#Sepref_Tool.sepref_preproc|attribute"><span class="operator"><span>sepref_preproc</span></span></a><span class="main"><span>]</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>