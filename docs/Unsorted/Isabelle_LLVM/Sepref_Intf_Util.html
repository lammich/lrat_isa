<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Sepref_Intf_Util</title>
</head>


<body>
<div class="head">
<h1>Theory Sepref_Intf_Util</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>section</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Utilities for Interface Specifications and Implementations›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="Sepref_Intf_Util.html"><span>Sepref_Intf_Util</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> </span><a href="Sepref_Rules.html"><span>Sepref_Rules</span></a><span> </span><a href="Sepref_Translate.html"><span>Sepref_Translate</span></a><span> </span><span class="quoted"><span>"</span><a href="Term_Synth.html"><span>Lib/Term_Synth</span></a><span>"</span></span><span> </span><a href="Sepref_Combinator_Setup.html"><span>Sepref_Combinator_Setup</span></a><span>
  </span><span class="quoted"><span>"</span><a href="Concl_Pres_Clarification.html"><span>Lib/Concl_Pres_Clarification</span></a><span>"</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>keywords</span></span></span><span> </span><span class="quoted"><span>"sepref_decl_op"</span></span><span> </span><span class="main"><span>::</span></span><span> thy_goal
     </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="quoted"><span>"sepref_decl_impl"</span></span><span> </span><span class="main"><span>::</span></span><span> thy_goal
</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Relation Interface Binding›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.INTF_OF_REL_def|fact"><span class="entity_def" id="Sepref_Intf_Util.INTF_OF_REL_def|thm"><span class="entity_def" id="Sepref_Intf_Util.INTF_OF_REL_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'c</span></span><span> </span><span>itself</span><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>INTF_OF_REL</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>R</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>I</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>"</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.intf_of_relI|fact"><span class="entity_def" id="Sepref_Intf_Util.intf_of_relI|thm"><span>intf_of_relI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>R</span></span><span class="main"><span>::</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
  </span><span class="keyword1"><span class="command"><span>declare</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.intf_of_relI|fact"><span>intf_of_relI</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="Term_Synth.html#Term_Synth.synth_rules|attribute"><span class="operator"><span>synth_rules</span></span></a><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>― ‹Declare as fallback rule›</span></span><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules|fact"><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules(9)|thm"><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules(8)|thm"><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules(7)|thm"><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules(6)|thm"><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules(5)|thm"><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules(4)|thm"><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules(3)|thm"><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules(2)|thm"><span class="entity_def" id="Sepref_Intf_Util.standard_intf_of_rel_rules(1)|thm"><span>standard_intf_of_rel_rules</span></span></span></span></span></span></span></span></span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Term_Synth.html#Term_Synth.synth_rules|attribute"><span class="operator"><span>synth_rules</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.unit_rel|const"><span>unit_rel</span></a><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.bool_rel|const"><span>bool_rel</span></a><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>

    </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>⟨</span></span><span class="free"><span>R</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.option_rel|const"><span>option_rel</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.option|type"><span>option</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>⟨</span></span><span class="free"><span>R</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.list_rel|const"><span>list_rel</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/List.html#List.list|type"><span>list</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>⟨</span></span><span class="free"><span>R</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres|type"><span>nres</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>S</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>R</span></span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.prod_rel_syn|const"><span>×<span class="hidden">⇩</span><sub>r</sub></span></a></span><span class="free"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>S</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>⟨</span></span><span class="free"><span>R</span></span><span class="main"><span>,</span></span><span class="free"><span>S</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.sum_rel|const"><span>sum_rel</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Sum_Type.html#Sum_Type.sum|type"><span>+</span></a></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>S</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>R</span></span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span class="free"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>⇒</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>R</span></span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span class="free"><span>Sx</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.undefined|const"><span>undefined</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.fref|const"><span>fref</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>Sx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp_all</span></span><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.synth_intf_of_relI|fact"><span class="entity_def" id="Sepref_Intf_Util.synth_intf_of_relI(2)|thm"><span class="entity_def" id="Sepref_Intf_Util.synth_intf_of_relI(1)|thm"><span>synth_intf_of_relI</span></span></span></span><span class="main"><span>:</span></span><span> 
    </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>I</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Term_Synth.html#Term_Synth.SYNTH_TERM|const"><span>SYNTH_TERM</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>I</span></span><span>"</span></span></span><span> 
    </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.INTF_OF_REL|const"><span>INTF_OF_REL</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>Rx</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.undefined|const"><span>undefined</span></a><span class="main"><span>)</span></span><span> </span><span class="free"><span>I</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Term_Synth.html#Term_Synth.SYNTH_TERM|const"><span>SYNTH_TERM</span></a><span> </span><span class="free"><span>Rx</span></span><span> </span><span class="free"><span>I</span></span><span>"</span></span></span><span> 
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp_all</span></span><span>


</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Operations with Precondition›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.mop_def|fact"><span class="entity_def" id="Sepref_Intf_Util.mop_def|thm"><span class="entity_def" id="Sepref_Intf_Util.mop_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Sepref_Intf_Util.mop|const"><span>mop</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>⇒</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>⇒</span></span><span class="tfree"><span>'b</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres|type"><span>nres</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'b</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres|type"><span>nres</span></a><span>"</span></span></span><span>
    </span><span class="comment1"><span>― ‹Package operation with precondition›</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>mop</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>f</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="keyword1"><span>doN</span></span><span> </span><span class="main"><span>{</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>f</span></span></span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>}</span></span><span>"</span></span></span><span>
  
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_1638..1643">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.param_op_mop_iff|fact"><span class="entity_def" id="Sepref_Intf_Util.param_op_mop_iff|thm"><span>param_op_mop_iff</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>Q</span></span><span class="main"><span>,</span></span><span class="free"><span>P</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>R</span></span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.bool_rel|const"><span>bool_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> 
    </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="free"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>[</span></a></span><span class="free"><span>P</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>]<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><span class="free"><span>S</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>
    </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.iff|const"><span>⟷</span></a></span><span> 
    </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.freftnd|const"><span>→<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><span class="main"><span>⟨</span></span><span class="free"><span>S</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>
    "</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_1638..1643"><span>assms</span></a><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> 
      </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop_def|fact"><span>mop_def</span></a><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.fref_def|fact"><span>fref_def</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_nres_rel_iff|fact"><span>pw_nres_rel_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span>
      </span><span class="quasi_keyword"><span>dest</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_relD|fact"><span>fun_relD</span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_1912..1917">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.param_mopI|fact"><span class="entity_def" id="Sepref_Intf_Util.param_mopI|thm"><span>param_mopI</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>[</span></a></span><span class="free"><span>P</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>]<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><span class="free"><span>S</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>  
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>Q</span></span><span class="main"><span>,</span></span><span class="free"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.bool_rel|const"><span>bool_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.freftnd|const"><span>→<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><span class="main"><span>⟨</span></span><span class="free"><span>S</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_1912..1917"><span>assms</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.param_op_mop_iff|fact"><span>param_op_mop_iff</span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mop_spec_rl|fact"><span class="entity_def" id="Sepref_Intf_Util.mop_spec_rl|thm"><span>mop_spec_rl</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_2167..2172">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mop_spec_rl_from_def|fact"><span class="entity_def" id="Sepref_Intf_Util.mop_spec_rl_from_def|thm"><span>mop_spec_rl_from_def</span></span></span><span class="main"><span>:</span></span><span>  
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>g</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>g</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>z</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>z</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_2167..2172"><span>assms</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop_spec_rl|fact"><span>mop_spec_rl</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_2322..2327">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mop_leof_rl_from_def|fact"><span class="entity_def" id="Sepref_Intf_Util.mop_leof_rl_from_def|thm"><span>mop_leof_rl_from_def</span></span></span><span class="main"><span>:</span></span><span>  
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>g</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>g</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>z</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>z</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_2322..2327"><span>assms</span></a><span> 
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.pw_leof_iff|fact"><span>pw_leof_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>


  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.assert_true_bind_conv|fact"><span class="entity_def" id="Sepref_Intf_Util.assert_true_bind_conv|thm"><span>assert_true_bind_conv</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="keyword1"><span>doN</span></span><span> </span><span class="main"><span>{</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span class="main"><span>;</span></span><span> </span><span class="free"><span>m</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>m</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span> 

  </span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mop_alt_unfolds|fact"><span class="entity_def" id="Sepref_Intf_Util.mop_alt_unfolds(7)|thm"><span class="entity_def" id="Sepref_Intf_Util.mop_alt_unfolds(6)|thm"><span class="entity_def" id="Sepref_Intf_Util.mop_alt_unfolds(5)|thm"><span class="entity_def" id="Sepref_Intf_Util.mop_alt_unfolds(4)|thm"><span class="entity_def" id="Sepref_Intf_Util.mop_alt_unfolds(3)|thm"><span class="entity_def" id="Sepref_Intf_Util.mop_alt_unfolds(2)|thm"><span class="entity_def" id="Sepref_Intf_Util.mop_alt_unfolds(1)|thm"><span>mop_alt_unfolds</span></span></span></span></span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.curry_def|fact"><span>curry_def</span></a><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.curry0_def|fact"><span>curry0_def</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop_def|fact"><span>mop_def</span></a><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry_apply|fact"><span>uncurry_apply</span></a><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry0_apply|fact"><span>uncurry0_apply</span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.o_apply|fact"><span>o_apply</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.assert_true_bind_conv|fact"><span>assert_true_bind_conv</span></a><span>

</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Constraints›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.add_is_pure_constraint|fact"><span class="entity_def" id="Sepref_Intf_Util.add_is_pure_constraint|thm"><span>add_is_pure_constraint</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span class="keyword1"><span>PROP</span></span><span> </span><span class="free"><span>P</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure|const"><span>is_pure</span></a><span> </span><span class="free"><span>A</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="keyword1"><span>PROP</span></span><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>.</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_relpropI|fact"><span class="entity_def" id="Sepref_Intf_Util.sepref_relpropI|thm"><span>sepref_relpropI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>R</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Purity›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.constraint_simps|attribute"><span class="operator"><span>constraint_simps</span></span></a><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure_pure|fact"><span>the_pure_pure</span></a><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.IS_PURE_def|fact"><span class="entity_def" id="Sepref_Intf_Util.IS_PURE_def|thm"><span class="entity_def" id="Sepref_Intf_Util.IS_PURE_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.constraint_abbrevs|attribute"><span class="operator"><span>constraint_abbrevs</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Intf_Util.IS_PURE|const"><span>IS_PURE</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>R</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure|const"><span>is_pure</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>R</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure|const"><span>the_pure</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>R</span></span></span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.IS_PURE_pureI|fact"><span class="entity_def" id="Sepref_Intf_Util.IS_PURE_pureI|thm"><span>IS_PURE_pureI</span></span></span><span class="main"><span>:</span></span><span> 
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE|const"><span>IS_PURE</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure|const"><span>pure</span></a><span> </span><span class="free"><span>R</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE_def|fact"><span>IS_PURE_def</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.fcomp_norm_simps|attribute"><span class="operator"><span>fcomp_norm_simps</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE|const"><span>IS_PURE</span></a><span> </span><span class="free"><span>Φ</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure|const"><span>pure</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure|const"><span>the_pure</span></a><span> </span><span class="free"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span> 
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE_def|fact"><span>IS_PURE_def</span></a><span class="main"><span>)</span></span><span>
 
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.fcomp_norm_simps|attribute"><span class="operator"><span>fcomp_norm_simps</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE|const"><span>IS_PURE</span></a><span> </span><span class="free"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>A</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure|const"><span>the_pure</span></a><span> </span><span class="free"><span>A</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE_def|fact"><span>IS_PURE_def</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.handle_purity1|fact"><span class="entity_def" id="Sepref_Intf_Util.handle_purity1|thm"><span>handle_purity1</span></span></span><span class="main"><span>:</span></span><span> 
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE|const"><span>IS_PURE</span></a><span> </span><span class="free"><span>Φ</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>A</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="free"><span>Φ</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure|const"><span>the_pure</span></a><span> </span><span class="free"><span>A</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE_def|fact"><span>IS_PURE_def</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.handle_purity2|fact"><span class="entity_def" id="Sepref_Intf_Util.handle_purity2|thm"><span>handle_purity2</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE|const"><span>IS_PURE</span></a><span> </span><span class="free"><span>Φ</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>A</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure|const"><span>is_pure</span></a><span> </span><span class="free"><span>A</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IS_PURE_def|fact"><span>IS_PURE_def</span></a><span class="main"><span>)</span></span><span>




</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Composition›</span></span></span><span>
</span><span class="comment1"><span>(* TODO/FIXME: Overlaps with FCOMP! *)</span></span><span>

  </span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Preconditions›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.tcomp_pre_def|fact"><span class="entity_def" id="Sepref_Intf_Util.tcomp_pre_def|thm"><span class="entity_def" id="Sepref_Intf_Util.tcomp_pre_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Intf_Util.tcomp_pre|const"><span>tcomp_pre</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Q</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>T</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>λ</span></span><span class="bound"><span>a</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Q</span></span></span></span><span> </span><span class="bound"><span>a</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.All|const"><span>∀</span></a></span><span class="bound"><span>a'</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.All|const"><span>.</span></a></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>a'</span></span><span class="main"><span>,</span></span><span> </span><span class="bound"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>T</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="bound"><span>a'</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.and_pre_def|fact"><span class="entity_def" id="Sepref_Intf_Util.and_pre_def|thm"><span class="entity_def" id="Sepref_Intf_Util.and_pre_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Intf_Util.and_pre|const"><span>and_pre</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P1</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P2</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P1</span></span></span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P2</span></span></span></span><span> </span><span class="bound"><span>x</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.imp_pre_def|fact"><span class="entity_def" id="Sepref_Intf_Util.imp_pre_def|thm"><span class="entity_def" id="Sepref_Intf_Util.imp_pre_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Intf_Util.imp_pre|const"><span>imp_pre</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P1</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P2</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P1</span></span></span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P2</span></span></span></span><span> </span><span class="bound"><span>x</span></span><span>"</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.and_pre_beta|fact"><span class="entity_def" id="Sepref_Intf_Util.and_pre_beta|thm"><span>and_pre_beta</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre|const"><span>and_pre</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre_def|fact"><span>and_pre_def</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.imp_pre_beta|fact"><span class="entity_def" id="Sepref_Intf_Util.imp_pre_beta|thm"><span>imp_pre_beta</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.imp_pre|const"><span>imp_pre</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.imp_pre_def|fact"><span>imp_pre_def</span></a><span class="main"><span>)</span></span><span>



  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_def|fact"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_def|thm"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P1</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P2</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.All|const"><span>∀</span></a></span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.All|const"><span>.</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P1</span></span></span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P2</span></span></span></span><span> </span><span class="bound"><span>x</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.IMP_PRED|fact"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRED|thm"><span>IMP_PRED</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span> </span><span class="free"><span>P1</span></span><span> </span><span class="free"><span>P2</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>P1</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>P2</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_def|fact"><span>IMP_PRE_def</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_refl|fact"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_refl|thm"><span>IMP_PRE_refl</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_def|fact"><span>IMP_PRE_def</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_CUSTOM_def|fact"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_CUSTOM_def|thm"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_CUSTOM_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_CUSTOM|const"><span>IMP_PRE_CUSTOM</span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_CUSTOMD|fact"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_CUSTOMD|thm"><span>IMP_PRE_CUSTOMD</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_CUSTOM|const"><span>IMP_PRE_CUSTOM</span></a><span> </span><span class="free"><span>P1</span></span><span> </span><span class="free"><span>P2</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span> </span><span class="free"><span>P1</span></span><span> </span><span class="free"><span>P2</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_CUSTOM_def|fact"><span>IMP_PRE_CUSTOM_def</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_CUSTOMI|fact"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_CUSTOMI|thm"><span>IMP_PRE_CUSTOMI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>P1</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>P2</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_CUSTOM|const"><span>IMP_PRE_CUSTOM</span></a><span> </span><span class="free"><span>P1</span></span><span> </span><span class="free"><span>P2</span></span><span>"</span></span></span><span> 
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_CUSTOM_def|fact"><span>IMP_PRE_CUSTOM_def</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_def|fact"><span>IMP_PRE_def</span></a><span class="main"><span>)</span></span><span>


  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.imp_and_triv_pre|fact"><span class="entity_def" id="Sepref_Intf_Util.imp_and_triv_pre|thm"><span>imp_and_triv_pre</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre|const"><span>and_pre</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="main"><span class="bound"><span>_</span></span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span class="main"><span>)</span></span><span> </span><span class="free"><span>P</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_def|fact"><span>IMP_PRE_def</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre_def|fact"><span>and_pre_def</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>


</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Premises›</span></span></span><span>    
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.ALL_LIST_def|fact"><span class="entity_def" id="Sepref_Intf_Util.ALL_LIST_def|thm"><span class="entity_def" id="Sepref_Intf_Util.ALL_LIST_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Intf_Util.ALL_LIST|const"><span>ALL_LIST</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>A</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>∀</span></span><span class="bound"><span>x</span></span><span class="main"><span>∈</span></span><a class="entity_ref" href="../../HOL/HOL/List.html#List.list.set|const"><span>set</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>A</span></span></span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>  
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Intf_Util.IMP_LIST_def|fact"><span class="entity_def" id="Sepref_Intf_Util.IMP_LIST_def|thm"><span class="entity_def" id="Sepref_Intf_Util.IMP_LIST_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>A</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>B</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.ALL_LIST|const"><span>ALL_LIST</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>A</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>B</span></span></span></span><span>"</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.to_IMP_LISTI|fact"><span class="entity_def" id="Sepref_Intf_Util.to_IMP_LISTI|thm"><span>to_IMP_LISTI</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/List.html#List.list.Nil|const"><span>[]</span></a></span><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span> 
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST_def|fact"><span>IMP_LIST_def</span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.to_IMP_LIST|fact"><span class="entity_def" id="Sepref_Intf_Util.to_IMP_LIST|thm"><span>to_IMP_LIST</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="free"><span>Ps</span></span><span> </span><span class="free"><span>Q</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/List.html#List.list.Cons|const"><span>#</span></a></span><span class="free"><span>Ps</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>Q</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST_def|fact"><span>IMP_LIST_def</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.ALL_LIST_def|fact"><span>ALL_LIST_def</span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><span>equal_intr_rule</span><span class="main"><span>)</span></span><span>
    
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.from_IMP_LIST|fact"><span class="entity_def" id="Sepref_Intf_Util.from_IMP_LIST(3)|thm"><span class="entity_def" id="Sepref_Intf_Util.from_IMP_LIST(2)|thm"><span class="entity_def" id="Sepref_Intf_Util.from_IMP_LIST(1)|thm"><span>from_IMP_LIST</span></span></span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="free"><span>As</span></span><span> </span><span class="free"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.ALL_LIST|const"><span>ALL_LIST</span></a><span> </span><span class="free"><span>As</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>B</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.ALL_LIST|const"><span>ALL_LIST</span></a><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/List.html#List.list.Nil|const"><span>[]</span></a></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="free"><span>B</span></span><span>"</span></span></span><span>
    </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.ALL_LIST|const"><span>ALL_LIST</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>A</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/List.html#List.list.Cons|const"><span>#</span></a></span><span class="free"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>A</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.ALL_LIST|const"><span>ALL_LIST</span></a><span> </span><span class="free"><span>As</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>B</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST_def|fact"><span>IMP_LIST_def</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.ALL_LIST_def|fact"><span>ALL_LIST_def</span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><span>equal_intr_rule</span><span class="main"><span>)</span></span><span>
    
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.IMP_LIST_trivial|fact"><span class="entity_def" id="Sepref_Intf_Util.IMP_LIST_trivial|thm"><span>IMP_LIST_trivial</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>B</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>B</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>.</span></span></span><span>



</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Composition Rules›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.hfcomp_tcomp_pre|fact"><span class="entity_def" id="Sepref_Intf_Util.hfcomp_tcomp_pre|thm"><span>hfcomp_tcomp_pre</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_5214..5215">B</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>g</span></span><span class="main"><span>,</span></span><span class="free"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.fref|const"><span>[</span></a></span><span class="free"><span>Q</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.fref|const"><span>]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.fref|const"><span>→</span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="main"><span>⟨</span></span><span class="free"><span>U</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_5271..5272">A</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>P</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><span class="free"><span>RR'</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.tcomp_pre|const"><span>tcomp_pre</span></a><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="free"><span>P</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrp_comp|const"><span>hrp_comp</span></a><span> </span><span class="free"><span>RR'</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrr_comp|const"><span>hrr_comp</span></a><span> </span><span class="free"><span>T</span></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="free"><span>U</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfcomp|fact"><span>hfcomp</span></a><span class="main"><span>[</span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_5271..5272"><span>A</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_5214..5215"><span>B</span></a><span class="main"><span>]</span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.transform_pre_param|fact"><span class="entity_def" id="Sepref_Intf_Util.transform_pre_param|thm"><span>transform_pre_param</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_5475..5476">A</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="free"><span>Cns</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="free"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.tcomp_pre|const"><span>tcomp_pre</span></a><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="free"><span>P</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrp_comp|const"><span>hrp_comp</span></a><span> </span><span class="free"><span>RR'</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrr_comp|const"><span>hrr_comp</span></a><span> </span><span class="free"><span>T</span></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="free"><span>U</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_5583..5584">P</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="free"><span>Cns</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span class="main"><span>,</span></span><span class="free"><span>P'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.bool_rel|const"><span>bool_rel</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_5637..5638">C</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span> </span><span class="free"><span>PP'</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre|const"><span>and_pre</span></a><span> </span><span class="free"><span>P'</span></span><span> </span><span class="free"><span>Q</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="comment1"><span>(*assumes D: "IMP_LIST Cns (∀a c x y. (c,a)∈T ⟶ S c x y ⊢ S' a x y)"*)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="free"><span>Cns</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>PP'</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrp_comp|const"><span>hrp_comp</span></a><span> </span><span class="free"><span>RR'</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrr_comp|const"><span>hrr_comp</span></a><span> </span><span class="free"><span>T</span></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="free"><span>U</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.from_IMP_LIST|fact"><span>from_IMP_LIST</span></a><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref_cons|fact"><span>hfref_cons</span></a><span class="main"><span>)</span></span><span> 
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_5475..5476"><span>A</span></a><span class="main"><span class="main"><span>[</span></span></span><span class="operator"><span>unfolded</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.from_IMP_LIST|fact"><span>from_IMP_LIST</span></a><span class="main"><span class="main"><span>]</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="operator"><span>assumption</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>drule</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRED|fact"><span>IMP_PRED</span></a><span class="main"><span class="main"><span>[</span></span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_5637..5638"><span>C</span></a><span class="main"><span class="main"><span>]</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_5583..5584"><span>P</span></a><span class="main"><span>[</span></span><span class="operator"><span>unfolded</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.from_IMP_LIST|fact"><span>from_IMP_LIST</span></a><span class="main"><span>]</span></span><span> </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre_def|fact"><span>and_pre_def</span></a><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>dest</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_relD|fact"><span>fun_relD</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><span class="keyword3"><span>[</span></span></span><span class="main"><span class="keyword3"><span>]</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="operator"><span>simp_all</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>
    
 
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.hfref_mop_conv|fact"><span class="entity_def" id="Sepref_Intf_Util.hfref_mop_conv|thm"><span>hfref_mop_conv</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="free"><span>g</span></span><span class="main"><span>,</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>Q</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.iff|const"><span>⟷</span></a></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>g</span></span><span class="main"><span>,</span></span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="bound"><span>x</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref_to_ASSERT_conv|fact"><span>hfref_to_ASSERT_conv</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Refine_Util.html#Refine_Util.fo_rule|method"><span class="operator"><span>fo_rule</span></span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.arg_cong|fact"><span>arg_cong</span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.fun_cong|fact"><span>fun_cong</span></a><span class="main"><span>)</span></span><span class="main"><span class="keyword3"><span>+</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.ext|fact"><span>ext</span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_eq_iff|fact"><span>pw_eq_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.hfref_op_to_mop|fact"><span class="entity_def" id="Sepref_Intf_Util.hfref_op_to_mop|thm"><span>hfref_op_to_mop</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_6414..6415">R</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>impl</span></span><span class="main"><span>,</span></span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>Q</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_6469..6472">DEF</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>mf</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>f</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_6501..6502">C</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span> </span><span class="free"><span>PP'</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.imp_pre|const"><span>imp_pre</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>impl</span></span><span class="main"><span>,</span></span><span class="free"><span>mf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>PP'</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_6469..6472"><span>DEF</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.hfref_mop_conv|fact"><span>hfref_mop_conv</span></a><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref_cons|fact"><span>hfref_cons</span></a><span class="main"><span class="main"><span>[</span></span></span><span class="operator"><span>OF</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_6414..6415"><span>R</span></a><span class="main"><span class="main"><span>]</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_6501..6502"><span>C</span></a><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_def|fact"><span>IMP_PRE_def</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.imp_pre_def|fact"><span>imp_pre_def</span></a><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.hfref_mop_to_op|fact"><span class="entity_def" id="Sepref_Intf_Util.hfref_mop_to_op|thm"><span>hfref_mop_to_op</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_6748..6749">R</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>impl</span></span><span class="main"><span>,</span></span><span class="free"><span>mf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>Q</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_6804..6807">DEF</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>mf</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>f</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_6836..6837">C</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span> </span><span class="free"><span>PP'</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre|const"><span>and_pre</span></a><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>P</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>impl</span></span><span class="main"><span>,</span></span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>PP'</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>a</sub></span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>C</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>→<span class="hidden">⇩</span><sub>d</sub></span></a></span><span> </span><span class="free"><span>S</span></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>[</span></a></span><span class="free"><span>CP</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>]<span class="hidden">⇩</span><sub>c</sub></span></a></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_6748..6749"><span>R</span></a><span> </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_6804..6807"><span>DEF</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.hfref_mop_conv|fact"><span>hfref_mop_conv</span></a><span> 
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref_cons|fact"><span>hfref_cons</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_6836..6837"><span>C</span></a><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre_def|fact"><span>and_pre_def</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_def|fact"><span>IMP_PRE_def</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>

  </span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Precondition Simplification›</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_7107..7112">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_eqI|fact"><span class="entity_def" id="Sepref_Intf_Util.IMP_PRE_eqI|thm"><span>IMP_PRE_eqI</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="bound"><span>x</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>P'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span> </span><span class="free"><span>P'</span></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_7107..7112"><span>assms</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_def|fact"><span>IMP_PRE_def</span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_7249..7254">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.simp_and1|fact"><span class="entity_def" id="Sepref_Intf_Util.simp_and1|thm"><span>simp_and1</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>Q</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>P'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>P'</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span></span><span>  
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_7249..7254"><span>assms</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_7371..7376">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.simp_and2|fact"><span class="entity_def" id="Sepref_Intf_Util.simp_and2|thm"><span>simp_and2</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>Q'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>Q'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span></span><span>  
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_7371..7376"><span>assms</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.triv_and1|fact"><span class="entity_def" id="Sepref_Intf_Util.triv_and1|thm"><span>triv_and1</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>Q</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/blast.ML.html#HOL.blast|method"><span class="operator"><span>blast</span></span></a><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_7537..7542">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.simp_imp|fact"><span class="entity_def" id="Sepref_Intf_Util.simp_imp|thm"><span>simp_imp</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>Q'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>Q'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PP</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>Q</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_7537..7542"><span>assms</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_7654..7659">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.CNV_split|fact"><span class="entity_def" id="Sepref_Intf_Util.CNV_split|thm"><span>CNV_split</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>A'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="free"><span>B</span></span><span> </span><span class="free"><span>B'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>A</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>A'</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>B'</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>  
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_7654..7659"><span>assms</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_7780..7785">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.CNV_prove|fact"><span class="entity_def" id="Sepref_Intf_Util.CNV_prove|thm"><span>CNV_prove</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span>"</span></span></span><span>  
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="free"><span>P</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_7780..7785"><span>assms</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_7865..7870">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.simp_pre_final_simp|fact"><span class="entity_def" id="Sepref_Intf_Util.simp_pre_final_simp|thm"><span>simp_pre_final_simp</span></span></span><span class="main"><span>:</span></span><span>   
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV|const"><span>CNV</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>P'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P'</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_7865..7870"><span>assms</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_7964..7969">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.auto_weaken_pre_uncurry_step&apos;|fact"><span class="entity_def" id="Sepref_Intf_Util.auto_weaken_pre_uncurry_step&apos;|thm"><span>auto_weaken_pre_uncurry_step'</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.PROTECT|const"><span>PROTECT</span></a><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>a</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>f'</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.PROTECT|const"><span>PROTECT</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry|const"><span>uncurry</span></a><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>a</span></span><span class="main"><span>,</span></span><span class="free"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>f'</span></span><span> </span><span class="free"><span>b</span></span><span>"</span></span></span><span> 
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_7964..7969"><span>assms</span></a><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.curry_def|fact"><span>curry_def</span></a><span> </span><span class="quasi_keyword"><span>dest</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.meta_eq_to_obj_eq|fact"><span>meta_eq_to_obj_eq</span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq_reflection|fact"><span>eq_reflection</span></a><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Protected Constants›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.add_PR_CONST_to_def|fact"><span class="entity_def" id="Sepref_Intf_Util.add_PR_CONST_to_def|thm"><span>add_PR_CONST_to_def</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>x</span></span><span class="main"><span>≡</span></span><span class="free"><span>y</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>y</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Rule Collections›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>named_theorems_rev</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_mop_def_thms|attribute"><span class="entity_def" id="Sepref_Intf_Util.sepref_mop_def_thms|fact"><span>sepref_mop_def_thms</span></span></span><span> </span><span class="quoted"><span>‹Sepref: mop - definition theorems›</span></span><span>

</span><span class="keyword1"><span class="command"><span>named_theorems_rev</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_fref_thms|attribute"><span class="entity_def" id="Sepref_Intf_Util.sepref_fref_thms|fact"><span>sepref_fref_thms</span></span></span><span> </span><span class="quoted"><span>‹Sepref: fref-theorems›</span></span><span>

</span><span class="keyword1"><span class="command"><span>named_theorems</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_relprops_transform|attribute"><span class="entity_def" id="Sepref_Intf_Util.sepref_relprops_transform|fact"><span>sepref_relprops_transform</span></span></span><span> </span><span class="quoted"><span>‹Sepref: Simp-rules to transform relator properties›</span></span><span>
</span><span class="keyword1"><span class="command"><span>named_theorems</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_relprops|attribute"><span class="entity_def" id="Sepref_Intf_Util.sepref_relprops|fact"><span>sepref_relprops</span></span></span><span> </span><span class="quoted"><span>‹Sepref: Simp-rules to add CONSTRAINT-tags to relator properties›</span></span><span>
</span><span class="keyword1"><span class="command"><span>named_theorems</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_relprops_simps|attribute"><span class="entity_def" id="Sepref_Intf_Util.sepref_relprops_simps|fact"><span>sepref_relprops_simps</span></span></span><span> </span><span class="quoted"><span>‹Sepref: Simp-rules to simplify relator properties›</span></span><span>

</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Default Setup›</span></span></span><span>



</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ML-Level Declarations›</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
    </span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SEPREF_INTF_UTIL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
      </span><span class="comment1"><span>(* Miscellaneous*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> list_filtered_subterms</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span>


      </span><span class="comment1"><span>(* Interface types for relations *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_intf_of_rel</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>

      </span><span class="comment1"><span>(* Constraints *)</span></span><span>
      </span><span class="comment1"><span>(* Convert relations to pure assertions *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> to_assns_rl</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
      </span><span class="comment1"><span>(* Recognize, summarize and simplify CONSTRAINT - premises *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cleanup_constraints</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

      </span><span class="comment1"><span>(* Preconditions *)</span></span><span>
      </span><span class="comment1"><span>(* Simplify precondition. Goal must be in IMP_PRE or IMP_PRE_CUSTOM form. *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simp_precond_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>


      </span><span class="comment1"><span>(* Configuration options *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cfg_def</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>       </span><span class="comment1"><span>(* decl_op: Define constant *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cfg_ismop</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>     </span><span class="comment1"><span>(* decl_op: Specified term is mop *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cfg_mop</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>       </span><span class="comment1"><span>(* decl_op, decl_impl: Derive mop *)</span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cfg_rawgoals</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>  </span><span class="comment1"><span>(* decl_op, decl_impl: Do not pre-process/solve goals *)</span></span><span>


      </span><span class="comment1"><span>(* TODO: Make do_cmd usable from ML-level! *)</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sepref_Intf_Util</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SEPREF_INTF_UTIL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_debug</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_debug_intf_util|attribute"><span>sepref_debug_intf_util</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Debugging.dbg_trace_msg</span></span><span> </span><span class="entity"><span>cfg_debug</span></span><span>  
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dbg_msg_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Debugging.dbg_msg_tac</span></span><span> </span><span class="entity"><span>cfg_debug</span></span><span>  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dbg_trace_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>Sepref_Debugging.dbg_trace</span></span><span> </span><span class="entity"><span>cfg_debug</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dbg_trace_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>Sepref_Debugging.dbg_trace</span></span><span> </span><span class="entity"><span>cfg_debug</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_filtered_subterms</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span>SOME</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>a</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
              </span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>t2</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_intf_of_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>Term_Synth.synth_term</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.synth_intf_of_relI|fact"><span>synth_intf_of_relI</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>R</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fastype_of</span><span> 
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Refine_Util.dest_itselfT</span></span><span>
  
      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_is_pure_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>]</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.add_is_pure_constraint|fact"><span>add_is_pure_constraint</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>rl</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_assns_rl</span></span><span> </span><span class="entity"><span>add_pure_constr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span>Variable.importT</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.fref|const"><span>fref</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="var"><span>?R</span></span><span> </span><span class="var"><span>?S</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"to_assns_rl: expected fref-thm"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_cn_subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>iname</span></span><span class="main"><span>,</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>C</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.assn|type"><span>assn</span></a></span><span class="antiquote"><span>}</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mk_term</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure|const"><span>the_pure</span></a><span> </span><span class="var"><span>?v'</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>v'</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>iname</span></span><span class="main"><span>,</span></span><span class="entity"><span>ct'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>relation_flt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span class="entity"><span>A</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>relation_flt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>  
      
            
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>R</span></span><span> 
            </span><span>|&gt;</span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>S</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relation_flt</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>#&gt;</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cn_substs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_cn_subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
      
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>cn_substs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_pure_constr</span></span><span> </span><span>?</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_is_pure_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cn_substs</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cleanup_constraints</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xform_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems</span></span><span> sepref_relprops_transform</span><span class="antiquote"><span>}</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rprops_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems</span></span><span> sepref_relprops</span><span class="antiquote"><span>}</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems</span></span><span> sepref_relprops_simps</span><span class="antiquote"><span>}</span></span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simp</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>
                  </span><span class="entity"><span>Simplifier.asm_full_rewrite</span></span><span> 
                    </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
          </span><span class="comment1"><span>(* Check for pure (the_pure R) - patterns *)</span></span><span>
      
          </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>hfref</span></a><span> </span><span class="var"><span>?P</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="var"><span>?R</span></span><span> </span><span class="var"><span>?S</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.fref|const"><span>fref</span></a><span> </span><span class="var"><span>?P</span></span><span> </span><span class="var"><span>?R</span></span><span> </span><span class="var"><span>?S</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cleanup_constraints: Expected hfref or fref-theorem"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>  
      
      
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flt_pat</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure|const"><span>pure</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure|const"><span>the_pure</span></a><span> </span><span class="var"><span>?A</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flt_pat</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>purify_terms</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span class="main"><span>(</span></span><span class="entity"><span>list_filtered_subterms</span></span><span> </span><span class="entity"><span>flt_pat</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>list_filtered_subterms</span></span><span> </span><span class="entity"><span>flt_pat</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span>
       
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_is_pure_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>purify_terms</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>xform_thms</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rprops_thms</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> 
              </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure|const"><span>the_pure</span></a><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.handle_purity1|fact"><span>handle_purity1</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>asm_rl</span><span>  
            </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>  
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>OF</span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Conv.fconv_rule</span><span> </span><span>Thm.eta_conversion</span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>simp</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.handle_purity2|fact"><span>handle_purity2</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>simp</span></span><span> </span><span class="entity"><span>simp_thms</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>  
      
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simp_precond_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simp_only</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>asm_full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cnv_ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>delsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV_def|fact"><span>CNV_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    
        </span><span class="comment1"><span>(*val uncurry_tac = SELECT_GOAL (ALLGOALS (DETERM o SOLVED' (
          REPEAT' (rtac @{thms auto_weaken_pre_uncurry_step'}) 
          THEN' rtac @{thms auto_weaken_pre_uncurry_finish}
        )))*)</span></span><span>
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prove_cnv_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.CNV_prove|fact"><span>CNV_prove</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span> </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>auto_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>do_cnv_tac</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="main"><span>(</span></span><span class="entity"><span>cp_clarsimp_tac</span></span><span> </span><span class="entity"><span>cnv_ss</span></span><span class="main"><span>)</span></span><span> </span><span>THEN_ALL_NEW</span><span>
          </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>match_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.CNV_split|fact"><span>CNV_split</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>THEN_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove_cnv_tac</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV_I|fact"><span>CNV_I</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>final_simp_tac</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.simp_pre_final_simp|fact"><span>simp_pre_final_simp</span></a><span class="antiquote"><span>}</span></span></span></span><span> 
          </span><span>THEN'</span><span> </span><span class="entity"><span>cp_clarsimp_tac</span></span><span> </span><span class="entity"><span>cnv_ss</span></span><span>
          </span><span>THEN'</span><span> </span><span class="entity"><span>dbg_msg_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Debugging.msg_subgoal</span></span><span> </span><span class="inner_quoted"><span>"final_simp_tac: Before CNV_I"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span>THEN'</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV_I|fact"><span>CNV_I</span></a><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span>THEN'</span><span> </span><span class="entity"><span>dbg_msg_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Debugging.msg_text</span></span><span> </span><span class="inner_quoted"><span>"Final-Simp done"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    
        </span><span class="comment1"><span>(*val curry_tac = let open Conv in
          CONVERSION (Refine_Util.HOL_concl_conv (fn ctxt =&gt; arg1_conv (
            top_conv ( fn _ =&gt; try_conv (rewr_conv @{thm uncurry_def})) ctxt)) ctxt)
          THEN' REPEAT' (EqSubst.eqsubst_tac ctxt [1] @{thms case_prod_eta})
          THEN' rtac @{thms CNV_I}
          end*)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_tupled_pre_tac</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.prod_casesK|fact"><span>prod_casesK</span></a><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.uncurry0_hfref_post|fact"><span>uncurry0_hfref_post</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>THEN'</span><span> </span><span class="entity"><span>REPEAT'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EqSubst.eqsubst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.case_prod_eta|fact"><span>case_prod_eta</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>THEN'</span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.CNV_I|fact"><span>CNV_I</span></a><span class="antiquote"><span>}</span></span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_and_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre_beta|fact"><span>and_pre_beta</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span class="entity"><span>simp_only</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.split|fact"><span>split</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_and1_tac</span></span><span> </span><span class="main"><span>=</span></span><span>  
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.simp_and1|fact"><span>simp_and1</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>do_cnv_tac</span></span><span>
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_and2_tac</span></span><span> </span><span class="main"><span>=</span></span><span>  
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.simp_and2|fact"><span>simp_and2</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>do_cnv_tac</span></span><span>
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>and_plan_tac</span></span><span> </span><span class="main"><span>=</span></span><span>   
          </span><span class="entity"><span>simp_and1_tac</span></span><span> 
          </span><span>THEN'</span><span> </span><span class="entity"><span>dbg_msg_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Debugging.msg_subgoal</span></span><span> </span><span class="inner_quoted"><span>"State after and1"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span>THEN'</span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.triv_and1|fact"><span>triv_and1</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span>ORELSE'</span><span> 
            </span><span class="entity"><span>dbg_msg_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Debugging.msg_subgoal</span></span><span> </span><span class="inner_quoted"><span>"Invoking and2 on"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>THEN'</span><span> </span><span class="entity"><span>simp_and2_tac</span></span><span> 
            </span><span>THEN'</span><span> </span><span class="entity"><span>dbg_msg_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Debugging.msg_subgoal</span></span><span> </span><span class="inner_quoted"><span>"State before final_simp_tac"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>THEN'</span><span> </span><span class="entity"><span>final_simp_tac</span></span><span>
          </span><span class="main"><span>)</span></span><span>
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_imp_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.imp_pre_beta|fact"><span>imp_pre_beta</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span class="entity"><span>simp_only</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.split|fact"><span>split</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_imp1_tac</span></span><span> </span><span class="main"><span>=</span></span><span>  
          </span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.simp_imp|fact"><span>simp_imp</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>do_cnv_tac</span></span><span>
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>imp_plan_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simp_imp1_tac</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>final_simp_tac</span></span><span> 
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>imp_pre_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>APPLY_LIST</span></span><span> </span><span class="main"><span>[</span></span><span>
            </span><span class="entity"><span>simp_only</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.split_tupled_all|fact"><span>split_tupled_all</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span>THEN'</span><span> </span><span class="entity"><span>Refine_Util.instantiate_tuples_subgoal_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>THEN'</span><span> </span><span class="entity"><span>CASES'</span></span><span> </span><span class="main"><span>[</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_and_tac</span></span><span class="main"><span>,</span></span><span> </span><span>ALLGOALS</span><span> </span><span class="entity"><span>and_plan_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_imp_tac</span></span><span class="main"><span>,</span></span><span> </span><span>ALLGOALS</span><span> </span><span class="entity"><span>imp_plan_tac</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>simp_tupled_pre_tac</span></span><span>
          </span><span class="main"><span>]</span></span><span>  
    
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>imp_pre_custom_tac</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.and_pre_def|fact"><span>and_pre_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span>
          </span><span>TRY</span><span> </span><span>o</span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>auto_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>CASES'</span></span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_eqI|fact"><span>IMP_PRE_eqI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>imp_pre_tac</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_CUSTOMI|fact"><span>IMP_PRE_CUSTOMI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span>ALLGOALS</span><span> </span><span class="entity"><span>imp_pre_custom_tac</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>




      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inf_bn_aux</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>String.tokens</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>#"."</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>l</span></span><span> </span><span>|&gt;</span><span> </span><span>hd</span><span> </span><span>|&gt;</span><span> </span><span>Binding.name</span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>infer_basename</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_type_constraint_"</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>infer_basename</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>infer_basename</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inf_bn_aux</span></span><span> </span><span class="entity"><span>name</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>infer_basename</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inf_bn_aux</span></span><span> </span><span class="entity"><span>name</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>infer_basename</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>    
  
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_mop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_register_mop|attribute"><span>sepref_register_mop</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_ismop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_register_ismop|attribute"><span>sepref_register_ismop</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_rawgoals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_register_rawgoals|attribute"><span>sepref_register_rawgoals</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_transfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_decl_impl_transfer|attribute"><span>sepref_decl_impl_transfer</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_register_def|attribute"><span>sepref_register_def</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_register</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.sepref_decl_impl_register|attribute"><span>sepref_decl_impl_register</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
  
      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> 
        </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Refine_Util</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flags</span></span><span> </span><span class="main"><span>=</span></span><span> 
             </span><span class="entity"><span>parse_bool_config'</span></span><span> </span><span class="inner_quoted"><span>"mop"</span></span><span> </span><span class="entity"><span>cfg_mop</span></span><span>
          </span><span>||</span><span> </span><span class="entity"><span>parse_bool_config'</span></span><span> </span><span class="inner_quoted"><span>"ismop"</span></span><span> </span><span class="entity"><span>cfg_ismop</span></span><span>
          </span><span>||</span><span> </span><span class="entity"><span>parse_bool_config'</span></span><span> </span><span class="inner_quoted"><span>"rawgoals"</span></span><span> </span><span class="entity"><span>cfg_rawgoals</span></span><span>
          </span><span>||</span><span> </span><span class="entity"><span>parse_bool_config'</span></span><span> </span><span class="inner_quoted"><span>"def"</span></span><span> </span><span class="entity"><span>cfg_def</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_flags</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_paren_list'</span></span><span> </span><span class="entity"><span>flags</span></span><span>  

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>Parse.binding</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>:</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_relconds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>where</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Parse.and_list1</span><span> </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span> </span><span>Parse.prop</span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>flat</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>do_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_flags</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_name</span></span><span> </span><span>--</span><span> </span><span>Parse.term</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>::</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>--</span><span> </span><span>Parse.term</span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_relconds</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
  
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>flags</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>opt_raw</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>relt_raw</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>relconds_raw</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Util.apply_configs</span></span><span> </span><span class="entity"><span>flags</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flag_ismop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_ismop</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flag_mop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_mop</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>flag_ismop</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flag_rawgoals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_rawgoals</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flag_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_def</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
        </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sepref_Basic</span><span> </span><span>Sepref_Rules</span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.parse_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>relt_raw</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relconds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.parse_prop</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>relconds_raw</span></span><span> 

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Parse relation and relation conditions together"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><span>Pure.term</span><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>relt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_props</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relt</span></span><span>::</span><span class="entity"><span>relconds</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>relconds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span>tl</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.dest_term</span><span> </span><span class="entity"><span>relt</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.parse_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>opt_raw</span></span><span>
  

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Infer basename"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>infer_basename</span></span><span> </span><span class="entity"><span>opt_pre</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
              </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>error</span><span> </span><span class="inner_quoted"><span>"Could not infer basename: You have to specify a basename"</span></span><span class="main"><span>;</span></span><span> </span><span>Binding.empty</span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name</span></span><span>
          </span><span class="main"><span>)</span></span><span>
          
  
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qname</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>t_pre</span></span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>t_pre</span></span><span>
            </span><span class="comment1"><span>(*|&gt; Thm.cterm_of lthy
            |&gt; Drule.mk_term
            |&gt; Local_Defs.unfold0 lthy @{thms PR_CONST_def}
            |&gt; Drule.dest_term
            |&gt; Thm.term_of*)</span></span><span>
  
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.begin_nested</span><span> </span><span class="entity"><span>lthy</span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>dt</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.define</span><span> 
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>Mixfix.NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.def_binding</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>code</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>@</span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy_old</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span>Local_Theory.end_nested</span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.export_morphism</span><span> </span><span class="entity"><span>lthy_old</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>dt</span></span><span>
  
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>dt</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Analyze Relation"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pre</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>analyze_rel</span></span><span> </span><span class="entity"><span>relt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>specified_pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>pre</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_triv_precond</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pre</span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST_def|fact"><span>PR_CONST_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Define op"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.prefix_name</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag_ismop</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"mop_"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"op_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def_thms</span></span><span class="main"><span>,</span></span><span class="entity"><span>opc</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag_def</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>opc</span></span><span class="main"><span>,</span></span><span class="entity"><span>op_def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="entity"><span>op_name</span></span><span> </span><span class="entity"><span>opt_pre</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>lthy</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Util.dummify_tvars</span></span><span> </span><span class="entity"><span>opc</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>op_def_thm</span></span><span>::</span><span class="entity"><span>def_thms</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>def_thms</span></span><span class="main"><span>,</span></span><span class="entity"><span>opc</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Refine type of opt_pre to get opc"</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>opt_pre</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>opc</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export_terms</span><span> </span><span class="entity"><span>new_ctxt</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opc</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>Refine_Util.dummify_tvars</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
              </span><span class="main"><span>(</span></span><span class="entity"><span>def_thms</span></span><span class="main"><span>,</span></span><span class="entity"><span>opc</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
            
        </span><span class="comment1"><span>(* PR_CONST Heuristics *)</span></span><span>    
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_const_heuristics</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>c_pre</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"PR_CONST heuristics "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>c_pre</span></span><span class="main"><span>)</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>c_pre</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c_pre</span></span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c_pre</span></span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>c</span></span><span>
  
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Autoref_Tagging.list_APP</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mk_term</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.UNPROTECT|const"><span>UNPROTECT</span></a><span> </span><span class="var"><span>?c</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> 
                    </span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP_def|fact"><span>APP_def</span></a><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.UNPROTECT_def|fact"><span>UNPROTECT_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                    </span><span>THEN</span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove_internal</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> 
                    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_def_pat"</span></span><span> </span><span class="entity"><span>basename</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.def_pat_rules|attribute"><span class="operator"><span>def_pat_rules</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>writeln</span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="entity"><span>lthy</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
                </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Complex operation pattern. Added PR_CONST but no pattern rules:"</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>]</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>warning</span><span>  
                </span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c_pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>c_pre</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c_pre</span></span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>opc</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_const_heuristics</span></span><span> </span><span class="entity"><span>op_name</span></span><span> </span><span class="entity"><span>opc</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

        </span><span class="comment1"><span>(* Register *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_intfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_intf_of_rel</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res_intf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_intf_of_rel</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>res</span></span><span>
  

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Register"</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sepref_Basic</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>c</span></span><span>
  
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ri</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_nresT</span></span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_nresT</span></span><span> </span><span class="entity"><span>res_intf</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_nresT</span></span><span> </span><span class="entity"><span>res_intf</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>dest_nresT</span></span><span> </span><span class="entity"><span>res_intf</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>res_intf</span></span><span>
  
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arg_intfs</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>ri</span></span><span>
  
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>itype_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Combinator_Setup.sepref_register_single</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>basename</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>iT</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>itype_thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>writeln</span><span>
  
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>lthy</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>register</span></span><span> </span><span class="entity"><span>op_name</span></span><span> </span><span class="entity"><span>opc</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Define pre"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.prefix_name</span><span> </span><span class="inner_quoted"><span>"pre_"</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>prec</span></span><span class="main"><span>,</span></span><span class="entity"><span>pre_def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="entity"><span>pre_name</span></span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>lthy</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Util.dummify_tvars</span></span><span> </span><span class="entity"><span>prec</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pre_def_thm</span></span><span>::</span><span class="entity"><span>def_thms</span></span><span>
  
        </span><span class="comment1"><span>(* Re-integrate pre-constant into type-context of relation. TODO: This is probably not clean/robust *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constrain_type_pre</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>pre</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span>

  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Convert both, relation and operation to uncurried form, and add nres"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Convert relation (arguments have already been separated by analyze-rel)"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>λ</span></span><span class="main"><span class="bound"><span>_</span></span></span><span class="main"><span>.</span></span><span> </span><span class="main"><span>⟨</span></span><span class="main"><span>_</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>res</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mk_term</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="main"><span>⟨</span></span><span class="var"><span>?res</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_rel</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>pre</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace_term</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Converted relation"</span></span><span> </span><span class="entity"><span>relt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>relt</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>dbg_trace_term</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Converted relation (checked)"</span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Convert operation"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opcT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="main"><span>(</span></span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>opc</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op_is_nres</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Basic.is_nresT</span></span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>opcT</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opcu</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>op_ar</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binder_types</span><span> </span><span>#&gt;</span><span> </span><span>length</span><span>
          </span><span class="comment1"><span>(* Arity of operation is number of arguments before result (which may be a fun-type! )*)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_absT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span>#&gt;</span><span> </span><span>body_type</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_prodT</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span> </span><span class="comment1"><span>(* TODO: Generalization of with Realtors.rel_absT. Maybe move? *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res_ar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_absT</span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>op_is_nres</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>dest_nresT</span></span><span class="main"><span>)</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op_ar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>opcT</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>res_ar</span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>op_ar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> 
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Operation/relation arity mismatch: "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>op_ar</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" vs "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>opc</span></span><span class="main"><span>,</span></span><span class="entity"><span>relt</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  
          </span><span class="comment1"><span>(* Add RETURN o...o if necessary*)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opc</span></span><span> </span><span class="main"><span>=</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>op_is_nres</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>opc</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_compN_pre</span></span><span> </span><span class="entity"><span>op_ar</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>Refine_Basic.RETURN</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opc</span></span><span>
  
          </span><span class="comment1"><span>(* Add uncurry if necessary *)</span></span><span>  
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_uncurryN_pre</span></span><span> </span><span class="entity"><span>op_ar</span></span><span> </span><span class="entity"><span>opc</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
          </span><span class="main"><span>(</span></span><span class="entity"><span>opc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>op_ar</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
        </span><span class="comment1"><span>(* Build mop-variant *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>declare_mop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>specified_pre</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>op_is_nres</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>flag_mop</span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mop_data</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>declare_mop</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"mop definition"</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop|const"><span>mop</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>prec</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>opcu</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_curryN_pre</span></span><span> </span><span class="entity"><span>op_ar</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.prefix_name</span><span> </span><span class="inner_quoted"><span>"mop_"</span></span><span> </span><span class="entity"><span>name</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mopc</span></span><span class="main"><span>,</span></span><span class="entity"><span>mop_def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="entity"><span>mop_name</span></span><span> </span><span class="entity"><span>mop_rhs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mopc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Util.dummify_tvars</span></span><span> </span><span class="entity"><span>mopc</span></span><span>
  
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mopc</span></span><span class="main"><span>,</span></span><span class="entity"><span>added_pr_const</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_const_heuristics</span></span><span> </span><span class="entity"><span>mop_name</span></span><span> </span><span class="entity"><span>mopc</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_def_thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>added_pr_const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
                </span><span class="entity"><span>mop_def_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.add_PR_CONST_to_def|fact"><span>add_PR_CONST_to_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mop_def_thm</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.sepref_mop_def_thms|attribute"><span class="operator"><span>sepref_mop_def_thms</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>mop_def_thm'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"mop alternative definition"</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alt_unfolds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop_alt_unfolds|fact"><span>mop_alt_unfolds</span></a><span class="antiquote"><span>}</span></span></span></span><span>
              </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>specified_pre</span></span><span> </span><span>?</span><span> </span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>pre_def_thm</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_alt_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>alt_unfolds</span></span><span> </span><span class="entity"><span>mop_def_thm</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Refine_Util.shift_lambda_leftN</span></span><span> </span><span class="entity"><span>op_ar</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_alt"</span></span><span> </span><span class="entity"><span>mop_name</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>mop_alt_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"mop: register"</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>register</span></span><span> </span><span class="entity"><span>mop_name</span></span><span> </span><span class="entity"><span>mopc</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"mop: vcg theorem"</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Relators.rel_absT</span></span><span> </span><span class="entity"><span>args</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.declare_thm</span><span> </span><span class="entity"><span>mop_def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Variable.declare_typ</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Util.fix_left_tuple_from_Ts</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_def_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mop_def_thm</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.curry_shl|fact"><span>curry_shl</span></a><span class="antiquote"><span>}</span></span></span></span><span>
              
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mop_def_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Drule.infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry_apply|fact"><span>uncurry_apply</span></a><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry0_apply|fact"><span>uncurry0_apply</span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.o_apply|fact"><span>o_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                </span><span>|&gt;</span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def_thms</span></span><span> </span><span>@</span><span>
                    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.split|fact"><span>Product_Type.split</span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True_implies_equals|fact"><span>HOL.True_implies_equals</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>prep_thm</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop_spec_rl_from_def|fact"><span>mop_spec_rl_from_def</span></a><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.mop_leof_rl_from_def|fact"><span>mop_leof_rl_from_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>  

            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"vcg"</span></span><span> </span><span class="entity"><span>mop_name</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_vcg|attribute"><span class="operator"><span>refine_vcg</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mop_name</span></span><span class="main"><span>,</span></span><span class="entity"><span>mopc</span></span><span class="main"><span>,</span></span><span class="entity"><span>mop_def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Build Parametricity Theorem"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_pair_in_pre</span></span><span> </span><span class="entity"><span>opcu</span></span><span> </span><span class="entity"><span>opcu</span></span><span> </span><span class="entity"><span>relt</span></span><span> 
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace_term</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Param Term"</span></span><span> </span><span class="entity"><span>param_t</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>param_t</span></span><span> </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> 
          </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
          </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_implies</span><span> </span><span class="entity"><span>relconds</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Build Parametricity Theorem for Precondition"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_pre_t</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre_relt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Relators.mk_fun_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Relators.list_prodrel_left</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.bool_rel|const"><span>bool_rel</span></a></span><span class="antiquote"><span>}</span></span></span><span>
  
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_pre_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_pair_in_pre</span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span class="entity"><span>pre_relt</span></span><span> 
              </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
              </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_implies</span><span> </span><span class="entity"><span>relconds</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>param_pre_t</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Build goals"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_pre_t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>p_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pp_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="comment1"><span>(*ctxt*)</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"after_qed"</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p_thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p_thm</span></span><span> </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>specified_pre</span></span><span> </span><span>?</span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pre_def_thm</span></span><span class="main"><span>]</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"fref"</span></span><span> </span><span class="entity"><span>op_name</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.sepref_fref_thms|attribute"><span class="operator"><span>sepref_fref_thms</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p_thm'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"param"</span></span><span> </span><span class="entity"><span>pre_name</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Param_Tool.html#Param_Tool.param|attribute"><span class="operator"><span>param</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pp_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p'_unfolds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pre_def_thm</span></span><span> </span><span>::</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True_implies_equals|fact"><span>True_implies_equals</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"fref'"</span></span><span> </span><span class="entity"><span>op_name</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>p'_unfolds</span></span><span> </span><span class="entity"><span>p_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

  
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mop_data</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>|</span></span><span> 
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mop_name</span></span><span class="main"><span>,</span></span><span class="entity"><span>mopc</span></span><span class="main"><span>,</span></span><span class="entity"><span>mop_def_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Build and prove mop-stuff"</span></span><span>
                </span><span class="comment1"><span>(* mop - parametricity theorem: (uncurry<span class="hidden">⇧</span><sup>n</sup> mopc,uncurry<span class="hidden">⇧</span><sup>n</sup> mopc) ∈ args →<span class="hidden">⇩</span><sub>f</sub> res *)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mopcu</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_uncurryN_pre</span></span><span> </span><span class="entity"><span>op_ar</span></span><span> </span><span class="entity"><span>mopc</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_mop_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_pair_in_pre</span></span><span> </span><span class="entity"><span>mopcu</span></span><span> </span><span class="entity"><span>mopcu</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_rel</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span>Logic.list_implies</span><span> </span><span class="entity"><span>relconds</span></span><span>
  
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.augment</span><span> </span><span class="entity"><span>param_mop_t</span></span><span> </span><span class="entity"><span>lthy</span></span><span> 
                
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST_def|fact"><span>PR_CONST_def</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>p_thm</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mop_def_thm</span></span><span> </span><span>::</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST_def|fact"><span>PR_CONST_def</span></a><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry_curry_id|fact"><span>uncurry_curry_id</span></a><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry_curry0_id|fact"><span>uncurry_curry0_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                  </span><span>THEN</span><span> </span><span>FIRSTGOAL</span><span> </span><span class="main"><span>(</span></span><span>
                    </span><span class="entity"><span>dbg_msg_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Debugging.msg_subgoal</span></span><span> </span><span class="inner_quoted"><span>"Mop-param thm goal after unfolding"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
                    </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.param_mopI|fact"><span>param_mopI</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                      </span><span>THEN'</span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p_thm</span></span><span class="main"><span>]</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                      </span><span>THEN'</span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pp_thm</span></span><span class="main"><span>]</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pm_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove_internal</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>param_mop_t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"fref"</span></span><span> </span><span class="entity"><span>mop_name</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.sepref_fref_thms|attribute"><span class="operator"><span>sepref_fref_thms</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pm_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"fref'"</span></span><span> </span><span class="entity"><span>mop_name</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>p'_unfolds</span></span><span> </span><span class="entity"><span>pm_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  
  
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>lthy</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>thmss</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"After-qed: Wrong thmss structure"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span>flat</span><span> </span><span class="entity"><span>thmss</span></span><span class="main"><span>)</span></span><span>    
          
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>std_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ptac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>REPEAT_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Parametricity.net_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Parametricity.get_dflt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  
          </span><span class="comment1"><span>(* Massage simpset a bit *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Context_Position.set_visible</span><span> </span><span>false</span><span>
            </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>Thm.attribute_declaration</span><span> </span><span class="entity"><span>Clasimp.iff_del</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.pair_in_Id_conv|fact"><span>pair_in_Id_conv</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag_rawgoals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>all_tac</span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span>THEN</span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span>
              </span><span>TRY</span><span> </span><span>o</span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>
                </span><span>TRY</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefI|fact"><span>frefI</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                </span><span>THEN'</span><span> </span><span>TRY</span><span> </span><span>o</span><span> </span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>ematch_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.prod_relE|fact"><span>prod_relE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                </span><span>THEN'</span><span> </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.split|fact"><span>split</span></a><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry_apply|fact"><span>uncurry_apply</span></a><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry0_apply|fact"><span>uncurry0_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                </span><span>THEN'</span><span> </span><span class="main"><span>(</span></span><span>
                  </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ptac</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span class="entity"><span>asm_full_simp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                  </span><span>ORELSE'</span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cp_clarsimp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="entity"><span>ptac</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>auto_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>)</span></span><span>
  
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rf_std</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.refine</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.Basic</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>std_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;</span><span> </span><span>Seq.the_result</span><span> </span><span class="inner_quoted"><span>"do_cmd: Standard proof tactic returned empty result sequence"</span></span><span>

      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>goals</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>rf_std</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Outer_Syntax.local_theory_to_proof</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> "</span><span class="keyword1"><span>sepref_decl_op</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_parser</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>do_cmd</span></span><span class="main"><span>)</span></span><span>
  



      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_PR_CONST_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST_def|fact"><span>PR_CONST_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transfer_precond_rl</span></span><span> </span><span class="entity"><span>fixedTs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="comment1"><span>(*val tfrees = Term.add_tfreesT (fastype_of t) [] 
          val t' = map_types (map_type_tfree (fn x =&gt; if member op= tfrees x then dummyT else TFree x)) t
          *)</span></span><span> </span><span class="comment1"><span>(* TODO: Brute force approach, that may generalize too much! *)</span></span><span>

          </span><span class="comment1"><span>(* Subtypes that contain fixed TFrees are mapped structurally, preserving the fixed types, 
              all other types just become dummyT *)</span></span><span>          
              
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mapT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixedTs</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>dummyT</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mapT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mapT</span></span><span> </span><span class="entity"><span>Ts</span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>dummyT</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mapT</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>dummyT</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span>
              
              
          </span><span class="comment1"><span>(*fun is_declared_TFree (TFree (n,_)) = Variable.is_declared ctxt n
            | is_declared_TFree _ = false
          fun mpaT T = if is_declared_TFree T then T else dummyT
          fun mpT T = if exists_subtype is_declared_TFree T then map_atyps mpaT T else dummyT
          *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>mapT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
        
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Basic.mk_pair_in_pre</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="entity"><span>R</span></span><span> 
            </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dbg_trace_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Precond transfer term before checking"</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
                                    
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>NONE</span><span class="main"><span>,</span></span><span>SOME</span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>]</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST_trivial|fact"><span>IMP_LIST_trivial</span></a><span class="antiquote"><span>}</span></span></span></span><span>

        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      
        </span><span class="comment1"><span>(* Generate a hnr-thm for mop given one for op *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_mop_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>op_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>op_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>op_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
          </span><span class="comment1"><span>(* Convert mop_def_thms to form uncurry^n f ≡ mop P g *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems_Rev.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> sepref_mop_def_thms</span><span class="antiquote"><span>}</span></span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.curry_shl|fact"><span>curry_shl</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fail_hnr_tac</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid hnr-theorem"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>op_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fail_mop_def_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Found no matching mop-definition"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>g</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
          </span><span class="comment1"><span>(* Tactic to solve preconditions of hfref_op_to_mop *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>APPLY_LIST</span></span><span> </span><span class="main"><span>[</span></span><span>
            </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>op_thm</span></span><span class="main"><span>]</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>fail_hnr_tac</span></span><span class="main"><span>,</span></span><span>
            </span><span class="main"><span>(</span></span><span class="comment1"><span>(*unfold_PR_CONST_tac ctxt THEN'*)</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mop_def_thms</span></span><span class="main"><span>)</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>fail_mop_def_tac</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>simp_precond_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>Sepref_Debugging.error_tac'</span></span><span> </span><span class="inner_quoted"><span>"precond simplification failed"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      
          </span><span class="comment1"><span>(* Do synthesis *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.hfref_op_to_mop|fact"><span>hfref_op_to_mop</span></a><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.protect</span><span> </span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span> </span><span>|&gt;</span><span> </span><span>Goal.conclude</span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mop_thm</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>Sepref_Rules.norm_fcomp_rule</span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mop_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
      
        </span><span class="comment1"><span>(* Generate a hnr-thm for op given one for mop *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_op_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mop_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="comment1"><span>(* TODO: Almost-clone of generate_mop_thm *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mop_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mop_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
          </span><span class="comment1"><span>(* Convert mop_def_thms to form uncurry^n f ≡ mop P g *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems_Rev.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> sepref_mop_def_thms</span><span class="antiquote"><span>}</span></span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.curry_shl|fact"><span>curry_shl</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fail_hnr_tac</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid hnr-theorem"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>mop_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fail_mop_def_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Found no matching mop-definition"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>g</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
          </span><span class="comment1"><span>(* Tactic to solve preconditions of hfref_mop_to_op *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>APPLY_LIST</span></span><span> </span><span class="main"><span>[</span></span><span>
            </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mop_thm</span></span><span class="main"><span>]</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>fail_hnr_tac</span></span><span class="main"><span>,</span></span><span>
            </span><span class="main"><span>(</span></span><span class="comment1"><span>(*unfold_PR_CONST_tac ctxt THEN'*)</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mop_def_thms</span></span><span class="main"><span>)</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>fail_mop_def_tac</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>simp_precond_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>Sepref_Debugging.error_tac'</span></span><span> </span><span class="inner_quoted"><span>"precond simplification failed"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      
          </span><span class="comment1"><span>(* Do synthesis *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.hfref_mop_to_op|fact"><span>hfref_mop_to_op</span></a><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.protect</span><span> </span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span> </span><span>|&gt;</span><span> </span><span>Goal.conclude</span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>op_thm</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>Sepref_Rules.norm_fcomp_rule</span></span><span> </span><span class="entity"><span>orig_ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>op_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  


      
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_result</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hfref|const"><span>hfref</span></a><span> </span><span class="var"><span>?P</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="var"><span>?R</span></span><span> </span><span class="var"><span>?S</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"chk_result: Expected hfref-theorem"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>  
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"chk_result: Invalid pattern left in assertions: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_invalid</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hr_comp|const"><span>hr_comp</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>t</span></span><span> 
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_invalid</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrp_comp|const"><span>hrp_comp</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_invalid</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.hrr_comp|const"><span>hrr_comp</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_invalid</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure|const"><span>pure</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure|const"><span>the_pure</span></a><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_invalid</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>_</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.relcomp|const"><span>O</span></a></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_invalid</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
            
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists_subterm</span><span> </span><span class="entity"><span>check_invalid</span></span><span> </span><span class="entity"><span>R</span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists_subterm</span><span> </span><span class="entity"><span>check_invalid</span></span><span> </span><span class="entity"><span>S</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_IMP_LIST</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>    
          </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.to_IMP_LISTI|fact"><span>to_IMP_LISTI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.to_IMP_LIST|fact"><span>to_IMP_LIST</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>from_IMP_LIST</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.from_IMP_LIST|fact"><span>from_IMP_LIST</span></a><span class="antiquote"><span>}</span></span></span></span><span>  

      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    
        </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Refine_Util</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flags</span></span><span> </span><span class="main"><span>=</span></span><span> 
               </span><span class="entity"><span>parse_bool_config'</span></span><span> </span><span class="inner_quoted"><span>"mop"</span></span><span> </span><span class="entity"><span>cfg_mop</span></span><span>
            </span><span>||</span><span> </span><span class="entity"><span>parse_bool_config'</span></span><span> </span><span class="inner_quoted"><span>"ismop"</span></span><span> </span><span class="entity"><span>cfg_ismop</span></span><span>
            </span><span>||</span><span> </span><span class="entity"><span>parse_bool_config'</span></span><span> </span><span class="inner_quoted"><span>"transfer"</span></span><span> </span><span class="entity"><span>cfg_transfer</span></span><span>
            </span><span>||</span><span> </span><span class="entity"><span>parse_bool_config'</span></span><span> </span><span class="inner_quoted"><span>"rawgoals"</span></span><span> </span><span class="entity"><span>cfg_rawgoals</span></span><span>
            </span><span>||</span><span> </span><span class="entity"><span>parse_bool_config'</span></span><span> </span><span class="inner_quoted"><span>"register"</span></span><span> </span><span class="entity"><span>cfg_register</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_flags</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_paren_list'</span></span><span> </span><span class="entity"><span>flags</span></span><span>  
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_precond</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>[</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>]</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_fref_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>uses</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Parse.thm</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_fixed_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>fixes</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.typ</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>di_parser</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span class="entity"><span>parse_flags</span></span><span> 
           </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Parse.binding</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>:</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>Binding.empty</span><span> 
           </span><span>--</span><span> </span><span class="entity"><span>parse_precond</span></span><span> 
           </span><span>--</span><span> </span><span>Parse.thm</span><span> 
           </span><span>--</span><span> </span><span class="entity"><span>parse_fref_thm</span></span><span>
           </span><span>--</span><span> </span><span class="entity"><span>parse_fixed_types</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
      
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>di_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>flags</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>precond_raw</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i_thm_raw</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p_thm_raw</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixedTs_raw</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i_thm_raw</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p_thm_raw</span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_fixed_Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Variable.is_declared</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Fixed type must be declared"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_fixed_Ts</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Only TFrees can be fixed"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixedTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_fixed_Ts</span></span><span> </span><span>o</span><span> </span><span>Syntax.parse_typ</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixedTs_raw</span></span><span> 
          
          </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Util.apply_configs</span></span><span> </span><span class="entity"><span>flags</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flag_mop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_mop</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flag_ismop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_ismop</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flag_rawgoals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_rawgoals</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flag_transfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_transfer</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>flag_register</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_register</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fr_attribs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag_register</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Translate.html#Sepref_Translate.sepref_fr_rules|attribute"><span class="operator"><span>sepref_fr_rules</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>


          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      
          </span><span class="comment1"><span>(* Compose with fref-theorem *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Compose with fref"</span></span><span>

          </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hf_tcomp_pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.hfcomp_tcomp_pre|fact"><span>hfcomp_tcomp_pre</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span>asm_rl</span><span class="main"><span>,</span></span><span class="entity"><span>i_thm</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compose</span></span><span> </span><span class="entity"><span>p_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p_thm</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>to_assns_rl</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>lthy</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>hf_tcomp_pre</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p_thm</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>p_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>p_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>compose</span></span><span> </span><span class="entity"><span>p_thm</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems_Rev.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> sepref_fref_thms</span><span class="antiquote"><span>}</span></span></span><span>
        
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prem_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>hf_tcomp_pre</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>|&gt;</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Found no fref-theorem matching "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>prem_s</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="entity"><span>compose</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p_thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>  
        
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Theorem before transfer"</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Transfer Precond"</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_IMP_LIST</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.transform_pre_param|fact"><span>transform_pre_param</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      
          </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pre</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>pp_name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pp_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prems_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_LIST|const"><span>IMP_LIST</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="var"><span>?pre</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="var"><span>?R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE|const"><span>IMP_PRE</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Mpat_Antiquot.html#Mpat_Antiquot.mpaq_STRUCT|const"><span>mpaq_STRUCT</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Mpat_Antiquot.html#Mpat_Antiquot.mpaq_Var|const"><span>mpaq_Var</span></a><span> </span><span class="var"><span>?pp_name</span></span><span> </span><span class="var"><span>?pp_type</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pre</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>pp_name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pp_type</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"di_cmd: Cannot recognize first prems of transform_pre_param: "</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag_transfer</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>transfer_precond_rl</span></span><span> </span><span class="entity"><span>fixedTs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>thm</span></span><span>
      
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>precond_raw</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
              </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>precond_raw</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>precond</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.parse_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>precond_raw</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>Sepref_Basic.constrain_type_pre</span></span><span> </span><span class="entity"><span>pp_type</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>pp_name</span></span><span class="main"><span>,</span></span><span class="entity"><span>precond</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thm</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span>asm_rl</span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.IMP_PRE_CUSTOMD|fact"><span>IMP_PRE_CUSTOMD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="entity"><span>thm</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Transferred theorem"</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Build goals"</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>thmss</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"After QED"</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>thmss</span></span><span>
      
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>OF</span><span> </span><span class="entity"><span>prems_thms</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>from_IMP_LIST</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span>

            </span><span class="comment1"><span>(* Two rounds of cleanup-constraints, norm_fcomp *)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Cleanup"</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>cleanup_constraints</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Sepref_Rules.norm_fcomp_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>cleanup_constraints</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Sepref_Rules.norm_fcomp_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span>  
              </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>zero_var_indexes</span><span>
      
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Check Result"</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_result</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>thm</span></span><span>  
      
      
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qname</span></span><span> </span><span class="entity"><span>suffix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.is_empty</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="entity"><span>suffix</span></span><span> </span><span class="entity"><span>name</span></span><span> 
      
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag_ismop</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"_hnr_mop"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"_hnr"</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>thm_name</span></span><span class="main"><span>,</span></span><span class="entity"><span>fr_attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>writeln</span><span>

            </span><span class="comment1"><span>(* Create mop theorem from op-theorem *)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cr_mop_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flag_mop</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>flag_ismop</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>cr_mop_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Create mop-thm"</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mop_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>generate_mop_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>zero_var_indexes</span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"_hnr_mop"</span></span><span class="main"><span>,</span></span><span class="entity"><span>fr_attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>mop_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>mop_thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>writeln</span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span>

            </span><span class="comment1"><span>(* Create op theorem from mop-theorem *)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cr_op_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flag_ismop</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>cr_op_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_trace</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_quoted"><span>"Create op-thm"</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>generate_op_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>zero_var_indexes</span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qname</span></span><span> </span><span class="inner_quoted"><span>"_hnr"</span></span><span class="main"><span>,</span></span><span class="entity"><span>fr_attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>op_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>op_thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>writeln</span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span>

      
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
            </span><span class="entity"><span>lthy</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>std_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ptac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>REPEAT_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span> 
              </span><span class="entity"><span>Parametricity.net_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Parametricity.get_dflt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag_rawgoals</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>flag_transfer</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span>all_tac</span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>APPLY_LIST</span></span><span> </span><span class="main"><span>[</span></span><span>
                </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#Sepref_Intf_Util.from_IMP_LIST|fact"><span>from_IMP_LIST</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span> </span><span>TRY</span><span> </span><span>o</span><span> </span><span>SOLVED'</span><span> </span><span class="entity"><span>ptac</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>simp_precond_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
            
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rf_std</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.refine</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.Basic</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>std_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>#&gt;</span><span> </span><span>Seq.the_result</span><span> </span><span class="inner_quoted"><span>"di_cmd: Standard proof tactic returned empty result sequence"</span></span><span>

        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>goals</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>rf_std</span></span><span>
      
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Outer_Syntax.local_theory_to_proof</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> "</span><span class="keyword1"><span>sepref_decl_impl</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>di_parser</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>di_cmd</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
  ›</span></span><span>  

</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Obsolete Manual Specification Helpers›</span></span></span><span>

  </span><span class="comment1"><span>(* Generate VCG-rules for operations *)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_49347..49352">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.vcg_of_RETURN_np|fact"><span class="entity_def" id="Sepref_Intf_Util.vcg_of_RETURN_np(2)|thm"><span class="entity_def" id="Sepref_Intf_Util.vcg_of_RETURN_np(1)|thm"><span>vcg_of_RETURN_np</span></span></span></span><span class="main"><span>:</span></span><span>  
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="free"><span>r</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span class="free"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>m</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>m</span></span><span>"</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span class="free"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>m</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>m</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_49347..49352"><span>assms</span></a><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.pw_leof_iff|fact"><span>pw_leof_iff</span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_49543..49548">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.vcg_of_RETURN|fact"><span class="entity_def" id="Sepref_Intf_Util.vcg_of_RETURN(2)|thm"><span class="entity_def" id="Sepref_Intf_Util.vcg_of_RETURN(1)|thm"><span>vcg_of_RETURN</span></span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="keyword1"><span>do</span></span><span> </span><span class="main"><span>{</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><span class="free"><span>Φ</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="free"><span>r</span></span><span> </span><span class="main"><span>}</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span class="free"><span>Φ</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span class="free"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>m</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>m</span></span><span>"</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span class="free"><span>Φ</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span class="free"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>m</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>m</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_49543..49548"><span>assms</span></a><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.pw_leof_iff|fact"><span>pw_leof_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_49778..49783">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.vcg_of_SPEC|fact"><span class="entity_def" id="Sepref_Intf_Util.vcg_of_SPEC(2)|thm"><span class="entity_def" id="Sepref_Intf_Util.vcg_of_SPEC(1)|thm"><span>vcg_of_SPEC</span></span></span></span><span class="main"><span>:</span></span><span>  
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="keyword1"><span>do</span></span><span> </span><span class="main"><span>{</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><span class="free"><span>pre</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="free"><span>post</span></span><span> </span><span class="main"><span>}</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span class="free"><span>pre</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="free"><span>post</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>m</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>m</span></span><span>"</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span class="free"><span>pre</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="free"><span>post</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>m</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>m</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_49778..49783"><span>assms</span></a><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.pw_leof_iff|fact"><span>pw_leof_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_50010..50015">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.vcg_of_SPEC_np|fact"><span class="entity_def" id="Sepref_Intf_Util.vcg_of_SPEC_np(2)|thm"><span class="entity_def" id="Sepref_Intf_Util.vcg_of_SPEC_np(1)|thm"><span>vcg_of_SPEC_np</span></span></span></span><span class="main"><span>:</span></span><span>  
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="free"><span>post</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="free"><span>post</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>m</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span> </span><span class="free"><span>m</span></span><span>"</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.SPEC|const"><span>SPEC</span></a><span> </span><span class="free"><span>post</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>m</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Leof.html#Refine_Leof.le_or_fail|const"><span>≤<span class="hidden">⇩</span><sub>n</sub></span></a></span><span> </span><span class="free"><span>m</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_50010..50015"><span>assms</span></a><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> 




  </span><span class="comment1"><span>(* Generate parametricity rules to generalize 
    plain operations to monadic ones. Use with FCOMP.
  *)</span></span><span>  
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_50279..50284">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl1|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl1|thm"><span>mk_mop_rl1</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="keyword1"><span>doN</span></span><span> </span><span class="main"><span>{</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.comp|const"><span>o</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="free"><span>mf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_50279..50284"><span>assms</span></a><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_50500..50505">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl2|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl2|thm"><span>mk_mop_rl2</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="keyword1"><span>doN</span></span><span> </span><span class="main"><span>{</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.comp2|const"><span>oo</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="free"><span>mf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_50500..50505"><span>assms</span></a><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_50735..50740">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl3|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl3|thm"><span>mk_mop_rl3</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="keyword1"><span>doN</span></span><span> </span><span class="main"><span>{</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.comp3|const"><span>ooo</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="free"><span>mf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_50735..50740"><span>assms</span></a><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_50984..50989">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl0_np|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl0_np|thm"><span>mk_mop_rl0_np</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>mf</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="free"><span>f</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="free"><span>mf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_50984..50989"><span>assms</span></a><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_51171..51176">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl1_np|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl1_np|thm"><span>mk_mop_rl1_np</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.comp|const"><span>o</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="free"><span>mf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_51171..51176"><span>assms</span></a><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_51375..51380">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl2_np|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl2_np|thm"><span>mk_mop_rl2_np</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.comp2|const"><span>oo</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="free"><span>mf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_51375..51380"><span>assms</span></a><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_51591..51596">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl3_np|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_mop_rl3_np|thm"><span>mk_mop_rl3_np</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.comp3|const"><span>ooo</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="free"><span>mf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_51591..51596"><span>assms</span></a><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>intro</span></span><span class="main"><span class="main"><span>!</span></span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.pw_le_iff|fact"><span>pw_le_iff</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.refine_pw_simps|fact"><span class="dynamic"><span class="dynamic"><span>refine_pw_simps</span></span></span></a><span class="main"><span>)</span></span><span>



  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_51821..51826">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl0_np|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl0_np|thm"><span>mk_op_rl0_np</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>mf</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="free"><span>f</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry0|const"><span>uncurry0</span></a><span> </span><span class="free"><span>mf</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry0|const"><span>uncurry0</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.unit_rel|const"><span>unit_rel</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.freftnd|const"><span>→<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>intro</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefI|fact"><span>frefI</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_51821..51826"><span>assms</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_52019..52024">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl1|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl1|thm"><span>mk_op_rl1</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="keyword1"><span>doN</span></span><span> </span><span class="main"><span>{</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>mf</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.comp|const"><span>o</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>[</span></a></span><span class="free"><span>P</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>]<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>intro</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefI|fact"><span>frefI</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_52019..52024"><span>assms</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_52224..52229">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl1_np|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl1_np|thm"><span>mk_op_rl1_np</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>mf</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.comp|const"><span>o</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.freftnd|const"><span>→<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>intro</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefI|fact"><span>frefI</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_52224..52229"><span>assms</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_52410..52415">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl2|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl2|thm"><span>mk_op_rl2</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="keyword1"><span>doN</span></span><span> </span><span class="main"><span>{</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry|const"><span>uncurry</span></a><span> </span><span class="free"><span>mf</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry|const"><span>uncurry</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.comp2|const"><span>oo</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>[</span></a></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry|const"><span>uncurry</span></a><span> </span><span class="free"><span>P</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>]<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.prod_rel_syn|const"><span>×<span class="hidden">⇩</span><sub>r</sub></span></a></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>intro</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefI|fact"><span>frefI</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_52410..52415"><span>assms</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_52655..52660">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl2_np|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl2_np|thm"><span>mk_op_rl2_np</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry|const"><span>uncurry</span></a><span> </span><span class="free"><span>mf</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.uncurry|const"><span>uncurry</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.comp2|const"><span>oo</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.prod_rel_syn|const"><span>×<span class="hidden">⇩</span><sub>r</sub></span></a></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.freftnd|const"><span>→<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>intro</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefI|fact"><span>frefI</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_52655..52660"><span>assms</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_52869..52874">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl3|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl3|thm"><span>mk_op_rl3</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="keyword1"><span>doN</span></span><span> </span><span class="main"><span>{</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.ASSERT|const"><span>ASSERT</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry2|const"><span>uncurry2</span></a><span> </span><span class="free"><span>mf</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry2|const"><span>uncurry2</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.comp3|const"><span>ooo</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>[</span></a></span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry2|const"><span>uncurry2</span></a><span> </span><span class="free"><span>P</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>]<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.prod_rel_syn|const"><span>×<span class="hidden">⇩</span><sub>r</sub></span></a></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>)</span></span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.prod_rel_syn|const"><span>×<span class="hidden">⇩</span><sub>r</sub></span></a></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="main"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefnd|const"><span>→</span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>intro</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefI|fact"><span>frefI</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_52869..52874"><span>assms</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_53133..53138">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl3_np|fact"><span class="entity_def" id="Sepref_Intf_Util.mk_op_rl3_np|thm"><span>mk_op_rl3_np</span></span></span><span class="main"><span>:</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>mf</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>y</span></span><span> </span><span class="bound"><span>z</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry2|const"><span>uncurry2</span></a><span> </span><span class="free"><span>mf</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="Sepref_Misc.html#Sepref_Misc.uncurry2|const"><span>uncurry2</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Misc.html#Misc.comp3|const"><span>ooo</span></a></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.prod_rel_syn|const"><span>×<span class="hidden">⇩</span><sub>r</sub></span></a></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>)</span></span><span class="keyword1"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.prod_rel_syn|const"><span>×<span class="hidden">⇩</span><sub>r</sub></span></a></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.freftnd|const"><span>→<span class="hidden">⇩</span><sub>f</sub></span></a></span><span> </span><span class="main"><span>⟨</span></span><a class="entity_ref" href="../../HOL/HOL/Relation.html#Relation.Id|const"><span>Id</span></a><span class="main"><span>⟩</span></span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_rel|const"><span>nres_rel</span></a><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>intro</span></span><span> </span><a class="entity_ref" href="Sepref_Rules.html#Sepref_Rules.frefI|fact"><span>frefI</span></a><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/Refine_Basic.html#Refine_Basic.nres_relI|fact"><span>nres_relI</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Intf_Util.html#offset_53133..53138"><span>assms</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>








</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>