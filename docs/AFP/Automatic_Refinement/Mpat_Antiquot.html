<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Mpat_Antiquot</title>
</head>


<body>
<div class="head">
<h1>Theory Mpat_Antiquot</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>section</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Matching-Pattern Antiquotation›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="Mpat_Antiquot.html"><span>Mpat_Antiquot</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> </span><a href="Refine_Util_Bootstrap1.html"><span>Refine_Util_Bootstrap1</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Mpat_Antiquot.arity_type_term_struct|fact"><span class="entity_def" id="Mpat_Antiquot.arity_type_term_struct|thm"><span class="entity_def" id="Mpat_Antiquot.arity_type_term_struct|axiom"><span>typedecl</span></span></span></span></span></span><span> </span><span class="entity_def" id="Mpat_Antiquot.term_struct|type"><span>term_struct</span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Mpat_Antiquot.arity_type_typ_struct|fact"><span class="entity_def" id="Mpat_Antiquot.arity_type_typ_struct|thm"><span class="entity_def" id="Mpat_Antiquot.arity_type_typ_struct|axiom"><span>typedecl</span></span></span></span></span></span><span> </span><span class="entity_def" id="Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Mpat_Antiquot.arity_type_sort|fact"><span class="entity_def" id="Mpat_Antiquot.arity_type_sort|thm"><span class="entity_def" id="Mpat_Antiquot.arity_type_sort|axiom"><span>typedecl</span></span></span></span></span></span><span> </span><span class="entity_def" id="Mpat_Antiquot.sort|type"><span>sort</span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Mpat_Antiquot.mpaq_AS_PAT_def|fact"><span class="entity_def" id="Mpat_Antiquot.mpaq_AS_PAT_def|thm"><span class="entity_def" id="Mpat_Antiquot.mpaq_AS_PAT_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Mpat_Antiquot.mpaq_AS_PAT|const"><span>mpaq_AS_PAT</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'a</span></span><span>"</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>infixl</span></span></span><span> </span><span class="quoted"><span>"</span><span class="keyword1"><span>AS<span class="hidden">⇩</span><sub>p</sub></span></span><span>"</span></span><span> 900</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="bound"><span class="entity"><span>a</span></span></span></span><span> </span><span class="keyword1"><span class="free"><span>AS<span class="hidden">⇩</span><sub>p</sub></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>s</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>a</span></span></span></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Mpat_Antiquot.mpaq_STRUCT_def|fact"><span class="entity_def" id="Mpat_Antiquot.mpaq_STRUCT_def|thm"><span class="entity_def" id="Mpat_Antiquot.mpaq_STRUCT_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Mpat_Antiquot.mpaq_STRUCT|const"><span>mpaq_STRUCT</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'a</span></span><span>"</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>mpaq_STRUCT</span></span><span> </span><span class="main"><span class="bound"><span class="entity"><span>_</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.undefined|const"><span>undefined</span></a><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="entity"><span class="entity_def" id="Mpat_Antiquot.mpaq_AS_STRUCT|const"><span>mpaq_AS_STRUCT</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'a</span></span><span>"</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>infixl</span></span></span><span> </span><span class="quoted"><span>"</span><span class="keyword1"><span>AS<span class="hidden">⇩</span><sub>s</sub></span></span><span>"</span></span><span> 900</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="bound"><span class="entity"><span>a</span></span></span></span><span> </span><span class="keyword1"><span class="free"><span>AS<span class="hidden">⇩</span><sub>s</sub></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>s</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>a</span></span></span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_AS_PAT|const"><span>AS<span class="hidden">⇩</span><sub>p</sub></span></a></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_STRUCT|const"><span>mpaq_STRUCT</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>s</span></span></span></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>consts</span></span></span><span>
  </span><span class="entity_def" id="Mpat_Antiquot.mpaq_Const|const"><span>mpaq_Const</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/String.html#String.string|type"><span>string</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span>"</span></span></span><span>
  </span><span class="entity_def" id="Mpat_Antiquot.mpaq_Free|const"><span>mpaq_Free</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/String.html#String.string|type"><span>string</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span>"</span></span></span><span>
  </span><span class="entity_def" id="Mpat_Antiquot.mpaq_Var|const"><span>mpaq_Var</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/String.html#String.string|type"><span>string</span></a><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>*</span></a></span><a class="entity_ref" href="../../HOL/HOL/Nat.html#Nat.nat|type"><span>nat</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span>"</span></span></span><span>
  </span><span class="entity_def" id="Mpat_Antiquot.mpaq_Bound|const"><span>mpaq_Bound</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/Nat.html#Nat.nat|type"><span>nat</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span>"</span></span></span><span>
  </span><span class="entity_def" id="Mpat_Antiquot.mpaq_Abs|const"><span>mpaq_Abs</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/String.html#String.string|type"><span>string</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span>"</span></span></span><span>
  </span><span class="entity_def" id="Mpat_Antiquot.mpaq_App|const"><span>mpaq_App</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span>"</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>infixl</span></span></span><span> </span><span class="quoted"><span>"</span><span class="keyword1"><span>$$</span></span><span>"</span></span><span> 900</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>consts</span></span></span><span>
  </span><span class="entity_def" id="Mpat_Antiquot.mpaq_TFree|const"><span>mpaq_TFree</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/String.html#String.string|type"><span>string</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.sort|type"><span>sort</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></a><span>"</span></span></span><span>
  </span><span class="entity_def" id="Mpat_Antiquot.mpaq_TVar|const"><span>mpaq_TVar</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/String.html#String.string|type"><span>string</span></a><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>*</span></a></span><a class="entity_ref" href="../../HOL/HOL/Nat.html#Nat.nat|type"><span>nat</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.sort|type"><span>sort</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></a><span>"</span></span></span><span>
  </span><span class="entity_def" id="Mpat_Antiquot.mpaq_Type|const"><span>mpaq_Type</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/String.html#String.string|type"><span>string</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/List.html#List.list|type"><span>list</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></a><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="comment1"><span>(*
    Antiquotation to generate a term-pattern in ML. 
    Features:
      * Schematic term variables are translated to ML-variables of same name.
      * Non-dummy variables in lambda-abstractions are bound to variables of 
        same name, and type of λx. t is bound to x_T
      * In (typs) mode, schematic type variables are translated if they start
        with 'v_, where the prefix is removed. Otherwise, types are completely
        ignored and translated to ML dummy pattern.
      * Dummy variables are translated to ML dummy patterns
      * Supports AS to define alternative pattern,
        and STRUCT to reflect term structure
  
    Limitations:
      * Non-linear patterns are not allowed, due to SML limitation.
        For term variables, it will result in an error. Type variables, 
        however, are silently linearized and only the first occurrence is bound.
      * Indexes &lt;&gt;0 on term variables are not allowed. 
        On type variables, such indexes are silently ignored.
      * Sorts are completely ignored
      * Due to the type-inference on patterns, only innermost types can be 
        bound to names.
      * Patterns are not localized. Currently, we issue an error if pattern
        contains free variables.

    TODO:
      * We could also bind the type of a term-var, where the name for the 
        type ML-var is encoded into the term-var name

    Examples: See below

  *)</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replace_dummy'</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><span>Pure.dummy_pattern</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_dummy_"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>replace_dummy'</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>replace_dummy'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>i</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>replace_dummy'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>replace_dummy'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>replace_dummy'</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>replace_dummy'</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_dummies'</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span class="entity"><span>replace_dummy'</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tcheck</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tnames</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_fold</span></span><span> </span><span class="entity"><span>tcheck</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>tnames</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
          </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tcheck</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Pattern contains free type variable: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tcheck</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tnames</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"'v_"</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tnames</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"'v_"</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span>::</span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tcheck</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>tnames</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Pattern contains free variable: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_dummy_"</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tcheck</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>tnames</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tcheck</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>tnames</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Variable index greater zero: "</span></span><span>
            </span><span>^</span><span> </span><span>Term.string_of_vname</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vnames</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Non-linear pattern: "</span></span><span>
            </span><span>^</span><span> </span><span>Term.string_of_vname</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span>::</span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"uu_"</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tcheck</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>tnames</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tcheck</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>tnames</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>vnames</span></span><span class="main"><span>,</span></span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>p</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>p</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.mode</span><span> </span><span class="inner_quoted"><span>"typs"</span></span><span> </span><span class="main"><span>)</span></span><span>
      </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>Args.context</span><span> </span><span>--</span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Parse.position</span><span> </span><span>Parse.embedded_inner_syntax</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>write</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>with_types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>twr_aux</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Type ("</span></span><span> </span><span>^</span><span> </span><span>ML_Syntax.print_string</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span>ML_Syntax.print_list</span><span> </span><span class="entity"><span>twr_aux</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>twr_aux</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"TFree ("</span></span><span> </span><span>^</span><span> </span><span>ML_Syntax.print_string</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", _)"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>twr_aux</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>twr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>with_types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>twr_aux</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_string</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_string</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_string</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ML_Syntax.print_string</span><span> </span><span class="entity"><span>s</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Expected var or string literal"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_index</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_index</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_nat</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ML_Syntax.print_int</span><span> </span><span class="entity"><span>n</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Expected var or nat literal"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_indexname</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_indexname</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>n</span></span><span>$</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_string</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_index</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_indexname</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Expected var or indexname-pair"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_TFree|const"><span>mpaq_TFree</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>name</span></span><span>$</span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> 
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"TFree ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_string</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_TVar|const"><span>mpaq_TVar</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>name</span></span><span>$</span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"TVar ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_indexname</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_Type|const"><span>mpaq_Type</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>name</span></span><span>$</span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Type ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_string</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_args</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Expected var or type structure"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>s_args</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_args</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_list</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ML_Syntax.print_list</span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="entity"><span>l</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Expected variable or type argument list"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_Const|const"><span>mpaq_Const</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>name</span></span><span>$</span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> 
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Const ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_string</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_Free|const"><span>mpaq_Free</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>name</span></span><span>$</span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Free ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_string</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_Var|const"><span>mpaq_Var</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>name</span></span><span>$</span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Var ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_indexname</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_Bound|const"><span>mpaq_Bound</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Bound "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_index</span></span><span> </span><span class="entity"><span>idx</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_Abs|const"><span>mpaq_Abs</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>name</span></span><span>$</span><span class="entity"><span>T</span></span><span>$</span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Abs ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_string</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s_typ</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_App|const"><span>mpaq_App</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>") $ ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>swr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Expected var or term structure"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
            </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Const ("</span></span><span> </span><span>^</span><span> </span><span>ML_Syntax.print_string</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>twr</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Free ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>twr</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Bound "</span></span><span> </span><span>^</span><span> </span><span>ML_Syntax.print_int</span><span> </span><span class="entity"><span>i</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Abs (_,"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>twr</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Abs ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>","</span></span><span> 
                </span><span>^</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_T as "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>twr</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>","</span></span><span> 
                </span><span>^</span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_STRUCT|const"><span>mpaq_STRUCT</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="entity"><span>swr</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> "</span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_AS_PAT|const"><span>mpaq_AS_PAT</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="entity"><span>t</span></span><span>$</span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" as ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_AS_ must have identifier on LHS"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>trm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>") $ ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vcheck</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vwr</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>with_types</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_t</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>Syntax_Phases.term_check</span><span> </span><span class="inner_numeral"><span>90</span></span><span> </span><span class="inner_quoted"><span>"Prepare dummies"</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>prepare_dummies'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.read_term_pattern</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>raw_t</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>write</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>with_types</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="comment1"><span>(*tracing res;*)</span></span><span>
      </span><span class="entity"><span>res</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span>Position.here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>


  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mpat_antiquot</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>process</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span>ML_Antiquotation.inline</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> "</span><span>mpat</span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mpat_antiquot</span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Examples›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>ML_val</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_pair_singleton</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>{</span></span><span class="main"><span>(</span></span><span class="var"><span>?a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_pair_singleton</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_pair_singleton"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_nat_pair_singleton</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="main"><span>(</span></span><span class="quasi_keyword"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>{</span></span><span class="main"><span>(</span></span><span class="var"><span>?a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../HOL/HOL/Nat.html#Nat.nat|type"><span>nat</span></a><span class="main"><span>,</span></span><span class="var"><span>?b</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../HOL/HOL/Nat.html#Nat.nat|type"><span>nat</span></a><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_nat_pair_singleton</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_nat_pair_singleton"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_pair_singleton_T</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="main"><span>(</span></span><span class="quasi_keyword"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>{</span></span><span class="main"><span>(</span></span><span class="var"><span>?a</span></span><span class="main"><span>::</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tvar"><span>?'v_Ta</span></span><span class="main"><span>,</span></span><span class="var"><span>?b</span></span><span class="main"><span>::</span></span><span class="tvar"><span>?'v_Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_pair_singleton_T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_pair_singleton_T"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_pair_lambda</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>{</span></span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>a</span></span><span> </span><span class="main"><span class="bound"><span>_</span></span></span><span> </span><span class="main"><span class="bound"><span>_</span></span></span><span class="main"><span>.</span></span><span> </span><span class="var"><span>?Ta</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>λ</span></span><span class="bound"><span>b</span></span><span class="main"><span>.</span></span><span> </span><span class="var"><span>?Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>a_T</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>b_T</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_pair_lambda</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_pair_lambda"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>


  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>foo</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>[</span></span><span class="var"><span>?a</span></span><span class="main"><span>,</span></span><span class="var"><span>?b</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_AS_STRUCT|const"><span>AS<span class="hidden">⇩</span><sub>s</sub></span></a></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_Bound|const"><span>mpaq_Bound</span></a><span> </span><span class="var"><span>?i</span></span><span class="main"><span>,</span></span><span class="var"><span>?c</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.mpaq_AS_PAT|const"><span>AS<span class="hidden">⇩</span><sub>p</sub></span></a></span><span> </span><span class="main"><span>[</span></span><span class="var"><span>?n</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>foo</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"foo"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>


›</span></span><span>

</span><span class="keyword1"><span class="command"><span>hide_type</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>open</span></span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.term_struct|type"><span>term_struct</span></a><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.typ_struct|type"><span>typ_struct</span></a><span> </span><a class="entity_ref" href="Mpat_Antiquot.html#Mpat_Antiquot.sort|type"><span>sort</span></a><span>


</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>