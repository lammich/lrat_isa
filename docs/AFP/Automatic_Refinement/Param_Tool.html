<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Param_Tool</title>
</head>


<body>
<div class="head">
<h1>Theory Param_Tool</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>section</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Basic Parametricity Reasoning›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="Param_Tool.html"><span>Param_Tool</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> </span><a href="Relators.html"><span>Relators</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Auxiliary Lemmas›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Param_Tool.tag_both|fact"><span class="entity_def" id="Param_Tool.tag_both|thm"><span>tag_both</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="free"><span>x'</span></span><span> </span><span class="free"><span>f'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>R</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><span class="free"><span>f'</span></span><span> </span><span class="free"><span>x'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>R</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Param_Tool.tag_rhs|fact"><span class="entity_def" id="Param_Tool.tag_rhs|thm"><span>tag_rhs</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>c</span></span><span class="main"><span>,</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>R</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>c</span></span><span class="main"><span>,</span></span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>R</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Param_Tool.tag_lhs|fact"><span class="entity_def" id="Param_Tool.tag_lhs|thm"><span>tag_lhs</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>R</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><span class="free"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>R</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Param_Tool.tagged_fun_relD_both|fact"><span class="entity_def" id="Param_Tool.tagged_fun_relD_both|thm"><span>tagged_fun_relD_both</span></span></span><span class="main"><span>:</span></span><span> 
    </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>f'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>A</span></span><span class="main"><a class="entity_ref" href="Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span class="free"><span>B</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><span class="free"><span>x'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>A</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="free"><span>x'</span></span><span> </span><span class="free"><span>f'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>B</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity_def" id="Param_Tool.tagged_fun_relD_rhs|fact"><span class="entity_def" id="Param_Tool.tagged_fun_relD_rhs|thm"><span>tagged_fun_relD_rhs</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>f'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>A</span></span><span class="main"><a class="entity_ref" href="Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span class="free"><span>B</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><span class="free"><span>x'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>A</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="free"><span>x'</span></span><span> </span><span class="free"><span>f'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>B</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity_def" id="Param_Tool.tagged_fun_relD_lhs|fact"><span class="entity_def" id="Param_Tool.tagged_fun_relD_lhs|thm"><span>tagged_fun_relD_lhs</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>f'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>A</span></span><span class="main"><a class="entity_ref" href="Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span class="free"><span>B</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><span class="free"><span>x'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>A</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>f'</span></span><span> </span><span class="free"><span>x'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>B</span></span><span>"</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity_def" id="Param_Tool.tagged_fun_relD_none|fact"><span class="entity_def" id="Param_Tool.tagged_fun_relD_none|thm"><span>tagged_fun_relD_none</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><span>,</span></span><span class="free"><span>f'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>A</span></span><span class="main"><a class="entity_ref" href="Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span class="free"><span>B</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><span class="free"><span>x'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>A</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><span class="free"><span>f'</span></span><span> </span><span class="free"><span>x'</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="free"><span>B</span></span><span>"</span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp_all</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Relators.html#Relators.fun_relD|fact"><span>fun_relD</span></a><span class="main"><span>)</span></span><span>


  </span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ML-Setup›</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
    </span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PARAMETRICITY</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>param_ruleT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
        lhs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
        rhs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
        R</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
        rhs_head</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
        arity</span><span class="main"><span>:</span></span><span> </span><span>int</span><span>
      </span><span class="main"><span>}</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_param_term</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_ruleT</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_param_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_ruleT</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_param_goal</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_ruleT</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> safe_fun_relD_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> adjust_arity</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> adjust_arity_tac</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unlambda_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fo_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

      </span><span class="comment1"><span>(*** Basic tactics ***)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> param_rule_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> param_rules_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> asm_param_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>


      </span><span class="comment1"><span>(*** Nets of parametricity rules ***)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>param_net</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> net_empty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>param_net</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> net_add</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_net</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_net</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> net_del</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_net</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_net</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> net_add_int</span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_net</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_net</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> net_del_int</span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_net</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_net</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> net_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>param_net</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
    
      </span><span class="comment1"><span>(*** Default parametricity rules ***)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_dflt</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_dflt_attr</span><span class="main"><span>:</span></span><span> </span><span>attribute</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_dflt</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_dflt_attr</span><span class="main"><span>:</span></span><span> </span><span>attribute</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_dflt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>param_net</span></span><span>

      </span><span class="comment1"><span>(** Configuration **)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cfg_use_asm</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cfg_single_step</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>

      </span><span class="comment1"><span>(** Setup **)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> setup</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Parametricity</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PARAMETRICITY</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>param_ruleT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
        lhs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
        rhs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
        R</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
        rhs_head</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
        arity</span><span class="main"><span>:</span></span><span> </span><span>int</span><span>
      </span><span class="main"><span>}</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_param_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> 
          </span><span>strip_all_body</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Logic.strip_imp_concl</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="var"><span>?lhs</span></span><span class="main"><span>,</span></span><span class="var"><span>?rhs</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>:</span></a></span><span class="var"><span>?R</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs_head</span></span><span class="main"><span>,</span></span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span>length</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span>length</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span>length</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_param_term: Head"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
            </span><span class="main"><span>{</span></span><span> lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> rhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> R</span><span class="main"><span>=</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> rhs_head </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhs_head</span></span><span class="main"><span>,</span></span><span> arity </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>}</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_param_term: Expected (_,_):_"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest_param_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_param_term</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_param_goal</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;</span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_param_goal"</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>st</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>dest_param_term</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.concl_of_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>


      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>safe_fun_relD_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fo_resolve_tac</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>a</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="entity"><span>t</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Param_Tool.html#Param_Tool.tag_both|fact"><span>tag_both</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Param_Tool.html#Param_Tool.tagged_fun_relD_both|fact"><span>tagged_fun_relD_both</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>ORELSE'</span><span>
          </span><span class="entity"><span>t</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Param_Tool.html#Param_Tool.tag_rhs|fact"><span>tag_rhs</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Param_Tool.html#Param_Tool.tagged_fun_relD_rhs|fact"><span>tagged_fun_relD_rhs</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>ORELSE'</span><span>
          </span><span class="entity"><span>t</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Param_Tool.html#Param_Tool.tag_lhs|fact"><span>tag_lhs</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Param_Tool.html#Param_Tool.tagged_fun_relD_lhs|fact"><span>tagged_fun_relD_lhs</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>ORELSE'</span><span>
          </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Param_Tool.html#Param_Tool.tagged_fun_relD_none|fact"><span>tagged_fun_relD_none</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adjust_arity</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span>&lt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>funpow</span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Relators.html#Relators.fun_relI|fact"><span>fun_relI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>funpow</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Relators.html#Relators.fun_relD|fact"><span>fun_relD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>NTIMES</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>K</span><span> </span><span>all_tac</span><span> 
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>NTIMES</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tac</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adjust_arity_tac</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>K</span><span> </span><span>all_tac</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span>&gt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>NTIMES</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Relators.html#Relators.fun_relI|fact"><span>fun_relI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>NTIMES</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_fun_relD_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unlambda_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_param_goal</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.empty</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rhs_head </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>|&gt;</span><span> </span><span>length</span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>NTIMES</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Relators.html#Relators.fun_relI|fact"><span>fun_relI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>Subgoal.FOCUS</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>PRIMITIVE</span><span> </span><span class="main"><span>(</span></span><span>Drule.eta_contraction_rule</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span>THEN'</span><span> </span><span class="entity"><span>unlambda_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>


      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>could_param_rl</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;</span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_param_goal</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>,</span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_param_term</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_unify</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rhs_head </span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>rhs_head </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>arity </span><span class="entity"><span>r</span></span><span> </span><span>-</span><span> </span><span class="main"><span>#</span></span><span>arity </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>param_rule_tac_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>could_param_rl</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>adj</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>adjust_arity_tac</span></span><span> </span><span class="entity"><span>adj</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.empty</span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>param_rule_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>prepare_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>param_rule_tac_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>param_rules_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>prepare_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span>FIRST'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_rule_tac_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>asm_param_tac_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;</span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Seq.empty</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.prems_of_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>|&gt;</span><span> </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>could_param_rl</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>adj</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>adjust_arity_tac</span></span><span> </span><span class="entity"><span>adj</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>rprem_tac</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.empty</span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>FIRST'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>asm_param_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prepare_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>asm_param_tac_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>param_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_ruleT</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Item_Net.T</span><span>

      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_get_key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>rhs_head </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net_empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.init</span><span> </span><span class="main"><span>(</span></span><span>Thm.eq_thm</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_get_key</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wrap_pr_op</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>dest_param_rule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Ignoring invalid parametricity theorem: "</span></span><span>
              </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>warning</span><span> </span><span class="entity"><span>msg</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>p</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net_add_int</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wrap_pr_op</span></span><span> </span><span>Item_Net.update</span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net_del_int</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wrap_pr_op</span></span><span> </span><span>Item_Net.remove</span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net_add</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.update</span><span> </span><span>o</span><span> </span><span>`</span><span class="entity"><span>dest_param_rule</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net_del</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.remove</span><span> </span><span>o</span><span> </span><span>`</span><span class="entity"><span>dest_param_rule</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>net_tac_aux</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;</span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
          </span><span>Seq.empty</span><span> 
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_param_goal</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.retrieve</span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rhs_head </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span>
        
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span class="entity"><span>adjust_arity_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>arity </span><span class="entity"><span>r</span></span><span> </span><span>-</span><span> </span><span class="main"><span>#</span></span><span>arity </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
              </span><span>THEN'</span><span> </span><span>DETERM</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
            </span><span>FIRST'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>rls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>net_tac</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prepare_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>net_tac_aux</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>dflt_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>param_net</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>net_empty</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span>
      </span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_dflt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dflt_rules.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>net_add_int</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_dflt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dflt_rules.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>net_del_int</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_dflt_attr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>add_dflt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>del_dflt_attr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>del_dflt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_dflt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dflt_rules.get</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_use_asm</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Param_Tool.param_use_asm|attribute"><span>param_use_asm</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_single_step</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Param_Tool.param_single_step|attribute"><span>param_single_step</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Refine_Util</span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span>Args.add</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>add_dflt_attr</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span>Args.del</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>del_dflt_attr</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"only"</span></span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> </span><span>&gt;&gt;</span><span>
            </span><span>K</span><span> </span><span class="main"><span>{</span></span><span>init </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>dflt_rules.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>net_empty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                attribute </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_dflt_attr</span></span><span class="main"><span>,</span></span><span> pos </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>}</span></span><span class="main"><span>]</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_flags</span></span><span> </span><span class="main"><span>=</span></span><span> 
           </span><span class="entity"><span>parse_bool_config</span></span><span> </span><span class="inner_quoted"><span>"use_asm"</span></span><span> </span><span class="entity"><span>cfg_use_asm</span></span><span>
        </span><span>||</span><span> </span><span class="entity"><span>parse_bool_config</span></span><span> </span><span class="inner_quoted"><span>"single_step"</span></span><span> </span><span class="entity"><span>cfg_single_step</span></span><span>

      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parametricity_method</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="entity"><span>parse_paren_lists</span></span><span> </span><span class="entity"><span>param_flags</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>Method.sections</span></span><span> </span><span class="entity"><span>param_modifiers</span></span><span> </span><span>&gt;&gt;</span><span> 
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_dflt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>asm_tac</span></span><span> </span><span class="main"><span>=</span></span><span> 
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_use_asm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
                  </span><span class="entity"><span>asm_param_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span>no_tac</span><span>
   
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RPT</span></span><span> </span><span class="main"><span>=</span></span><span> 
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_single_step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>REPEAT_ALL_NEW_FWD</span></span><span>
  
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span>
                </span><span class="entity"><span>RPT</span></span><span> </span><span class="main"><span>(</span></span><span>
                  </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> 
                    </span><span>ORELSE'</span><span> </span><span class="entity"><span>net_tac</span></span><span> </span><span class="entity"><span>net2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span>ORELSE'</span><span> </span><span class="entity"><span>asm_tac</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>)</span></span><span> 
              </span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fo_rule</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fo_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Relators.html#Relators.fun_relD|fact"><span>fun_relD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> 
          
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_fo_attr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span>Thm.rule_attribute</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>fo_rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Param_Tool.param|attribute"><span>param</span></span><span class="antiquote"><span>}</span></span></span></span><span> 
            </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.add_del</span></span><span> </span><span class="entity"><span>add_dflt_attr</span></span><span> </span><span class="entity"><span>del_dflt_attr</span></span><span class="main"><span>)</span></span><span>
            </span><span class="inner_quoted"><span>"declaration of parametricity theorem"</span></span><span>
        </span><span>#&gt;</span><span> </span><span>Global_Theory.add_thms_dynamic</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Param_Tool.param|fact"><span>param</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> 
             </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>o</span><span> </span><span>Item_Net.content</span><span> </span><span>o</span><span> </span><span>dflt_rules.get</span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Param_Tool.parametricity|method"><span>parametricity</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>parametricity_method</span></span><span> 
             </span><span class="inner_quoted"><span>"Parametricity solver"</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Param_Tool.param_fo|attribute"><span>param_fo</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>param_fo_attr</span></span><span> 
             </span><span class="inner_quoted"><span>"Parametricity: Rule in first-order form"</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>

  </span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="entity"><span>Parametricity.setup</span></span><span>



  </span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Convenience Tools›</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
    </span><span class="comment1"><span>(* Prefix p_ or wrong type supresses generation of relAPP *)</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cnv_relAPP</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"p_"</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>false</span><span>   
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>Type</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span>Type</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>consider</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_rcomb</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span>$</span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>consider</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span>::</span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>x</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stripc</span></span><span>  </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>x</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>stripc</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_rcomb</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span class="entity"><span>Relators.list_relAPP</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>f</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_relAPP_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Util.f_tac_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
      </span><span class="entity"><span>cnv_relAPP</span></span><span> 
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_tac</span></span><span> 
        </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Relators.html#Relators.relAPP_def|fact"><span>relAPP_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>to_relAPP_attr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.rule_attribute</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg1_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_relAPP_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
›</span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>attribute_setup</span></span></span><span> </span><span class="entity_def" id="Param_Tool.to_relAPP|attribute"><span>to_relAPP</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_relAPP_attr</span></span><span class="main"><span>)</span></span><span>›</span></span><span> 
    </span><span class="quoted"><span>"Convert relator definition to prefix-form"</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>