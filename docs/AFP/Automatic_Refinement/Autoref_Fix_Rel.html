<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Autoref_Fix_Rel</title>
</head>


<body>
<div class="head">
<h1>Theory Autoref_Fix_Rel</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>section</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Relator Fixing›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="Autoref_Fix_Rel.html"><span>Autoref_Fix_Rel</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> </span><a href="Autoref_Id_Ops.html"><span>Autoref_Id_Ops</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>ML_val</span></span></span><span> </span><span class="quoted"><span>"</span><span class="inner_numeral"><span>2</span></span><span> </span><span>upto</span><span> </span><span class="inner_numeral"><span>5</span></span><span>"</span></span><span>

</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Priority tags›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  Priority tags are used to influence the ordering of refinement theorems.
  A priority tag defines two numeric priorities, a major and a minor priority.
  The major priority is considered first, the minor priority last, i.e., after
  the homogenity and relator-priority criteria.
  The default value for both priorities is 0.
›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Autoref_Fix_Rel.PRIO_TAG_def|fact"><span class="entity_def" id="Autoref_Fix_Rel.PRIO_TAG_def|thm"><span class="entity_def" id="Autoref_Fix_Rel.PRIO_TAG_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Autoref_Fix_Rel.PRIO_TAG|const"><span>PRIO_TAG</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PRIO_TAG</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>ma</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>mi</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.PRIO_TAGI|fact"><span class="entity_def" id="Autoref_Fix_Rel.PRIO_TAGI|thm"><span>PRIO_TAGI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.PRIO_TAG|const"><span>PRIO_TAG</span></a><span> </span><span class="free"><span>ma</span></span><span> </span><span class="free"><span>mi</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Autoref_Fix_Rel.MAJOR_PRIO_TAG|const"><span>MAJOR_PRIO_TAG</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>i</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.PRIO_TAG|const"><span>PRIO_TAG</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>i</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Autoref_Fix_Rel.MINOR_PRIO_TAG|const"><span>MINOR_PRIO_TAG</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>i</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.PRIO_TAG|const"><span>PRIO_TAG</span></a><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>i</span></span></span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Autoref_Fix_Rel.DFLT_PRIO_TAG|const"><span>DFLT_PRIO_TAG</span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.PRIO_TAG|const"><span>PRIO_TAG</span></a><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Some standard tags›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Autoref_Fix_Rel.PRIO_TAG_OPTIMIZATION|const"><span>PRIO_TAG_OPTIMIZATION</span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.MINOR_PRIO_TAG|const"><span>MINOR_PRIO_TAG</span></a><span> </span><span class="numeral"><span>10</span></span><span>"</span></span></span><span>
  </span><span class="comment1"><span>― ‹Optimized version of an algorithm, with additional side-conditions›</span></span><span>
</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Autoref_Fix_Rel.PRIO_TAG_GEN_ALGO|const"><span>PRIO_TAG_GEN_ALGO</span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.MINOR_PRIO_TAG|const"><span>MINOR_PRIO_TAG</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.uminus_class.uminus|const"><span>-</span></a></span><span> </span><span class="numeral"><span>10</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="comment1"><span>― ‹Generic algorithm, considered to be less efficient than default algorithm›</span></span><span>


</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Solving Relator Constraints›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  In this phase, we try to instantiate the annotated relators, using
  the available refinement rules.
›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Autoref_Fix_Rel.CONSTRAINT_def|fact"><span class="entity_def" id="Autoref_Fix_Rel.CONSTRAINT_def|thm"><span class="entity_def" id="Autoref_Fix_Rel.CONSTRAINT_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Autoref_Fix_Rel.CONSTRAINT|const"><span>CONSTRAINT</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="main"><span>(</span></span><span class="tfree"><span>'c</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>CONSTRAINT</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>f</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>R</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.CONSTRAINTI|fact"><span class="entity_def" id="Autoref_Fix_Rel.CONSTRAINTI|thm"><span>CONSTRAINTI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>R</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Autoref_Rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Thms</span></span><span> </span><span class="main"><span>(</span></span><span> 
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.autoref_rules_raw|attribute"><span class="entity_def" id="Autoref_Fix_Rel.autoref_rules_raw|fact"><span>autoref_rules_raw</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Refinement Framework: "</span></span><span> </span><span>^</span><span>
        </span><span class="inner_quoted"><span>"Automatic refinement rules"</span></span><span> 
  </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
›</span></span><span>
</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="entity"><span>Autoref_Rules.setup</span></span><span>


</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Generic algorithm tags have to be defined here, as we need them for
  relator fixing !›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Autoref_Fix_Rel.PREFER_tag_def|fact"><span class="entity_def" id="Autoref_Fix_Rel.PREFER_tag_def|thm"><span class="entity_def" id="Autoref_Fix_Rel.PREFER_tag_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Autoref_Fix_Rel.PREFER_tag|const"><span>PREFER_tag</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.autoref_tag_defs|attribute"><span class="operator"><span>autoref_tag_defs</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PREFER_tag</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Autoref_Fix_Rel.DEFER_tag_def|fact"><span class="entity_def" id="Autoref_Fix_Rel.DEFER_tag_def|thm"><span class="entity_def" id="Autoref_Fix_Rel.DEFER_tag_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Autoref_Fix_Rel.DEFER_tag|const"><span>DEFER_tag</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.autoref_tag_defs|attribute"><span class="operator"><span>autoref_tag_defs</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>DEFER_tag</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.PREFER_tagI|fact"><span class="entity_def" id="Autoref_Fix_Rel.PREFER_tagI|thm"><span>PREFER_tagI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.PREFER_tag|const"><span>PREFER_tag</span></a><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.DEFER_tagI|fact"><span class="entity_def" id="Autoref_Fix_Rel.DEFER_tagI|thm"><span>DEFER_tagI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.DEFER_tag|const"><span>DEFER_tag</span></a><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.SIDEI|fact"><span class="entity_def" id="Autoref_Fix_Rel.SIDEI(2)|thm"><span class="entity_def" id="Autoref_Fix_Rel.SIDEI(1)|thm"><span>SIDEI</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.PREFER_tagI|fact"><span>PREFER_tagI</span></a><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.DEFER_tagI|fact"><span>DEFER_tagI</span></a><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Autoref_Fix_Rel.GEN_OP_tag_def|fact"><span class="entity_def" id="Autoref_Fix_Rel.GEN_OP_tag_def|thm"><span class="entity_def" id="Autoref_Fix_Rel.GEN_OP_tag_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.autoref_tag_defs|attribute"><span class="operator"><span>autoref_tag_defs</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Autoref_Fix_Rel.GEN_OP_tag|const"><span>GEN_OP_tag</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="main"><span>==</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.GEN_OP_tagI|fact"><span class="entity_def" id="Autoref_Fix_Rel.GEN_OP_tagI|thm"><span>GEN_OP_tagI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><span>==&gt;</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.GEN_OP_tag|const"><span>GEN_OP_tag</span></a><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Autoref_Fix_Rel.SIDE_GEN_OP|const"><span>SIDE_GEN_OP</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="main"><span>==</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.PREFER_tag|const"><span>PREFER_tag</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.GEN_OP_tag|const"><span>GEN_OP_tag</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Shortcut for assuming an operation in a generic algorithm lemma›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Autoref_Fix_Rel.GEN_OP|const"><span>GEN_OP</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>c</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>a</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>R</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.SIDE_GEN_OP|const"><span>SIDE_GEN_OP</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="free"><span class="bound"><span class="entity"><span>c</span></span></span></span><span class="main"><span>,</span></span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.OP|const"><span>OP</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>a</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.rel_ANNOT|const"><span>:::</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>R</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>R</span></span></span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>


</span><span class="keyword1"><span class="command"><span class="entity_def" id="Autoref_Fix_Rel.TYREL_def|fact"><span class="entity_def" id="Autoref_Fix_Rel.TYREL_def|thm"><span class="entity_def" id="Autoref_Fix_Rel.TYREL_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Autoref_Fix_Rel.TYREL|const"><span>TYREL</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>TYREL</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>R</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Autoref_Fix_Rel.TYREL_DOMAIN_def|fact"><span class="entity_def" id="Autoref_Fix_Rel.TYREL_DOMAIN_def|thm"><span class="entity_def" id="Autoref_Fix_Rel.TYREL_DOMAIN_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Autoref_Fix_Rel.TYREL_DOMAIN|const"><span>TYREL_DOMAIN</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="tfree"><span>'a</span></span><span> </span><span>itself</span><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>TYREL_DOMAIN</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>i</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.TYREL_RES|fact"><span class="entity_def" id="Autoref_Fix_Rel.TYREL_RES|thm"><span>TYREL_RES</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL_DOMAIN|const"><span>TYREL_DOMAIN</span></a><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL|const"><span>TYREL</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>R</span></span><span class="main"><span>::</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL|const"><span>TYREL</span></a><span> </span><span class="free"><span>R</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>.</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.DOMAIN_OF_TYREL|fact"><span class="entity_def" id="Autoref_Fix_Rel.DOMAIN_OF_TYREL|thm"><span>DOMAIN_OF_TYREL</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL|const"><span>TYREL</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>R</span></span><span class="main"><span>::</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span class="main"><span>)</span></span><span> 
  </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL_DOMAIN|const"><span>TYREL_DOMAIN</span></a><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.TYRELI|fact"><span class="entity_def" id="Autoref_Fix_Rel.TYRELI|thm"><span>TYRELI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL|const"><span>TYREL</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>R</span></span><span class="main"><span>::</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.ty_REL|fact"><span class="entity_def" id="Autoref_Fix_Rel.ty_REL|thm"><span>ty_REL</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL|const"><span>TYREL</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>R</span></span><span class="main"><span>::</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>


</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
  
  </span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>AUTOREF_FIX_REL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>constraint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>thm_pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constraint</span></span><span> </span><span>option</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> 
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>hom_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> thm_pairsD_init</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> thm_pairsD_get</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>thm_pairs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> constraints_of_term</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> constraints_of_goal</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_CONSTRAINT</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> 
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_CONSTRAINT_rl</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>constraint</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> insert_CONSTRAINTS_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> constraint_of_thm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>constraint</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>prio_relpos</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>PR_FIRST</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PR_LAST</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PR_BEFORE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PR_AFTER</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> declare_prio</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>prio_relpos</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> delete_prio</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> print_prios</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> compute_hom_net</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>thm_pairs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>hom_net</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_hom_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_hom_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_hom_rules</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_tyrel_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_tyrel_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_tyrel_rules</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>


    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> insert_tyrel_tac </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> solve_tyrel_tac </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tyrel_tac </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itactic</span></span><span>


    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> internal_hom_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itactic</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> internal_spec_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itactic</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> internal_solve_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itactic</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_relators_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itactic</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_constraint</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>constraint</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_constraints</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>constraint</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_thm_pair</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constraint</span></span><span> </span><span>option</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_thm_pairs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>thm_pairs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> analyze</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_failure</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> try_solve_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> solve_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> phase</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Autoref_Phases.phase</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> setup</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Autoref_Fix_Rel</span></span><span> </span><span class="main"><span>:</span></span><span class="entity"><span>AUTOREF_FIX_REL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>constraint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>thm_pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constraint</span></span><span> </span><span>option</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> 
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>hom_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span>


    </span><span class="comment1"><span>(*********************)</span></span><span>
    </span><span class="comment1"><span>(*    Constraints    *)</span></span><span>
    </span><span class="comment1"><span>(*********************)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fix_loose_bvars</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.is_open</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>env</span></span><span> 
              </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>":"</span></span><span>^</span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.OP|const"><span>OP</span></a><span> </span><span class="var"><span>?f</span></span><span> </span><span class="main"><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.rel_ANNOT|const"><span>:::</span></a></span><span> </span><span class="var"><span>?R</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="main"><span>(</span></span><span> </span><span>Term.is_open</span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Loose bvar in relator"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>fix_loose_bvars</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="var"><span>?f</span></span><span> </span><span class="main"><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.rel_ANNOT|const"><span>:::</span></a></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>f</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="var"><span>?f</span></span><span class="main"><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>$</span></a></span><span class="var"><span>?x</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> 
          </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>f</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.PROTECT|const"><span>PROTECT</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.PROTECT|const"><span>PROTECT</span></a><span> </span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span><span> 
          </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>x_T</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.PROTECT|const"><span>PROTECT</span></a><span> </span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.PROTECT|const"><span>PROTECT</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"constraints_of_term"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constraints_of_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constraints</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constraints_of_goal</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.concl_of_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="var"><span>?a</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>constraints_of_term</span></span><span> </span><span class="entity"><span>a</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"constraints_of_goal"</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>st</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>


    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_CONSTRAINT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>R</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINT|const"><span>CONSTRAINT</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="entity"><span>fT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>RT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span>
        </span><span>$</span><span class="entity"><span>f</span></span><span>$</span><span class="entity"><span>R</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span class="entity"><span>res</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* Types of f and R must match! *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_CONSTRAINT_rl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_CONSTRAINT</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_CONSTRAINT</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>g</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINTI|fact"><span>CONSTRAINTI</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* Internal use for hom-patterns, f and R are unified *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_CONSTRAINT_rl_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.maxidx_term</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span>infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.incr_indexes</span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINTI|fact"><span>CONSTRAINTI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_CONSTRAINTS_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constraints_of_goal</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> 
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_CONSTRAINT</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>#&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Refine_Util.insert_subgoals_tac</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constraint_of_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>NO_REL</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>term</span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Autoref_Tagging</span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_entry</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.strip_imp_concl</span><span> </span><span class="main"><span>(</span></span><span>strip_all_body</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="var"><span>?f</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_app</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>relator_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="comment1"><span>(*val _ = tracing (Syntax.string_of_term @{context} t)*)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_all_body</span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="var"><span>?R</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_app</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
              </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.OP|const"><span>OP</span></a><span> </span><span class="var"><span>?f</span></span><span class="main"><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.rel_ANNOT|const"><span>:::</span></a></span><span class="var"><span>?rel</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="entity"><span>extract_entry</span></span><span> </span><span class="entity"><span>prems</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_rel</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>=</span></span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rels</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relator_of</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NO_REL</span></span><span> </span><span class="entity"><span>t</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>argrels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>find_rel</span></span><span> </span><span class="entity"><span>args</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>Relators.mk_fun_rel</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>argrels</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"constraint_of_thm: Invalid concl"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>relator_of</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> 
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>exc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NO_REL</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="inner_quoted"><span>"Could not infer unique higher-order relator for "</span></span><span>
            </span><span>^</span><span> </span><span class="inner_quoted"><span>"refinement rule: \n"</span></span><span>
            </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span>
            </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n for argument: "</span></span><span> 
            </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> 
          </span><span>Exn.reraise</span><span> </span><span class="entity"><span>exc</span></span><span class="main"><span>)</span></span><span>

      </span><span class="comment1"><span>(* Extract GEN_OP-tags *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> 
        </span><span class="entity"><span>genop_cs</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.SIDE_GEN_OP|const"><span>SIDE_GEN_OP</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.OP|const"><span>OP</span></a><span> </span><span class="var"><span>?f</span></span><span> </span><span class="main"><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.rel_ANNOT|const"><span>:::</span></a></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span> </span><span class="var"><span>?R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_Var</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>genop_cs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen_ops</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prems_of</span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="entity"><span>genop_cs</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>gen_ops</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="comment1"><span>(*********************)</span></span><span>
    </span><span class="comment1"><span>(*    Priorities     *)</span></span><span>
    </span><span class="comment1"><span>(*********************)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Rel_Prio_List</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prio_List</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>item</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> * </span><span>term</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span> 
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Rel_Prio</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rel_Prio_List.T</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rel_Prio_List.empty</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rel_Prio_List.merge</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_rel_prio</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
      </span><span>Pretty.str</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>":"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
      </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_prios</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rpl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Rel_Prio.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_rel_prio</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rpl</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"Relator Priorities"</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span>
      </span><span>|&gt;</span><span> </span><span>warning</span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>prio_relpos</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>PR_FIRST</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PR_LAST</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PR_BEFORE</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PR_AFTER</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_prio</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>pat0</span></span><span> </span><span class="entity"><span>relpos</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.cert_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>pat0</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export_terms</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.augment</span><span> </span><span class="entity"><span>pat1</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pervasive </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pos </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>}</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>item</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>pat2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>Rel_Prio.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rpl</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>relpos</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="entity"><span>PR_FIRST</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Rel_Prio_List.add_first</span></span><span> </span><span class="entity"><span>rpl</span></span><span> </span><span class="entity"><span>item</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PR_LAST</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Rel_Prio_List.add_last</span></span><span> </span><span class="entity"><span>rpl</span></span><span> </span><span class="entity"><span>item</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PR_BEFORE</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Rel_Prio_List.add_before</span></span><span> </span><span class="entity"><span>rpl</span></span><span> </span><span class="entity"><span>item</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span>Term.dummy</span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PR_AFTER</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Rel_Prio_List.add_after</span></span><span> </span><span class="entity"><span>rpl</span></span><span> </span><span class="entity"><span>item</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span>Term.dummy</span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>delete_prio</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pervasive </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> pos </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Rel_Prio.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rel_Prio_List.delete</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Term.dummy</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>relators_of</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="var"><span>?R1.0</span></span><span class="main"><a class="entity_ref" href="Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span class="var"><span>?R2.0</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>R2</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>Refine_Util.anorm_term</span></span><span> </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_prio_tag</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.PRIO_TAG|const"><span>PRIO_TAG</span></a><span> </span><span class="var"><span>?ma</span></span><span> </span><span class="var"><span>?mi</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> 
            </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_number</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ma</span></span><span class="main"><span>,</span></span><span class="entity"><span>mi</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_prio_tag</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_prio_tag"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_tagged_prios</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prems_of</span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prem</span></span><span>::</span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_prio_tag</span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>prems</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>p</span></span><span>
            </span><span class="main"><span>)</span></span><span> 

      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>prems</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prio_order_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>relators_of</span></span><span> </span><span class="entity"><span>R</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>rels</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>major_prio</span></span><span class="main"><span>,</span></span><span class="entity"><span>minor_prio</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_tagged_prios</span></span><span> </span><span class="entity"><span>thm</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rpl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Rel_Prio.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pattern.matches</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prefer</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>p1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span class="entity"><span>p1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prio_of</span></span><span> </span><span class="entity"><span>R</span></span><span> 
            </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rel_Prio_List.prio_of</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>matches</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefer</span></span><span> </span><span class="entity"><span>rpl</span></span><span> 
              </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prio</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prio_of</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rels</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>major_prio</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hom</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>prio</span></span><span class="main"><span>,</span></span><span class="entity"><span>minor_prio</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prio_order_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prio_order</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span>prod_ord</span><span>
          </span><span class="main"><span>(</span></span><span>rev_order</span><span> </span><span>o</span><span> </span><span>int_ord</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>prod_ord</span><span> 
            </span><span>int_ord</span><span>
            </span><span class="main"><span>(</span></span><span>prod_ord</span><span> </span><span class="main"><span>(</span></span><span>rev_order</span><span> </span><span>o</span><span> </span><span>int_ord</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>rev_order</span><span> </span><span>o</span><span> </span><span>int_ord</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>annotate_thm_pair</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Autoref_Tagging</span><span>  </span><span>Conv</span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>warn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Error annotating refinement theorem: "</span></span><span>
            </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="main"><span>)</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R_cert</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>R</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cnv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.OP|const"><span>OP</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.rel_ANNOT|const"><span>:::</span></a></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>all_conv</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.OP|const"><span>OP</span></a><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_rel_ANNOT_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>R_cert</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>_</span></span><span> </span><span class="main"><a class="entity_ref" href="Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>$</span></a></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>arg1_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cnv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_OP_conv</span></span><span> </span><span>then_conv</span><span> </span><span class="entity"><span>mk_rel_ANNOT_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>R_cert</span></span><span>

          </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>

          </span><span class="comment1"><span>(*val _ = tracing ("ANNOT: " ^ @{make_string} thm)*)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs_conv</span></span><span> </span><span class="entity"><span>cnv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs_conv</span></span><span> </span><span class="entity"><span>cnv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>warn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>
          </span><span class="comment1"><span>(*val _ = tracing ("RES: " ^ @{make_string} thm)*)</span></span><span>

        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>annotate_thm_pair</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compute_thm_pairs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Autoref_Rules.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_o</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prio_order_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rules</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constraint_of_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>add_o</span></span><span> 
          </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prio_order</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>npairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>is_none</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>spairs</span></span><span>@</span><span class="entity"><span>npairs</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>annotate_thm_pair</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>thm_pairsD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Autoref_Data</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compute</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compute_thm_pairs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prereq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm_pairsD_init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairsD.init</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm_pairsD_get</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairsD.get</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>hom_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Sorted_Thms</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.autoref_hom|attribute"><span class="entity_def" id="Autoref_Fix_Rel.autoref_hom|fact"><span>autoref_hom</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Autoref: Homogenity rules"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transform</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid homogenity rule"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_hom_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hom_rules.add_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>del_hom_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hom_rules.del_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_hom_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hom_rules.get</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Relators</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> 
        </span><span class="entity"><span>repl</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="var"><span>?R</span></span><span class="main"><a class="entity_ref" href="Relators.html#Relators.fun_rel_syn|const"><span>→</span></a></span><span class="var"><span>?S</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repl</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>ctab</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repl</span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="entity"><span>ctab</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_fun_rel</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repl</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_relAPP</span></span><span> </span><span class="entity"><span>R</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>repl</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>ctab</span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctab</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Termtab.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>R</span></span><span> </span><span>|&gt;</span><span> </span><span>strip_type</span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> 
                </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_prodT</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cT</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span>Variable.invent_types</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>sort</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.type|class"><span>type</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>cT</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>args</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cT</span></span><span class="main"><span>,</span></span><span class="entity"><span>aT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R'</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="inner_quoted"><span>"R"</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>list_relAPP</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R'</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R'</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
          </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>   
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hom_pat_of_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repl</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>Termtab.empty</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export_terms</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>Refine_Util.anorm_term</span></span><span> </span><span class="entity"><span>R</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compute_hom_net</span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>hom_pat_of_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_hom_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_CONSTRAINT_rl_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs'</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span>#&gt;</span><span> </span><span>Thm.trivial</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Tactic.build_net</span><span> </span><span class="entity"><span>thms</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>net</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>hom_netD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Autoref_Data</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hom_net</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compute</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compute_hom_net</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm_pairsD.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prereq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span> </span><span class="entity"><span>thm_pairsD.init</span></span><span> </span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>tyrel_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Sorted_Thms</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Autoref_Fix_Rel.autoref_tyrel|attribute"><span class="entity_def" id="Autoref_Fix_Rel.autoref_tyrel|fact"><span>autoref_tyrel</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Autoref: Type-based relator fixing rules"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sort</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transform</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL|const"><span>TYREL</span></a><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid tyrel-rule"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_tyrel_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tyrel_rules.add_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>del_tyrel_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tyrel_rules.del_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_tyrel_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tyrel_rules.get</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
      </span><span class="comment1"><span>(*fun rel_annots @{mpat "_ ::: ?R"} = [R]
        | rel_annots @{mpat "?f$?x"} = rel_annots f @ rel_annots x
        | rel_annots @{mpat "PROTECT (λ_. PROTECT ?t)"} = rel_annots t
        | rel_annots @{mpat "PROTECT PROTECT"} = []
        | rel_annots (Free _) = []
        | rel_annots (Bound _) = []
        | rel_annots t = raise TERM ("rel_annots",[t])
      *)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_relators</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Relators</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_relAPP</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_relators</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>acc</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_relators_of_subgoal</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.concl_of_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="var"><span>?R</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_relators</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>acc</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>acc</span></span><span>
  
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_tyrel_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_constraint</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL|const"><span>TYREL</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>res</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relators</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_relators_of_subgoal</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tyrels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>get_constraint</span></span><span> </span><span class="entity"><span>relators</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>Refine_Util.insert_subgoals_tac</span></span><span> </span><span class="entity"><span>tyrels</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>st</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>solve_tyrel_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_tac</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYREL_RES|fact"><span>TYREL_RES</span></a><span class="antiquote"><span>}</span></span></span></span><span> 
        </span><span>THEN'</span><span> </span><span>match_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.DOMAIN_OF_TYREL|fact"><span>DOMAIN_OF_TYREL</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span>
        </span><span>THEN'</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>FIRST'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyrel_rules.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>tac</span></span><span> </span><span>ORELSE'</span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.TYRELI|fact"><span>TYRELI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tyrel_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>insert_tyrel_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span>
      </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="entity"><span>solve_tyrel_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>



    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>internal_hom_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hom_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hom_netD.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Seq.INTERVAL</span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span>DETERM</span><span> </span><span>o</span><span> </span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hom_net</span></span><span class="main"><span>)</span></span><span>    
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>internal_spec_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairsD.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>mk_CONSTRAINT_rl_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Tactic.build_net</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>REPEAT</span><span> </span><span class="main"><span>(</span></span><span>CHANGED</span><span> 
        </span><span class="main"><span>(</span></span><span>Seq.INTERVAL</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>Anti_Unification.specialize_net_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_to_constraints</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>no_CONSTRAINT_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.concl_of_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.empty</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.single</span><span> </span><span class="entity"><span>st</span></span><span>  

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Seq.INTERVAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_CONSTRAINT_tac</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>internal_solve_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairsD.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_CONSTRAINT_rl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Tactic.build_net</span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span class="entity"><span>apply_to_constraints</span></span><span> </span><span class="entity"><span>s_tac</span></span><span>
      </span><span class="entity"><span>ORELSE_INTERVAL</span></span><span> 
      </span><span class="entity"><span>apply_to_constraints</span></span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>s_tac</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_relators_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairsD.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_CONSTRAINT_rl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Tactic.build_net</span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hom_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hom_netD.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hom_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.INTERVAL</span><span> 
        </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span>DETERM</span><span> </span><span>o</span><span> </span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hom_net</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>spec_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span>REPEAT</span><span> </span><span class="main"><span>(</span></span><span>CHANGED</span><span> 
          </span><span class="main"><span>(</span></span><span>Seq.INTERVAL</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>Anti_Unification.specialize_net_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>solve_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>   
        </span><span class="entity"><span>apply_to_constraints</span></span><span> </span><span class="entity"><span>s_tac</span></span><span>
        </span><span class="entity"><span>ORELSE_INTERVAL</span></span><span> 
        </span><span class="entity"><span>apply_to_constraints</span></span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>s_tac</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Seq.INTERVAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insert_CONSTRAINTS_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>THEN_INTERVAL</span></span><span> </span><span class="entity"><span>hom_tac</span></span><span>
      </span><span class="entity"><span>THEN_INTERVAL</span></span><span> </span><span class="entity"><span>spec_tac</span></span><span>
      </span><span class="entity"><span>THEN_INTERVAL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyrel_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>THEN_INTERVAL</span></span><span> </span><span class="entity"><span>solve_tac</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


    </span><span class="comment1"><span>(*********************)</span></span><span>
    </span><span class="comment1"><span>(*  Pretty Printing  *)</span></span><span>
    </span><span class="comment1"><span>(*********************)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_constraint_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> 
      </span><span class="main"><span>[</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span>
        </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" :: "</span></span><span class="main"><span>,</span></span><span>
        </span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" ::: "</span></span><span class="main"><span>,</span></span><span>
        </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty_constraint_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
               </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_constraint_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps</span></span><span> 
               </span><span>|&gt;</span><span> </span><span>Pretty.separate</span><span> </span><span class="inner_quoted"><span>"; "</span></span><span> 
               </span><span>|&gt;</span><span> </span><span>Pretty.enclose</span><span> </span><span class="inner_quoted"><span>"⟦"</span></span><span> </span><span class="inner_quoted"><span>"⟧"</span></span><span class="main"><span>,</span></span><span>
               </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"⟹"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>pretty_constraint_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>]</span></span><span>


    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_constraints</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"Constraints"</span></span><span> 
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_thm_pair</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"NONE"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span>
      </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"---"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span>
      </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_thm_pairs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"Thm-Pairs"</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_thm_pair</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unifies</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.could_unify</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>t1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.incr_indexes</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx1</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t2</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>can</span><span> </span><span class="main"><span>(</span></span><span>Pattern.unify</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.empty</span><span> </span><span class="entity"><span>idx2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze_possible_problems</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strange_aux</span></span><span> </span><span class="entity"><span>sf</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="main"><span>(</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>R</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_prodT</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_setT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Strange relator type, expected plain relation: "</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Syntax.pretty_term</span><span> </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span>show_types</span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R</span></span><span>
                </span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>(</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>⟨</span></span><span class="var"><span>?R</span></span><span class="main"><span>⟩</span></span><span class="var"><span>?S</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>strange_aux</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>R</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>strange_aux</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>S</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> 
                </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_prodT</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_setT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>strip_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Fixed concrete type on schematic relator: "</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Syntax.pretty_term</span><span> </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span>show_types</span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R</span></span><span>
                </span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>strange</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>strange_aux</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>folded_relator</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> 
            </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rargs</span></span><span class="main"><span>,</span></span><span class="entity"><span>Rhd</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Relators.strip_relAPP</span></span><span> </span><span class="entity"><span>R</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Var</span><span> </span><span class="entity"><span>Rhd</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>Rargs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span> 
                    </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Type/relator arity mismatch:"</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                      </span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"/"</span></span><span class="main"><span>,</span></span><span> 
                      </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"vs."</span></span><span class="main"><span>,</span></span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                      </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Rhd</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"/"</span></span><span class="main"><span>,</span></span><span> 
                      </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Rargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>]</span></span><span>
                  </span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="entity"><span>args</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Rargs</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>match</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>flat</span><span>

              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>   

        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> 
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.fbreaks</span><span> </span><span class="entity"><span>l</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
              </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Explanation: This may be due to using polymorphic "</span></span><span>
              </span><span>^</span><span> </span><span class="inner_quoted"><span>"relators like Id on non-terminal types."</span></span><span> 
              </span><span>^</span><span> </span><span class="inner_quoted"><span>"A problem usually occurs when "</span></span><span>
              </span><span>^</span><span> </span><span class="inner_quoted"><span>"this relator has to be matched against a fully unfolded one."</span></span><span>
              </span><span>^</span><span> </span><span class="inner_quoted"><span>"This warning is also issued on partially parametric relators "</span></span><span>
              </span><span>^</span><span> </span><span class="inner_quoted"><span>"like br. However, the refinement rules are usually set up to "</span></span><span>
              </span><span>^</span><span> </span><span class="inner_quoted"><span>"compensate for this, so this is probably not the cause for an "</span></span><span>
              </span><span>^</span><span> </span><span class="inner_quoted"><span>"unsolved constraint"</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>issues</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>strange</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>folded_relator</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span>I</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>issues</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"Possible problems"</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_try_candidates</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;</span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Goal number out of range"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.concl_of_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="var"><span>?f</span></span><span> </span><span class="var"><span>?R</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairsD.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.zero_var_indexes</span><span> </span><span class="entity"><span>st</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pt_hd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Head: "</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>pretty_constraint_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>]</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isc</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>fp</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>unifies</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>fp</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>fp</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isc</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="entity"><span>isc</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_c</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pt1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Trying "</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="entity"><span>pretty_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span>
                </span><span class="main"><span>]</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_CONSTRAINT_rl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span> 
                   </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Seq.pull</span><span> </span><span>|&gt;</span><span> </span><span>is_some</span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pt2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"OK"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"ERR"</span></span><span class="main"><span>)</span></span><span>
                  
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pt1</span></span><span class="main"><span>,</span></span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span class="entity"><span>pt2</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>
                </span><span>Pretty.fbreaks</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pt_hd</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"Solving Attempts"</span></span><span> 
                    </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>try_c</span></span><span> </span><span class="entity"><span>candidates</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>)</span></span><span>

            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
              </span><span class="entity"><span>res</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Unexpected goal format"</span></span><span>


      </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>ERR</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Pretty.T</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_horn</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> 
          </span><span>|&gt;</span><span> </span><span>drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>take</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span>-</span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>strip_all_body</span><span> </span><span>#&gt;</span><span> </span><span>Logic.strip_imp_concl</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="var"><span>?f</span></span><span> </span><span class="var"><span>?R</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ERR</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                 </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Internal: Unexpected goal format: "</span></span><span class="main"><span>,</span></span><span>
                 </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
               </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs_problems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>analyze_possible_problems</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty_constraint_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_constraint_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Cs</span></span><span>
 
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs_pretty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"Constraints"</span></span><span> </span><span class="entity"><span>Cs_problems</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ERR</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
            </span><span>Pretty.str</span><span> 
              </span><span class="inner_quoted"><span>"Could not infer all relators, some constraints remaining"</span></span><span class="main"><span>,</span></span><span>
            </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>Cs_pretty</span></span><span class="main"><span>,</span></span><span>
            </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
            </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
              </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Trying to solve first constraint"</span></span><span class="main"><span>,</span></span><span>
              </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>pretty_try_candidates</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
            </span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>analyze'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_failure</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="main"><span>(</span></span><span class="entity"><span>analyze'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>;</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"No failure"</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>ERR</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>p</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_solve_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>  
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;</span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="inner_quoted"><span>"Goal number out of range"</span></span><span class="main"><span>;</span></span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.concl_of_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Autoref_Fix_Rel.html#Autoref_Fix_Rel.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><span class="var"><span>?f</span></span><span> </span><span class="var"><span>?R</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairsD.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.zero_var_indexes</span><span> </span><span class="entity"><span>st</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Head: "</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
                  </span><span class="entity"><span>pretty_constraint_atom</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>]</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="entity"><span>pt</span></span><span class="main"><span>)</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>analyze_possible_problems</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
            
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isc</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>fp</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
                      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>unifies</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>fp</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>fp</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isc</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_CONSTRAINT_rl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Tactic.build_net</span><span>


                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="entity"><span>isc</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_c</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                    </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Trying "</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>pretty_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span>
                  </span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>tracing</span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_CONSTRAINT_rl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span> 
                     </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span> 
                      </span><span>THEN_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Seq.pull</span><span> </span><span>|&gt;</span><span> </span><span>is_some</span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"OK"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"ERR"</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>tracing</span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>try_c</span></span><span> </span><span class="entity"><span>candidates</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
                </span><span>Seq.single</span><span> </span><span class="entity"><span>st</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.empty</span><span>


    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>solve_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairsD.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_CONSTRAINT_rl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Tactic.build_net</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>net</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
      init </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_pairsD.init</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>hom_netD.init</span></span><span class="main"><span>,</span></span><span>
      tac </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>guess_relators_tac</span></span><span class="main"><span>,</span></span><span>
      analyze </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>analyze</span></span><span class="main"><span>,</span></span><span>
      pretty_failure </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_failure</span></span><span>
    </span><span class="main"><span>}</span></span><span>


    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hom_rules.setup</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>tyrel_rules.setup</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

›</span></span><span>

</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="entity"><span>Autoref_Fix_Rel.setup</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>