<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory LLVM_Codegen</title>
</head>


<body>
<div class="head">
<h1>Theory LLVM_Codegen</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>section</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹LLVM Code Generator›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="LLVM_Codegen.html"><span>LLVM_Codegen</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> 
  </span><a href="LLVM_Shallow.html"><span>LLVM_Shallow</span></a><span>
  </span><span class="quoted"><span>"</span><a href="Monadify.html"><span>../preproc/Monadify</span></a><span>"</span></span><span> </span><span class="comment1"><span>(* Needed for M_CONST *)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>

  </span><span class="comment1"><span>(* DO NOT USE IN PRODUCTION VERSION → SLOWDOWN *)</span></span><span>
  </span><span class="keyword1"><span class="command"><span>declare</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="operator"><span>ML_exception_debugger</span></span><span class="main"><span>,</span></span><span> </span><span class="operator"><span>ML_debugger</span></span><span class="main"><span>,</span></span><span> </span><span class="operator"><span>ML_exception_trace</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

    
  </span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹This is the trusted part of the code generator, which accepts
    Isabelle-LLVM programs that follow a strict format 
    (fully monadified, only </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>ll_›</span></span></span><span> instructions).
    
    The preprocessor and user-interface of the code generator can be found in 
    </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>file</span></span><span> </span><a href="LLVM_Codegen_Preproc.html"><span>"../preproc/LLVM_Codegen_Preproc.thy"</span></a><span class="antiquote"><span>}</span></span></span><span>
  ›</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Named Structures›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
    The code generator will create identified types in LLVM for types registered here
  ›</span></span></span><span>
  
  </span><span class="keyword1"><span class="command"><span class="entity_def" id="LLVM_Codegen.ll_is_identified_structure_def|fact"><span class="entity_def" id="LLVM_Codegen.ll_is_identified_structure_def|thm"><span class="entity_def" id="LLVM_Codegen.ll_is_identified_structure_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="LLVM_Codegen.ll_is_identified_structure|const"><span>ll_is_identified_structure</span></span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span class="bound"><span class="entity"><span>name</span></span></span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../HOL/HOL/String.html#String.string|type"><span>string</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'t</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep|class"><span>llvm_rep</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Simple_Memory.html#Simple_Memory.llvm_struct.is_struct|const"><span>llvm_struct.is_struct</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep_class.struct_of|const"><span>struct_of</span></a><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>named_theorems</span></span></span><span> </span><span class="entity_def" id="LLVM_Codegen.ll_identified_structures|attribute"><span class="entity_def" id="LLVM_Codegen.ll_identified_structures|fact"><span>ll_identified_structures</span></span></span><span> </span><span class="quoted"><span>‹LLVM: Identified Structures›</span></span><span>

  
  </span><span class="comment1"><span>(*named_theorems ll_to_val ‹LLVM: Equations to compute ‹to_val› shape›*)</span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>named_theorems</span></span></span><span> </span><span class="entity_def" id="LLVM_Codegen.ll_struct_of|attribute"><span class="entity_def" id="LLVM_Codegen.ll_struct_of|fact"><span>ll_struct_of</span></span></span><span> </span><span class="quoted"><span>‹LLVM: Equations to compute ‹struct_of› shape›</span></span><span>
  
  </span><span class="comment1"><span>(*lemma TERM_TYPE_I: "TERM (TYPE ('a))" .*)</span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>ML_val</span></span></span><span> </span><span class="quoted"><span>‹ </span><span>IntInf.pow</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>64</span></span><span class="main"><span>)</span></span><span>  ›</span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>typ</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>_</span></span><span> </span><a class="entity_ref" href="Simple_Memory.html#Simple_Memory.llM|type"><span>llM</span></a><span>"</span></span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹General Functions›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹ </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>LLC_Lib</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_llM</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="MMonad.html#MMonad.M|type"><span>M</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><a class="entity_ref" href="Simple_Memory.html#Simple_Memory.llvm_val|type"><span>llvm_val</span></a></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_llM</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_llM"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_llM</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>can</span><span> </span><span class="entity"><span>dest_llM</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_ptrT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ptr|type"><span>ptr</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_ptrT</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_ptrT"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> ‹</span><a class="entity_ref" href="../../AFP/Refine_Monadic/HOL-Library.Numeral_Type.html#Numeral_Type.bit0|type"><span>bit0</span></a><span>›</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>*</span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="entity"><span>ty</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> ‹</span><a class="entity_ref" href="../../AFP/Refine_Monadic/HOL-Library.Numeral_Type.html#Numeral_Type.bit1|type"><span>bit1</span></a><span>›</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>*</span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="entity"><span>ty</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> ‹</span><a class="entity_ref" href="../../AFP/Refine_Monadic/HOL-Library.Numeral_Type.html#Numeral_Type.num0|type"><span>num0</span></a><span>›</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> ‹</span><a class="entity_ref" href="../../AFP/Refine_Monadic/HOL-Library.Numeral_Type.html#Numeral_Type.num1|type"><span>num1</span></a><span>›</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_numeralT"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_wordT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/HOL-Library.Word.html#Word.word|type"><span>word</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_wordT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_wordT"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_word_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_number</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>dest_wordT</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_double_const</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>‹</span><a class="entity_ref" href="LLVM_Float_Types.html#LLVM_Float_Types.double_of_word|const"><span>double_of_word</span></a><span> </span><span class="var"><span>?w</span></span><span>›</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_number</span></span><span> </span><span class="entity"><span>w</span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>&lt;=</span><span class="entity"><span>n</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>n</span></span><span>&lt;</span><span>IntInf.pow</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>64</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_double_const (0≤ _ &lt;2^64): "</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>w</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Word64.fromInt</span><span> </span><span class="entity"><span>n</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_double_const</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_double_const"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_float_const</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>‹</span><a class="entity_ref" href="LLVM_Float_Types.html#LLVM_Float_Types.single_of_word|const"><span>single_of_word</span></a><span> </span><span class="var"><span>?w</span></span><span>›</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_number</span></span><span> </span><span class="entity"><span>w</span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>&lt;=</span><span class="entity"><span>n</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>n</span></span><span>&lt;</span><span>IntInf.pow</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>32</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_float_const (0≤ _ &lt;2^32): "</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>w</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Word32.fromInt</span><span> </span><span class="entity"><span>n</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_float_const</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_float_const"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        
        
      </span><span class="comment1"><span>(* Testing the dest-functions, to make them fail early after forgetting to 
        adapt them for changes to foundation.
      
        We use one indirection over a function, to make failed tests visible in stack trace
      *)</span></span><span>  
      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>  
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_dest_llM</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_llM</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>_</span></span><span> </span><a class="entity_ref" href="Simple_Memory.html#Simple_Memory.llM|type"><span>llM</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span>  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>test_dest_llM</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_dest_ptrT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_ptrT</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>_</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ptr|type"><span>ptr</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span>  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>test_dest_ptrT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_dest_numeralT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><span class="numeral"><span>32</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"test_dest_numeralT"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>test_dest_numeralT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>test_dest_wordT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_wordT</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><span class="numeral"><span>32</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/HOL-Library.Word.html#Word.word|type"><span>word</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"test_dest_wordT"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>test_dest_wordT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                        
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_eqn</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="var"><span>?lhs</span></span><span class="main"><span>≡</span></span><span class="var"><span>?rhs</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_eqn</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="var"><span>?lhs</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="var"><span>?rhs</span></span><span class="main"><span>)</span></span><span>›</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_eqn</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_eqn"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>can</span><span> </span><span class="entity"><span>dest_eqn</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest_eqn_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_eqn</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span>  
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_of_eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_eqn</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_of_eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_eqn</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>head_of_eqn</span></span><span> </span><span class="main"><span>=</span></span><span>head_of</span><span> </span><span>o</span><span> </span><span class="entity"><span>lhs_of_eqn</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>head_of_eqn_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>head_of_eqn</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eqn_conv</span></span><span> </span><span class="entity"><span>cvl</span></span><span> </span><span class="entity"><span>cvr</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.arg1_conv</span><span> </span><span class="entity"><span>cvl</span></span><span> </span><span>then_conv</span><span> </span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>cvr</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>_</span></span><span class="main"><span>≡</span></span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ct</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ct</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"rhs_conv"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ct</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lhs_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqn_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span>Conv.all_conv</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rhs_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqn_conv</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>cv</span></span><span>
      
      </span><span class="comment1"><span>(*              
      (* TODO: Move *)
      fun instantiate_uc (tyenv,tenv) thm = let
        val thy = Thm.theory_of_thm thm
        
        val tyi = Vartab.dest tyenv |&gt; map (fn (n,(s,T)) =&gt; ((n,s),Thm.global_ctyp_of thy T))
          |&gt; @{print}
        val ti = Vartab.dest tenv |&gt; map (fn (n,(s,t)) =&gt; ((n,s),Thm.global_cterm_of thy t))
          |&gt; @{print}
      in
        Thm.instantiate (tyi,ti) thm
      end
      *)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_monomorphic_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subtype</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_ground_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_type</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>is_monomorphic_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>is_Var</span><span> </span><span class="entity"><span>tt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>tt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert_ground_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_ground_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>           
        </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Expected ground term"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="comment1"><span>(*  
      fun is_monomorphic_const (Const (_,T)) = is_monomorphic_type T
        | is_monomorphic_const _ = false

      fun assert_monomorphic_const t = 
        is_monomorphic_const t orelse 
          raise TYPE("Expected monomorphic constant",[fastype_of t],[t])
      *)</span></span><span>      

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unique_variant1</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ntab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>=</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>n</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>    
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>ntab</span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>unique_variant1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ntab</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name'</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.insert_set</span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="entity"><span>ntab</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unique_variant</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unique_variant1</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
      
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_assert</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="entity"><span>msg</span></span><span> 
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>the_assert</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> 
      
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_identified_structure_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
        </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="main"><span>(</span></span><span class="quasi_keyword"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="LLVM_Codegen.html#LLVM_Codegen.ll_is_identified_structure|const"><span>ll_is_identified_structure</span></a><span> </span><span class="var"><span>?name</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tvar"><span>?'v_t</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep|class"><span>llvm_rep</span></a><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_string</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_identified_structure_thm"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
         
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_eta_all</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_bnames</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.declare</span><span> </span><span class="entity"><span>a</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>declare_bnames</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declare_bnames</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>#&gt;</span><span> </span><span>Name.declare</span><span> </span><span class="entity"><span>x</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>declare_bnames</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declare_bnames</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>declare_bnames</span></span><span> </span><span class="entity"><span>t2</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>declare_bnames</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declare_bnames</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>Name.context</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent</span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exp</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exp</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>exp</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exp</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>exp</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span>incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>exp</span></span><span> </span><span class="entity"><span>xTs</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
      

      </span><span class="comment1"><span>(* Simple name mangling. Get uniqued afterwards! *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span>$</span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"__"</span></span><span>
      
              
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>llc_compile_while</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="LLVM_Codegen.llc_compile_while|attribute"><span>llc_compile_while</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>llc_compile_par_call</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="LLVM_Codegen.llc_compile_par_call|attribute"><span>llc_compile_par_call</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>llc_compile_avx512f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="LLVM_Codegen.llc_compile_avx512f|attribute"><span>llc_compile_avx512f</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>llc_compile_union</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="LLVM_Codegen.llc_compile_union|attribute"><span>llc_compile_union</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>str_of_w32</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Word32.fmt</span><span> </span><span>StringCvt.HEX</span><span> </span><span>#&gt;</span><span> </span><span>StringCvt.padLeft</span><span> </span><span class="inner_quoted"><span>#"0"</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span> </span><span>#&gt;</span><span> </span><span>prefix</span><span> </span><span class="inner_quoted"><span>"0x"</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>str_of_w64</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Word64.fmt</span><span> </span><span>StringCvt.HEX</span><span> </span><span>#&gt;</span><span> </span><span>StringCvt.padLeft</span><span> </span><span class="inner_quoted"><span>#"0"</span></span><span> </span><span class="inner_numeral"><span>16</span></span><span> </span><span>#&gt;</span><span> </span><span>prefix</span><span> </span><span class="inner_quoted"><span>"0x"</span></span><span class="main"><span>;</span></span><span>
      
            
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  ›</span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Intermediate Representation›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
    The code generator translates Isabelle terms into this intermediate representation,
    and then generates LLVM code from this. 
    No transformations are done on the intermediate representation, but it merely serves 
    to cleanly separate the interpretation and checking of Isabelle terms, and the generation
    of LLVM code.
  ›</span></span></span><span>
  
  </span><span class="comment1"><span>(*
  TODO: conceptually, named types should be disambiguated during monomorphization,
    such that all named types come without type parameters!
    Is this feasible? Monomorphization would have to define new types.
  *)</span></span><span>  
  
  </span><span class="keyword1"><span class="command"><span>ML_val</span></span></span><span> </span><span class="quoted"><span>‹
    </span><span>Word64.fromInt</span><span> </span><span class="inner_numeral"><span>63</span></span><span> </span><span>|&gt;</span><span> </span><span>Word64.fmt</span><span> </span><span>StringCvt.HEX</span><span> </span><span>|&gt;</span><span> </span><span>StringCvt.padLeft</span><span> </span><span class="inner_quoted"><span>#"0"</span></span><span> </span><span class="inner_numeral"><span>16</span></span><span> </span><span>|&gt;</span><span> </span><span>prefix</span><span> </span><span class="inner_quoted"><span>"0x"</span></span><span class="main"><span>;</span></span><span>
  
    </span><span>Word64.fromInt</span><span> </span><span class="inner_numeral"><span>63</span></span><span> 
  ›</span></span><span>
  
  
  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹ </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>LLC_Intermediate</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
    
      </span><span class="comment1"><span>(* LLC intermediate representation. Somewhere in between Isabelle and LLVM-IR *)</span></span><span>    
      
      </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>llc_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TInt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TFloat</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TDouble</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TPtr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_type </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TStruct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_type list </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TNamed</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TUnion</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_type list
      </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>llc_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CInit</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CInt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CFloat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Word32.word </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CDouble</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Word64.word </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CNull</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>llc_opr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>OVar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>OConst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_const
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>llc_topr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_type</span></span><span> * </span><span class="entity"><span>llc_opr</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>llc_topr'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_topr </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>OOType</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_type </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int

      </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>llc_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> 
                 </span><span class="entity"><span>CmIf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_topr * llc_block * llc_block
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CmWhile</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>llc_type * string</span><span class="main"><span>)</span></span><span> * llc_block * llc_block * llc_topr
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CmInstr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * llc_topr' list
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CmCall</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_type option * string * llc_topr list
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CmPar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_type * string * llc_topr * llc_type * string * llc_topr
      
          </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>llc_block</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>BlBind</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>llc_type * string</span><span class="main"><span>)</span></span><span> option * llc_cmd * llc_block
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>BlReturn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_topr option 
    
      </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>llc_eqn</span></span><span> </span><span class="main"><span>=</span></span><span>              
                </span><span class="entity"><span>EQN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_type option * string * </span><span class="main"><span>(</span></span><span>llc_type * string</span><span class="main"><span>)</span></span><span> list * llc_block
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>EXT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> llc_type option * string * llc_type list   
    
      </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>llc_named_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * llc_type list                
                
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of_eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EQN</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of_eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EXT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
      
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.markup</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword1</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"i"</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword1</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"float"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword1</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"double"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"*"</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TUnion</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>"u{"</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_const</span></span><span> </span><span class="entity"><span>CInit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword1</span><span> </span><span class="inner_quoted"><span>"zeroinitializer"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CInt</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.numeral</span><span> </span><span class="main"><span>(</span></span><span>Int.toString</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CFloat</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.numeral</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLC_Lib.str_of_w32</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CDouble</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.numeral</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLC_Lib.str_of_w64</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_const</span></span><span> </span><span class="entity"><span>CNull</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword1</span><span> </span><span class="inner_quoted"><span>"null"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_opr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>OVar</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_opr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>OConst</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_const</span></span><span> </span><span class="entity"><span>c</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_topr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>opr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_opr</span></span><span> </span><span class="entity"><span>opr</span></span><span class="main"><span>]</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_topr'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_topr</span></span><span> </span><span class="entity"><span>x</span></span><span> 
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_topr'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>OOType</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_topr'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.numeral</span><span> </span><span class="main"><span>(</span></span><span>Int.toString</span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_tname</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>]</span></span><span>  
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_type'</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="entity"><span>t</span></span><span> 
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_type'</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword1</span><span> </span><span class="inner_quoted"><span>"void"</span></span><span>  
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"if"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_topr</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"then"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
            </span><span>Pretty.blk</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>4</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_block</span></span><span> </span><span class="entity"><span>c1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"else"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
            </span><span>Pretty.blk</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>4</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_block</span></span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>]</span></span><span>  
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmWhile</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
            </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"while"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.enclose</span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span class="inner_quoted"><span>"]"</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_tname</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span> 
              </span><span>Pretty.blk</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>4</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_block</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"do"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
              </span><span>Pretty.blk</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>4</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_block</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"init "</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_topr</span></span><span> </span><span class="entity"><span>s</span></span><span>
          </span><span class="main"><span>]</span></span><span> 
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmInstr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ops</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_topr'</span></span><span> </span><span class="entity"><span>ops</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmCall</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ops</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_type'</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>" call "</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_topr</span></span><span> </span><span class="entity"><span>ops</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmPar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span class="entity"><span>name1</span></span><span class="main"><span>,</span></span><span class="entity"><span>op1</span></span><span class="main"><span>,</span></span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span class="entity"><span>name2</span></span><span class="main"><span>,</span></span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TStruct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>" par "</span></span><span class="main"><span>,</span></span><span> 
          </span><span>Pretty.str</span><span> </span><span class="entity"><span>name1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_topr</span></span><span> </span><span class="entity"><span>op1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>" and "</span></span><span class="main"><span>,</span></span><span>
          </span><span>Pretty.str</span><span> </span><span class="entity"><span>name2</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_topr</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>]</span></span><span>
        
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>pretty_block</span></span><span> </span><span class="entity"><span>blk</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pblst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BlBind</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>tv</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_tname</span></span><span> </span><span class="entity"><span>tv</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" = "</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_cmd</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>pblst</span></span><span> </span><span class="entity"><span>b</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pblst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BlBind</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty_cmd</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>pblst</span></span><span> </span><span class="entity"><span>b</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pblst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BlReturn</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"return"</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pblst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BlReturn</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword2</span><span> </span><span class="inner_quoted"><span>"return "</span></span><span class="main"><span>,</span></span><span class="entity"><span>pretty_topr</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
          
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.fbreaks</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pblst</span></span><span> </span><span class="entity"><span>blk</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
      </span><span class="comment1"><span>(* pretty_eqn_body NONE = Pretty.block [Pretty.str "=", Pretty.brk 1, Pretty.str "external"]
        |*)</span></span><span>      
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_eqn_body</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
            </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" {"</span></span><span class="main"><span>,</span></span><span> 
              </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span> </span><span>Pretty.blk</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>4</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>pretty_block</span></span><span> </span><span class="entity"><span>block</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span> 
            </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"}"</span></span><span class="main"><span>]</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EQN</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
            </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_type'</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_tname</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_eqn_body</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> 
            </span><span>Pretty.fbrk</span><span>
          </span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EXT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
            </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_type'</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
            </span><span>Pretty.fbrk</span><span>
          </span><span class="main"><span>]</span></span><span>
        

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_eqns</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.fbreaks</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_eqn</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_named_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_mstr</span></span><span> </span><span>Markup.keyword3</span><span> </span><span class="inner_quoted"><span>"type "</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" = "</span></span><span class="main"><span>,</span></span><span> 
        </span><span>Pretty.list</span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_type</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>]</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_named_tys</span></span><span> </span><span class="entity"><span>ntys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.fbreaks</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_named_type</span></span><span> </span><span class="entity"><span>ntys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_llc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ntys</span></span><span class="main"><span>,</span></span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty_named_tys</span></span><span> </span><span class="entity"><span>ntys</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_eqns</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  ›</span></span><span>
   
  </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="LLVM_Codegen.llc_struct_of_eq_triv|fact"><span class="entity_def" id="LLVM_Codegen.llc_struct_of_eq_triv|thm"><span>llc_struct_of_eq_triv</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep_class.struct_of|const"><span>struct_of</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>a</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep_class.struct_of|const"><span>struct_of</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>a</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

    
  </span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Isabelle Term Parser›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Parser from Isabelle terms to intermediate representation›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹ </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>LLC_Compiler</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>LLC_Lib</span><span> </span><span>LLC_Intermediate</span><span>
    
      </span><span class="comment1"><span>(* Declare custom names for specific type instances *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Named_Type_Override</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> </span><span>Typtab.table</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>Typtab.empty</span><span>
      </span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_named_type_override</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Named_Type_Override.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_monomorphic_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Named type override: expected monomorphic type"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Typtab.defined</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Named type override: duplicate override for type"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.desymbolize</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Named type override: name was desymbolized: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" -&gt; "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Named_Type_Override.map</span><span> </span><span class="main"><span>(</span></span><span>Typtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>name'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      
      
      </span><span class="comment1"><span>(* Maps Isabelle type names to named type theorems *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Named_Type_Tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>Symtab.empty</span><span>
      </span><span class="main"><span>)</span></span><span>

      </span><span class="comment1"><span>(* Cache of already created llc-types *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Type_Cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_type</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>Typtab.table</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>Typtab.empty</span><span>
      </span><span class="main"><span>)</span></span><span>

      </span><span class="comment1"><span>(* Identified Structures: Maps names to field types *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Identified_Structures</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_type</span></span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>Symtab.empty</span><span>
      </span><span class="main"><span>)</span></span><span>
      
      
      
      
      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
        </span><span class="comment1"><span>(* Concatenate type name with argument names, and desymbolize type name.
           assumes argument names already desymbolized.partial_function_mono
        *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mangle_typename</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span>implode</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="comment1"><span>(* Get default name for type *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dflt_type_name</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/HOL-Library.Word.html#Word.word|type"><span>word</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="entity"><span>T</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="inner_quoted"><span>"i"</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>n</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dflt_type_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>argnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_type_name_dflt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
              </span><span class="entity"><span>mangle_typename</span></span><span> </span><span class="main"><span>(</span></span><span>Name.desymbolize</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>argnames</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dflt_type_name</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dflt_type_name: expected type"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="comment1"><span>(* Get name for type, using named type info. *)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>get_type_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Named_Type_Override.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>  
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Named_Type_Tab.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>SOME</span><span> </span><span class="entity"><span>cr_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cr_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_type_name</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"get_type_name: expected type"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>get_type_name_dflt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_type_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
              </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span> 
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>dflt_type_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span>
        
        </span><span class="comment1"><span>(* Create named type table. *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_named_type_tables</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_pt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_identified_structure_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.desymbolize</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>name</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_Type</span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"check_pt: Expected type"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>typ</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Type</span><span> </span><span class="entity"><span>typ</span></span><span>
            
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span>is_TVar</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"check_pt: Expected simple type"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>typ</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cr_tyname</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_type_name_dflt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mangle_typename</span></span><span> </span><span class="entity"><span>name</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cr_tyname</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span class="main"><span>,</span></span><span class="entity"><span>cr_tyname</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems</span></span><span> ll_identified_structures</span><span class="antiquote"><span>}</span></span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>check_pt</span></span><span> </span><span>|&gt;</span><span> </span><span>Symtab.make</span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>ctxt</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Named_Type_Tab.put</span><span> </span><span class="entity"><span>typtab</span></span><span>
        
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
      
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_undefined_ct</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.undefined|const"><span>undefined</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_type_ct</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_first</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>try_first</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>try_first</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>y</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_to_val</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep_class.to_val|const"><span>to_val</span></a><span> </span><span class="var"><span>?x</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> 
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_to_val</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_to_val"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_struct_of</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep_class.struct_of|const"><span>struct_of</span></a><span> </span><span class="var"><span>?x</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> 
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_struct_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_struct_of"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_struct_of_thm</span></span><span> </span><span class="entity"><span>parse_type</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_fields</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_list</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_struct_of</span></span><span> </span><span>#&gt;</span><span> </span><span>Logic.dest_type</span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_fs</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>parse_type</span></span><span> </span><span class="entity"><span>fTs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>llc_fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
      
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep_class.struct_of|const"><span>struct_of</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="Simple_Memory.html#Simple_Memory.llvm_struct.VS_STRUCT|const"><span>VS_STRUCT</span></a><span> </span><span class="var"><span>?fs</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse_fields</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>TStruct</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep_class.struct_of|const"><span>struct_of</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="Simple_Memory.html#Simple_Memory.llvm_struct.VS_UNION|const"><span>VS_UNION</span></a><span> </span><span class="var"><span>?fs</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse_fields</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>TUnion</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid struct_of theorem: "</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_get_type_struct</span></span><span> </span><span class="entity"><span>parse_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems</span></span><span> ll_struct_of</span><span class="antiquote"><span>}</span></span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_type_ct</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="LLVM_Codegen.html#LLVM_Codegen.llc_struct_of_eq_triv|fact"><span>llc_struct_of_eq_triv</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>try_first</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts_thms</span></span><span>
                
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Cannot find struct_of theorem for type: "</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>
      
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>dest_struct_of_thm</span></span><span> </span><span class="entity"><span>parse_type</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="comment1"><span>(* Lookup already cached type *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_lookup_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/HOL-Library.Word.html#Word.word|type"><span>word</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>TInt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_lookup_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="LLVM_Float_Types.html#LLVM_Float_Types.single|type"><span>single</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_lookup_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="LLVM_Float_Types.html#LLVM_Float_Types.double|type"><span>double</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_lookup_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ptr|type"><span>ptr</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>llc_lookup_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>lT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>lT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_lookup_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Type_Cache.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
      
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="../../AFP/Refine_Monadic/HOL-Library.Word.html#Word.word|type"><span>word</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_numeralT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>TInt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="LLVM_Float_Types.html#LLVM_Float_Types.single|type"><span>single</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="LLVM_Float_Types.html#LLVM_Float_Types.double|type"><span>double</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ptr|type"><span>ptr</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>TPtr</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_make_type_inst</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"llc_parse_type: "</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>llc_make_type_inst</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Type_Cache.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"llc_parse_type: circular type"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="comment1"><span>(* Get naming of type *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_type_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span>
          
          </span><span class="comment1"><span>(* Register type: as anonymous (NONE), or as TNamed *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_tycache_entry</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type_Cache.map</span><span> </span><span class="main"><span>(</span></span><span>Typtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>map_option</span></span><span> </span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_tycache_entry</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    
          </span><span class="comment1"><span>(* Get intermediate type *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_get_type_struct</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

          </span><span class="comment1"><span>(* Complete entry for anonymous type / register identified structure *)</span></span><span>
                    
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_identified_structure</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.defined</span><span> </span><span class="main"><span>(</span></span><span>Identified_Structures.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Duplicate identified structure name: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>Identified_Structures.map</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>register_identified_structure</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Only struct can be registered as named: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_T</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_T</span></span><span class="main"><span>,</span></span><span> </span><span>Type_Cache.map</span><span> </span><span class="main"><span>(</span></span><span>Typtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span>SOME</span><span> </span><span class="entity"><span>llc_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>register_identified_structure</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>llc_T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>)</span></span><span>
      
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>res_T</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      
      
      </span><span class="comment1"><span>(* TODO/FIXME: Populate with actual instructions! Register them, together with their compilers! *)</span></span><span>  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_llvm_instr</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"LLVM_Shallow.ll_"</span></span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_llvm_instr_t</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_llvm_instr</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_llvm_instr_t</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
                

      </span><span class="comment1"><span>(* M_CONST aware strip_comb *)</span></span><span>          
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_comb_mc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>‹</span><a class="entity_ref" href="Monadify.html#Monadify.M_CONST|const"><span>M_CONST</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span>$</span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stripc</span></span><span>  </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>x</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>stripc</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze_eqn</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_eqn</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hdc</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_comb_mc</span></span><span> </span><span class="entity"><span>lhs</span></span><span> 
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hdc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>hdc</span></span><span>
        
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>hdc</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_eqn</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>hdc</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>analyze_eqn</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_ground_term</span></span><span> </span><span class="entity"><span>hdc</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_llvm_instr_t</span></span><span> </span><span class="entity"><span>hdc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Code equation for internal LLVM instruction"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>is_Var</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"llc_parse_eqn: arguments must be vars"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>a</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
        
            
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>analyze_eqn_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>analyze_eqn</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>check_eqn_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_eqn</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compute_fun_names</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>extfuns</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>Envir.beta_eta_contract</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>Envir.beta_eta_contract</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extfuns</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assert_ground_term</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assert_ground_term</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extfuns</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.make</span><span> </span><span class="entity"><span>fixes</span></span><span>
        </span><span class="comment1"><span>(* Pre-populate name table with fixed and external function names, AND ensure no duplicates *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>extfuns</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>Symtab.empty</span><span>
        
        </span><span class="comment1"><span>(* Add external functions to ftab *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_extfun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ftab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ftab</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ftab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_extfun</span></span><span> </span><span class="entity"><span>extfuns</span></span><span> </span><span>Termtab.empty</span><span>

        </span><span class="comment1"><span>(* Add code equations, and disambiguate non-fixed names *)</span></span><span>        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ftab</span></span><span class="main"><span>,</span></span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_eqn_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Termtab.defined</span><span> </span><span class="entity"><span>ftab</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"More than one code equation for constant"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>c</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Termtab.lookup</span><span> </span><span class="entity"><span>fixtab</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Termtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ftab</span></span><span class="main"><span>,</span></span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_of_head</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>|&gt;</span><span> </span><span>Name.desymbolize</span><span> </span><span>NONE</span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unique_variant</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>names</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ftab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ftab</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>ftab</span></span><span class="main"><span>,</span></span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ftab</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_thm</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ftab</span></span><span class="main"><span>,</span></span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>ftab</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

                
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_vtype</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>type_name</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_vtype</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>SOME</span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_const</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="main"><span>(</span></span><span class="quasi_keyword"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span>‹</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep_class.init|const"><span>init</span></a><span class="main"><span>::</span></span><span class="tvar"><span>?'v_T</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep|class"><span>llvm_rep</span></a><span>›</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>CInit</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_const</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="main"><span>(</span></span><span class="quasi_keyword"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span>‹</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.null|const"><span>null</span></a><span class="main"><span>::</span></span><span class="tvar"><span>?'v_T</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep|class"><span>llvm_rep</span></a><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ptr|type"><span>ptr</span></a><span>›</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>CNull</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_const</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_word_const</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>w</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>CInt</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_float_const</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>,</span></span><span class="entity"><span>CFloat</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_double_const</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>,</span></span><span class="entity"><span>CDouble</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"llc_parse_const"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_cidx</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_number</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../HOL/HOL/Nat.html#Nat.nat|type"><span>nat</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_cidx"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>    
          
      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>    

        </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>Tstored</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_type</span></span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span>
            
        </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env_empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.empty</span><span class="main"><span>,</span></span><span>Termtab.empty</span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>LLC_Env</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.set</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>llc_type</span></span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>Termtab.table</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>llc_type</span></span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span>   
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_empty</span></span><span>
          </span><span class="main"><span>)</span></span><span>
          
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env_init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.put</span><span> </span><span class="entity"><span>env_empty</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env_save</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span>o</span><span> </span><span>LLC_Env.get</span><span> 
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>env_restore</span></span><span> </span><span class="entity"><span>bnds</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.put</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>bnds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
          </span><span class="comment1"><span>(* val env_syms = LLC_Env.get #&gt; #1 *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.get</span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env_bnds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.get</span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span>
                
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_uniqueN</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>=</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>n</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>make_uniqueN</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>name'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_unique</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_uniqueN</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
          
          
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>env_add_sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>bnds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.desymbolize</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>make_unique</span></span><span> </span><span class="entity"><span>syms</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.insert_set</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>syms</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.put</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>bnds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>env_add_bound</span></span><span> </span><span class="entity"><span>lty</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_add_sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>bnds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>bnds</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.put</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>bnds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>env_add_unit_bound</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>bnds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.put</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span>NONE</span><span>::</span><span class="entity"><span>bnds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>env_add_param</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iname</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Var</span><span> </span><span class="entity"><span>v</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>iname</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lty</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_add_sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>bnds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>lty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LLC_Env.put</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>syms</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>bnds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>env_lookup_bound</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>nth</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env_bnds</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Reference to bound unit variable"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>env_lookup_param</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.lookup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env_params</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
                
      
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>env_parse_add_bound</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>llc_parse_vtype</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env_add_unit_bound</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_add_bound</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
        
        
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env_lookup_bound</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>OVar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env_lookup_param</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>OVar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_const</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>apsnd</span><span> </span><span class="entity"><span>OConst</span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_op'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>‹</span><span class="keyword1"><span>TYPE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>›</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.dest_type</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>OOType</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_op'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_cidx</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
              </span><span>SOME</span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>OOOp</span></span><span class="main"><span>)</span></span><span>
          
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_op_opt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.Unity|const"><span>()</span></a></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>  
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_op_opt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>SOME</span><span>
          
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_op_bool</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>=</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"parse_op_bool: not a Boolean"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
          
        </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Fun_Tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> </span><span>Termtab.table</span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>Termtab.empty</span><span>
        </span><span class="main"><span>)</span></span><span>
        
        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ftab_lookup</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>f</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Fun_Tab.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_none</span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No such function in ftab"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span>fastype_of</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>f</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="entity"><span>fname</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_llc_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>llc_lookup_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>lT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lT</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"get_llc_type: internal, unregistered type: "</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>  
        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_identified_structure_fields</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Identified_Structures.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"get_identified_structure_fields: internal, unregistered name: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>fTs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fTs</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_field_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_llc_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>get_identified_structure_fields</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>fTs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fTs</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"get_field_types: not a structure type"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_valid_struct_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>pT</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>fT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_number</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span> 
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid structure instruction instance, index must be constant"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_llc_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fT</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_field_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pT</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&lt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>fTs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>fT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>fTs</span></span><span> </span><span class="entity"><span>i</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid structure instruction instance"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span>fastype_of</span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          
          </span><span class="comment1"><span>(*val _ = Pretty.block [Pretty.str "Type instance OK ", Syntax.pretty_term ctxt t, Pretty.str " :: ", Syntax.pretty_typ ctxt (fastype_of t) ]
            |&gt; Pretty.string_of |&gt; writeln
          *)</span></span><span>  
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_llvm_struct_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="main"><span>(</span></span><span class="quasi_keyword"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span>‹</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_extract_value|const"><span>ll_extract_value</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>::</span></span><span class="tvar"><span>?'v_pT</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep|class"><span>llvm_rep</span></a><span class="main"><span>)</span></span><span> </span><span class="var"><span>?i</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="tvar"><span>?'v_aT</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep|class"><span>llvm_rep</span></a><span> </span><a class="entity_ref" href="Simple_Memory.html#Simple_Memory.llM|type"><span>llM</span></a><span>›</span></span><span class="antiquote"><span>}</span></span></span></span></span></span><span class="main"><span>)</span></span><span> 
            </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_valid_struct_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>pT</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>aT</span></span><span>        
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_llvm_struct_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="main"><span>(</span></span><span class="quasi_keyword"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span>‹</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_insert_value|const"><span>ll_insert_value</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>::</span></span><span class="tvar"><span>?'v_pT</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep|class"><span>llvm_rep</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="tvar"><span>?'v_aT</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llvm_rep|class"><span>llvm_rep</span></a><span class="main"><span>)</span></span><span> </span><span class="var"><span>?i</span></span><span>›</span></span><span class="antiquote"><span>}</span></span></span></span></span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_valid_struct_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>pT</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>aT</span></span><span>
        </span><span class="comment1"><span>(*| check_llvm_struct_cmd ctxt (t as @{mpat (typs) ‹ll_gep_struct (_::?'v_pT::llvm_rep ptr) ?i :: ?'v_aT::llvm_rep ptr llM›})
            = check_valid_struct_inst ctxt t pT i aT*)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_llvm_struct_cmd</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>    
                        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_fun_name</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="comment1"><span>(*val _ = check_valid_head f            
          val cname = name_of_head f
          val _ = is_llvm_instr cname andalso raise TERM("llc_parse_fun_name: expected function name, but got instruction",[f])
          *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ftab_lookup</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>|&gt;</span><span> </span><span>body_type</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>dest_llM</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_vtype</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="entity"><span>fname</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_cmd</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_comb_mc</span></span><span> </span><span class="entity"><span>t</span></span><span>

          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> ‹</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llc_if|const"><span>llc_if</span></a><span>›</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
                  </span><span class="main"><span>[</span></span><span class="entity"><span>arg_cond</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg_then</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg_else</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l_cond</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_op_bool</span></span><span> </span><span class="entity"><span>arg_cond</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l_then</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="entity"><span>arg_then</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l_else</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="entity"><span>arg_else</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>CmIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l_cond</span></span><span class="main"><span>,</span></span><span class="entity"><span>l_then</span></span><span class="main"><span>,</span></span><span class="entity"><span>l_else</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"parse_cmd: If needs 3 arguments"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> ‹</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llc_while|const"><span>llc_while</span></a><span>›</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>λ</span></span><span class="main"><span class="bound"><span>_</span></span></span><span class="main"><span>.</span></span><span> </span><span class="var"><span>?tcond</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>λ</span></span><span class="bound"><span>xb</span></span><span class="main"><span>.</span></span><span> </span><span class="var"><span>?tbody</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_inits</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inits</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="entity"><span>arg_inits</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_save</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                                        
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sv</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_parse_add_bound</span></span><span> </span><span class="entity"><span>xb_T</span></span><span> </span><span class="entity"><span>xb</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>sv</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"While with unit-state not yet supported"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>sv</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sv</span></span><span>
                    
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="entity"><span>tcond</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="entity"><span>tbody</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_restore</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>CmWhile</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cond</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inits</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"parse_cmd: While needs 3 arguments"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> ‹</span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.llc_par|const"><span>llc_par</span></a><span>›</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="main"><span>[</span></span><span class="entity"><span>arg_f1</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg_f2</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg_x1</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg_x2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rty1</span></span><span class="main"><span>,</span></span><span class="entity"><span>fn1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_fun_name</span></span><span> </span><span class="entity"><span>arg_f1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rty2</span></span><span class="main"><span>,</span></span><span class="entity"><span>fn2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_fun_name</span></span><span> </span><span class="entity"><span>arg_f2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>op1</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="entity"><span>arg_x1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>op2</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="entity"><span>arg_x2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty1</span></span><span class="main"><span>,</span></span><span class="entity"><span>rty2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span>SOME</span><span> </span><span class="entity"><span>ty2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmPar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span class="entity"><span>fn1</span></span><span class="main"><span>,</span></span><span class="entity"><span>op1</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty2</span></span><span class="main"><span>,</span></span><span class="entity"><span>fn2</span></span><span class="main"><span>,</span></span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"parse_cmd: llc_par expects two non-void one-argument functions"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                      
                
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"parse_cmd: llc_par needs 4 arguments"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_llvm_instr_t</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Const</span><span> </span><span class="entity"><span>f</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ops</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>llc_parse_op'</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_llvm_struct_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmInstr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span class="main"><span>,</span></span><span class="entity"><span>ops</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ops</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ftab_lookup</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmCall</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>,</span></span><span class="entity"><span>ops</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                   
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="MMonad.html#MMonad.Mbind|const"><span>Mbind</span></a><span> </span><span class="var"><span>?m</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="var"><span>?f</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_vtype</span></span><span> </span><span class="entity"><span>x_T</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cmd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_cmd</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_save</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sv</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_parse_add_bound</span></span><span> </span><span class="entity"><span>x_T</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>blk</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_restore</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>BlBind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sv</span></span><span class="main"><span>,</span></span><span class="entity"><span>cmd</span></span><span class="main"><span>,</span></span><span class="entity"><span>blk</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Product_Type.html#Product_Type.Unity|const"><span>()</span></a></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BlReturn</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="MMonad.html#MMonad.Mreturn|const"><span>Mreturn</span></a><span> </span><span class="var"><span>?x</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_op</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>SOME</span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>BlReturn</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"llc_parse_block: structural error"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
         
          
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_eqn</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>hdc</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_eqn</span></span><span> </span><span class="entity"><span>t</span></span><span>
          
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ftab_lookup</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hdc</span></span><span> 
            
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_init</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                      
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>env_add_param</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>blk</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_block</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rlty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_vtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_llM</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  
            </span><span class="comment1"><span>(* Erase meaningless environment after equation has been parsed! *)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env_init</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>EQN</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rlty</span></span><span class="main"><span>,</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span class="entity"><span>blk</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"From "</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span>
          
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>trace_exn</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          
          
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>      
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_parse_extfun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>fname</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>c</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_llvm_instr_t</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"External declaration for internal LLVM instruction"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>c</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ptys</span></span><span class="main"><span>,</span></span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
                
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pltys</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>llc_parse_type</span></span><span> </span><span class="entity"><span>ptys</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rlty</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_parse_vtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_llM</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>EXT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rlty</span></span><span class="main"><span>,</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span class="entity"><span>pltys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_cthms_aux</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_parse_eqn</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_cthms</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>nt_ovr</span></span><span> </span><span class="entity"><span>extfuns</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ftab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compute_fun_names</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>extfuns</span></span><span> </span><span class="entity"><span>thms</span></span><span>      
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Fun_Tab.put</span><span> </span><span class="entity"><span>ftab</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_named_type_override</span></span><span> </span><span class="entity"><span>nt_ovr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        
        </span><span class="comment1"><span>(* Parse external function declarations *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext_eqns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>llc_parse_extfun</span></span><span> </span><span class="entity"><span>extfuns</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        
        </span><span class="comment1"><span>(* Parse code theorems *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqns</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_cthms_aux</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>build_named_type_tables</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>named_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Identified_Structures.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Symtab.dest</span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>Named_Type</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
        </span><span class="main"><span>(</span></span><span class="entity"><span>named_tys</span></span><span class="main"><span>,</span></span><span class="entity"><span>ext_eqns</span></span><span>@</span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
     
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
  ›</span></span><span>  

  </span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹LLVM Writer›</span></span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹LLVM Builder. Interface to build actual LLVM text.›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>ML_file</span></span></span><span> </span><span class="quoted"><a href="USER_HOME/devel/isabelle/lrat_isa/isabelle_llvm/thys/basic/kernel/par_wrapper.tmpl.ml.html"><span>"par_wrapper.tmpl.ml"</span></a></span><span>
  </span><span class="keyword1"><span class="command"><span>ML_file</span></span></span><span> </span><span class="quoted"><a href="USER_HOME/devel/isabelle/lrat_isa/isabelle_llvm/thys/basic/kernel/LLVM_Builder.ml.html"><span>"LLVM_Builder.ml"</span></a></span><span>
  
  
  </span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Compiler from intermediate representation to actual LLVM text.›</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹ </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>LLC_Backend</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>LLC_Lib</span><span> </span><span>LLC_Intermediate</span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.value</span></span><span> </span><span>Symtab.table</span><span>
      </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>LLVM_Builder.regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>llc_topr'</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>LLVM_Builder.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>LLVM_Builder.value</span></span><span> </span><span>option</span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_ty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_i</span></span><span> </span><span class="entity"><span>w</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_ty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_float</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_ty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_double</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_ptr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_struct</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_named</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TUnion</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_union</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_const_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>CInit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_zeroinit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_const_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CInt</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_const_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CFloat</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_const_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CDouble</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_const_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CNull</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_null</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>OVar</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>the_assert</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Variable not in vtab "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>OConst</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_const_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>c</span></span><span>
        

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_op'_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x</span></span><span>  
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>llc_op'_to_val</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"llc_op'_to_val: Expected value operand: "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLC_Intermediate.pretty_topr'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dstreg</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dstreg</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unsuffix_float_instr</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="inner_quoted"><span>"_d"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>unsuffix</span><span> </span><span class="inner_quoted"><span>"_d"</span></span><span> </span><span class="entity"><span>s</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="inner_quoted"><span>"_f"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>unsuffix</span><span> </span><span class="inner_quoted"><span>"_f"</span></span><span> </span><span class="entity"><span>s</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Expected floating point suffixed operation [_d,_f]: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>feature_check_union</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>llc_compile_union</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Union aggregate type is experimental and disabled! declare [[llc_compile_union=true]] to enable!"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
              
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>arith_instr_builder</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_arith_instr</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>arith_instr_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"arith_instr_builder: invalid arguments"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>farith_instr_builder</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_arith_instr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unsuffix_float_instr</span></span><span> </span><span class="entity"><span>iname</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>farith_instr_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"farith_instr_builder: invalid arguments"</span></span><span>
            
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>icmp_instr_builder</span></span><span> </span><span class="entity"><span>cmpcode</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_icmp_instr</span></span><span> </span><span class="entity"><span>cmpcode</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>icmp_instr_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"icmp_instr_builder: invalid arguments"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fcmp_instr_builder</span></span><span> </span><span class="entity"><span>cmpcode</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_fcmp_instr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unsuffix_float_instr</span></span><span> </span><span class="entity"><span>cmpcode</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fcmp_instr_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"fcmp_instr_builder: invalid arguments"</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ptrcmp_instr_builder</span></span><span> </span><span class="entity"><span>cmpcode</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_ptrcmp_instr</span></span><span> </span><span class="entity"><span>cmpcode</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ptrcmp_instr_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"icmp_instr_builder: invalid arguments"</span></span><span>
            
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conv_instr_builder</span></span><span> </span><span class="entity"><span>cmpcode</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOType</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_conv_instr</span></span><span> </span><span class="entity"><span>cmpcode</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>conv_instr_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"conv_instr_builder: invalid arguments"</span></span><span>

      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_value_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_extractvalue</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_value_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"extract_value_builder: invalid arguments"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_value_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_insertvalue</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>insert_value_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"insert_value_builder: invalid arguments"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_union_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOType</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>feature_check_union</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_make_union</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_union_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"make_union_builder: invalid arguments"</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_union_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>feature_check_union</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_dest_union</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_union_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"make_union_builder: invalid arguments"</span></span><span>
            
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>malloc_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOType</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_malloc</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>malloc_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"malloc_builder: invalid arguments"</span></span><span>
            
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>free_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_free</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>free_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"free_builder: invalid arguments"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_load</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"load_builder: invalid arguments"</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>store_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_store</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>store_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"store_builder: invalid arguments"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ofs_ptr_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_ofs_ptr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ofs_ptr_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"ofs_ptr_builder: invalid arguments"</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gep_idx_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>LLVM_Builder.mk_gep_idx</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gep_idx_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"gep_idx_builder: invalid arguments"</span></span><span>

      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intrinsic_builder</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op'_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_external_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>LLVM_Builder</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ll_t_2xdouble</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkty_vector</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>mkty_double</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ll_zeroinit_2xdouble</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkc_zeroinit</span></span><span> </span><span class="entity"><span>ll_t_2xdouble</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ll_t_4xfloat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkty_vector</span></span><span> </span><span class="inner_numeral"><span>4</span></span><span> </span><span class="entity"><span>mkty_float</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ll_zeroinit_4xfloat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkc_zeroinit</span></span><span> </span><span class="entity"><span>ll_t_4xfloat</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_to_vector_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_insertelement</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"mmx_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ll_zeroinit_2xdouble</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>64</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_from_vector_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_extractelement</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>64</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_to_vector_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_insertelement</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"mmx_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ll_zeroinit_4xfloat</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_from_vector_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_extractelement</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert_avx512f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>llc_compile_avx512f</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"AVX512f support is experimental and disabled! Declare [[llc_compile_avx512f=true]] to enable!"</span></span><span>
                  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_op_to_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>llc_to_vector_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span>          
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_op'_to_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op'_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>llc_to_vector_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span>          

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_op_to_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>llc_to_vector_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span>          
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llc_op'_to_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op'_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>llc_to_vector_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span>          
                      
      </span><span class="comment1"><span>(* {add, sub, mul, div} r x1 x2 → llvm.x86.avx512.mask.XXX.sd.round x1 x2 0 -1 r *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>avx512_asmd_sd_round_intrinsic_builder</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_avx512f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unsuffix</span><span> </span><span class="inner_quoted"><span>"_sd_round"</span></span><span> </span><span class="entity"><span>iname</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"llvm.x86.avx512.mask."</span></span><span>^</span><span class="entity"><span>iname</span></span><span>^</span><span class="inner_quoted"><span>".sd.round"</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rounding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="entity"><span>rounding</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mask</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cop</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cop</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ll_zeroinit_2xdouble</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mask</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>       </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>                 </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>  </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"immarg"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>]</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_external_call_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"mmx_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ll_t_2xdouble</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>llc_from_vector_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span>
                
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>avx512_asmd_sd_round_intrinsic_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"avx512_asmd_sd_round_intrinsic_builder: invalid arguments"</span></span><span>
      
      </span><span class="comment1"><span>(* sqrt r x → llvm.x86.avx512.mask.sqrt.sd x x 0 -1 r   *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>avx512_sqrt_sd_round_intrinsic_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_avx512f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"llvm.x86.avx512.mask.sqrt.sd"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mask</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rounding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="entity"><span>rounding</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>ll_zeroinit_2xdouble</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mask</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>]</span></span><span>      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"immarg"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>]</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_external_call_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"mmx_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ll_t_2xdouble</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>llc_from_vector_2xdouble_sd</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span>
              
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>avx512_sqrt_sd_round_intrinsic_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"avx512_sqrt_sd_round_intrinsic_builder: invalid arguments"</span></span><span>

      </span><span class="comment1"><span>(* fmadd r x1 x2 x3 → llvm.x86.avx512.vfmadd.f64 x1 x2 x3 r *)</span></span><span>      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>avx512_vfmadd_f64_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x3</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_avx512f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"llvm.x86.avx512.vfmadd.f64"</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rounding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="entity"><span>rounding</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>cop</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span class="entity"><span>x2</span></span><span class="main"><span>,</span></span><span class="entity"><span>x3</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rounding</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"immarg"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>]</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_external_call_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_double</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>avx512_vfmadd_f64_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"avx512_vfmadd_f64_builder: invalid arguments"</span></span><span>
      

      </span><span class="comment1"><span>(* {add, sub, mul, div} r x1 x2 → llvm.x86.avx512.mask.XXX.ss.round x1 x2 0 -1 r *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>avx512_asmd_ss_round_intrinsic_builder</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_avx512f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unsuffix</span><span> </span><span class="inner_quoted"><span>"_ss_round"</span></span><span> </span><span class="entity"><span>iname</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"llvm.x86.avx512.mask."</span></span><span>^</span><span class="entity"><span>iname</span></span><span>^</span><span class="inner_quoted"><span>".ss.round"</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rounding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="entity"><span>rounding</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mask</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cop</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cop</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ll_zeroinit_4xfloat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mask</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>       </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>                 </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>  </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"immarg"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>]</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_external_call_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"mmx_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ll_t_4xfloat</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>llc_from_vector_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span>
                
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>avx512_asmd_ss_round_intrinsic_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"avx512_asmd_ss_round_intrinsic_builder: invalid arguments"</span></span><span>
      
      </span><span class="comment1"><span>(* sqrt r x → llvm.x86.avx512.mask.sqrt.ss x x 0 -1 r   *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>avx512_sqrt_ss_round_intrinsic_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_avx512f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"llvm.x86.avx512.mask.sqrt.ss"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mask</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rounding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="entity"><span>rounding</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>ll_zeroinit_4xfloat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mask</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>]</span></span><span>      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"immarg"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>]</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_external_call_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"mmx_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ll_t_4xfloat</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>llc_from_vector_4xfloat_ss</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span>
              
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>avx512_sqrt_ss_round_intrinsic_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"avx512_sqrt_ss_round_intrinsic_builder: invalid arguments"</span></span><span>

      </span><span class="comment1"><span>(* fmadd r x1 x2 x3 → llvm.x86.avx512.vfmadd.f32 x1 x2 x3 r *)</span></span><span>      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>avx512_vfmadd_f32_builder</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>OOCIdx</span></span><span> </span><span class="entity"><span>rounding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>OOOp</span></span><span> </span><span class="entity"><span>x3</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_avx512f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"llvm.x86.avx512.vfmadd.f32"</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rounding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkc_iw</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span> </span><span class="entity"><span>rounding</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>cop</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x1</span></span><span class="main"><span>,</span></span><span class="entity"><span>x2</span></span><span class="main"><span>,</span></span><span class="entity"><span>x3</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rounding</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"immarg"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>]</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_external_call_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_float</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>avx512_vfmadd_f32_builder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"avx512_vfmadd_f32_builder: invalid arguments"</span></span><span>
      
      
                  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>:</span></span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>:</span></span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_prfx_builder</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>|&gt;</span><span> </span><span>unprefix</span><span> </span><span class="entity"><span>prfx</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>iname</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>n</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>builders</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_prfx_builder</span></span><span> </span><span class="inner_quoted"><span>"ll_"</span></span><span> </span><span class="entity"><span>arith_instr_builder</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_add|const"><span>ll_add</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_sub|const"><span>ll_sub</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_mul|const"><span>ll_mul</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
           </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_udiv|const"><span>ll_udiv</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_urem|const"><span>ll_urem</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_sdiv|const"><span>ll_sdiv</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_srem|const"><span>ll_srem</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
           </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_shl|const"><span>ll_shl</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_lshr|const"><span>ll_lshr</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_ashr|const"><span>ll_ashr</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
           </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_and|const"><span>ll_and</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_or|const"><span>ll_or</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_xor|const"><span>ll_xor</span></a><span class="antiquote"><span>}</span></span></span><span>
          </span><span class="main"><span>]</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_prfx_builder</span></span><span> </span><span class="inner_quoted"><span>"ll_"</span></span><span> </span><span class="entity"><span>farith_instr_builder</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="main"><span>[</span></span><span>
           </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fadd_d|const"><span>ll_fadd_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fsub_d|const"><span>ll_fsub_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fmul_d|const"><span>ll_fmul_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fdiv_d|const"><span>ll_fdiv_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_frem_d|const"><span>ll_frem_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
           </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fadd_f|const"><span>ll_fadd_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fsub_f|const"><span>ll_fsub_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fmul_f|const"><span>ll_fmul_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fdiv_f|const"><span>ll_fdiv_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_frem_f|const"><span>ll_frem_f</span></a><span class="antiquote"><span>}</span></span></span><span>
          </span><span class="main"><span>]</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_prfx_builder</span></span><span> </span><span class="inner_quoted"><span>"ll_"</span></span><span> </span><span class="entity"><span>conv_instr_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_trunc|const"><span>ll_trunc</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_sext|const"><span>ll_sext</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_zext|const"><span>ll_zext</span></a><span class="antiquote"><span>}</span></span></span><span>
          </span><span class="main"><span>]</span></span><span>  
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_prfx_builder</span></span><span> </span><span class="inner_quoted"><span>"ll_icmp_"</span></span><span> </span><span class="entity"><span>icmp_instr_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_icmp_eq|const"><span>ll_icmp_eq</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_icmp_ne|const"><span>ll_icmp_ne</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_icmp_slt|const"><span>ll_icmp_slt</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_icmp_sle|const"><span>ll_icmp_sle</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_icmp_ult|const"><span>ll_icmp_ult</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_icmp_ule|const"><span>ll_icmp_ule</span></a><span class="antiquote"><span>}</span></span></span><span> 
          </span><span class="main"><span>]</span></span><span>  
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_prfx_builder</span></span><span> </span><span class="inner_quoted"><span>"ll_fcmp_"</span></span><span> </span><span class="entity"><span>fcmp_instr_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_oeq_d|const"><span>ll_fcmp_oeq_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_one_d|const"><span>ll_fcmp_one_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_olt_d|const"><span>ll_fcmp_olt_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ogt_d|const"><span>ll_fcmp_ogt_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ole_d|const"><span>ll_fcmp_ole_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_oge_d|const"><span>ll_fcmp_oge_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ord_d|const"><span>ll_fcmp_ord_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>                                         
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ueq_d|const"><span>ll_fcmp_ueq_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_une_d|const"><span>ll_fcmp_une_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ult_d|const"><span>ll_fcmp_ult_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ugt_d|const"><span>ll_fcmp_ugt_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ule_d|const"><span>ll_fcmp_ule_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_uge_d|const"><span>ll_fcmp_uge_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_uno_d|const"><span>ll_fcmp_uno_d</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
             
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_oeq_f|const"><span>ll_fcmp_oeq_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_one_f|const"><span>ll_fcmp_one_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_olt_f|const"><span>ll_fcmp_olt_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ogt_f|const"><span>ll_fcmp_ogt_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ole_f|const"><span>ll_fcmp_ole_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_oge_f|const"><span>ll_fcmp_oge_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ord_f|const"><span>ll_fcmp_ord_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ueq_f|const"><span>ll_fcmp_ueq_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_une_f|const"><span>ll_fcmp_une_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ult_f|const"><span>ll_fcmp_ult_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ugt_f|const"><span>ll_fcmp_ugt_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_ule_f|const"><span>ll_fcmp_ule_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_uge_f|const"><span>ll_fcmp_uge_f</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> 
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_fcmp_uno_f|const"><span>ll_fcmp_uno_f</span></a><span class="antiquote"><span>}</span></span></span><span>
          </span><span class="main"><span>]</span></span><span>  
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_prfx_builder</span></span><span> </span><span class="inner_quoted"><span>"ll_ptrcmp_"</span></span><span> </span><span class="entity"><span>ptrcmp_instr_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>
             </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_ptrcmp_eq|const"><span>ll_ptrcmp_eq</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_ptrcmp_ne|const"><span>ll_ptrcmp_ne</span></a><span class="antiquote"><span>}</span></span></span><span>
          </span><span class="main"><span>]</span></span><span>  
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_value_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_extract_value|const"><span>ll_extract_value</span></a><span class="antiquote"><span>}</span></span></span><span>          
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insert_value_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_insert_value|const"><span>ll_insert_value</span></a><span class="antiquote"><span>}</span></span></span><span>          

        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_union_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_make_union|const"><span>ll_make_union</span></a><span class="antiquote"><span>}</span></span></span><span>          
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_union_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_dest_union|const"><span>ll_dest_union</span></a><span class="antiquote"><span>}</span></span></span><span>          
        
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>malloc_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_malloc|const"><span>ll_malloc</span></a><span class="antiquote"><span>}</span></span></span><span>          
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>free_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_free|const"><span>ll_free</span></a><span class="antiquote"><span>}</span></span></span><span>          
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>load_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_load|const"><span>ll_load</span></a><span class="antiquote"><span>}</span></span></span><span>          
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>store_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_store|const"><span>ll_store</span></a><span class="antiquote"><span>}</span></span></span><span>          
      
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ofs_ptr_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_ofs_ptr|const"><span>ll_ofs_ptr</span></a><span class="antiquote"><span>}</span></span></span><span>          
        </span><span class="comment1"><span>(*|&gt; register_builder (gep_idx_builder) @{const_name ll_gep_struct}          *)</span></span><span>
        
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intrinsic_builder</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_double</span></span><span> </span><span class="inner_quoted"><span>"llvm.sqrt.f64"</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_sqrt_f64|const"><span>ll_sqrt_f64</span></a><span class="antiquote"><span>}</span></span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intrinsic_builder</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_float</span></span><span> </span><span class="inner_quoted"><span>"llvm.sqrt.f32"</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_sqrt_f32|const"><span>ll_sqrt_f32</span></a><span class="antiquote"><span>}</span></span></span><span>
        
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_prfx_builder</span></span><span> </span><span class="inner_quoted"><span>"ll_x86_avx512_"</span></span><span> </span><span class="entity"><span>avx512_asmd_sd_round_intrinsic_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>
              </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_add_sd_round|const"><span>ll_x86_avx512_add_sd_round</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
              </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_sub_sd_round|const"><span>ll_x86_avx512_sub_sd_round</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
              </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_mul_sd_round|const"><span>ll_x86_avx512_mul_sd_round</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
              </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_div_sd_round|const"><span>ll_x86_avx512_div_sd_round</span></a><span class="antiquote"><span>}</span></span></span><span>
          </span><span class="main"><span>]</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>avx512_sqrt_sd_round_intrinsic_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_sqrt_sd|const"><span>ll_x86_avx512_sqrt_sd</span></a><span class="antiquote"><span>}</span></span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>avx512_vfmadd_f64_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_vfmadd_f64|const"><span>ll_x86_avx512_vfmadd_f64</span></a><span class="antiquote"><span>}</span></span></span><span>
        
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_prfx_builder</span></span><span> </span><span class="inner_quoted"><span>"ll_x86_avx512_"</span></span><span> </span><span class="entity"><span>avx512_asmd_ss_round_intrinsic_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>
              </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_add_ss_round|const"><span>ll_x86_avx512_add_ss_round</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
              </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_sub_ss_round|const"><span>ll_x86_avx512_sub_ss_round</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
              </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_mul_ss_round|const"><span>ll_x86_avx512_mul_ss_round</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
              </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_div_ss_round|const"><span>ll_x86_avx512_div_ss_round</span></a><span class="antiquote"><span>}</span></span></span><span>
          </span><span class="main"><span>]</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>avx512_sqrt_ss_round_intrinsic_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_sqrt_ss|const"><span>ll_x86_avx512_sqrt_ss</span></a><span class="antiquote"><span>}</span></span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>register_builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>avx512_vfmadd_f32_builder</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="LLVM_Shallow.html#LLVM_Shallow.ll_x86_avx512_vfmadd_f32|const"><span>ll_x86_avx512_vfmadd_f32</span></a><span class="antiquote"><span>}</span></span></span><span>
            

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vtab_bind</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>dst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dst</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vtab</span></span><span>  
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vtab_bind</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>dst</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Void instruction bound to value ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>dst</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>") "</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vtab_bind</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_instr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iname</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bld</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>builders</span></span><span> </span><span class="entity"><span>iname</span></span><span> 
          </span><span>|&gt;</span><span> </span><span class="entity"><span>the_assert</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown instruction "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>iname</span></span><span class="main"><span>)</span></span><span>
          
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bld</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dstreg</span></span><span> </span><span class="entity"><span>dst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>vtab_bind</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_call</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="entity"><span>pname</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rty</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLVM_Builder.mk_call_void</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>pname</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dstreg</span></span><span> </span><span class="entity"><span>dst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>pname</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>

      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>vtab_bind</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_par_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty1</span></span><span class="main"><span>,</span></span><span class="entity"><span>pname1</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg1</span></span><span class="main"><span>,</span></span><span class="entity"><span>rty2</span></span><span class="main"><span>,</span></span><span class="entity"><span>pname2</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>llc_compile_par_call</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Parallel call is experimental and disabled! Declare [[llc_compile_par_call=true]] to enable!"</span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>arg1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>arg2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty2</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_par_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dstreg</span></span><span> </span><span class="entity"><span>dst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rty1</span></span><span> </span><span class="entity"><span>pname1</span></span><span> </span><span class="entity"><span>arg1</span></span><span> </span><span class="entity"><span>rty2</span></span><span> </span><span class="entity"><span>pname2</span></span><span> </span><span class="entity"><span>arg2</span></span><span>
          </span><span>|&gt;</span><span> </span><span>SOME</span><span>

      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>vtab_bind</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      
            
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_if</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>op_cond</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blk_then</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blk_else</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_then</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.variant_label</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="inner_quoted"><span>"then"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_else</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.variant_label</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="inner_quoted"><span>"else"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_ctd_if</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.variant_label</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="inner_quoted"><span>"ctd_if"</span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_cbr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>op_cond</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l_then</span></span><span> </span><span class="entity"><span>l_else</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_then</span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_then</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>blk_then</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_then'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_br</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_ctd_if</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_else</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_else</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>blk_else</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_else'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_br</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_ctd_if</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_ctd_if</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r_then</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r_else</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>r_then</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>r_else</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LLVM_Builder.mk_phi'</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dstreg</span></span><span> </span><span class="entity"><span>dst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>r_then</span></span><span class="main"><span>,</span></span><span class="entity"><span>l_then'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r_else</span></span><span class="main"><span>,</span></span><span class="entity"><span>l_else'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"If type mismatch (void/non-void)"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>vtab_bind</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="comment1"><span>(*
        "while [x] cond body s" is compiled to
      
        br start (in l_this)
        
        start:
          %s = Phi (l_this,%s) (l_body',%s')
          %b = ⟦cond⟧(x↦%s)
          cbr %b body end
      
        body:
          %s' = ⟦body⟧(x↦%s)
          br start (in l_body')
          
        end:
          (returns %s)

      *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_while</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blk_cond</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blk_body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>op_init</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>llc_compile_while</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Direct while compilation disabled! Declare [[llc_compile_while=true]] to enable!"</span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_start</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.variant_label</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="inner_quoted"><span>"while_start"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.variant_label</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="inner_quoted"><span>"while_body"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_end</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.variant_label</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="inner_quoted"><span>"while_end"</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v_init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>op_init</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_this</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_br</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_start</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>sname</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sv</span></span><span>
        
        </span><span class="comment1"><span>(* start: *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_start</span></span><span>
        
        </span><span class="comment1"><span>(* s = Φ [v_init,this] […] *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_handle</span></span><span class="main"><span>,</span></span><span class="entity"><span>v_state</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_phi</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>s_ty</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>sname</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.phi_add</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>phi_handle</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v_init</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l_this</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vtab'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vtab_bind</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>sname</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v_state</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
        
        </span><span class="comment1"><span>(* cond *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_cond</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab'</span></span><span> </span><span class="entity"><span>blk_cond</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_cond</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>r_cond</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"While (bug): Cond-block with no result"</span></span><span>
        
        </span><span class="comment1"><span>(* cbr r_cond body end *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_cbr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>r_cond</span></span><span> </span><span class="entity"><span>l_body</span></span><span> </span><span class="entity"><span>l_end</span></span><span>
        
        </span><span class="comment1"><span>(* body: *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_body</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab'</span></span><span> </span><span class="entity"><span>blk_body</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>r_body</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"While (bug): Body-block with no result"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l_body'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_br</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_start</span></span><span>
        
        </span><span class="comment1"><span>(* add [r_body,l_body'] to Φ-node of l_start *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.phi_add</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>phi_handle</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r_body</span></span><span class="main"><span>,</span></span><span class="entity"><span>l_body'</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>l_end</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>vtab_bind</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v_state</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vtab</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmInstr</span></span><span> </span><span class="entity"><span>ia</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_instr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>ia</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>build_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmCall</span></span><span> </span><span class="entity"><span>na</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>na</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>build_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmIf</span></span><span> </span><span class="entity"><span>bte</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_if</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>bte</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>build_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmWhile</span></span><span> </span><span class="entity"><span>cbi</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_while</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>cbi</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>build_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CmPar</span></span><span> </span><span class="entity"><span>na</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_par_call</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>na</span></span><span>
            
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BlBind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dst</span></span><span class="main"><span>,</span></span><span class="entity"><span>cmd</span></span><span class="main"><span>,</span></span><span class="entity"><span>blk</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>dst</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_cmd</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>cmd</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>blk</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BlReturn</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_op_to_val</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span>
              
        
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_eqn</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EQN</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blk</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rty</span></span><span>
          
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>paramsv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.open_proc</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>pname</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update_new</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>paramsv</span></span><span class="main"><span>)</span></span><span> </span><span>Symtab.empty</span><span>
            
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>retv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>build_block</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>vtab</span></span><span> </span><span class="entity"><span>blk</span></span><span>
            
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mk_return</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>retv</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.close_proc</span></span><span> </span><span class="entity"><span>b</span></span><span>
            
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>build_eqn</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EXT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rty</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.decl_ext_fun</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>pname</span></span><span> </span><span class="entity"><span>params</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> 

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ftys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ltys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>llc_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ftys</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.mkty_struct</span></span><span> </span><span class="entity"><span>ltys</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>LLVM_Builder.decl_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>sty</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>init_attributes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"strictfp"</span></span><span class="main"><span>]</span></span><span>
        </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>llc_compile_avx512f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"\"target-features\"=\"+avx512f\""</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.declare_every_proc_attributes</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>b</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_to_llvm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys</span></span><span class="main"><span>,</span></span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.builder</span></span><span> </span><span class="entity"><span>LLVM_Builder.target_x86_64_linux</span></span><span> </span><span class="comment1"><span>(* TODO: Let user choose and define targets! *)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>init_attributes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        
        </span><span class="comment1"><span>(* val _ = LLVM_Builder.set_dbg_trace b true *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>build_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>build_eqn</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder.string_of</span></span><span> </span><span class="entity"><span>b</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       
  ›</span></span><span>  

  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹ </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Simple_PP</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Empty</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Word</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NWord</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Space</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> bool </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Newline</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> bool </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Block</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * T list

    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>last_tk</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NL</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>WR</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NW</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SP</span></span><span> </span><span class="comment1"><span>(* Newline | word | nonword | space *)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>last_tk</span></span><span>  </span><span class="comment1"><span>(* indentation, last token *)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init_state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span class="entity"><span>NL</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>indentS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"  "</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spaceS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newlineS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>indentation</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>implode</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>indentS</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Word</span></span><span> </span><span class="entity"><span>kw</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NL</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indentation</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>kw</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>WR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Word</span></span><span> </span><span class="entity"><span>kw</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>WR</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spaceS</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>kw</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>WR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Word</span></span><span> </span><span class="entity"><span>kw</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NW</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kw</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>WR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Word</span></span><span> </span><span class="entity"><span>kw</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>SP</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kw</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>WR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NWord</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NL</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indentation</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NW</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NWord</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>WR</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NW</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NWord</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NW</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NW</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NWord</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>SP</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NW</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Newline</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newlineS</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NL</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Newline</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NL</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NL</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Newline</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newlineS</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NL</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Space</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spaceS</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>SP</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Space</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>NL</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>SP</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Space</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>SP</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>SP</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Space</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spaceS</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>SP</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Empty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>ltk</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>ltk</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Block</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ii</span></span><span class="main"><span>,</span></span><span class="entity"><span>tks</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>lt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strs</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="entity"><span>tks</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="entity"><span>ii</span></span><span class="main"><span>,</span></span><span class="entity"><span>lt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>implode</span><span> </span><span class="entity"><span>strs</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>str</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>lt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
    </span><span class="comment1"><span>(* User Interface *)</span></span><span>    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of</span></span><span> </span><span class="entity"><span>tk</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>string_of'</span></span><span> </span><span class="entity"><span>tk</span></span><span> </span><span class="entity"><span>init_state</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span>
            
    </span><span class="comment1"><span>(* Basic Functions *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Empty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Word</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nword</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NWord</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>brk</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Newline</span></span><span> </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fbrk</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Newline</span></span><span> </span><span>true</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Space</span></span><span> </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fsep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Space</span></span><span> </span><span>true</span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>block_indent</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>tks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Block</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>tks</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block_indent</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
    
    </span><span class="comment1"><span>(* Derived Functions *)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>enclose_indent</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>lpar</span></span><span> </span><span class="entity"><span>rpar</span></span><span> </span><span class="entity"><span>prt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block_indent</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>nword</span></span><span> </span><span class="entity"><span>lpar</span></span><span class="main"><span>,</span></span><span class="entity"><span>prt</span></span><span class="main"><span>,</span></span><span class="entity"><span>nword</span></span><span> </span><span class="entity"><span>rpar</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>line</span></span><span> </span><span class="entity"><span>prts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prts</span></span><span>@</span><span class="main"><span>[</span></span><span class="entity"><span>fbrk</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>enclose</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>enclose_indent</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>paren</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>enclose</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>braces</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>enclose</span></span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>big_block</span></span><span> </span><span class="entity"><span>lpar</span></span><span> </span><span class="entity"><span>rpar</span></span><span> </span><span class="entity"><span>prts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>block_indent</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nword</span></span><span> </span><span class="entity"><span>lpar</span></span><span>::</span><span class="entity"><span>brk</span></span><span>::</span><span class="entity"><span>prts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>brk</span></span><span class="main"><span>,</span></span><span class="entity"><span>nword</span></span><span> </span><span class="entity"><span>rpar</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>big_braces</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>big_block</span></span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>separate</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>prts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>(</span></span><span>Library.separate</span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>prts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>commas</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>separate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nword</span></span><span> </span><span class="inner_quoted"><span>","</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>brks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>separate</span></span><span> </span><span class="entity"><span>brk</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fbrks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>separate</span></span><span> </span><span class="entity"><span>fbrk</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>lpar</span></span><span> </span><span class="entity"><span>rpar</span></span><span> </span><span class="entity"><span>prts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>enclose</span></span><span> </span><span class="entity"><span>lpar</span></span><span> </span><span class="entity"><span>rpar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>separate</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>prts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parlist</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nword</span></span><span> </span><span class="inner_quoted"><span>", "</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="main"><span>(</span></span><span>Int.toString</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="comment1"><span>(* enclose, enclose_indent, separate, ... *)</span></span><span>
  
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  ›</span></span><span>
  
  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Parser_Util</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>RESET_VALUE</span></span><span> </span><span class="entity"><span>atom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*required for all primitive parsers*)</span></span><span>
      </span><span>Scan.ahead</span><span> </span><span class="main"><span>(</span></span><span>Scan.one</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>atom</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Token.assign</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kind_with</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RESET_VALUE</span></span><span> </span><span class="main"><span>(</span></span><span>Scan.one</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tk</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Token.is_kind</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>tk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span>Token.content_of</span><span> </span><span class="entity"><span>tk</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>Token.content_of</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> 
      
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ident_with</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind_with</span></span><span> </span><span>Token.Ident</span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>scan_if_then_else</span></span><span> </span><span class="entity"><span>scan1</span></span><span> </span><span class="entity"><span>scan2</span></span><span> </span><span class="entity"><span>scan3</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Scan.catch</span><span> </span><span class="entity"><span>scan1</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>scan3</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>scan2</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>xs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    

    </span><span class="comment1"><span>(* Choices, where first parser's success commits to this choice *)</span></span><span>  
    </span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> |||

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>|||</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>scan_if_then_else</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>e</span></span><span>
        
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lastg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span>:|--</span><span> </span><span class="entity"><span>p</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pkw</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.keyword_markup</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span>Markup.keyword1</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.keyword_markup</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span>Markup.keyword2</span><span class="main"><span>)</span></span><span>

    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_inner</span></span><span> </span><span class="entity"><span>kws</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>cartouche</span><span> </span><span>|&gt;</span><span> </span><span>Symbol_Pos.explode</span><span> </span><span>|&gt;</span><span> </span><span>Symbol_Pos.cartouche_content</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kws</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kws</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>Keyword.no_spec</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kws</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Keyword.add_keywords</span><span> </span><span class="entity"><span>kws</span></span><span> </span><span>Keyword.empty_keywords</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>Token.tokenize</span><span> </span><span class="entity"><span>kws</span></span><span> </span><span class="main"><span>{</span></span><span>strict</span><span class="main"><span>=</span></span><span>true</span><span class="main"><span>}</span></span><span> 
      </span><span class="comment1"><span>(*val _ = map (Token.reports kws) tks |&gt; flat*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span>Token.is_proper</span><span> </span><span class="entity"><span>tks</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_all</span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Token.init_assignable</span><span> </span><span class="entity"><span>src</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.catch</span><span> </span><span class="main"><span>(</span></span><span>Scan.finite</span><span> </span><span>Token.stopper</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span>--|</span><span> </span><span>Scan.ahead</span><span> </span><span>Parse.eof</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>src</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Token.reports_of_value</span><span> </span><span class="entity"><span>src</span></span><span> </span><span>|&gt;</span><span> </span><span>flat</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context_Position.reports</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rp</span></span><span>
        
        </span><span class="comment1"><span>(*val _ = map Token.reports_of_value src |&gt; flat*)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>res</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_all</span></span><span> </span><span class="entity"><span>tks</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>res</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                                              
        
    
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>›</span></span><span> 
               
  
  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>C_Interface</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cprim</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>PRIM_CHAR</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_UI8</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_SI16</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_UI16</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_SI32</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_UI32</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_SI64</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_UI64</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_FLOAT</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PRIM_DOUBLE</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cfield</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FLD_NAMED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ctype * string </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>FLD_ANON</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> cfield list
         </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>ctype</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span class="entity"><span>CTY_PRIM</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> cprim 
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CTY_PTR</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ctype            
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> cfield list
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CTY_NAMED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CTY_UNION</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> cfield list
  
         
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>typedef</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * ctype
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_tydef</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_tydef</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TYPEDEF</span></span><span>

    </span><span class="comment1"><span>(* Signature *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>c_sig</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CSIG</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ctype option * string * ctype list 
    
    </span><span class="comment1"><span>(* Optional types, not all info needs to be specified *)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cfieldo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ctypeo option * string option
         </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>ctypeo</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> cprim 
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CTYO_PTR</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ctypeo
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> cfieldo list
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> cfieldo list
  
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>crtypeo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CRTYO_UNSPEC</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CRTYO_VOID</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CRTYO_TY</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ctypeo         
            
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>typedefo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TYPEDEFO</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * ctypeo
    
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>c_sigo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CSIGO</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> crtypeo * string option * ctypeo option list option
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_tydefo</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TYPEDEFO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_tydefo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TYPEDEFO</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of_sig</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CSIGO</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of_sig</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Signature must have name"</span></span><span>
    
         
    </span><span class="comment1"><span>(* Parsing *)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Parser_Util</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    
      </span><span class="comment1"><span>(* TODO: Check for valid C identifier *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.short_ident</span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_cprim</span></span><span> </span><span class="main"><span>=</span></span><span> 
         </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"char"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_CHAR</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"int8_t"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"int16_t"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_SI16</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"int32_t"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_SI32</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"int64_t"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_SI64</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"uint8_t"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_UI8</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"uint16_t"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_UI16</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"uint32_t"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_UI32</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"uint64_t"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_UI64</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"float"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_FLOAT</span></span><span>
      </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"double"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PRIM_DOUBLE</span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ptr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_ptr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PTR</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ptr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_cfield</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
           </span><span class="entity"><span>parse_ctype</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="entity"><span>parse_id</span></span><span> </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>";"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>FLDO_NAMED</span></span><span>
        </span><span class="comment1"><span>(*|| parse_fld_struct --| Parse.$$$ ";" &gt;&gt; FLDO_ANON*)</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>parse_fld_struct</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pkw</span></span><span> </span><span class="inner_quoted"><span>"struct"</span></span><span> </span><span>|--</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span class="entity"><span>parse_cfield</span></span><span> </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>"}"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>parse_fld_union</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pkw</span></span><span> </span><span class="inner_quoted"><span>"union"</span></span><span> </span><span>|--</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span class="entity"><span>parse_cfield</span></span><span> </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>"}"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>parse_ctype1</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
           </span><span class="entity"><span>parse_cprim</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>CTYO_PRIM</span></span><span>
        </span><span>||</span><span> </span><span class="entity"><span>parse_id</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>CTYO_NAMED</span></span><span>   
        </span><span>||</span><span> </span><span class="entity"><span>parse_fld_struct</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>CTYO_STRUCT</span></span><span>
        </span><span>||</span><span> </span><span class="entity"><span>parse_fld_union</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>CTYO_UNION</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>parse_ctype_noauto</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_ctype1</span></span><span> </span><span>--</span><span> </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>"*"</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>ptrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ptr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ptrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>parse_ctype</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
           </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"auto"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        </span><span>||</span><span> </span><span>Parse.underscore</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        </span><span>||</span><span> </span><span class="entity"><span>parse_ctype_noauto</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
         
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_rtype</span></span><span> </span><span class="main"><span>=</span></span><span> 
           </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"auto"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>CRTYO_UNSPEC</span></span><span> 
        </span><span>||</span><span> </span><span>Parse.underscore</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>CRTYO_UNSPEC</span></span><span> 
        </span><span>||</span><span> </span><span class="entity"><span>pcm</span></span><span> </span><span class="inner_quoted"><span>"void"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>CRTYO_VOID</span></span><span>
        </span><span>||</span><span> </span><span class="entity"><span>parse_ctype_noauto</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>CRTYO_TY</span></span><span> 
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_typedef</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pkw</span></span><span> </span><span class="inner_quoted"><span>"typedef"</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>parse_ctype_noauto</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_id</span></span><span> </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>";"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_tydefo</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_typedefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.repeat</span><span> </span><span class="entity"><span>parse_typedef</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>long_sig</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rt</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CSIGO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rt</span></span><span class="main"><span>,</span></span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_wildcard</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.underscore</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>NONE</span><span> </span><span>||</span><span> </span><span class="entity"><span>p</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_parlist</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>|--</span><span> </span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="entity"><span>parse_ctype</span></span><span> </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_short_sig</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_id</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>CSIGO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CRTYO_UNSPEC</span></span><span class="main"><span>,</span></span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_long_sig</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="entity"><span>parse_rtype</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_id</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_wildcard</span></span><span> </span><span class="entity"><span>parse_parlist</span></span><span> 
        </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>long_sig</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_sig</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_long_sig</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>parse_short_sig</span></span><span>
            
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
    
    
    
    
    
    </span><span class="comment1"><span>(* Checking *)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct_basic_kws</span></span><span> </span><span class="main"><span>=</span></span><span>       </span><span class="main"><span>[</span></span><span>
      </span><span class="inner_quoted"><span>"auto"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"break"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"case"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"char"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"const"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"continue"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"default"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"do"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"double"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"else"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"enum"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"extern"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"float"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"for"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"goto"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"if"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"inline"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"int"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"long"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"register"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"restrict"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"return"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"short"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"signed"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"sizeof"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"static"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"struct"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"switch"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"typedef"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"union"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"unsigned"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"void"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"volatile"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"while"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Alignas"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Alignof"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Atomic"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Bool"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Complex"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Generic"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Imaginary"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Noreturn"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Static_assert"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="inner_quoted"><span>"_Thread_local"</span></span><span>
    </span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct_basic_kw_set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.make_set</span><span> </span><span class="entity"><span>ct_basic_kws</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct_kws</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"{"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"}"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"*"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>","</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(* TODO: Complete this list *)</span></span><span>      
    </span><span>@</span><span>
    </span><span class="entity"><span>ct_basic_kws</span></span><span>
    </span><span>@</span><span>
    </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"int8_t"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"int16_t"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"int32_t"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"int64_t"</span></span><span class="main"><span>,</span></span><span>
     </span><span class="inner_quoted"><span>"uint8_t"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"uint16_t"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"uint32_t"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"uint64_t"</span></span><span class="main"><span>]</span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ct_kws_context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.make_context</span><span> </span><span class="entity"><span>ct_kws</span></span><span>
     
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_cid_start</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symbol.is_ascii_letter</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"_"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_cid_ctd</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_cid_start</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Symbol.is_ascii_digit</span><span> </span><span class="entity"><span>s</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_c_identifier</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>size</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_cid_start</span></span><span> </span><span class="main"><span>(</span></span><span>String.substring</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
      </span><span>forall_string</span><span> </span><span class="entity"><span>is_cid_ctd</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
      </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Symtab.defined</span><span> </span><span class="entity"><span>ct_basic_kw_set</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
         
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_identifier</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_c_identifier</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid identifier "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_decl</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.defined</span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Undeclared type "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_type</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_NAMED</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_decl</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PRIM</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_type</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PTR</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_type</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_type</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_field</span></span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_type</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_UNION</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_field</span></span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>check_field</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_type</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>check_identifier</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_field</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_ANON</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_field</span></span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clookup</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Undeclared type: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>  

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_ctab</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_tydef</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Duplicate typedef "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctab</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>fold</span><span> </span><span class="entity"><span>add_tydef</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span>Symtab.empty</span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_indirect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span>@</span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>join_di</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span>@</span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span>@</span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flat_dis</span></span><span> </span><span class="entity"><span>dis</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>join_di</span></span><span> </span><span class="entity"><span>dis</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cty_di_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_NAMED</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>n</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_di_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>cfld_di_names</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>flat_dis</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_di_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_UNION</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>cfld_di_names</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>flat_dis</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_di_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PTR</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cty_di_names</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_indirect</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_di_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PRIM</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>cfld_di_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cty_di_names</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cfld_di_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_ANON</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>cfld_di_names</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>flat_dis</span></span><span>
    
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cty_direct_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_NAMED</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>n</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_direct_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>cfld_direct_names</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span>|&gt;</span><span> </span><span>flat</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_direct_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_UNION</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>cfld_direct_names</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span>|&gt;</span><span> </span><span>flat</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_direct_names</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>cfld_direct_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cty_direct_names</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cfld_direct_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_ANON</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span>map</span><span> </span><span class="entity"><span>cfld_direct_names</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span>|&gt;</span><span> </span><span>flat</span><span>
        
          
          
          
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>order_tydefs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_ctab</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>dest_tydef</span></span><span> </span><span class="entity"><span>tydefs</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>succs_of_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_struct</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> 
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_indirect</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>is_struct</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span>
      
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cty_di_names</span></span><span> </span><span class="entity"><span>ty</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>succs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>filter_indirect</span></span><span> </span><span class="entity"><span>i</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>succs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            
      </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>OPEN</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CLOSED</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vset</span></span><span class="main"><span>,</span></span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>vset</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span>SOME</span><span> </span><span class="entity"><span>CLOSED</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vset</span></span><span class="main"><span>,</span></span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span> 
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>OPEN</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"C-Header: circular typedefs via "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>OPEN</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vset</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clookup</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>name</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>succs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>succs_of_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span>
            
            </span><span class="comment1"><span>(*val _ = (@{print} name, @{print} succs)*)</span></span><span>
            
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vset</span></span><span class="main"><span>,</span></span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>succs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vset</span></span><span class="main"><span>,</span></span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>CLOSED</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vset</span></span><span>
            
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>res</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>vset</span></span><span class="main"><span>,</span></span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>tydefs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.keys</span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.empty</span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>tydefs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>tydefs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
    
            
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_tdef_cycle</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clookup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clookup</span></span><span> </span><span class="entity"><span>ctab</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>OPEN</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CLOSE</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ccyc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_NAMED</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>OPEN</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>ccyc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clookup</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>CLOSE</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>OPEN</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Circular struct via "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>CLOSE</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>stab</span></span><span>
      </span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ccyc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>ccyc_fld</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>stab</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ccyc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_UNION</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>ccyc_fld</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>stab</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ccyc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PRIM</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stab</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ccyc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PTR</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stab</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> 
        </span><span class="entity"><span>ccyc_fld</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ccyc</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ccyc_fld</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_ANON</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>ccyc_fld</span></span><span> </span><span class="entity"><span>fs</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.dest</span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>snd</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>ccyc</span></span><span> </span><span class="entity"><span>decls</span></span><span>   
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
      

    </span><span class="comment1"><span>(*      
    fun is_valid_rty ctab (CTY_NAMED name) = 
          (case Symtab.lookup ctab name of NONE =&gt; false | SOME t =&gt; is_valid_rty ctab t)
      | is_valid_rty _ (CTY_PRIM _) = true
      | is_valid_rty _ (CTY_PTR _) = true
      | is_valid_rty _ (CTY_STRUCT _) = false
    
    fun check_valid_rty dd t = (is_valid_rty dd t orelse error "Aggregate return type not supported by C"; ())  
    *)</span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_allowed_ty</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_NAMED</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_allowed_ty</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_allowed_ty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PRIM</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_allowed_ty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PTR</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_allowed_ty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_allowed_ty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_UNION</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_allowed_ty</span></span><span> </span><span class="entity"><span>dd</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_allowed_ty</span></span><span> </span><span class="entity"><span>dd</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: struct argument or return types in LLVM not compatible with C-ABI!"</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_rtype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_rtype</span></span><span> </span><span class="entity"><span>dd</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_type</span></span><span> </span><span class="entity"><span>dd</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>check_allowed_ty</span></span><span> </span><span class="entity"><span>dd</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_csig</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CSIG</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>argtys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>check_rtype</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>check_identifier</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_type</span></span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>argtys</span></span><span class="main"><span>;</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_allowed_ty</span></span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>argtys</span></span><span class="main"><span>;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Signature "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span>
      
    
    </span><span class="comment1"><span>(* Check list of type definitions, and create lookup table *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_tydefs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>dest_tydef</span></span><span> </span><span class="entity"><span>tydefs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_identifier</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tydefs</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_ctab</span></span><span> </span><span class="entity"><span>tydefs</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_tdef_cycle</span></span><span> </span><span class="entity"><span>ctab</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_tydef</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>cty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_identifier</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>check_type</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>cty</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_tydef</span></span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tydefs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>ctab</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_tydefs_sigs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="entity"><span>sigs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_tydefs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_csig</span></span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sigs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
    
    </span><span class="comment1"><span>(* Printing *)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Simple_PP</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="comment1"><span>(* TODO: Rename _to_Cs ↦ pretty_ *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_CHAR</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"char"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"int8_t"</span></span><span> 
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_SI16</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"int16_t"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_SI32</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"int32_t"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_SI64</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"int64_t"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_UI8</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"uint8_t"</span></span><span> 
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_UI16</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"uint16_t"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_UI32</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"uint32_t"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_UI64</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"uint64_t"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_FLOAT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"float"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>PRIM_DOUBLE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"double"</span></span><span>
                                                  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cfield_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nword</span></span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>]</span></span><span>  
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cfield_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLD_ANON</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fldstruct_to_Cs</span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nword</span></span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>fldstruct_to_Cs</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"struct"</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>big_braces</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line</span></span><span> </span><span>o</span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>cfield_to_Cs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>fldunion_to_Cs</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"union"</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>big_braces</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line</span></span><span> </span><span>o</span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>cfield_to_Cs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PRIM</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cprim_to_Cs</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_PTR</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nword</span></span><span> </span><span class="inner_quoted"><span>"*"</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fldstruct_to_Cs</span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="entity"><span>fs</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_UNION</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fldunion_to_Cs</span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="entity"><span>fs</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTY_NAMED</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tydef_proto_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"typedef"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"struct"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nword</span></span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tydef_proto_to_Cs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tydef_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"typedef"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fldstruct_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nword</span></span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tydef_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>CTY_UNION</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"typedef"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fldunion_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nword</span></span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tydef_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"typedef"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nword</span></span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>]</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tydefs_proto_to_Cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fbrks</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>tydef_proto_to_Cs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tydefs_to_Cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fbrks</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>tydef_to_Cs</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rty_to_Cs</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"void"</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rty_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>csig_to_Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CSIG</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>partys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rty_to_Cs</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="entity"><span>fsep</span></span><span class="main"><span>,</span></span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>parlist</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>ctype_to_Cs</span></span><span> </span><span class="entity"><span>partys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>]</span></span><span>
                
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>csigs_to_Cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fbrks</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>csig_to_Cs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="comment1"><span>(* Conversion from optional to definitive C *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invent_fld_names</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.declare</span><span> </span><span class="entity"><span>n</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>fs</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>fs</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>

      </span><span class="comment1"><span>(* Create field names. 
        Special rule: anonymous structure and union fields stay anonymous 
      *)</span></span><span>    
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>amend</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>fld</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fld</span></span><span class="main"><span>,</span></span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>fld</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fld</span></span><span class="main"><span>,</span></span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"field"</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
              </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>fld</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fld</span></span><span class="main"><span>,</span></span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> 
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ct_kws_context</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>fs</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span>I</span><span> </span><span class="entity"><span>fs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>amend</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>context</span></span><span>
      
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>fs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTY_PRIM</span></span><span> </span><span class="entity"><span>p</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PTR</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTY_PTR</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="entity"><span>fso</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTY_STRUCT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fso_to_fs</span></span><span> </span><span class="entity"><span>fso</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTY_NAMED</span></span><span> </span><span class="entity"><span>n</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="entity"><span>fso</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTY_UNION</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fso_to_fs</span></span><span> </span><span class="entity"><span>fso</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>fso_to_fs</span></span><span> </span><span class="entity"><span>fso</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>invent_fld_names</span></span><span> </span><span class="entity"><span>fso</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>cfieldo_to_cfield</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>cfieldo_to_cfield</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"C-Header: incomplete type for field"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cfieldo_to_cfield</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="entity"><span>fso</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FLD_ANON</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>cfieldo_to_cfield</span></span><span> </span><span class="entity"><span>fso</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cfieldo_to_cfield</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="entity"><span>fso</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FLD_ANON</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>cfieldo_to_cfield</span></span><span> </span><span class="entity"><span>fso</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cfieldo_to_cfield</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"C-Header: incomplete name for field"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cfieldo_to_cfield</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cty</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FLD_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="entity"><span>cty</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>crtypeo_to_ctype</span></span><span> </span><span class="entity"><span>CRTYO_UNSPEC</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: unspecified return type"</span></span><span>  
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>crtypeo_to_ctype</span></span><span> </span><span class="entity"><span>CRTYO_VOID</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>crtypeo_to_ctype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CRTYO_TY</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cargo_to_carg</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: unspecified argument type"</span></span><span>  
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cargo_to_carg</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="entity"><span>ty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>csigo_to_csig</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CSIGO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>argtys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CSIG</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>crtypeo_to_ctype</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>cargo_to_carg</span></span><span> </span><span class="entity"><span>argtys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>csigo_to_csig</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: incomplete signature"</span></span><span>
      
  
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctdefo_to_ctdef</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TYPEDEFO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctypeo_to_ctype</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>   
          
    </span><span class="comment1"><span>(* Amending partial specification *)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_CHAR</span></span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_CHAR</span></span><span> </span><span class="entity"><span>PRIM_UI8</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_UI8</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span> </span><span class="entity"><span>PRIM_UI8</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_UI8</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span> </span><span class="entity"><span>PRIM_CHAR</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_CHAR</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_UI8</span></span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_UI8</span></span><span> </span><span class="entity"><span>PRIM_CHAR</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_CHAR</span></span><span>
    
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_SI16</span></span><span> </span><span class="entity"><span>PRIM_UI16</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_UI16</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_UI16</span></span><span> </span><span class="entity"><span>PRIM_SI16</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_SI16</span></span><span>
    
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_SI32</span></span><span> </span><span class="entity"><span>PRIM_UI32</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_UI32</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_UI32</span></span><span> </span><span class="entity"><span>PRIM_SI32</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_SI32</span></span><span>
      
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_SI64</span></span><span> </span><span class="entity"><span>PRIM_UI64</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_UI64</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>PRIM_UI64</span></span><span> </span><span class="entity"><span>PRIM_SI64</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PRIM_SI64</span></span><span>
      
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>=</span></span><span class="entity"><span>ta</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ta</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: declared type does not match"</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>amend_option</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_option</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span>  
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_option</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span>  
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_option</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>x'</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>amend_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>amend_option</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_named_override</span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PTR</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PTR</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>p'</span></span><span> </span><span class="entity"><span>stab</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>=</span></span><span class="entity"><span>n'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"C-Header: cannot override structure name: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" -&gt; "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>stab</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold2</span><span> </span><span class="entity"><span>chk_fld</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>fs'</span></span><span> </span><span class="entity"><span>stab</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold2</span><span> </span><span class="entity"><span>chk_fld</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>fs'</span></span><span> </span><span class="entity"><span>stab</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>stab</span></span><span> </span><span class="entity"><span>n'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clookup</span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stab</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tyy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyy</span></span><span class="main"><span>=</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: ambiguous named override"</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>stab</span></span><span class="main"><span>)</span></span><span>  
        </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="entity"><span>cty1</span></span><span> </span><span class="entity"><span>cty2</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"C-Header: mismatched named override "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>cty1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" --- "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>cty2</span></span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>chk_fld</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ty'</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_fld</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: incomplete or mismatching structure in named override"</span></span><span>
        
    
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>chk_ty</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_cprim</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PTR</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_PTR</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PTR</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span>length</span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>fs'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: declared number of fields do not match"</span></span><span class="main"><span>;</span></span><span>
          </span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_cfield</span></span><span> </span><span class="entity"><span>ctab'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span>length</span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>fs'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: declared number of fields do not match"</span></span><span class="main"><span>;</span></span><span>
          </span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_cfield</span></span><span> </span><span class="entity"><span>ctab'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="entity"><span>n</span></span><span class="main"><span>=</span></span><span class="entity"><span>n'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"C-Header: cannot override structure name: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" -&gt; "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n</span></span><span>
        </span><span class="main"><span>)</span></span><span> 
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span class="entity"><span>check_named_override</span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>n'</span></span><span> </span><span class="main"><span>)</span></span><span> 
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"C-Header: declared structure does not match"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>amend_cfield</span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="entity"><span>ctab'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>amend_name</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span>
          

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>amend_crtype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>CRTYO_UNSPEC</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_crtype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>CRTYO_UNSPEC</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_crtype</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CRTYO_TY</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CRTYO_TY</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CRTYO_TY</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_crtype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CRTYO_VOID</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CRTYO_VOID</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CRTYO_VOID</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>amend_crtype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"C-Header: return type mismatch"</span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_ctabo</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TYPEDEFO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Duplicate typdef: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
    
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span>Symtab.empty</span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
            
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>amend_typedefs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="entity"><span>tydefs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_ctabo</span></span><span> </span><span class="entity"><span>tydefs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctab'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_ctabo</span></span><span> </span><span class="entity"><span>tydefs'</span></span><span>
    
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Symtab.join</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="entity"><span>ctab'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctab'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
      
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>amend_sig</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CSIGO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>argtys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CSIGO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty'</span></span><span class="main"><span>,</span></span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span class="entity"><span>argtys'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nts</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nts</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>argtys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>argtys'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>xs'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"C-Header: ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>nts</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"): parameter number mismatch"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>   
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>CSIGO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_crtype</span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>amend_name</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>amend_option</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_option</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_ctype</span></span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>argtys</span></span><span> </span><span class="entity"><span>argtys'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
    
    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>LLC_Intermediate</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>      
      </span><span class="comment1"><span>(* Create initial optional specification from LLVM *)</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>PRIM_SI8</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="inner_numeral"><span>16</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>PRIM_SI16</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>PRIM_SI32</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="inner_numeral"><span>64</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>PRIM_SI64</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cty_of_lty: Unsupported integer width "</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>PRIM_FLOAT</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PRIM</span></span><span> </span><span class="entity"><span>PRIM_DOUBLE</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_PTR</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>cfld_of_lty</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TUnion</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_UNION</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>cfld_of_lty</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CTYO_NAMED</span></span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>cfld_of_lty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cty_of_rlty</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CRTYO_VOID</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cty_of_rlty</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>lty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CRTYO_TY</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="entity"><span>lty</span></span><span class="main"><span>)</span></span><span>
    
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>csig_of_eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EQN</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rlty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>largs</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
            </span><span class="entity"><span>CSIGO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cty_of_rlty</span></span><span> </span><span class="entity"><span>rlty</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span class="entity"><span>cty_of_lty</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>largs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>csig_of_eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EXT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rlty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>largs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>CSIGO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cty_of_rlty</span></span><span> </span><span class="entity"><span>rlty</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span class="entity"><span>cty_of_lty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>largs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cfield_of_lty</span></span><span> </span><span class="entity"><span>lty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FLDO_NAMED</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cty_of_lty</span></span><span> </span><span class="entity"><span>lty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctydef_of_llc_named</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ltys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="entity"><span>TYPEDEFO</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>CTYO_STRUCT</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>cfield_of_lty</span></span><span> </span><span class="entity"><span>ltys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        
        
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>    
    
    
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>›</span></span><span>
  
  
    
  
  
  
  </span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>LLC_HeaderGen</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>C_Interface</span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_raw_tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.position</span><span> </span><span>Parse.cartouche</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_raw_sig</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.position</span><span> </span><span class="main"><span>(</span></span><span>Parse.cartouche</span><span> </span><span>||</span><span> </span><span>Parse.short_ident</span><span> </span><span>||</span><span> </span><span>Parse.string</span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>check_raw_tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Parser_Util.parse_inner</span></span><span> </span><span class="entity"><span>ct_kws</span></span><span> </span><span class="entity"><span>parse_typedefs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>check_raw_sig</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Parser_Util.parse_inner</span></span><span> </span><span class="entity"><span>ct_kws</span></span><span> </span><span class="entity"><span>parse_sig</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_reachable_types</span></span><span> </span><span class="entity"><span>ntys</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>LLC_Intermediate</span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_nty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ftys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ftys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_ltab</span></span><span> </span><span class="entity"><span>ntys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.make</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>dest_nty</span></span><span> </span><span class="entity"><span>ntys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_nty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ftys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ftys</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ltab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_ltab</span></span><span> </span><span class="entity"><span>ntys</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>llookup</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>ltab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Undefined type: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rc_eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EQN</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rc_rty</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rc_eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>EXT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rc_rty</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>rc_rty</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rc_rty</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="entity"><span>tys</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TUnion</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="entity"><span>tys</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>tab</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>llookup</span></span><span> </span><span class="entity"><span>name</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>tab</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rc_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>fold</span><span> </span><span class="entity"><span>rc_eqn</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span>Symtab.empty</span><span>
      </span><span>|&gt;</span><span> </span><span>Symtab.dest</span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_nty</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_header</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span> 
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_header</span></span><span> </span><span class="entity"><span>hfname</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="entity"><span>named_types</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    
      </span><span class="comment1"><span>(* Strip down named types to what is reachable from signatures *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>named_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find_reachable_types</span></span><span> </span><span class="entity"><span>named_types</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span>
    
      </span><span class="comment1"><span>(* Create joint named type table *)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>ctydef_of_llc_named</span></span><span> </span><span class="entity"><span>named_types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>amend_typedefs</span></span><span> </span><span class="entity"><span>ctydefs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      </span><span class="comment1"><span>(* Create signatures from equations, and amend with declared signatures *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sigs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>csig_of_eqn</span></span><span> </span><span>#&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>amend_sig</span></span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span>
      
      </span><span class="comment1"><span>(* Convert optional type-table and signatures to definitive ones *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>ctdefo_to_ctdef</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_tydefo</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="entity"><span>ctab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sigs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>csigo_to_csig</span></span><span> </span><span class="entity"><span>sigs</span></span><span>

      </span><span class="comment1"><span>(* Order typedefs *)</span></span><span>
      </span><span class="comment1"><span>(*xxx: we must also consider *indirect* references!
        see bin_search, where typedef uint64 elem_t gets sorted to the end!
      *)</span></span><span>
        
        
        
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>order_tydefs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span>
      
      </span><span class="comment1"><span>(* Check consistency *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_tydefs_sigs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span> </span><span class="entity"><span>sigs</span></span><span>      
            
      </span><span class="comment1"><span>(* Print *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_hd_id</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symbol.explode</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="entity"><span>is_cid_ctd</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>Symbol.to_ascii_upper</span><span> </span><span>|&gt;</span><span> </span><span>implode</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_H"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
        
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hfname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_hd_id</span></span><span> </span><span class="entity"><span>hfname</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>h_to_C</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Simple_PP</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hfsym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="entity"><span>hfname</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="comment1"><span>(* TODO: Include information for which version of ll-file this has been generated! *)</span></span><span>
          </span><span class="entity"><span>line</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"// Generated by Isabelle-LLVM. Do not modify."</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>line</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"#ifndef"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hfsym</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>line</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"#define"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hfsym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"1"</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>line</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"#include &lt;stdint.h&gt;"</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span>         
          </span><span class="entity"><span>tydefs_proto_to_Cs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>tydefs_to_Cs</span></span><span> </span><span class="entity"><span>tydefs</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>csigs_to_Cs</span></span><span> </span><span class="entity"><span>sigs</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fbrk</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>line</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>word</span></span><span> </span><span class="inner_quoted"><span>"#endif"</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simple_PP.string_of</span></span><span> </span><span class="entity"><span>h_to_C</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
    
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>    
    
›</span></span><span>    
  

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>