<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Sepref_Id_Op</title>
</head>


<body>
<div class="head">
<h1>Theory Sepref_Id_Op</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>section</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Operation Identification Phase›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="Sepref_Id_Op.html"><span>Sepref_Id_Op</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> 
  </span><a href="../../HOL/HOL/Main.html"><span>Main</span></a><span> 
  </span><a href="../../AFP/Automatic_Refinement/Refine_Lib.html"><span>Automatic_Refinement.Refine_Lib</span></a><span>
  </span><a href="../../AFP/Automatic_Refinement/Autoref_Tagging.html"><span>Automatic_Refinement.Autoref_Tagging</span></a><span>
  </span><span class="quoted"><span>"</span><a href="Refine_Imperative_HOL.Named_Theorems_Rev.html"><span>Refine_Imperative_HOL.Named_Theorems_Rev</span></a><span>"</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>

    </span><span class="comment1"><span>(* DO NOT USE IN PRODUCTION VERSION → SLOWDOWN *)</span></span><span>
    </span><span class="comment1"><span>(* declare [[ML_exception_debugger, ML_debugger, ML_exception_trace]] *)</span></span><span>


</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  The operation identification phase is adapted from the Autoref tool.
  The basic idea is to have a type system, which works on so called 
  interface types (also called conceptual types). Each conceptual type
  denotes an abstract data type, e.g., set, map, priority queue.
  
  Each abstract operation, which must be a constant applied to its arguments,
  is assigned a conceptual type. Additionally, there is a set of 
  {\emph pattern rewrite rules},
  which are applied to subterms before type inference takes place, and 
  which may be backtracked over. 
  This way, encodings of abstract operations in Isabelle/HOL, like 
  </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> [</span><span>source</span><span>] </span><span class="quoted"><span>"</span><span class="main"><span>λ</span></span><span class="main"><span class="bound"><span>_</span></span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.option.None|const"><span>None</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> for the empty map, 
  or </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> [</span><span>source</span><span>] </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/Fun.html#Fun.fun_upd|const"><span>fun_upd</span></a><span> </span><span class="free"><span>m</span></span><span> </span><span class="free"><span>k</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.option.Some|const"><span>Some</span></a><span> </span><span class="free"><span>v</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> for map update, can be rewritten
  to abstract operations, and get properly typed.
›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>"Proper Protection of Term"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ The following constants are meant to encode abstraction and 
  application as proper HOL-constants, and thus avoid strange effects with
  HOL's higher-order unification heuristics and automatic 
  beta and eta-contraction.

  The first step of operation identification is to protect the term
  by replacing all function applications and abstractions be 
  the constants defined below.
›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Id_Op.PROTECT2_def|fact"><span class="entity_def" id="Sepref_Id_Op.PROTECT2_def|thm"><span class="entity_def" id="Sepref_Id_Op.PROTECT2_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Id_Op.PROTECT2|const"><span>PROTECT2</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span class="bound"><span class="entity"><span>y</span></span></span></span><span class="main"><span>::</span></span><span>prop</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>consts</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.DUMMY|const"><span>DUMMY</span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span>prop</span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="entity"><span class="entity_def" id="Sepref_Id_Op.PROTECT2_syn|const"><span>PROTECT2_syn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="quoted"><span>"</span><span class="keyword1"><span>'(#</span></span><span>_</span><span class="keyword1"><span>#')</span></span><span>"</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>PROTECT2_syn</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>t</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PROTECT2|const"><span>PROTECT2</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>t</span></span></span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.DUMMY|const"><span>DUMMY</span></a><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>abbreviation</span></span></span><span> </span><span class="main"><span>(</span></span><span>input</span><span class="main"><span>)</span></span><span class="entity"><span class="entity_def" id="Sepref_Id_Op.ABS2|const"><span>ABS2</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>⇒</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span class="main"><span>⇒</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>⇒</span></span><span class="tfree"><span>'b</span></span><span>"</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>binder</span></span></span><span> </span><span class="quoted"><span>"</span><span class="keyword1"><span>λ<span class="hidden">⇩</span><sub>2</sub></span></span><span>"</span></span><span> 10</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>ABS2</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>f</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PROTECT2|const"><span>PROTECT2</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span class="bound"><span class="entity"><span>f</span></span></span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.DUMMY|const"><span>DUMMY</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.beta|fact"><span class="entity_def" id="Sepref_Id_Op.beta|thm"><span>beta</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ABS2|const"><span>λ<span class="hidden">⇩</span><sub>2</sub></span></a></span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ABS2|const"><span>.</span></a></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>$</span></a></span><span class="free"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  Another version of </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> "</span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>APP</span></a><span>"</span><span class="antiquote"><span>}</span></span></span><span>. Treated like </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>APP</span></a><span class="antiquote"><span>}</span></span></span><span> by our tool.
  Required to avoid infinite pattern rewriting in some cases, e.g., map-lookup.
›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Id_Op.APP&apos;_def|fact"><span class="entity_def" id="Sepref_Id_Op.APP&apos;_def|thm"><span class="entity_def" id="Sepref_Id_Op.APP&apos;_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Sepref_Id_Op.APP&apos;|const"><span>APP'</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>infixl</span></span></span><span> </span><span class="quoted"><span>"</span><span class="keyword1"><span>$''</span></span><span>"</span></span><span> 900</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.autoref_tag_defs|attribute"><span class="operator"><span>autoref_tag_defs</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="bound"><span class="entity"><span>f</span></span></span></span><span class="main"><span class="free"><span>$'</span></span></span><span class="free"><span class="bound"><span class="entity"><span>a</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>f</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>a</span></span></span></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  Sometimes, whole terms should be protected from being processed by our tool.
  For example, our tool should not look into numerals. For this reason,
  the </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"PR_CONST"</span></span><span class="antiquote"><span>}</span></span></span><span> tag indicates terms that our tool shall handle as
  atomic constants, an never look into them.

  The special form </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"UNPROTECT"</span></span><span class="antiquote"><span>}</span></span></span><span> can be used inside pattern rewrite rules.
  It has the effect to revert the protection from its argument, and then wrap
  it into a </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"PR_CONST"</span></span><span class="antiquote"><span>}</span></span></span><span>.
›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Id_Op.PR_CONST_def|fact"><span class="entity_def" id="Sepref_Id_Op.PR_CONST_def|thm"><span class="entity_def" id="Sepref_Id_Op.PR_CONST_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.autoref_tag_defs|attribute"><span class="operator"><span>autoref_tag_defs</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span>"</span></span></span><span> </span><span class="comment1"><span>― ‹Tag to protect constant›</span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Id_Op.UNPROTECT_def|fact"><span class="entity_def" id="Sepref_Id_Op.UNPROTECT_def|thm"><span class="entity_def" id="Sepref_Id_Op.UNPROTECT_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.autoref_tag_defs|attribute"><span class="operator"><span>autoref_tag_defs</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Id_Op.UNPROTECT|const"><span>UNPROTECT</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>x</span></span></span></span><span>"</span></span></span><span> </span><span class="comment1"><span>― ‹Gets 
  converted to </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a></span><span class="antiquote"><span>}</span></span></span><span>, after unprotecting its content›</span></span><span>


</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ Operation Identification ›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ Indicator predicate for conceptual typing of a constant ›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Id_Op.intf_type_def|fact"><span class="entity_def" id="Sepref_Id_Op.intf_type_def|thm"><span class="entity_def" id="Sepref_Id_Op.intf_type_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Sepref_Id_Op.intf_type|const"><span>intf_type</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'b</span></span><span> </span><span>itself</span><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>infix</span></span></span><span> </span><span class="quoted"><span>"</span><span class="keyword1"><span>::<span class="hidden">⇩</span><sub>i</sub></span></span><span>"</span></span><span> 10</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span>
  </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="bound"><span class="entity"><span>c</span></span></span></span><span class="keyword1"><span class="free"><span>::<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="free"><span class="bound"><span class="entity"><span>I</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.itypeI|fact"><span class="entity_def" id="Sepref_Id_Op.itypeI|thm"><span>itypeI</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>c</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.intf_type|const"><span>::<span class="hidden">⇩</span><sub>i</sub></span></a></span><span class="free"><span>I</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.itypeI&apos;|fact"><span class="entity_def" id="Sepref_Id_Op.itypeI&apos;|thm"><span>itypeI'</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.intf_type|const"><span>intf_type</span></a><span> </span><span class="free"><span>c</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'T</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.itypeI|fact"><span>itypeI</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.itype_self|fact"><span class="entity_def" id="Sepref_Id_Op.itype_self|thm"><span>itype_self</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>c</span></span><span class="main"><span>::</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.intf_type|const"><span>::<span class="hidden">⇩</span><sub>i</sub></span></a></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Id_Op.CTYPE_ANNOT_def|fact"><span class="entity_def" id="Sepref_Id_Op.CTYPE_ANNOT_def|thm"><span class="entity_def" id="Sepref_Id_Op.CTYPE_ANNOT_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Sepref_Id_Op.CTYPE_ANNOT|const"><span>CTYPE_ANNOT</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="tfree"><span>'b</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'a</span></span><span> </span><span>itself</span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'b</span></span><span>"</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>infix</span></span></span><span> </span><span class="quoted"><span>"</span><span class="keyword1"><span>:::<span class="hidden">⇩</span><sub>i</sub></span></span><span>"</span></span><span> 10</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span>
  </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="bound"><span class="entity"><span>c</span></span></span></span><span class="keyword1"><span class="free"><span>:::<span class="hidden">⇩</span><sub>i</sub></span></span></span><span class="free"><span class="bound"><span class="entity"><span>I</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>c</span></span></span></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ Wrapper predicate for an conceptual type inference ›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Id_Op.ID_def|fact"><span class="entity_def" id="Sepref_Id_Op.ID_def|thm"><span class="entity_def" id="Sepref_Id_Op.ID_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="entity"><span class="entity_def" id="Sepref_Id_Op.ID|const"><span>ID</span></span></span><span> </span><span class="main"><span>::</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'c</span></span><span> </span><span>itself</span><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>where</span></span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>ID</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>t</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>t'</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>T</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>t</span></span></span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span class="free"><span class="bound"><span class="entity"><span>t'</span></span></span></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ Conceptual Typing Rules ›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.ID_unfold_vars|fact"><span class="entity_def" id="Sepref_Id_Op.ID_unfold_vars|thm"><span>ID_unfold_vars</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>x</span></span><span class="main"><span>≡</span></span><span class="free"><span>y</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.ID_PR_CONST_trigger|fact"><span class="entity_def" id="Sepref_Id_Op.ID_PR_CONST_trigger|thm"><span>ID_PR_CONST_trigger</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a><span> </span><span class="free"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>y</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a><span> </span><span class="free"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>y</span></span><span> </span><span class="free"><span>T</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>.</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.pat_rule|fact"><span class="entity_def" id="Sepref_Id_Op.pat_rule|thm"><span>pat_rule</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><span class="free"><span>p</span></span><span class="main"><span>≡</span></span><span class="free"><span>p'</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>p'</span></span><span> </span><span class="free"><span>t'</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>p</span></span><span> </span><span class="free"><span>t'</span></span><span> </span><span class="free"><span>T</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.app_rule|fact"><span class="entity_def" id="Sepref_Id_Op.app_rule|thm"><span>app_rule</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>f'</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>⇒</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>x'</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>$</span></a></span><span class="free"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f'</span></span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>$</span></a></span><span class="free"><span>x'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.app&apos;_rule|fact"><span class="entity_def" id="Sepref_Id_Op.app&apos;_rule|thm"><span>app'_rule</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>f'</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>⇒</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>x'</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>f</span></span><span class="main"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.APP&apos;|const"><span>$'</span></a></span><span class="free"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>f'</span></span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>$</span></a></span><span class="free"><span>x'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.abs_rule|fact"><span class="entity_def" id="Sepref_Id_Op.abs_rule|thm"><span>abs_rule</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><span> </span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>x'</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>x'</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>t</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>t'</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="bound"><span>x'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span>
    </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ABS2|const"><span>λ<span class="hidden">⇩</span><sub>2</sub></span></a></span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ABS2|const"><span>.</span></a></span><span> </span><span class="free"><span>t</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ABS2|const"><span>λ<span class="hidden">⇩</span><sub>2</sub></span></a></span><span class="bound"><span>x'</span></span><span class="main"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ABS2|const"><span>.</span></a></span><span> </span><span class="free"><span>t'</span></span><span> </span><span class="bound"><span>x'</span></span><span> </span><span class="bound"><span>x'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>⇒</span></span><span class="tfree"><span>'b</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.id_rule|fact"><span class="entity_def" id="Sepref_Id_Op.id_rule|thm"><span>id_rule</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>c</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.intf_type|const"><span>::<span class="hidden">⇩</span><sub>i</sub></span></a></span><span class="free"><span>I</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>I</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.annot_rule|fact"><span class="entity_def" id="Sepref_Id_Op.annot_rule|thm"><span>annot_rule</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="free"><span>t</span></span><span> </span><span class="free"><span>t'</span></span><span> </span><span class="free"><span>I</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>t</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.CTYPE_ANNOT|const"><span>:::<span class="hidden">⇩</span><sub>i</sub></span></a></span><span class="free"><span>I</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>t'</span></span><span> </span><span class="free"><span>I</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.fallback_rule|fact"><span class="entity_def" id="Sepref_Id_Op.fallback_rule|thm"><span>fallback_rule</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>c</span></span><span class="main"><span>::</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tfree"><span>'c</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.unprotect_rl1|fact"><span class="entity_def" id="Sepref_Id_Op.unprotect_rl1|thm"><span>unprotect_rl1</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a><span> </span><span class="free"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>t</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.UNPROTECT|const"><span>UNPROTECT</span></a><span> </span><span class="free"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>t</span></span><span> </span><span class="free"><span>T</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ ML-Level code ›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> THEN_ELSE_COMB'

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ID_OP_TACTICAL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> SOLVE_FWD</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>tactic'</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> DF_SOLVE_FWD</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Id_Op_Tactical</span></span><span> </span><span class="main"><span>:</span></span><span class="entity"><span>ID_OP_TACTICAL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>SOLVE_FWD</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="entity"><span>tac</span></span><span> 
    </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SOLVE_FWD</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>


  </span><span class="comment1"><span>(* Search for solution with DFS-strategy. If dbg-flag is given,
    return sequence of stuck states if no solution is found.
  *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>DF_SOLVE_FWD</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stuck_list_ref</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stuck_tac</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>stuck_list_ref</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>st</span></span><span> </span><span>::</span><span> </span><span>!</span><span class="entity"><span>stuck_list_ref</span></span><span class="main"><span>;</span></span><span>
      </span><span>Seq.empty</span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Seq.empty</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rec_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>SOLVED'</span><span> </span><span class="entity"><span>rec_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>ORELSE'</span><span> </span><span class="entity"><span>stuck_tac</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fail_tac</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>Seq.of_list</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>stuck_list_ref</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Seq.empty</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>rec_tac</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>fail_tac</span></span><span>    
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>


</span><span class="keyword1"><span class="command"><span>named_theorems_rev</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.id_rules|attribute"><span class="entity_def" id="Sepref_Id_Op.id_rules|fact"><span>id_rules</span></span></span><span> </span><span class="quoted"><span>"Operation identification rules"</span></span><span>
</span><span class="keyword1"><span class="command"><span>named_theorems_rev</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.pat_rules|attribute"><span class="entity_def" id="Sepref_Id_Op.pat_rules|fact"><span>pat_rules</span></span></span><span> </span><span class="quoted"><span>"Operation pattern rules"</span></span><span>
</span><span class="keyword1"><span class="command"><span>named_theorems_rev</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.def_pat_rules|attribute"><span class="entity_def" id="Sepref_Id_Op.def_pat_rules|fact"><span>def_pat_rules</span></span></span><span> </span><span class="quoted"><span>"Definite operation pattern rules (not backtracked over)"</span></span><span>



</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Id_Op</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>id_a_conv</span></span><span> </span><span class="entity"><span>cnv</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.fun_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.fun_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>cnv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"id_a_conv"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>ct</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> 
      </span><span class="entity"><span>protect</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="var"><span>?t</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.CTYPE_ANNOT|const"><span>:::<span class="hidden">⇩</span><sub>i</sub></span></a></span><span class="var"><span>?I</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>protect</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
        </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mk_term</span></span><span> env</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span>"</span><span class="var"><span>?t</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.CTYPE_ANNOT|const"><span>:::<span class="hidden">⇩</span><sub>i</sub></span></a></span><span class="var"><span>?I</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>protect</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a><span> </span><span class="main"><span>_</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>protect</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>protect</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>protect</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mk_term</span></span><span> env</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span>"</span><span class="var"><span>?t1.0</span></span><span> </span><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>$</span></a></span><span> </span><span class="var"><span>?t2.0</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>protect</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span>::</span><span class="entity"><span>env</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>protect</span></span><span> </span><span class="entity"><span>env'</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mk_term</span></span><span> env'</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PROTECT2|const"><span>PROTECT2</span></a><span> </span><span class="var"><span>?t</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.DUMMY|const"><span>DUMMY</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="comment1"><span>(* TODO: Avoiding mk_term with loose vars under λ! Fix that!
    | protect env (Abs (x,T,t)) = let
        val t = protect (T::env) t
      in
        @{mk_term env: "λv_x::?'v_T. PROTECT2 ?t DUMMY"}
      end
    *)</span></span><span>  
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>protect</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>protect_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Util.f_tac_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>protect</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>simp_tac</span></span><span> 
        </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PROTECT2_def|fact"><span>PROTECT2_def</span></a><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP_def|fact"><span>APP_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unprotect_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> 
        </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PROTECT2_def|fact"><span>PROTECT2_def</span></a><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP_def|fact"><span>APP_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_unprotect_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.unprotect_rl1|fact"><span>unprotect_rl1</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span>
      </span><span>CONVERSION</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Refine_Util.HOL_concl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>id_a_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unprotect_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_id_debug</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.id_debug|attribute"><span>id_debug</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_id_trace_fallback</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.id_trace_fallback|attribute"><span>id_trace_fallback</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_id_rl</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="main"><span>(</span></span><span class="quasi_keyword"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="var"><span>?c</span></span><span class="keyword1"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.intf_type|const"><span>::<span class="hidden">⇩</span><sub>i</sub></span></a></span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><span class="tvar"><span>?'v_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_id_rl"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_id_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span>Thm.proof_attributes</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Named_Theorems_Rev.add</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> id_rules</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>id_tac_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Init</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Step</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Normal</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Solve</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>id_tac</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Id_Op_Tactical</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>certT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems_Rev.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> id_rules</span><span class="antiquote"><span>}</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems_Rev.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> pat_rules</span><span class="antiquote"><span>}</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_pat_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Theorems_Rev.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> def_pat_rules</span><span class="antiquote"><span>}</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Tactic.build_net</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>pat_rules</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.pat_rule|fact"><span>pat_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
        </span><span>@</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.annot_rule|fact"><span>annot_rule</span></a><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.app_rule|fact"><span>app_rule</span></a><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.app&apos;_rule|fact"><span>app'_rule</span></a><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.abs_rule|fact"><span>abs_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span> 
        </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id_rules</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.id_rule|fact"><span>id_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_rl_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Tactic.build_net</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>def_pat_rules</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.pat_rule|fact"><span>pat_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>  

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_pr_const_rename_tac</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID_PR_CONST_trigger|fact"><span>ID_PR_CONST_trigger</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span>
          </span><span class="entity"><span>Subgoal.FOCUS</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span> context</span><span class="main"><span>=</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_ID</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_ID</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>is_ID</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID_unfold_vars|fact"><span>ID_unfold_vars</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.rewrs_conv</span><span> </span><span class="entity"><span>eqs</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.top_sweep_conv</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.fun2_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Util.HOL_concl_conv</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>CONVERSION</span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> 
          </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
          </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.id_rule|fact"><span>id_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN'</span><span>
          </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>id_rules</span></span><span> 

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ityping</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id_rules</span></span><span> 
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>dest_id_rl</span></span><span>
        </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>is_Const</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>dest_Const</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Symtab.make_list</span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>ityping</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_fallback</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>cT</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Sign.the_const_constraint</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate'</span><span> 
                          </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>certT</span></span><span> </span><span class="entity"><span>cT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>certT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>cT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.fallback_rule|fact"><span>fallback_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span> 
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trace_fallback</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_id_trace_fallback</span></span><span>       
        </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
          </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"ID_OP: Applying fallback rule: "</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
          </span><span>string_of</span><span> </span><span class="entity"><span>p</span></span><span> </span><span>|&gt;</span><span> </span><span>tracing</span><span class="main"><span>;</span></span><span> 
          </span><span>false</span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fallback_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>CONVERSION</span><span> </span><span>Thm.eta_conversion</span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>IF_EXGOAL</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.concl_of_goal</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.ID|const"><span>ID</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Mpat_Antiquot.html#Mpat_Antiquot.mpaq_STRUCT|const"><span>mpaq_STRUCT</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Mpat_Antiquot.html#Mpat_Antiquot.mpaq_Const|const"><span>mpaq_Const</span></a><span> </span><span class="var"><span>?name</span></span><span> </span><span class="var"><span>?cT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_type</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> 
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mk_fallback</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>cT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trace_fallback</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.empty</span><span>  
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Seq.empty</span><span>
          </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>CONVERSION</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>Refine_Util.HOL_concl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id_a_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>protect_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>FIRST'</span><span> </span><span class="main"><span>[</span></span><span>
        </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> 
        </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.id_rule|fact"><span>id_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>def_rl_net</span></span><span class="main"><span>,</span></span><span> 
        </span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rl_net</span></span><span class="main"><span>,</span></span><span> 
        </span><span class="entity"><span>id_pr_const_rename_tac</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>do_unprotect_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> 
        </span><span class="entity"><span>fallback_tac</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>solve_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>DF_SOLVE_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cfg_id_debug</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>step_tac</span></span><span>  

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Init</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>init_tac</span></span><span> 
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Step</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>step_tac</span></span><span> 
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Normal</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>init_tac</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>solve_tac</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Solve</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>solve_tac</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

›</span></span><span>

</span><span class="keyword1"><span class="command"><span>subsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Default Setup›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>subsubsection</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Numerals›</span></span></span><span> 
</span><span class="comment1"><span>(* TODO: Either remove, or also add numerals 0 and 1! *)</span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.pat_numeral|fact"><span class="entity_def" id="Sepref_Id_Op.pat_numeral|thm"><span>pat_numeral</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.def_pat_rules|attribute"><span class="operator"><span>def_pat_rules</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/Num.html#Num.numeral_class.numeral|const"><span>numeral</span></a><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>$</span></a></span><span class="free"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.UNPROTECT|const"><span>UNPROTECT</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/Num.html#Num.numeral_class.numeral|const"><span>numeral</span></a><span class="main"><a class="entity_ref" href="../../AFP/Automatic_Refinement/Autoref_Tagging.html#Autoref_Tagging.APP|const"><span>$</span></a></span><span class="free"><span>x</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.id_nat_const|fact"><span class="entity_def" id="Sepref_Id_Op.id_nat_const|thm"><span>id_nat_const</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.id_rules|attribute"><span class="operator"><span>id_rules</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../HOL/HOL/Nat.html#Nat.nat|type"><span>nat</span></a><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.intf_type|const"><span>::<span class="hidden">⇩</span><sub>i</sub></span></a></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/Nat.html#Nat.nat|type"><span>nat</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Id_Op.id_int_const|fact"><span class="entity_def" id="Sepref_Id_Op.id_int_const|thm"><span>id_int_const</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.id_rules|attribute"><span class="operator"><span>id_rules</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.PR_CONST|const"><span>PR_CONST</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="Sepref_Id_Op.html#Sepref_Id_Op.intf_type|const"><span>::<span class="hidden">⇩</span><sub>i</sub></span></a></span><span> </span><span class="keyword1"><span>TYPE</span></span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="comment1"><span>(*subsection ‹Example›
schematic_lemma 
  "ID (λa b. (b(1::int↦2::nat) |`(-{3})) a, Map.empty, λa. case a of None ⇒ Some a | Some _ ⇒ None) (?c) (?T::?'d itself)"
  (*"TERM (?c,?T)"*)
  using [[id_debug]]
  apply (tactic {* Id_Op.id_tac Id_Op.Normal @{context} 1  *})  
  done
*)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span></pre>
</body>

</html>