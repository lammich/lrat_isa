<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Definition_Utils</title>
</head>


<body>
<div class="head">
<h1>Theory Definition_Utils</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="Definition_Utils.html"><span>Definition_Utils</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> 
  </span><a href="../../HOL/HOL/Main.html"><span>Main</span></a><span>
  </span><span class="quoted"><span>"</span><a href="../../AFP/Automatic_Refinement/Refine_Lib.html"><span>Automatic_Refinement.Refine_Lib</span></a><span>"</span></span><span> 
  </span><span class="quoted"><span>"</span><a href="HOL-Library.Rewrite.html"><span>HOL-Library.Rewrite</span></a><span>"</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>keywords</span></span></span><span> 
      </span><span class="quoted"><span>"concrete_definition"</span></span><span> </span><span class="main"><span>::</span></span><span> thy_decl
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="quoted"><span>"prepare_code_thms"</span></span><span> </span><span class="main"><span>::</span></span><span> thy_decl
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="quoted"><span>"synth_definition"</span></span><span> </span><span class="main"><span>::</span></span><span> thy_goal

</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>

  </span><span class="comment1"><span>(*
    (* DO NOT USE IN PRODUCTION VERSION → SLOWDOWN *)
    declare [[ML_exception_debugger, ML_debugger, ML_exception_trace]]
  *)</span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  This theory provides a tool for extracting definitions from terms, and
  for generating code equations for recursion combinators.
›</span></span></span><span>

</span><span class="comment1"><span>(*
  TODO: Copied and merged from $AFP/Refine_Monadic/Refine_Automation
    and isafol/GRAT/gratchk/Synth_Definition

  TODO: Not properly localized  
  
  
  TODO: Finally merge Definition_Utils and Synth_Definition structure. 
    Use ⌑ instead of schematics for user interface!
    
*)</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML_val</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Symtab.update_list</span><span>›</span></span><span>
</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>DEFINITION_UTILS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    pattern</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>   </span><span class="comment1"><span>(* Pattern to be defined as own constant *)</span></span><span>
    gen_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>    </span><span class="comment1"><span>(* Code eq generator: [| c==rhs; ... |] ==&gt; c == ... *)</span></span><span>
    gen_tac</span><span class="main"><span>:</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span> </span><span class="comment1"><span>(* Solves remaining premises of gen_thm *)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> extract_as_def</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> 
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>

  </span><span class="comment1"><span>(* Returns new_def_thm, code_thms, raw_def_thms *)</span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> extract_recursion_eqs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> 
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
    
  </span><span class="comment1"><span>(* Generate and register with names, code-theorems by specified attrib *)</span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> extract_recursion_eqs'</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.src</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> 
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> declare_extraction_group</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_extraction</span><span class="main"><span>:</span></span><span> </span><span>xstring</span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_extraction_group</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>xstring</span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_extraction_group</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>list</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_code_thms_cmd</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>xstring</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.src</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sd_cmd</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sd_parser</span><span class="main"><span>:</span></span><span> </span><span>Token.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>Token.T</span><span> </span><span>list</span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> define_concrete_fun</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>list</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> 
    </span><span>Token.src</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.src</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>indexname</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>cterm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_qualified</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bstring</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span>

  </span><span class="comment1"><span>(* Convert ⌑ to schematic variable *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_pattern</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> 
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_cd_pattern</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_cd_pattern</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_cd_pattern</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_cd_patterns</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_vc_rec_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_vc_rec_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_vc_rec_thms</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_vc_solve_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_vc_solve_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_vc_solve_thms</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> vc_solve_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> vc_solve_modifiers</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Method.modifier</span></span><span> </span><span>parser</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> setup</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Definition_Utils</span></span><span> </span><span class="main"><span>:</span></span><span class="entity"><span>DEFINITION_UTILS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    pattern</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>   </span><span class="comment1"><span>(* Pattern to be defined as own constant *)</span></span><span>
    gen_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>    </span><span class="comment1"><span>(* Code eq generator: [| c==rhs; ... |] ==&gt; c == ... *)</span></span><span>
    gen_tac</span><span class="main"><span>:</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span> </span><span class="comment1"><span>(* Solves remaining premises of gen_thm *)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_extraction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>pattern</span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>extractions</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>list</span><span> </span><span>Name_Space.table</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.empty_table</span><span> </span><span class="inner_quoted"><span>"Fixed-Point Extractions"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.join_tables</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Library.merge</span><span> </span><span class="entity"><span>eq_extraction</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_extraction_group</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>extractions.get</span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>table</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.define</span><span> </span><span class="entity"><span>context</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>table</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>extractions.put</span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_extraction</span></span><span> </span><span class="entity"><span>namepos</span></span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.check</span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="entity"><span>namepos</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.map_table_entry</span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>(</span></span><span>Library.update</span><span> </span><span class="entity"><span>eq_extraction</span></span><span> </span><span class="entity"><span>ex</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>table</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>table</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>extractions.map</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_extraction_group</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>namepos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>extractions.get</span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.check</span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="entity"><span>namepos</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>key</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_extraction_group</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>full_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>extractions.get</span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>exs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.check</span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_name</span></span><span class="main"><span>,</span></span><span>Position.none</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
    </span><span class="entity"><span>exs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  
</span><span class="comment1"><span>(*  
    Context.theory_map (extractions.map (
      Symtab.update_list (op = o apply2 #pattern) (name,ex)))
*)</span></span><span>      

  </span><span class="comment1"><span>(*
    Define new constant name for subterm t in context bnd.
    Returns replacement for t using the new constant and definition 
    theorem.
  *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_as_def</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>loose</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>loose_bnos</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nctx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.names_of</span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>nctx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>nctx</span></span><span> </span><span class="comment1"><span>(* TODO: Disambiguate name by appending serial_string() *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span>serial_string</span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rnames</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span>Name.variant</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="entity"><span>nctx</span></span><span>
    
    </span><span class="comment1"><span>(*val rnames = #1 (Variable.names_of lthy |&gt; fold_map (Name.variant o #1) bnd);*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rnames</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>bnd</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rfrees</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>loose</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_vars</span></span><span> 
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Library.foldl</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>rfrees</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>loose</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>param_vars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> 
      </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>param_types</span></span><span> </span><span>---&gt;</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>param_vars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Logic.all</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_vars</span></span><span> 

    </span><span class="comment1"><span>(* TODO: Makarius says: Use Local_Theory.define here! *)</span></span><span>  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lhs_t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> 
      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Specification.definition</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span class="entity"><span>def_t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*val _ = tracing "xxxx";*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>app_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>app_t</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_qualified</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform</span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat_net</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>Item_Net.T</span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Item_Net.init</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>pattern</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Item_Net.update</span><span> </span><span class="entity"><span>exs</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="comment1"><span>(* Recurse for subterms *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>ctx</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>ctx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
            </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span>      

      </span><span class="comment1"><span>(* Check if we match a pattern *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span>Item_Net.retrieve_matching</span><span> </span><span class="entity"><span>pat_net</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span>|&gt;</span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
             </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span>
               </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Pattern.first_order_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern </span><span class="entity"><span>ex</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
                 </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ex</span></span><span>
           </span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="comment1"><span>(* Extract as new constant *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctx</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"f_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_as_def</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span class="entity"><span>ex</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simp_only_tac</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span>
  
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_recursion_eqs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_recursion_eqs</span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
 
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Defs.meta_rewrite_rule</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>def_thm</span></span><span>

  </span><span class="comment1"><span>(* Open local target *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.begin_nested</span><span> </span><span class="entity"><span>lthy</span></span><span> 
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.map_background_naming</span><span> </span><span class="main"><span>(</span></span><span>Name_Space.mandatory_path</span><span> </span><span class="entity"><span>basename</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.rhs_of</span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.term_of</span><span>
  
  </span><span class="comment1"><span>(* Transform RHS, generating new constants *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rhs'</span></span><span class="main"><span>,</span></span><span class="entity"><span>aux_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transform</span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aux_def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>aux_defs</span></span><span>
  
  </span><span class="comment1"><span>(* Prove equality *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_eq_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove_internal</span><span> 
    </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs'</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_only_tac</span></span><span> </span><span class="entity"><span>aux_def_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="comment1"><span>(* Generate new definition theorem *)</span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.transitive</span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>rhs_eq_thm</span></span><span>  
      
  </span><span class="comment1"><span>(* Generate code equations *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_code_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span class="main"><span>{</span></span><span class="entity"><span>gen_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_tac</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>yield_singleton2</span></span><span> 
      </span><span class="main"><span>(</span></span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>gen_thm</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_tac</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
      </span><span>ORELSE'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_only_tac</span></span><span> </span><span class="entity"><span>aux_def_thms</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>gen_tac</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* TODO: The unfold auf_def_thms fallback is a dirty hack, to enable e.g., monotonicity proofs
        without proper mono-prover setup for the generated constants.
        
        A cleaner way would only generate constants along with mono-prover-setup!
      *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>SINGLE</span><span> </span><span class="main"><span>(</span></span><span>ALLGOALS</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aux_code_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_code_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aux_defs</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>aux_code_thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> 
    </span><span>warning</span><span> </span><span class="inner_quoted"><span>"Unresolved premises in code theorems"</span></span><span>
    
  </span><span class="comment1"><span>(* Close Target *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.end_nested</span><span> </span><span class="entity"><span>lthy</span></span><span>

  </span><span class="comment1"><span>(* Transfer Results *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.standard_form</span><span> </span><span class="entity"><span>lthy1</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.entity</span><span> </span><span>Morphism.thm</span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xfer</span></span><span> </span><span class="entity"><span>code_thm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aux_code_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>xfer</span></span><span> </span><span class="entity"><span>aux_code_thms</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aux_def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>xfer</span></span><span> </span><span class="entity"><span>aux_def_thms</span></span><span>
    
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>code_thm</span></span><span class="main"><span>,</span></span><span class="entity"><span>aux_code_thms</span></span><span class="main"><span>,</span></span><span class="entity"><span>aux_def_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
fun extract_recursion_eqs exs basename orig_def_thm lthy = let
  val thy = Proof_Context.theory_of lthy
 
  val pat_net : extraction Item_Net.T =
    Item_Net.init (op= o apply2 #pattern) (fn {pattern, ...} =&gt; [pattern])
    |&gt; fold Item_Net.update exs

  local
    fun tr env t ctx = let
      (* Recurse for subterms *)
      val (t,ctx) = case t of
        t1$t2 =&gt; let
            val (t1,ctx) = tr env t1 ctx
            val (t2,ctx) = tr env t2 ctx
          in 
            (t1$t2,ctx)
          end
      | Abs (x,T,t) =&gt; let 
            val (t',ctx) = tr ((x,T)::env) t ctx
          in (Abs (x,T,t'),ctx) end
      | _ =&gt; (t,ctx)      

      (* Check if we match a pattern *)
      val ex = 
        Item_Net.retrieve_matching pat_net t
        |&gt; get_first (fn ex =&gt; 
             case
               try (Pattern.first_order_match thy (#pattern ex,t)) 
                 (Vartab.empty,Vartab.empty)
             of NONE =&gt; NONE | SOME _ =&gt; SOME ex
           )
    in
      case ex of 
        NONE =&gt; (t,ctx)
      | SOME ex =&gt; let
          (* Extract as new constant *)
          val (idx,defs,lthy) = ctx
          val name = (basename ^ "_" ^ string_of_int idx)
          val ((t,def_thm),lthy) = extract_as_def env name t lthy
          val ctx = (idx+1,(def_thm,ex)::defs,lthy)
        in
          (t,ctx)
        end
    end
  in
    fun transform t lthy = let 
      val (t,(_,defs,lthy)) = tr [] t (0,[],lthy)
    in 
      ((t,defs),lthy)
    end
  end

  (* Import theorem and extract RHS *)
  
  (* val lthy0 = lthy *)
  val orig_def_thm = Local_Defs.meta_rewrite_rule lthy orig_def_thm
  val args = Thm.lhs_of orig_def_thm |&gt; Thm.term_of |&gt; Term.strip_comb |&gt; snd |&gt; take_suffix is_Var
    |&gt; map (fst o fst o dest_Var)
  
  val orig_def_thm = Local_Defs.abs_def_rule lthy orig_def_thm
  
  val ((_,orig_def_thm'),lthy) = yield_singleton2 
    (Variable.importT) orig_def_thm lthy;
  val (lhs,rhs) = orig_def_thm' (*|&gt; Local_Defs.meta_rewrite_rule lthy *) |&gt; Thm.prop_of |&gt; Logic.dest_equals;
  
  (* Transform RHS, generating new constants *)
  val ((rhs',defs),lthy) = transform rhs lthy;
  val def_thms = map #1 defs

  (* Obtain new def_thm *)
  val def_unfold_ss = 
    put_simpset HOL_basic_ss lthy addsimps (orig_def_thm::def_thms)

  val _ = @{print}  (orig_def_thm::def_thms)
  
  local  
    val lthy0 = lthy
    val (argns,lthy) = Variable.variant_fixes args lthy
    
    val tys = fastype_of lhs |&gt; binder_types |&gt; take (length args)
    
    val args = map Free (argns ~~ tys)

    val lhs = list_comb (lhs,args)
    val rhs = list_comb (rhs',args)

    val new_def_ct = Logic.mk_equals (lhs,rhs) |&gt; Thm.cterm_of lthy

    val _ = tracing "Prove"
    val new_def_thm = Goal.prove_internal lthy [] new_def_ct (K (simp_tac def_unfold_ss 1))
    val _ = tracing "Done"
  in 
    val new_def_thm = singleton (Variable.export lthy lthy0) new_def_thm
  end
  
  
  (*  
  val def_unfold_ss = 
    put_simpset HOL_basic_ss lthy addsimps (orig_def_thm::def_thms)
  val new_def_thm = Goal.prove_internal lthy
    [] (Logic.mk_equals (lhs,rhs') |&gt; Thm.cterm_of lthy) (K (simp_tac def_unfold_ss 1))
  *)

  (* Obtain new theorem by folding with defs of generated constants *)
  (* TODO: Maybe cleaner to generate eq-thm and prove by "unfold, refl" *)
  (*val new_def_thm 
    = Library.foldr (fn (dt,t) =&gt; Local_Defs.fold lthy [dt] t) 
        (def_thms,orig_def_thm');*)

  (* Prepare code equations *)
  fun mk_code_thm lthy (def_thm,{gen_thm, gen_tac, ...}) = let
    val ((_,def_thm),lthy') = yield_singleton2 
      (Variable.import true) def_thm lthy;
    val thm = def_thm RS gen_thm;
    val tac = SOLVED' (gen_tac lthy')
      ORELSE' (simp_tac def_unfold_ss THEN' gen_tac lthy')

    val thm = the (SINGLE (ALLGOALS tac) thm);
    val thm = singleton (Variable.export lthy' lthy) thm;
  in
    thm
  end;
  
  val code_thms = map (mk_code_thm lthy) defs;

  val _ = if forall Thm.no_prems code_thms then () else 
    warning "Unresolved premises in code theorems"
    
in
  ((new_def_thm,code_thms,def_thms),lthy)
end;
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_recursion_eqs'</span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="entity"><span>orig_def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>new_def_thm</span></span><span class="main"><span>,</span></span><span class="entity"><span>code_thms</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_recursion_eqs</span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>orig_def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

  </span><span class="comment1"><span>(* Register definitions of generated constants *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_qualified</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="inner_quoted"><span>"defs"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>new_def_thm</span></span><span>::</span><span class="entity"><span>code_thms</span></span><span>
    
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> 
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_qualified</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="inner_quoted"><span>"code"</span></span><span class="main"><span>,</span></span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>code_thms</span></span><span class="main"><span>)</span></span><span>
     </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>code_thms</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_code_thms_cmd</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No definitional theorem"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Local_Defs.meta_rewrite_rule</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.prop_of</span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_equals</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>|&gt;</span><span> </span><span>strip_comb</span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> 
    </span><span>|&gt;</span><span> </span><span class="entity"><span>name_of</span></span><span> 
    </span><span>|&gt;</span><span> </span><span>Long_Name.base_name</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exs_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>extractions.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Name_Space.check</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exs_tab</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>|&gt;</span><span> </span><span>flat</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Name_Space.dest_table</span><span> </span><span class="entity"><span>exs_tab</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span>|&gt;</span><span> </span><span>flat</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>exs</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No extraction patterns selected"</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_recursion_eqs'</span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>lthy</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Conclusion does not match any extraction pattern"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span>::</span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Refine_Util.fo_matchp</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>concl</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"concrete_definition: Pattern has multiple holes, taking "</span></span><span>
            </span><span>^</span><span> </span><span class="inner_quoted"><span>"first one: "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>pat</span></span><span>
          </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"concrete_definition: Ignoring invalid pattern "</span></span><span> 
             </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
             </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* Define concrete function from refinement lemma *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_concrete_fun</span></span><span> </span><span class="entity"><span>gen_code</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>attribs_def_raw</span></span><span> </span><span class="entity"><span>attribs_ref_raw</span></span><span> </span><span class="entity"><span>param_names</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>pats</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>orig_lthy</span></span><span class="main"><span>:</span></span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>orig_lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>yield_singleton2</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.concl_of</span><span>

  </span><span class="comment1"><span>(*val ((typ_subst,term_subst),lthy) 
    = Variable.import_inst true [concl] lthy;
  val concl = Term_Subst.instantiate (typ_subst,term_subst) concl;
  *)</span></span><span>

  </span><span class="comment1"><span>(* TODO/FIXME: Copied blindly&amp;without understanding from corresponding change to Refine_Monadic, on 2021-2021-1 transition *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term_subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>build</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span> </span><span>|&gt;</span><span> </span><span>Vars.fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>  

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term_subst</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No such variable: "</span></span><span>
                           </span><span>^</span><span>Term.string_of_vname</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_names</span></span><span class="main"><span>;</span></span><span>

  </span><span class="comment1"><span>(* 
  val _ = Syntax.pretty_term lthy concl |&gt; Pretty.writeln
  val _ = Pretty.big_list "Patterns" (map (Syntax.pretty_term lthy o Thm.term_of) pats) |&gt; Pretty.writeln
  *)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>param_terms</span></span><span> </span><span>---&gt;</span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>f_term</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_term</span></span><span> 
    </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span class="entity"><span>lhs_type</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>param_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs_term</span></span><span class="main"><span>,</span></span><span class="entity"><span>f_term</span></span><span class="main"><span>)</span></span><span> 
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>param_terms</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attribs_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.check_src</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attribs_def_raw</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attribs_ref</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.check_src</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attribs_ref_raw</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Specification.definition</span></span><span> 
    </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>,</span></span><span>Mixfix.NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span class="entity"><span>attribs_def</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_term</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>folded_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Defs.fold</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>fun_name</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> 
       </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_qualified</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>basename</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"refine"</span></span><span class="main"><span>,</span></span><span class="entity"><span>attribs_ref</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>folded_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
       </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>gen_code</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_recursion_eqs'</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>code</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
      
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span class="entity"><span>folded_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_pattern</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nidx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maxidx_of_term</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t_orig</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> 
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="main"><span>(</span></span><span class="quasi_keyword"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="HOL-Library.Rewrite.html#Rewrite.rewrite_HOLE|const"><span>⌑</span></a></span><span class="main"><span>::</span></span><span class="tvar"><span>?'v_T</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"HOLE"</span></span><span class="main"><span>,</span></span><span class="entity"><span>nidx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span>^</span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>nidx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Term_Subst.zero_var_indexes</span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_hole</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_hole</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_holes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_hole</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>?</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>  
      
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>num_holes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cd-pattern has multiple or no holes"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t_orig</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


    </span><span class="comment1"><span>(*val cfg_prep_code = Attrib.setup_config_bool @{binding synth_definition_prep_code} (K false)*)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> 
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Refine_Util</span><span>
      </span><span class="comment1"><span>(*val flags = parse_bool_config' "prep_code" cfg_prep_code
      val parse_flags = parse_paren_list' flags  *)</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>       
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sd_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*parse_flags --*)</span></span><span> </span><span>Parse.binding</span><span> </span><span>--</span><span> </span><span>Parse.opt_attribs</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>is</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> 
        </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Parse.attribs</span><span> </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>":"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>--</span><span> </span><span>Parse.term</span><span> 
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  


    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sd_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>attribs_def_raw</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>attribs_ref_raw</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>t_raw</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
        </span><span class="comment1"><span>(*val ctxt = Refine_Util.apply_configs flags lthy*)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="comment1"><span>(*val flag_prep_code = Config.get ctxt cfg_prep_code*)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_prop</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t_raw</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>read</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>prepare_pattern</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>=</span></span><span class="entity"><span>t</span></span><span>

      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> 
        </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> 
              </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> 
                 </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_qualified</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"refine_raw"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
                 </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>dthm</span></span><span class="main"><span>,</span></span><span class="entity"><span>rthm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>define_concrete_fun</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>attribs_def_raw</span></span><span> </span><span class="entity"><span>attribs_ref_raw</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pat</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

            </span><span class="comment1"><span>(* FIXME: Does not work, as we cannot see the default extraction patterns!
            val lthy = lthy 
              |&gt; flag_prep_code ? Refine_Automation.extract_recursion_eqs 
                [Sepref_Extraction.heap_extraction] (Binding.name_of name) dthm
            *)</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>dthm</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>writeln</span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>rthm</span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.string_of</span><span> </span><span>|&gt;</span><span> </span><span>writeln</span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>thmss</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"After-qed: Wrong thmss structure"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span>flat</span><span> </span><span class="entity"><span>thmss</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  
  
  

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cd_pat_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>Refine_Util.anorm_term</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>cd_patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>merge</span><span> </span><span class="entity"><span>cd_pat_eq</span></span><span>
  </span><span class="main"><span>)</span></span><span> 

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_cd_pattern</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span>|&gt;</span><span> </span><span>fastype_of</span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span>Thm.term_of</span><span> </span><span class="entity"><span>pat</span></span><span> 
        </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> 
        </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pat</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_cd_pattern</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span>cd_patterns.map</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="entity"><span>cd_pat_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepare_cd_pattern</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_cd_pattern</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span>cd_patterns.map</span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="entity"><span>cd_pat_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepare_cd_pattern</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_cd_patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cd_patterns.get</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>


    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>rec_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Thms</span></span><span> </span><span class="main"><span>(</span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Definition_Utils.vcs_rec|attribute"><span class="entity_def" id="Definition_Utils.vcs_rec|fact"><span>vcs_rec</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"VC-Solver: Recursive intro rules"</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>solve_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Thms</span></span><span> </span><span class="main"><span>(</span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Definition_Utils.vcs_solve|attribute"><span class="entity_def" id="Definition_Utils.vcs_solve|fact"><span>vcs_solve</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"VC-Solver: Solve rules"</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_vc_rec_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_thms.add_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>del_vc_rec_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_thms.del_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_vc_rec_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_thms.get</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_vc_solve_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solve_thms.add_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>del_vc_solve_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solve_thms.del_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_vc_solve_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solve_thms.get</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>
      </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"rec"</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Args.add</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> 
        </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>rec_thms.add</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"rec"</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Args.del</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> 
        </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>rec_thms.del</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>solve_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>
      </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"solve"</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Args.add</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> 
        </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>solve_thms.add</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"solve"</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Args.del</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> 
        </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>solve_thms.del</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vc_solve_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>clasimp_modifiers</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rec_modifiers</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>solve_modifiers</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vc_solve_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>no_pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_thms.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sthms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solve_thms.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_pre</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>K</span><span> </span><span>all_tac</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>clarsimp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>auto_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>TRY</span><span> </span><span>o</span><span> </span><span class="entity"><span>pre_tac</span></span><span>
      </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span class="entity"><span>REPEAT_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rthms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sthms</span></span><span> </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span>#&gt;</span><span> </span><span class="entity"><span>rec_thms.setup</span></span><span> 
      </span><span>#&gt;</span><span> </span><span class="entity"><span>solve_thms.setup</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="entity"><span>Definition_Utils.setup</span></span><span>


</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_cpat</span></span><span> </span><span class="entity"><span>cxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tks</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.lift</span><span> </span><span>Parse.embedded_inner_syntax</span><span> </span><span class="entity"><span>cxt</span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.read_term_pattern</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>Definition_Utils.prepare_pattern</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tks</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_p</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.repeat1</span><span> </span><span class="entity"><span>parse_cpat</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> "</span><span class="entity_def" id="Definition_Utils.cd_patterns|attribute"><span>cd_patterns</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>
       </span><span>Scan.lift</span><span> </span><span>Args.add</span><span> </span><span>|--</span><span> </span><span class="entity"><span>do_p</span></span><span> </span><span class="entity"><span>Definition_Utils.add_cd_pattern</span></span><span>
    </span><span>||</span><span> </span><span>Scan.lift</span><span> </span><span>Args.del</span><span> </span><span>|--</span><span> </span><span class="entity"><span>do_p</span></span><span> </span><span class="entity"><span>Definition_Utils.del_cd_pattern</span></span><span>
    </span><span>||</span><span> </span><span class="entity"><span>do_p</span></span><span> </span><span class="entity"><span>Definition_Utils.add_cd_pattern</span></span><span>
    </span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"Add/delete concrete_definition pattern"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>

</span><span class="comment1"><span>(* Command setup *)</span></span><span>

</span><span class="comment1"><span>(* TODO: Folding of .refine-lemma seems not to work, if the function has
  parameters on which it does not depend *)</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹ </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> 
  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> </span><span class="keyword1"><span>concrete_definition</span></span><span class="antiquote"><span>}</span></span></span></span><span> 
  </span><span class="inner_quoted"><span>"Define constant from theorem"</span></span><span>
  </span><span class="main"><span>(</span></span><span>Parse.binding</span><span> 
    </span><span>--</span><span> </span><span>Parse.opt_attribs</span><span>
    </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>for</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Args.var</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>is</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>--</span><span> </span><span>Parse.opt_attribs</span><span> </span><span>--</span><span> </span><span>Parse.thm</span><span>
    </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>uses</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.embedded_inner_syntax</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>attribs_def</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>attribs_ref</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>raw_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>raw_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Expecting exactly one theorem"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Definition_Utils.get_cd_patterns</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.read_term_pattern</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>Definition_Utils.prepare_pattern</span></span><span> </span><span>#&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>#&gt;</span><span>
        </span><span class="entity"><span>Definition_Utils.prepare_cd_pattern</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
    </span><span class="entity"><span>Definition_Utils.define_concrete_fun</span></span><span> 
      </span><span>NONE</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>attribs_def</span></span><span> </span><span class="entity"><span>attribs_ref</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>lthy</span></span><span> 
    </span><span>|&gt;</span><span> </span><span>snd</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ 
  Command: 
    </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"concrete_definition name [attribs_def] for params is [attribs_ref] thm uses patterns"</span></span><span class="antiquote"><span>}</span></span></span><span>
  where </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"attribs_..."</span></span><span class="antiquote"><span>}</span></span></span><span>, </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"for"</span></span><span class="antiquote"><span>}</span></span></span><span>, and </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"uses"</span></span><span class="antiquote"><span>}</span></span></span><span>-parts are optional.

  Declares a new constant </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"name"</span></span><span class="antiquote"><span>}</span></span></span><span> by matching the theorem </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"thm"</span></span><span class="antiquote"><span>}</span></span></span><span> 
  against a pattern.
  
  The definition theorem of the constant gets the attributes specified in </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>attribs_def›</span></span></span><span>.
  Moreover, a new theorem is derived from </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>thm›</span></span></span><span>, with the defined constant folded.
  This is registered as </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>name.refine›</span></span></span><span>, with attributes [attribs_ref].
  
  If the </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"for"</span></span><span class="antiquote"><span>}</span></span></span><span> clause is given, it lists variables in the theorem, 
  and thus determines the order of parameters of the defined constant. Otherwise,
  parameters will be in order of occurrence.

  If the </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"uses"</span></span><span class="antiquote"><span>}</span></span></span><span> clause is given, it lists patterns. The conclusion of the
  theorem will be matched against each of these patterns. For the first matching
  pattern, the constant will be declared to be the term that matches the first
  non-dummy variable of the pattern. If no </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"uses"</span></span><span class="antiquote"><span>}</span></span></span><span>-clause is specified,
  the default patterns will be tried.

  Attribute: </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"cd_patterns pats"</span></span><span class="antiquote"><span>}</span></span></span><span>. Declaration attribute. Declares
    default patterns for the </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"concrete_definition"</span></span><span class="antiquote"><span>}</span></span></span><span> command.
  
›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>declare</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><a class="entity_ref" href="Definition_Utils.html#Definition_Utils.cd_patterns|attribute"><span class="operator"><span>cd_patterns</span></span></a><span> </span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span></a></span></a></span></a></span><span> </span><span class="main"><a class="entity_ref" href="HOL-Library.Rewrite.html#Rewrite.rewrite_HOLE|const"><span class="main"><a class="entity_ref" href="HOL-Library.Rewrite.html#Rewrite.rewrite_HOLE|const"><span class="main"><a class="entity_ref" href="HOL-Library.Rewrite.html#Rewrite.rewrite_HOLE|const"><span class="main"><a class="entity_ref" href="HOL-Library.Rewrite.html#Rewrite.rewrite_HOLE|const"><span>⌑</span></a></span></a></span></a></span></a></span><span>"</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span> </span><span class="main"><span class="main"><span class="main"><span class="main"><span>==</span></span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="HOL-Library.Rewrite.html#Rewrite.rewrite_HOLE|const"><span class="main"><a class="entity_ref" href="HOL-Library.Rewrite.html#Rewrite.rewrite_HOLE|const"><span class="main"><a class="entity_ref" href="HOL-Library.Rewrite.html#Rewrite.rewrite_HOLE|const"><span class="main"><a class="entity_ref" href="HOL-Library.Rewrite.html#Rewrite.rewrite_HOLE|const"><span>⌑</span></a></span></a></span></a></span></a></span><span>"</span></span></span></span></span></span><span> </span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML_val</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Parse.binding</span><span>›</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML_val</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>:</span></span><span>binding</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.empty</span><span>›</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML_val</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> foo</span><span class="antiquote"><span>}</span></span></span></span><span>›</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹ 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Scan.optional</span><span>
     </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>(</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Parse.list1</span><span> </span><span class="main"><span>(</span></span><span>Parse.position</span><span> </span><span>Args.name</span><span class="main"><span>)</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>)</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> 
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> </span><span class="keyword1"><span>prepare_code_thms</span></span><span class="antiquote"><span>}</span></span></span></span><span> 
    </span><span class="inner_quoted"><span>"Extract recursive code equations from definition theorem with fixed points"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>modes</span></span><span> </span><span>--</span><span> </span><span>Parse.opt_attribs</span><span> </span><span>--</span><span> </span><span>Parse.thms1</span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>modes</span></span><span class="main"><span>,</span></span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>raw_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.check_src</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attribs</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>raw_thms</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Definition_Utils.prepare_code_thms_cmd</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ 
  Command: 
    </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"prepare_code_thms (modes) thm"</span></span><span class="antiquote"><span>}</span></span></span><span>
  where the </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"(mode)"</span></span><span class="antiquote"><span>}</span></span></span><span>-part is optional.

  Set up code-equations for recursions in constant defined by </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"thm"</span></span><span class="antiquote"><span>}</span></span></span><span>.
  The optional </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"modes"</span></span><span class="antiquote"><span>}</span></span></span><span> is a comma-separated list of extraction modes.
›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Example setup for option monad fixed points›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Definition_Utils.gen_code_thm_option_fixp|fact"><span class="entity_def" id="Definition_Utils.gen_code_thm_option_fixp|thm"><span>gen_code_thm_option_fixp</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>fixes</span></span></span><span> </span><span class="free"><span>x</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_27530..27531">D</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Partial_Function.html#Partial_Function.option.fixp_fun|const"><span>option.fixp_fun</span></a><span> </span><span class="free"><span>B</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_27567..27568">M</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Partial_Function.html#Partial_Function.option.mono_body|const"><span>option.mono_body</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>f</span></span><span class="main"><span>.</span></span><span> </span><span class="free"><span>B</span></span><span> </span><span class="bound"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>B</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Definition_Utils.html#offset_27530..27531"><span>D</span></a><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Tools/eqsubst.ML.html#HOL.subst|method"><span class="operator"><span>subst</span></span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/Partial_Function.html#Partial_Function.option.mono_body_fixp|fact"><span>option.mono_body_fixp</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Definition_Utils.html#offset_27567..27568"><span>M</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML_val</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="entity"><span>Definition_Utils.add_extraction</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"option"</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>{</span></span><span>
    pattern </span><span class="main"><span>=</span></span><span> </span><span>Logic.varify_global</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/Partial_Function.html#Partial_Function.option.fixp_fun|const"><span>option.fixp_fun</span></a><span> </span><span class="free"><span>x</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
    gen_thm </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Definition_Utils.html#Definition_Utils.gen_code_thm_option_fixp|fact"><span>gen_code_thm_option_fixp</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
    gen_tac </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Partial_Function.mono_tac</span></span><span>
  </span><span class="main"><span>}</span></span><span>
›</span></span><span>
  
</span><span class="keyword1"><span class="command"><span>declaration</span></span></span><span> </span><span class="quoted"><span>‹</span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Definition_Utils.declare_extraction_group</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span>option</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>›</span></span><span>
  
</span><span class="keyword1"><span class="command"><span>declaration</span></span></span><span> </span><span class="quoted"><span>‹ </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="entity"><span>Definition_Utils.add_extraction</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"option"</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>{</span></span><span>
    pattern </span><span class="main"><span>=</span></span><span> </span><span>Logic.varify_global</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/Partial_Function.html#Partial_Function.option.fixp_fun|const"><span>option.fixp_fun</span></a><span> </span><span class="free"><span>x</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
    gen_thm </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Definition_Utils.html#Definition_Utils.gen_code_thm_option_fixp|fact"><span>gen_code_thm_option_fixp</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
    gen_tac </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Partial_Function.mono_tac</span></span><span>
  </span><span class="main"><span>}</span></span><span>
›</span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test_def|fact"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test_def|thm"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test|const"><span>option_fixp_extraction_test</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>m</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>n</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="../../HOL/HOL/Partial_Function.html#Partial_Function.option.fixp_fun|const"><span>option.fixp_fun</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>D</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> 
    </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>if</span></a></span><span> </span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>then</span></a></span><span> 
      </span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.option.Some|const"><span>Some</span></a><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span> 
    </span><span class="keyword1"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.If|const"><span>else</span></a></span><span> 
      </span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.bind|const"><span>Option.bind</span></a><span> </span><span class="main"><span>(</span></span><span class="bound"><span>D</span></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.minus_class.minus|const"><span>-</span></a></span><a class="entity_ref" href="../../HOL/HOL/Int.html#Int.int|const"><span>int</span></a><span> </span><span class="free"><span class="bound"><span class="entity"><span>m</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>a</span></span><span class="main"><span>.</span></span><span>
      </span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.bind|const"><span>Option.bind</span></a><span> </span><span class="main"><span>(</span></span><span class="bound"><span>D</span></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.minus_class.minus|const"><span>-</span></a></span><span class="free"><span class="bound"><span class="entity"><span>n</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>b</span></span><span class="main"><span>.</span></span><span>
      </span><a class="entity_ref" href="../../HOL/HOL/Option.html#Option.option.Some|const"><span>Some</span></a><span> </span><span class="main"><span>(</span></span><span class="bound"><span>a</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Groups.html#Groups.plus_class.plus|const"><span>+</span></a></span><span class="bound"><span>b</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>

  </span><span class="keyword1"><span class="command"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test.code|fact"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test.defs|fact"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test.f_06306516_def|fact"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test.code(2)|thm"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test.code(1)|thm"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test.defs|thm"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test.f_06306516_def|thm"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test.f_06306516_def_raw|axiom"><span class="entity_def" id="Definition_Utils.option_fixp_extraction_test.f_06306516|const"><span>prepare_code_thms</span></span></span></span></span></span></span></span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span>option</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>code</span></span><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="Definition_Utils.html#Definition_Utils.option_fixp_extraction_test_def|fact"><span>option_fixp_extraction_test_def</span></a><span>
  </span><span class="keyword1"><span class="command"><span>print_theorems</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>export_code</span></span></span><span> </span><span class="quoted"><span class="quoted"><a class="entity_ref" href="Definition_Utils.html#Definition_Utils.option_fixp_extraction_test|const"><span>option_fixp_extraction_test</span></a></span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> SML

</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span>
  </span><span class="main"><span>(</span></span><span>ML_Antiquotation.inline</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>extraction_group</span><span>›</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Args.context</span><span> </span><span>--</span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Parse.position</span><span> </span><span>Args.name</span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ML_Syntax.print_string</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Definition_Utils.check_extraction_group</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
›</span></span><span>  

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ 
  Command: 
    </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"synth_definition binding [def_attrs] is [ref_attrs]: term"</span></span><span class="antiquote"><span>}</span></span></span><span>
  where the </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"(def_attrs)"</span></span><span class="antiquote"><span>}</span></span></span><span> and </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"(ref_attrs)"</span></span><span class="antiquote"><span>}</span></span></span><span> parts are optional.

  Sets up a schematic goal with a hole, proves the schematic goal, and  
  define what has been inserted into the hole as a new constant. 
  Moreover, generate a refinement theorem for the proved goal with the hole replaced by 
  the defined constant.
  
  The </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>def_attrs›</span></span></span><span> are applied to the definition theorem, the </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>ref_attrs›</span></span></span><span> to 
  the refinement theorem.
›</span></span></span><span>
  
  
</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Definition_Utils</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Outer_Syntax.local_theory_to_proof</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> "</span><span class="keyword1"><span>synth_definition</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="inner_quoted"><span>"Synthesis of constant from schematic goal with hole"</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>sd_parser</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>sd_cmd</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>
  
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>