<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹LLVM_Builder.ml›</title>
</head>


<body>
<div class="head">
<h1>File ‹LLVM_Builder.ml›</h1>
</div>

<pre class="source"><span class="comment1"><span>(* Alignment *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ALIGNMENT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> to_bytes</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> to_bits</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> from_bytes</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> from_bits</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="comment1"><span>(* Raises Error unless argument is multiple of 8. *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> min_align</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="comment1"><span>(* Minimum possible alignment (1 byte) *)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> align_ofs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invalid</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_valid</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
      
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Alignment</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ALIGNMENT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_bytes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Align</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_bits</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_bytes</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>*</span><span> </span><span class="inner_numeral"><span>8</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>from_bytes</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>=</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>from_bits</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>mod</span><span> </span><span class="inner_numeral"><span>8</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bit-size must be multiple of 8: "</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>from_bytes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>8</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Align</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Align</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align</span></span><span> </span><span class="main"><span>(</span></span><span>Int.max</span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_align</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>from_bytes</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>align_ofs</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_bytes</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>+</span><span class="entity"><span>a</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>a</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>invalid</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_valid</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Align</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span>&gt;</span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Integer and Float Alignment info *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ALIGN_INFO</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span>
  
  </span><span class="comment1"><span>(** All alignments in bytes *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>Alignment.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="entity"><span>Alignment.T</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_alignment</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Alignment.T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_empty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> strings_of</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>

  
      
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Align_Info</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ALIGN_INFO</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="entity"><span>Alignment.T</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(* type-size, alignment. Sorted *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Ambiguous alignment for size "</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make</span></span><span> </span><span class="entity"><span>als</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>als</span></span><span> </span><span class="entity"><span>empty</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_alignment</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>u</span></span><span>&gt;=</span><span class="entity"><span>sz</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Align-Info should not be empty"</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>split_last</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strings_of</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>u</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>":"</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Alignment.to_bits</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>xs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  
  
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Data Layout *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>DATA_LAYOUT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> string_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> of_string</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parsed_info_string</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
    
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_complete</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> int_alignment</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Alignment.T</span></span><span> </span><span class="comment1"><span>(* Alignment for iN type *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> float_alignment</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Alignment.T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> double_alignment</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Alignment.T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ptr_alignment</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Alignment.T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> aggr_alignment</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Alignment.T</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ptr_size_bits</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> llvm_dflt_layout</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> x86_64_linux_layout</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span>
  
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data_Layout</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>DATA_LAYOUT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    raw_items</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* Everything *)</span></span><span>
    ptr_size</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* bits *)</span></span><span>
    ptr_align</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Alignment.T</span></span><span class="main"><span>,</span></span><span>
    int_align</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Align_Info.T</span></span><span class="main"><span>,</span></span><span>
    float_align</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Align_Info.T</span></span><span class="main"><span>,</span></span><span>
    aggr_align</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Alignment.T</span></span><span>
  </span><span class="main"><span>}</span></span><span>
                                
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_empty</span></span><span> </span><span class="entity"><span>raw_items</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    raw_items</span><span class="main"><span>=</span></span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span>
    ptr_size</span><span class="main"><span>=</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span>
    ptr_align</span><span class="main"><span>=</span></span><span class="entity"><span>Alignment.invalid</span></span><span class="main"><span>,</span></span><span>
    int_align</span><span class="main"><span>=</span></span><span class="entity"><span>Align_Info.empty</span></span><span class="main"><span>,</span></span><span>
    float_align</span><span class="main"><span>=</span></span><span class="entity"><span>Align_Info.empty</span></span><span class="main"><span>,</span></span><span>
    aggr_align</span><span class="main"><span>=</span></span><span class="entity"><span>Alignment.invalid</span></span><span>
  </span><span class="main"><span>}</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_ptr_size</span></span><span>    </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>raw_items</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> ptr_size</span><span class="main"><span>=</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> ptr_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> int_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> float_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> aggr_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_ptr_align</span></span><span>   </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>raw_items</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> ptr_size</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> ptr_align</span><span class="main"><span>=</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> int_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> float_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> aggr_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_int_align</span></span><span>   </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>raw_items</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> ptr_size</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> ptr_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> int_align</span><span class="main"><span>=</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> float_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> aggr_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_float_align</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>raw_items</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> ptr_size</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> ptr_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> int_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> float_align</span><span class="main"><span>=</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> aggr_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_aggr_align</span></span><span>  </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>raw_items</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> ptr_size</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> ptr_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> int_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> float_align</span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> aggr_align</span><span class="main"><span>=</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>}</span></span><span>

  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_complete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>raw_items </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_not_null</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ename</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span>&lt;&gt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span class="main"><span>(</span></span><span class="entity"><span>ename</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" unspecified"</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_valid</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ename</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Alignment.is_valid</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span class="main"><span>(</span></span><span class="entity"><span>ename</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" unspecified"</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_not_empty</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>ename</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align_Info.is_empty</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>error</span><span class="main"><span>(</span></span><span class="entity"><span>ename</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" unspecified"</span></span><span class="main"><span>)</span></span><span> 
    
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>chk_not_null</span></span><span> </span><span class="entity"><span>ptr_size</span></span><span> </span><span class="inner_quoted"><span>"pointer size"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>chk_valid</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span> </span><span class="inner_quoted"><span>"pointer alignment"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>chk_valid</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span> </span><span class="inner_quoted"><span>"aggregate alignment"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>chk_not_empty</span></span><span> </span><span class="entity"><span>int_align</span></span><span> </span><span class="inner_quoted"><span>"integer alignment"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>chk_not_empty</span></span><span> </span><span class="entity"><span>float_align</span></span><span> </span><span class="inner_quoted"><span>"float alignment"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>raw_items</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"-"</span></span><span> </span><span class="entity"><span>raw_items</span></span><span>
                                                                              
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parsed_info_string</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>raw_items</span><span class="main"><span>=</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>float_align</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s_p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"p:"</span></span><span>^</span><span>Int.toString</span><span> </span><span class="entity"><span>ptr_size</span></span><span>^</span><span class="inner_quoted"><span>":"</span></span><span>^</span><span>Int.toString</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Alignment.to_bits</span></span><span> </span><span class="entity"><span>ptr_align</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s_a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"a:"</span></span><span>^</span><span>Int.toString</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Alignment.to_bits</span></span><span> </span><span class="entity"><span>aggr_align</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s_i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align_Info.strings_of</span></span><span> </span><span class="inner_quoted"><span>"i"</span></span><span> </span><span class="entity"><span>int_align</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s_f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align_Info.strings_of</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span> </span><span class="entity"><span>float_align</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>items</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_p</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>s_i</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>s_f</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>s_a</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="inner_quoted"><span>"&lt;dbg only!&gt;: "</span></span><span> </span><span>^</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"-"</span></span><span> </span><span class="entity"><span>items</span></span><span> </span><span class="comment1"><span>(* Prevent this to be printed to LLVM output! *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_digit</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>size</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Char.ord</span><span> </span><span class="inner_quoted"><span>#"0"</span></span><span> </span><span>&lt;=</span><span> </span><span>ord</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>ord</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>&lt;=</span><span> </span><span>Char.ord</span><span> </span><span class="inner_quoted"><span>#"9"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_nat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.repeat1</span><span> </span><span class="main"><span>(</span></span><span>Scan.one</span><span> </span><span class="entity"><span>is_digit</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>implode</span><span> </span><span>#&gt;</span><span> </span><span>Int.fromString</span><span> </span><span>#&gt;</span><span> </span><span>the</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_bit_align</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_nat</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Alignment.from_bits</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_all</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span>Scan.one</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>size</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>implode</span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stopper</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.stopper</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.read</span><span> </span><span>Lexicon.stopper</span><span>           
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_val</span></span><span> </span><span class="entity"><span>newv</span></span><span> </span><span class="entity"><span>oldv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Alignment.is_valid</span></span><span> </span><span class="entity"><span>oldv</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"duplicate alignment info"</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>newv</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_val_int</span></span><span> </span><span class="entity"><span>newv</span></span><span> </span><span class="entity"><span>oldv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>oldv</span></span><span>&lt;&gt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"duplicate alignment info"</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>newv</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_item</span></span><span> </span><span class="main"><span>=</span></span><span> 
       </span><span>$$</span><span class="inner_quoted"><span>"i"</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>parse_nat</span></span><span> </span><span>--|</span><span> </span><span>$$</span><span class="inner_quoted"><span>":"</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_bit_align</span></span><span> </span><span>--|</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span class="inner_quoted"><span>":"</span></span><span>--</span><span> </span><span class="entity"><span>parse_bit_align</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>map_int_align</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Align_Info.add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>||</span><span> </span><span>$$</span><span class="inner_quoted"><span>"f"</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>parse_nat</span></span><span> </span><span>--|</span><span> </span><span>$$</span><span class="inner_quoted"><span>":"</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_bit_align</span></span><span> </span><span>--|</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span class="inner_quoted"><span>":"</span></span><span>--</span><span> </span><span class="entity"><span>parse_bit_align</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>map_float_align</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Align_Info.add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>  
    </span><span>||</span><span> </span><span>$$</span><span class="inner_quoted"><span>"p"</span></span><span> </span><span>|--</span><span> </span><span>$$</span><span class="inner_quoted"><span>":"</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>parse_nat</span></span><span> </span><span>--|</span><span> </span><span>$$</span><span class="inner_quoted"><span>":"</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_bit_align</span></span><span> </span><span>--|</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span class="inner_quoted"><span>":"</span></span><span>--</span><span> </span><span class="entity"><span>parse_bit_align</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>map_ptr_size</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_val_int</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>map_ptr_align</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_val</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>||</span><span> </span><span>$$</span><span class="inner_quoted"><span>"a"</span></span><span> </span><span>|--</span><span> </span><span>$$</span><span class="inner_quoted"><span>":"</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>parse_bit_align</span></span><span> </span><span>--|</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span class="inner_quoted"><span>":"</span></span><span>--</span><span> </span><span class="entity"><span>parse_bit_align</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>map_aggr_align</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_val</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>||</span><span> </span><span class="entity"><span>parse_all</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
                                                
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>itemf_of_string</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span>raw_explode</span><span>
    </span><span>#&gt;</span><span> </span><span>Scan.read</span><span> </span><span class="entity"><span>stopper</span></span><span> </span><span class="entity"><span>parse_item</span></span><span> 
    </span><span>#&gt;</span><span> </span><span>the</span><span> 
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>                            
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_string</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>items</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_explode</span><span> </span><span class="inner_quoted"><span>"-"</span></span><span> </span><span class="entity"><span>s</span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>itemf_of_string</span></span><span> </span><span class="entity"><span>items</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default_empty</span></span><span> </span><span class="entity"><span>items</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(*val _ = tracing (parsed_info_string t)*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_complete</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>    
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_alignment</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align_Info.get_alignment</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>int_align </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>float_alignment</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align_Info.get_alignment</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>float_align </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>32</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>double_alignment</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Align_Info.get_alignment</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>float_align </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>64</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ptr_alignment</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>ptr_align
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ptr_size_bits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>ptr_size
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aggr_alignment</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>aggr_align


  </span><span class="comment1"><span>(* See 🌐‹https://releases.llvm.org/14.0.0/docs/LangRef.html#data-layout›*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>llvm_dflt_layout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>of_string</span></span><span> </span><span class="inner_quoted"><span>"e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:32:64-f16:16:16-f32:32:32-f64:64:64-f128:128:128-v64:64:64-v128:128:128-a:0:64"</span></span><span>
  
  </span><span class="comment1"><span>(* clang10 on my linux box creates: "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"  
    Stripped of unused address spaces and types, and combined with LLVM-default this yields:
  *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x86_64_linux_layout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>of_string</span></span><span> </span><span class="inner_quoted"><span>"e-m:e-p:64:64:64-a:0:64-n8:16:32:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f16:16:16-f32:32:32-f64:64:64-f128:128:128"</span></span><span>
  
  
</span><span class="comment1"><span>(*  
    
  xxx, ctd here: 
    parser, default, add to export_llvm command
    function to compute structure size, then support for union
*)</span></span><span>  
  

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>LLVM_BUILDER</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(* Target Triple *)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>target_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>target_triple</span><span class="main"><span>:</span></span><span>string</span><span class="main"><span>,</span></span><span> data_layout</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Data_Layout.T</span></span><span class="main"><span>}</span></span><span>
    
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> target_x86_64_linux</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>target_info</span></span><span>
  
  
  
  </span><span class="comment1"><span>(* Builder Type *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> builder</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>target_info</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> string_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> set_dbg_trace</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  
  </span><span class="comment1"><span>(* Types *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>value</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_i</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_double</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_float</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_ptr</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_array</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_vector</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_struct</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_union</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_named</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkty_fptr</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_primitive_ty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dstty_i</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="comment1"><span>(** TODO: Add other dstty functions *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> decl_named_ty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ty_of_val</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>    

  </span><span class="comment1"><span>(* Alignment and sizeof *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> alignment_of_ty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Alignment.T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sizeof_ty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(** Allocation Size *)</span></span><span>
  
  </span><span class="comment1"><span>(*
  xxx, ctd here: test correctness of size-of computations:
    for a variety of types, compare results of
    a) static sizeof_ty
    b) dynamic sizeof_ty in LLVM (then replace in malloc!)
    c) sizeof() of corresponding C structure
  *)</span></span><span>
  
  </span><span class="comment1"><span>(* Constants *)</span></span><span>    
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkc_iw</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkc_i</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkc_f</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Word32.word</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkc_d</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Word64.word</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkc_undef</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkc_zeroinit</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkc_null</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mkc_fun</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  
  </span><span class="comment1"><span>(* Attributes *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>attributes</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> declare_attributes</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>attributes</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_every_proc_attributes</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>attributes</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> declare_every_proc_attributes</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>attributes</span></span><span>
  
  </span><span class="comment1"><span>(* Procedures *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> open_proc</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>attributes</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> close_proc</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

  </span><span class="comment1"><span>(* Basic Blocks *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>label</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> variant_label</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> open_bb</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> </span><span>option</span><span>
  
  
  </span><span class="comment1"><span>(* Instructions *)</span></span><span>
  </span><span class="comment1"><span>(** Arithmetic *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_arith_instr</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_icmp_instr</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_fcmp_instr</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_ptrcmp_instr</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_conv_instr</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  
  </span><span class="comment1"><span>(** Data Structures *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_extractvalue</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_insertvalue</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_dest_union</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_make_union</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  
    
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_extractelement</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_insertelement</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_ofs_ptr</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_gep_idx</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>

  </span><span class="comment1"><span>(** Memory *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_malloc</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_free</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_load</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_store</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_alloca</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  
  
    
  </span><span class="comment1"><span>(** Control Flow *)</span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_call</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_call_void</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_return</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

  </span><span class="comment1"><span>(** Declare external function. 
    When used multiple times for the same function, only one declaration is generated. 
    Thus can be used to ensure that function is declared.
  *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> decl_ext_fun_attrs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> decl_ext_fun</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  
  
  </span><span class="comment1"><span>(** Call and declare function as external, e.g., for intrinsics.
    Note: these functions will automatically declare the called function as external, 
        so no need to additionally call decl_ext_fun
  
  *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_external_call</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_external_call_void</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_external_call_attrs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_external_call_void_attrs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  
  
  </span><span class="comment1"><span>(** Parallel *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_par_call</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 
    </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 
    </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> 
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>  
  
  
  </span><span class="comment1"><span>(* The branch instruction builders return the label of the current basic block, that is terminated by this branch *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_br</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_cbr</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span>
  
  </span><span class="comment1"><span>(* Phi-nodes can be dynamically extended *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>phi_handle</span></span><span>
    
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_phi</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_handle</span></span><span> * </span><span class="entity"><span>value</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> phi_add</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_handle</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span> * </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_phi'</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>value</span></span><span> * </span><span class="entity"><span>label</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>
  

  </span><span class="comment1"><span>(* Derived *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_size_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span>   </span><span class="comment1"><span>(* Dynamic size_of using GEP trick *)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> size_t</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  
  
  </span><span class="comment1"><span>(*
  val size_t: ty
  val mk_size_of: T -&gt; string -&gt; ty -&gt; value        
  *)</span></span><span>
  
      
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>



</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>LLVM_Builder</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>LLVM_BUILDER</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> 'a </span><span class="entity"><span>ref</span></span><span> </span><span class="main"><span>=</span></span><span> 'a </span><span>Unsynchronized.ref</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>regname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> </span><span>option</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>attributes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>target_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>target_triple</span><span class="main"><span>:</span></span><span>string</span><span class="main"><span>,</span></span><span> data_layout</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Data_Layout.T</span></span><span class="main"><span>}</span></span><span>

  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>target_x86_64_linux</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> target_triple </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"x86_64-pc-linux-gnu"</span></span><span class="main"><span>,</span></span><span> data_layout </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data_Layout.x86_64_linux_layout</span></span><span> </span><span class="main"><span>}</span></span><span>  
    
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>TInt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TFloat</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TDouble</span></span><span>  
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TPtr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ty 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TStruct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ty list 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TUnion</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ty * ty list </span><span class="comment1"><span>(* repr type * variant types *)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TVector</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * ty 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TArray</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int * ty 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TNamed</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TFptr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ty option * ty list

  
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    target_info </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>target_info</span></span><span class="main"><span>,</span></span><span>
    next_id </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="entity"><span>ref</span></span><span class="main"><span>,</span></span><span>
    next_attr </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>attributes</span></span><span> </span><span class="entity"><span>ref</span></span><span class="main"><span>,</span></span><span>
    every_proc_attrs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>attributes</span></span><span> </span><span>list</span><span> </span><span class="entity"><span>ref</span></span><span class="main"><span>,</span></span><span>
    out </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="entity"><span>ref</span></span><span class="main"><span>,</span></span><span>
    in_proc </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="entity"><span>ref</span></span><span class="main"><span>,</span></span><span>
    curr_bb </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span>option</span><span> </span><span class="entity"><span>ref</span></span><span class="main"><span>,</span></span><span>
    local_names </span><span class="main"><span>:</span></span><span> </span><span>Name.context</span><span> </span><span class="entity"><span>ref</span></span><span class="main"><span>,</span></span><span>
    dbg_trace </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="entity"><span>ref</span></span><span class="main"><span>,</span></span><span>
    ext_funs </span><span class="main"><span>:</span></span><span> </span><span>Symtab.set</span><span> </span><span class="entity"><span>ref</span></span><span class="main"><span>,</span></span><span>
    named_tys </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>ty</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span> </span><span class="entity"><span>ref</span></span><span> </span><span class="comment1"><span>(* Maps type name to type declaration. Empty string if not (yet) declared *)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>builder_aux</span></span><span> </span><span class="entity"><span>ti</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> 
    target_info</span><span class="main"><span>=</span></span><span class="entity"><span>ti</span></span><span class="main"><span>,</span></span><span>
    next_id </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> 
    next_attr </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> 
    every_proc_attrs </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    out </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    in_proc </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
    curr_bb </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span>
    local_names </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>Name.context</span><span class="main"><span>,</span></span><span>
    dbg_trace </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
    ext_funs </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span>
    named_tys </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>Symtab.empty</span><span>
  </span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>in_bb</span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>curr_bb </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="entity"><span>msg</span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert_open_bb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>curr_bb </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"No open basic block"</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_dbg_trace</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>dbg_trace </span><span class="entity"><span>b</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>x</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> ^#
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>^#</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>b</span></span><span>
  
  
        
  </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>write</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span class="main"><span>#</span></span><span>out </span><span class="entity"><span>builder</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>out </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_indentation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>in_proc </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"  "</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> 
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>in_bb</span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"  "</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>writeln_trace</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>dbg_trace </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>write</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>write</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>  
      
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>writeln'</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>the_indentation</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>writeln_trace</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>writeln'</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>emptyln</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>writeln_trace</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_named_tys</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.change</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>named_tys </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_ext_fun_raw</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.change</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ext_funs </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.insert_set</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prelude</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_defined</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Undefined named type "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_defined</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>text</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tydecls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.dest</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>named_tys </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>check_defined</span></span><span>
      </span><span>|&gt;</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>efdecls</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>Symtab.keys</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ext_funs </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>target_triple</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>target_triple </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>target_info </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data_layout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data_Layout.string_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>data_layout </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>target_info </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="inner_quoted"><span>"; Generated by Isabelle/LLVM-shallow\n"</span></span><span>
  </span><span class="comment1"><span>(*^ "target datalayout = \"e-m:e-i64:64-f80:128-n8:16:32:64-S128\"\n" 
  ^ "target triple = \"x86_64-pc-linux-gnu\"\n\n"*)</span></span><span>
  </span><span>^</span><span> </span><span class="inner_quoted"><span>"target datalayout = \""</span></span><span>^</span><span class="entity"><span>data_layout</span></span><span>^</span><span class="inner_quoted"><span>"\"\n"</span></span><span> 
  </span><span>^</span><span> </span><span class="inner_quoted"><span>"target triple = \""</span></span><span>^</span><span class="entity"><span>target_triple</span></span><span>^</span><span class="inner_quoted"><span>"\"\n\n"</span></span><span>
  </span><span>^</span><span> </span><span class="entity"><span>tydecls</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n\n"</span></span><span>
  </span><span>^</span><span> </span><span class="entity"><span>efdecls</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n\n"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> 

      
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_prelude</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span>^</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>acc</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>out </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="entity"><span>ti</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>builder_aux</span></span><span> </span><span class="entity"><span>ti</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
    </span><span class="entity"><span>b</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> 
  
  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_named_tys</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_named_ty_raw</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="entity"><span>check_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>named_tys </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>map_named_tys</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Duplicate named type declaration:"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_named_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>   
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>named_tys </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Undefined (but declared) named type:"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Undeclared named type:"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
    

  </span><span class="comment1"><span>(* Primitive types: those valid as vector elements *)</span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_primitive_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_primitive_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_primitive_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_primitive_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_primitive_ty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    
      
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkty_i</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TInt</span></span><span> </span><span class="entity"><span>w</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mkty_double</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TDouble</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mkty_float</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TFloat</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkty_ptr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="comment1"><span>(*fun mkty_array n ty = "[" ^ Int.toString n ^# "x" ^# ty ^"]"*)</span></span><span>
  </span><span class="comment1"><span>(*fun mkty_struct tys = "{" ^ (separate ", " tys |&gt; implode) ^ "}"*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkty_array</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TArray</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkty_vector</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span> 
    </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_primitive_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"mkty_vector: non-primitive element"</span></span><span class="main"><span>;</span></span><span> 
    </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>&gt;</span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"mkty_vector: n=0"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>TVector</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkty_struct</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>tys</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkty_named</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkty_fptr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TFptr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dstty_i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dstty_i</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"dstty_i"</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dstty_ptr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dstty_ptr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"dstty_ptr"</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isty_i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isty_i</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isty_f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isty_f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isty_f</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>alignment_of_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>data_layout </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>target_info </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>

    </span><span class="comment1"><span>(*
      As this is redundant code to LLVM's align computation, and part of trusted code base, 
      we only support the cases we actually need, and raise an error otherwise. 
    *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data_Layout.int_alignment</span></span><span> </span><span class="entity"><span>dl</span></span><span> </span><span class="entity"><span>w</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="entity"><span>TFloat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data_Layout.float_alignment</span></span><span> </span><span class="entity"><span>dl</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="entity"><span>TDouble</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data_Layout.double_alignment</span></span><span> </span><span class="entity"><span>dl</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data_Layout.ptr_alignment</span></span><span> </span><span class="entity"><span>dl</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TVector</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Vector types not supported for alignment/sizeof computation"</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* Not (yet) needed here *)</span></span><span> 
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TArray</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TInt</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data_Layout.int_alignment</span></span><span> </span><span class="entity"><span>dl</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TArray</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Array types other than i8[] not supported for alignment/sizeof computation"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>Alignment.max</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data_Layout.aggr_alignment</span></span><span> </span><span class="entity"><span>dl</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TUnion</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="comment1"><span>(* rty has been constructed to have correct alignment *)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFptr</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data_Layout.ptr_alignment</span></span><span> </span><span class="entity"><span>dl</span></span><span>
      
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>al</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>align_ofs_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alignment_of_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Alignment.align_ofs</span></span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sizeof_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>data_layout </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>target_info </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>round_bit_to_byte</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>+</span><span class="inner_numeral"><span>7</span></span><span class="main"><span>)</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>8</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ptr_size_bytes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>round_bit_to_byte</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data_Layout.ptr_size_bits</span></span><span> </span><span class="entity"><span>dl</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>incr_ofs</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>align_ofs_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="entity"><span>ty</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>round_bit_to_byte</span></span><span> </span><span class="entity"><span>w</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="entity"><span>TFloat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>4</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="entity"><span>TDouble</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ptr_size_bytes</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TVector</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Vector types not supported for alignment/sizeof computation"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TArray</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TArray</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Array types other than i8[] not supported for alignment/sizeof computation"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>incr_ofs</span></span><span> </span><span class="entity"><span>sz</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>align_ofs_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TUnion</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="entity"><span>rty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFptr</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ptr_size_bytes</span></span><span>
      
  
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>align_ofs_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sz</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maximum</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"maximum: empty"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>maximum</span></span><span> </span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mx</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_greater</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cmp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>b</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fold</span><span> </span><span class="entity"><span>mx</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fill_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sz1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sizeof_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sz1</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>sz</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"fill_ty: nothing to fill"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sz2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span>-</span><span class="entity"><span>sz1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkty_struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mkty_array</span></span><span> </span><span class="entity"><span>sz2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkty_i</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sz</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>sizeof_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"sizeof fill_ty"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alignment_of_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alignment_of_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"alignment_of fill_ty"</span></span><span class="main"><span>;</span></span><span>
    
    </span><span class="entity"><span>res</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkty_union</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"mkty_union: empty union type"</span></span><span>
    
    </span><span class="comment1"><span>(*
      If the largest sized variant also has largest alignment: take this!
      Otherwise: type with largest alignment + i8[] to fill up to aligned largest size
    *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>al_of_ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Alignment.to_bytes</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>alignment_of_ty</span></span><span> </span><span class="entity"><span>b</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sz_of_ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sizeof_ty</span></span><span> </span><span class="entity"><span>b</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_al_cmp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="entity"><span>sz_of_ty</span></span><span> </span><span>|||</span><span> </span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="entity"><span>al_of_ty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>al_ty_cmp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="entity"><span>al_of_ty</span></span><span> </span><span>|||</span><span> </span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="entity"><span>sz_of_ty</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_sz</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maximum</span></span><span> </span><span class="entity"><span>ty_al_cmp</span></span><span> </span><span class="entity"><span>tys</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_al</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maximum</span></span><span> </span><span class="entity"><span>al_ty_cmp</span></span><span> </span><span class="entity"><span>tys</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_size</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sz_of_ty</span></span><span> </span><span class="entity"><span>ty_sz</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_align</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alignment_of_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty_al</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_align_bytes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Alignment.to_bytes</span></span><span> </span><span class="entity"><span>max_align</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>al_of_ty</span></span><span> </span><span class="entity"><span>ty_sz</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_align_bytes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ty_sz</span></span><span> 
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>fill_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty_al</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Alignment.align_ofs</span></span><span> </span><span class="entity"><span>max_align</span></span><span> </span><span class="entity"><span>max_size</span></span><span class="main"><span>)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sz_of_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>sz_of_ty</span></span><span> </span><span class="entity"><span>repty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"mkty_union: repty size"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>al_of_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>al_of_ty</span></span><span> </span><span class="entity"><span>repty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"mkty_union: repty alignment"</span></span><span>
    
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>TUnion</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repty</span></span><span class="main"><span>,</span></span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
  
  
      
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>size_w</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>data_layout </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>target_info </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Data_Layout.ptr_size_bits</span></span><span> </span><span class="entity"><span>dl</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkty_i</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>size_w</span></span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quote_name</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="comment1"><span>(* TODO: Put into quotes, and escape if necessary! *)</span></span><span>  
  
    
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>REG</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ty * string </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CONST</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ty * string </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>UNNAMED</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>REG</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>UNNAMED</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"ty_of_val UNNAMED"</span></span><span class="main"><span>)</span></span><span>
  

  </span><span class="comment1"><span>(* Work around ~ sign, which is - in LLVM *)</span></span><span>  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_to_string</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span>&lt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"-"</span></span><span>^</span><span>Int.toString</span><span> </span><span class="main"><span>(</span></span><span>abs</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>i</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkc_i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>TInt</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_to_string</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mkc_i</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mkc_i: Expected integer type"</span></span><span class="main"><span>)</span></span><span>

  </span><span class="comment1"><span>(* Also in LLC_Lib. Duplicated here as this is part of printing TCB *)</span></span><span>  
  </span><span class="comment1"><span>(*val str_of_w32 = Word32.fmt StringCvt.HEX #&gt; StringCvt.padLeft #"0" 8 #&gt; prefix "0x";  *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>str_of_w64</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Word64.fmt</span><span> </span><span>StringCvt.HEX</span><span> </span><span>#&gt;</span><span> </span><span>StringCvt.padLeft</span><span> </span><span class="inner_quoted"><span>#"0"</span></span><span> </span><span class="inner_numeral"><span>16</span></span><span> </span><span>#&gt;</span><span> </span><span>prefix</span><span> </span><span class="inner_quoted"><span>"0x"</span></span><span class="main"><span>;</span></span><span>  
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkc_d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>TDouble</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>str_of_w64</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mkc_d</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mkc_d: Expected double type"</span></span><span class="main"><span>)</span></span><span>
    

  </span><span class="comment1"><span>(* TODO: Generate reflected function on Word32/64, using Machine-Words AFP entry! *)</span></span><span>
  </span><span class="comment1"><span>(* Convert 32bit single representation to 64bit representation required by LLVM.
    The funtion LLVM_Extend_Float_Double.fext_int_32_64 is verified in Isabelle, 
    and reflected into the ML environment. See <span class="hidden">\&lt;^</span><span class="control">theory</span><span class="hidden">&gt;</span>‹IEEE_Float_Extend_Integer›
  *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fext_word_32_64</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Word32.toInt</span><span> </span><span>#&gt;</span><span> </span><span>LLVM_Extend_Float_Double.fext_int_32_64</span><span> </span><span>#&gt;</span><span> </span><span>Word64.fromInt</span><span>
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkc_f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>TFloat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>str_of_w64</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fext_word_32_64</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mkc_f</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mkc_f: Expected float type"</span></span><span class="main"><span>)</span></span><span>
      
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkc_iw</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkc_i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkty_i</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkc_undef</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"undef"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkc_zeroinit</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"zeroinitializer"</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkc_null</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>TPtr</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"null"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mkc_null</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mkc_null: Expected pointer type"</span></span><span class="main"><span>)</span></span><span>
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkc_fun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>TFptr</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"@"</span></span><span>^</span><span class="entity"><span>quote_name</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mkc_fun</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mkc_fun: Expected function type"</span></span><span class="main"><span>)</span></span><span>
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iop</span></span><span> </span><span class="entity"><span>sr</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span class="entity"><span>sr</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>sr</span></span><span>:=</span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>variant_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iop</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>local_names </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>variant_reg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>variant_name</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>variant_label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>variant_name</span></span><span>

  </span><span class="comment1"><span>(*
  fun define_name (builder:T) s = iop (#local_names builder) (fn context =&gt; let
    val _ = Name.is_declared context s andalso raise Error ("define-name: Duplicate name " ^ s)
    val context = Name.declare s context
  in
    ((),context)
  end
  ) 
  *)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fresh_id</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iop</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>next_id </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fresh_id_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.toString</span><span> </span><span>o</span><span> </span><span class="entity"><span>fresh_id</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>next_attr_id</span></span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iop</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>next_attr </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_every_proc_attributes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.change</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>every_proc_attrs </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is</span></span><span>@</span><span class="main"><span>[</span></span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_regname</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>variant_reg</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_regname</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_tyname</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"%"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>quote_name</span></span><span> </span><span class="entity"><span>n</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_reg</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"%"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>quote_name</span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"i"</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>w</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFloat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"float"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TDouble</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"double"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"*"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TVector</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"&lt;"</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>^</span><span class="inner_quoted"><span>"&gt;"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TArray</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>^</span><span class="inner_quoted"><span>"]"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_tys</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TUnion</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>rty</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFptr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty'</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_tys</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"*"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_tyname</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>pr_tys</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>separate</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>implode</span><span>
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>pr_ty'</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"void"</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_ty'</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span>  
      
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_param</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pr_reg</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_params</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>separate</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pr_param</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>implode</span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_label</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"%"</span></span><span>^</span><span class="entity"><span>quote_name</span></span><span> </span><span class="entity"><span>l</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_ty_label</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"label"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_label</span></span><span> </span><span class="entity"><span>l</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_proc</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"@"</span></span><span>^</span><span class="entity"><span>quote_name</span></span><span> </span><span class="entity"><span>p</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pr_int</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_to_string</span></span><span> 


  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_ty_attrs</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span>|&gt;</span><span> </span><span>implode</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_tys_attrs</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>separate</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>pr_ty_attrs</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>implode</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_attr</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"#"</span></span><span>^</span><span class="entity"><span>pr_int</span></span><span> </span><span class="entity"><span>i</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_attrs</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>separate</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pr_attr</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>implode</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_ext_fun_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ptys</span></span><span> </span><span class="entity"><span>pattrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"declare"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty'</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_proc</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pr_tys_attrs</span></span><span> </span><span class="entity"><span>ptys</span></span><span> </span><span class="entity"><span>pattrs</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>decl_ext_fun_raw</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>raw</span></span><span class="main"><span>;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_ext_fun</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ptys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_ext_fun_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ptys</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ptys</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_tyname</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"type"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>decl_named_ty_raw</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>mkty_named</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="comment1"><span>(* Resolve named type until unnamed type is reached. *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rsl</span></span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TNamed</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>V</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Cyclic named types over "</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lookup_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>rsl</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.insert_set</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rsl</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span>  
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>rsl</span></span><span> </span><span>Symtab.empty</span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>in_bb</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"Already open basic block"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>emptyln</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quote_name</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>":"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="main"><span>#</span></span><span>curr_bb </span><span class="entity"><span>b</span></span><span> </span><span>:=</span><span> </span><span>SOME</span><span> </span><span class="entity"><span>label</span></span><span>
  </span><span class="main"><span>)</span></span><span>

  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_attributes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>content</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>next_attr_id</span></span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"attributes"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_attr</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>content</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_every_proc_attributes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>content</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declare_attributes</span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="entity"><span>content</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_every_proc_attributes</span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>open_proc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>attributes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>in_proc </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"open_proc: Already open"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>local_names </span><span class="entity"><span>builder</span></span><span> </span><span>:=</span><span> </span><span>Name.context</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attributes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>every_proc_attrs </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>attributes</span></span><span>
        
    </span><span class="comment1"><span>(* val _ = map (apsnd (define_name builder)) params *)</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>variant_name</span></span><span> </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>emptyln</span></span><span> </span><span class="entity"><span>builder</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"define"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty'</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_proc</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pr_params</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_attrs</span></span><span> </span><span class="entity"><span>attributes</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>in_proc </span><span class="entity"><span>builder</span></span><span> </span><span>:=</span><span> </span><span>true</span><span class="main"><span>;</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>open_bb</span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>variant_label</span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="inner_quoted"><span>"start"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="entity"><span>REG</span></span><span> </span><span class="entity"><span>params</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close_proc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>builder</span></span><span class="main"><span>:</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span>!</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>in_proc </span><span class="entity"><span>builder</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"close_proc: No open procedure"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="main"><span>#</span></span><span>in_proc </span><span class="entity"><span>builder</span></span><span> </span><span>:=</span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>builder</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span>
  </span><span class="main"><span>)</span></span><span>
   
         
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_val</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>REG</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_reg</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_val</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pr_val</span></span><span> </span><span class="entity"><span>UNNAMED</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"pr_val UNNAMED"</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_val</span></span><span> </span><span class="entity"><span>v</span></span><span>

  </span><span class="comment1"><span>(*  Build %dst = s. dst must be unique. Return value (rty,%dst)
  *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_dst_instr'</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_regname</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>writeln'</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>UNNAMED</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>writeln'</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pr_reg</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="entity"><span>REG</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="entity"><span>dst</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_dst_instr'</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
  
   
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_arith_instr</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"arith_instr: different types"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pr_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>    
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_conv_instr</span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iname</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"to"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_icmp_instr</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"arith_instr: different types"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isty_i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"mk_icmp_instr: expected integer type"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkty_i</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"icmp"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pr_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_fcmp_instr</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"arith_instr: different types"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isty_f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"mk_fcmp_instr: expected float type"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkty_i</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fcmp"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pr_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_extractvalue</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span>&gt;=</span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"extractvalue: Negative index"</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>resolve_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
        </span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span> </span><span>&lt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"extractvalue: index out of bounds"</span></span><span class="main"><span>;</span></span><span>
          </span><span>nth</span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>idx</span></span><span>
        </span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"extractvalue: expected structure type"</span></span><span>
    
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>dty</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"extractvalue"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_int</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_insertvalue</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span>&gt;=</span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"insertvalue: Negative index"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"insertvalue"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_int</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_extractelement</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>resolve_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
        </span><span class="entity"><span>TVector</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>vty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="entity"><span>vty</span></span><span>
        </span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"extractelement: expected vector type"</span></span><span>
    
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>dty</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"extractelement"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span>  </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_insertelement</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"insertelement"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
    
  
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>phi_handle</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span> * </span><span>string</span><span> </span><span>list</span><span> </span><span class="entity"><span>ref</span></span><span>
  
  </span><span class="comment1"><span>(*  
  val mk_phi: T -&gt; regname -&gt; (value * label) list -&gt; phi_handle * value
  val phi_add: T -&gt; phi_handle -&gt; value * label -&gt; unit
  *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phi_add</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>hnd</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"phi_add: Wrong type"</span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_val</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_label</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"]"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>hnd</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span>!</span><span class="entity"><span>hnd</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_phi</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

    </span><span class="comment1"><span>(* TODO: Assert start of bb! *)</span></span><span>
      
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"phi: Empty predecessor list"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>separate</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>implode</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="inner_quoted"><span>"phi"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>args</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hnd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span>
    
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>hnd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_dst_instr'</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>str</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_phi'</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pairs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hnd</span></span><span class="main"><span>,</span></span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_phi</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dst</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_add</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>hnd</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pairs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>res</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_phi'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"mk_phi': Empty arguments"</span></span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pr_args</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>separate</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>implode</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"call"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_proc</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pr_args</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_call_void</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="inner_quoted"><span>"call"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"void"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_proc</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pr_args</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>b</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_return</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>assert_open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="inner_quoted"><span>"ret void"</span></span><span class="main"><span>;</span></span><span>
      </span><span class="main"><span>#</span></span><span>curr_bb </span><span class="entity"><span>b</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>)</span></span><span> 
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_return</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>op1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>assert_open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"ret"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="main"><span>#</span></span><span>curr_bb </span><span class="entity"><span>b</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_external_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_ext_fun</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_external_call_void</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_ext_fun</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_call_void</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_external_call_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_ext_fun_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_external_call_void_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_ext_fun_attrs</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_call_void</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>args</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_br</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cbl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"br"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_label</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>curr_bb </span><span class="entity"><span>b</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>cbl</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_cbr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cbl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"br"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span>  </span><span class="entity"><span>pr_ty_label</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_label</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>curr_bb </span><span class="entity"><span>b</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>cbl</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ofs_ptr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dstty_ptr</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"getelementptr"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>bty</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dst_iconst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CONST</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TInt</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Int.fromString</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* TODO: Hack! Make const-structure explicit instead.*)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dst_iconst</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Expected integer constant"</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_gep_idx</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dstty_ptr</span></span><span> </span><span class="entity"><span>ty</span></span><span> 
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>resolve_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>bty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>TStruct</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dst_iconst</span></span><span> </span><span class="entity"><span>op2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span>&lt;=</span><span class="entity"><span>i</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>i</span></span><span>&lt;</span><span>length</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"gep_idx: Index out of range"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>nth</span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>i</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>TArray</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ty</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"gep_idx: Invalid base type"</span></span><span>
  
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"getelementptr"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>bty</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="inner_quoted"><span>"i32 0"</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(* TODO: Is i32 for first index a good choice here? *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_size_of</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ofs_ptr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"t"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkc_null</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TPtr</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkc_i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_t</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conv_instr</span></span><span> </span><span class="inner_quoted"><span>"ptrtoint"</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_t</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>res</span></span><span>  
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cnv_to_size_t</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dstty_i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>size_w</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>mk_conv_instr</span></span><span> </span><span class="inner_quoted"><span>"zext"</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_t</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>size_w</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>op1</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Safe downcast to size_t not yet supported"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i8ptr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkty_ptr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkty_i</span></span><span> </span><span class="inner_numeral"><span>8</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_malloc</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>calloc_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"isabelle_llvm_calloc"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_ext_fun</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>i8ptr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>calloc_name</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>size_t</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size_t</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cnv_to_size_t</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>op1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sz</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_size_of</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i8ptr</span></span><span> </span><span class="entity"><span>calloc_name</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>op1</span></span><span class="main"><span>,</span></span><span class="entity"><span>sz</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conv_instr</span></span><span> </span><span class="inner_quoted"><span>"bitcast"</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkty_ptr</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>res</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_free</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"isabelle_llvm_free"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_ext_fun</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>free_name</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>i8ptr</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="entity"><span>dstty_ptr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"free: expected pointer type"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conv_instr</span></span><span> </span><span class="inner_quoted"><span>"bitcast"</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>i8ptr</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_call_void</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>free_name</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>op1</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_isabelle_llvm_parallel</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fptr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkty_fptr</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>i8ptr</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_ext_fun</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span>NONE</span><span> </span><span class="inner_quoted"><span>"isabelle_llvm_parallel"</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fptr</span></span><span class="main"><span>,</span></span><span class="entity"><span>fptr</span></span><span class="main"><span>,</span></span><span class="entity"><span>i8ptr</span></span><span class="main"><span>,</span></span><span class="entity"><span>i8ptr</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_par_call_auxiliaries</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty1</span></span><span> </span><span class="entity"><span>proc1</span></span><span> </span><span class="entity"><span>aty1</span></span><span> </span><span class="entity"><span>rty2</span></span><span> </span><span class="entity"><span>proc2</span></span><span> </span><span class="entity"><span>aty2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>rty1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>rty2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aty1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>aty1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aty2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>aty2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uid</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fresh_id_str</span></span><span> </span><span class="entity"><span>b</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LLVM_Builder_templates.mk_par_call</span></span><span> </span><span class="entity"><span>uid</span></span><span> </span><span class="entity"><span>rty1</span></span><span> </span><span class="entity"><span>rty2</span></span><span> </span><span class="entity"><span>proc1</span></span><span> </span><span class="entity"><span>proc2</span></span><span> </span><span class="entity"><span>aty1</span></span><span> </span><span class="entity"><span>aty2</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_isabelle_llvm_parallel</span></span><span> </span><span class="entity"><span>b</span></span><span>
    
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_ext_fun_raw</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="comment1"><span>(* TODO: Somewhat of a hack. Add-to-prelude would be correct functionality here. *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_par_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty1</span></span><span> </span><span class="entity"><span>proc1</span></span><span> </span><span class="entity"><span>arg1</span></span><span> </span><span class="entity"><span>rty2</span></span><span> </span><span class="entity"><span>proc2</span></span><span> </span><span class="entity"><span>arg2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aty1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>arg1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aty2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>arg2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_par_call_auxiliaries</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rty1</span></span><span> </span><span class="entity"><span>proc1</span></span><span> </span><span class="entity"><span>aty1</span></span><span> </span><span class="entity"><span>rty2</span></span><span> </span><span class="entity"><span>proc2</span></span><span> </span><span class="entity"><span>aty2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkty_struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rty1</span></span><span class="main"><span>,</span></span><span class="entity"><span>rty2</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_call</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg1</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg2</span></span><span class="main"><span>]</span></span><span>   
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>res</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ptrcmp_instr</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"ptrcmp_instr: different types"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="entity"><span>dstty_ptr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"ptrcmp_instr: expected pointer types"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cty</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"eq"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>cty</span></span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"ne"</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"ptrcmp_instr: Only supports eq and ne comparsion!"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op1'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conv_instr</span></span><span> </span><span class="inner_quoted"><span>"ptrtoint"</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_t</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>op2'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conv_instr</span></span><span> </span><span class="inner_quoted"><span>"ptrtoint"</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size_t</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_icmp_instr</span></span><span> </span><span class="entity"><span>cty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1'</span></span><span> </span><span class="entity"><span>op2'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_load</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>dstty_ptr</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"load"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_store</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>op2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert_open_bb</span></span><span> </span><span class="entity"><span>b</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>writeln</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"store"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span>^</span><span class="inner_quoted"><span>", "</span></span><span>^</span><span> </span><span class="entity"><span>pr_ty_val</span></span><span> </span><span class="entity"><span>op2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>   

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_alloca</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkty_ptr</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_dst_instr</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"alloca"</span></span><span> </span><span class="entity"><span>^#</span></span><span> </span><span class="entity"><span>pr_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  

  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>union_repty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TUnion</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rty</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>union_repty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>TNamed</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>union_repty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>resolve_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>union_repty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"union_repty: expected union type"</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>union_fty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TUnion</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span> </span><span>&lt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"union_fty: index out of bounds"</span></span><span class="main"><span>;</span></span><span>
      </span><span>nth</span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>union_fty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>TNamed</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>union_fty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>resolve_named_ty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>union_fty</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Error</span></span><span> </span><span class="inner_quoted"><span>"union_fty: expected union type"</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>union_internal_bitcast</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>sop</span></span><span> </span><span class="entity"><span>dty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>sop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_alloca</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sty</span></span><span>  </span><span class="comment1"><span>(* Reserve stack space *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_store</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>sop</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="comment1"><span>(* Write operand there *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conv_instr</span></span><span> </span><span class="inner_quoted"><span>"bitcast"</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mkty_ptr</span></span><span> </span><span class="entity"><span>dty</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* Bitcast to target operand *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_load</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="comment1"><span>(* Load *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>res</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
          
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_dest_union</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>union_fty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>op1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>idx</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>union_internal_bitcast</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>op1</span></span><span> </span><span class="entity"><span>dty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>res</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_make_union</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>uty</span></span><span> </span><span class="entity"><span>sop</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>union_fty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>uty</span></span><span> </span><span class="entity"><span>idx</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty_of_val</span></span><span> </span><span class="entity"><span>sop</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"make-union type mismatch"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>union_repty</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>uty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>union_internal_bitcast</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>dst</span></span><span> </span><span class="entity"><span>sop</span></span><span> </span><span class="entity"><span>dty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  
  
  
  
  
  
  
  
  
  
    
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>