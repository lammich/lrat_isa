<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Refine_Automation</title>
</head>


<body>
<div class="head">
<h1>Theory Refine_Automation</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>section</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>"More Automation"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="Refine_Automation.html"><span>Refine_Automation</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> </span><a href="Refine_Basic.html"><span>Refine_Basic</span></a><span> </span><a href="Refine_Transfer.html"><span>Refine_Transfer</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>keywords</span></span></span><span> </span><span class="quoted"><span>"concrete_definition"</span></span><span> </span><span class="main"><span>::</span></span><span> thy_decl
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="quoted"><span>"prepare_code_thms"</span></span><span> </span><span class="main"><span>::</span></span><span> thy_decl
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="quoted"><span>"uses"</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  This theory provides a tool for extracting definitions from terms, and
  for generating code equations for recursion combinators.
›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>REFINE_AUTOMATION</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    pattern</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>   </span><span class="comment1"><span>(* Pattern to be defined as own constant *)</span></span><span>
    gen_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>    </span><span class="comment1"><span>(* Code eq generator: [| c==rhs; ... |] ==&gt; c == ... *)</span></span><span>
    gen_tac</span><span class="main"><span>:</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span> </span><span class="comment1"><span>(* Solves remaining premises of gen_thm *)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> extract_as_def</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> 
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> extract_recursion_eqs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> 
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_extraction</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_code_thms_cmd</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> define_concrete_fun</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>list</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> 
    </span><span>Token.src</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>indexname</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>cterm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_qualified</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bstring</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_cd_pattern</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_cd_pattern</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_cd_pattern</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_cd_patterns</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_vc_rec_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_vc_rec_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_vc_rec_thms</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_vc_solve_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_vc_solve_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_vc_solve_thms</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> vc_solve_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> vc_solve_modifiers</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Method.modifier</span></span><span> </span><span>parser</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> setup</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Refine_Automation</span></span><span> </span><span class="main"><span>:</span></span><span class="entity"><span>REFINE_AUTOMATION</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    pattern</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>   </span><span class="comment1"><span>(* Pattern to be defined as own constant *)</span></span><span>
    gen_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>    </span><span class="comment1"><span>(* Code eq generator: [| c==rhs; ... |] ==&gt; c == ... *)</span></span><span>
    gen_tac</span><span class="main"><span>:</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span> </span><span class="comment1"><span>(* Solves remaining premises of gen_thm *)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>extractions</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
  </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge_list</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>pattern</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_extraction</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>extractions.map</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>Symtab.update_list</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>pattern</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>ex</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="comment1"><span>(*
    Define new constant name for subterm t in context bnd.
    Returns replacement for t using the new constant and definition 
    theorem.
  *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_as_def</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>loose</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>loose_bnos</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.names_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span>Name.variant</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnd</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rnames</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>bnd</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rfrees</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>loose</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_vars</span></span><span> 
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Library.foldl</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>rfrees</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>loose</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>param_vars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> 
      </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>param_types</span></span><span> </span><span>---&gt;</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>param_vars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lhs_t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> 
      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Specification.definition</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span class="entity"><span>def_t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*val _ = tracing "xxxx";*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>app_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>app_t</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_qualified</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_recursion_eqs</span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>orig_def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span>
 
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat_net</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>extraction</span></span><span> </span><span>Item_Net.T</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Item_Net.init</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>pattern</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Item_Net.update</span><span> </span><span class="entity"><span>exs</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="comment1"><span>(* Recurse for subterms *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>ctx</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="entity"><span>ctx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
            </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span>$</span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span>      

      </span><span class="comment1"><span>(* Check if we match a pattern *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span>Item_Net.retrieve_matching</span><span> </span><span class="entity"><span>pat_net</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span>|&gt;</span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
             </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span>
               </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Pattern.first_order_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern </span><span class="entity"><span>ex</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
                 </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ex</span></span><span>
           </span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ex</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="comment1"><span>(* Extract as new constant *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span class="main"><span>,</span></span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctx</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>basename</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_as_def</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idx</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span class="entity"><span>ex</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctx</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tr</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="comment1"><span>(* Import theorem and extract RHS *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>orig_def_thm'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>yield_singleton2</span></span><span> 
    </span><span class="main"><span>(</span></span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>orig_def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>orig_def_thm'</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.prop_of</span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_equals</span><span class="main"><span>;</span></span><span>
  
  </span><span class="comment1"><span>(* Transform RHS, generating new constants *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rhs'</span></span><span class="main"><span>,</span></span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transform</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>defs</span></span><span>

  </span><span class="comment1"><span>(* Register definitions of generated constants *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_qualified</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="inner_quoted"><span>"defs"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
  
  </span><span class="comment1"><span>(* Obtain new def_thm *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_unfold_ss</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>orig_def_thm</span></span><span>::</span><span class="entity"><span>def_thms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_def_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove_internal</span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="entity"><span>rhs'</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_tac</span></span><span> </span><span class="entity"><span>def_unfold_ss</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="comment1"><span>(* Obtain new theorem by folding with defs of generated constants *)</span></span><span>
  </span><span class="comment1"><span>(* TODO: Maybe cleaner to generate eq-thm and prove by "unfold, refl" *)</span></span><span>
  </span><span class="comment1"><span>(*val new_def_thm 
    = Library.foldr (fn (dt,t) =&gt; Local_Defs.fold lthy [dt] t) 
        (def_thms,orig_def_thm');*)</span></span><span>

  </span><span class="comment1"><span>(* Prepare code equations *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_code_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span class="main"><span>{</span></span><span class="entity"><span>gen_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_tac</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>yield_singleton2</span></span><span> 
      </span><span class="main"><span>(</span></span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>gen_thm</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_tac</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
      </span><span>ORELSE'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_tac</span></span><span> </span><span class="entity"><span>def_unfold_ss</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>gen_tac</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>SINGLE</span><span> </span><span class="main"><span>(</span></span><span>ALLGOALS</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_code_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>code_thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> 
    </span><span>warning</span><span> </span><span class="inner_quoted"><span>"Unresolved premises in code theorems"</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> 
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_qualified</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="inner_quoted"><span>"code"</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>code</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>new_def_thm</span></span><span>::</span><span class="entity"><span>code_thms</span></span><span class="main"><span>)</span></span><span>
     </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>lthy</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_code_thms_cmd</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> 
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No definitional theorem"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.prop_of</span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_equals</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>|&gt;</span><span> </span><span>strip_comb</span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> 
    </span><span>|&gt;</span><span> </span><span class="entity"><span>name_of</span></span><span> 
    </span><span>|&gt;</span><span> </span><span>Long_Name.base_name</span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exs_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>extractions.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_exs</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>exs_tab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No such extraction mode: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>exs</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.dest_list</span><span> </span><span class="entity"><span>exs_tab</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>get_exs</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>|&gt;</span><span> </span><span>flat</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No extraction patterns selected"</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_recursion_eqs</span></span><span> </span><span class="entity"><span>exs</span></span><span> </span><span class="entity"><span>basename</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="entity"><span>lthy</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Conclusion does not match any extraction pattern"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span>::</span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Refine_Util.fo_matchp</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>concl</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"concrete_definition: Pattern has multiple holes, taking "</span></span><span>
            </span><span>^</span><span> </span><span class="inner_quoted"><span>"first one: "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>pat</span></span><span>
          </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"concrete_definition: Ignoring invalid pattern "</span></span><span> 
             </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
             </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* Define concrete function from refinement lemma *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_concrete_fun</span></span><span> </span><span class="entity"><span>gen_code</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>attribs_raw</span></span><span> </span><span class="entity"><span>param_names</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>pats</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>orig_lthy</span></span><span class="main"><span>:</span></span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>orig_lthy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>yield_singleton2</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.concl_of</span><span>

  </span><span class="comment1"><span>(*val ((typ_subst,term_subst),lthy) 
    = Variable.import_inst true [concl] lthy;
  val concl = Term_Subst.instantiate (typ_subst,term_subst) concl;
  *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term_subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>build</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span> </span><span>|&gt;</span><span> </span><span>Vars.fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term_subst</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No such variable: "</span></span><span>
                           </span><span>^</span><span>Term.string_of_vname</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_names</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_concrete_fun</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>param_terms</span></span><span> </span><span>---&gt;</span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>f_term</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_term</span></span><span> 
    </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span class="entity"><span>lhs_type</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>param_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs_term</span></span><span class="main"><span>,</span></span><span class="entity"><span>f_term</span></span><span class="main"><span>)</span></span><span> 
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>param_terms</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.check_src</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attribs_raw</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Specification.definition</span></span><span> 
    </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_name</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>,</span></span><span>Mixfix.NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>def_term</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>folded_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Defs.fold</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> 
    </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.note</span><span> 
       </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_qualified</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"refine"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>folded_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
       </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>gen_code</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="entity"><span>extract_recursion_eqs</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>fun_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span class="entity"><span>folded_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>



  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cd_pat_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>Refine_Util.anorm_term</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>cd_patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
  </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>merge</span><span> </span><span class="entity"><span>cd_pat_eq</span></span><span>
  </span><span class="main"><span>)</span></span><span> 

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_cd_pattern</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span>|&gt;</span><span> </span><span>fastype_of</span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span>Thm.term_of</span><span> </span><span class="entity"><span>pat</span></span><span> 
        </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> 
        </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pat</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_cd_pattern</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span>cd_patterns.map</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="entity"><span>cd_pat_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepare_cd_pattern</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_cd_pattern</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span>cd_patterns.map</span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="entity"><span>cd_pat_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepare_cd_pattern</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_cd_patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cd_patterns.get</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>


    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>rec_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Thms</span></span><span> </span><span class="main"><span>(</span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Refine_Automation.vcs_rec|attribute"><span class="entity_def" id="Refine_Automation.vcs_rec|fact"><span>vcs_rec</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"VC-Solver: Recursive intro rules"</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>solve_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Thms</span></span><span> </span><span class="main"><span>(</span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Refine_Automation.vcs_solve|attribute"><span class="entity_def" id="Refine_Automation.vcs_solve|fact"><span>vcs_solve</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>description</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"VC-Solver: Solve rules"</span></span><span>
    </span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_vc_rec_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_thms.add_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>del_vc_rec_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_thms.del_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_vc_rec_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_thms.get</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_vc_solve_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solve_thms.add_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>del_vc_solve_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solve_thms.del_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_vc_solve_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solve_thms.get</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>
      </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"rec"</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Args.add</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> 
        </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>rec_thms.add</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"rec"</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Args.del</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> 
        </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>rec_thms.del</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>solve_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>
      </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"solve"</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Args.add</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> 
        </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>solve_thms.add</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"solve"</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span>Args.del</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> 
        </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>solve_thms.del</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vc_solve_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>clasimp_modifiers</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rec_modifiers</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>solve_modifiers</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vc_solve_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>no_pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rthms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_thms.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sthms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solve_thms.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_pre</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>K</span><span> </span><span>all_tac</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>clarsimp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>auto_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>TRY</span><span> </span><span>o</span><span> </span><span class="entity"><span>pre_tac</span></span><span>
      </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span class="entity"><span>REPEAT_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rthms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sthms</span></span><span> </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span>#&gt;</span><span> </span><span class="entity"><span>rec_thms.setup</span></span><span> 
      </span><span>#&gt;</span><span> </span><span class="entity"><span>solve_thms.setup</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="entity"><span>Refine_Automation.setup</span></span><span>

</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_cpat</span></span><span> </span><span class="entity"><span>cxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tks</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.lift</span><span> </span><span>Parse.embedded_inner_syntax</span><span> </span><span class="entity"><span>cxt</span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.read_term_pattern</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tks</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_p</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.repeat1</span><span> </span><span class="entity"><span>parse_cpat</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> "</span><span class="entity_def" id="Refine_Automation.cd_patterns|attribute"><span>cd_patterns</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>
       </span><span>Scan.lift</span><span> </span><span>Args.add</span><span> </span><span>|--</span><span> </span><span class="entity"><span>do_p</span></span><span> </span><span class="entity"><span>Refine_Automation.add_cd_pattern</span></span><span>
    </span><span>||</span><span> </span><span>Scan.lift</span><span> </span><span>Args.del</span><span> </span><span>|--</span><span> </span><span class="entity"><span>do_p</span></span><span> </span><span class="entity"><span>Refine_Automation.del_cd_pattern</span></span><span>
    </span><span>||</span><span> </span><span class="entity"><span>do_p</span></span><span> </span><span class="entity"><span>Refine_Automation.add_cd_pattern</span></span><span>
    </span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"Add/delete concrete_definition pattern"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>


</span><span class="comment1"><span>(* Command setup *)</span></span><span>

</span><span class="comment1"><span>(* TODO: Folding of .refine-lemma seems not to work, if the function has
  parameters on which it does not depend *)</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> 
  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> </span><span class="keyword1"><span>concrete_definition</span></span><span class="antiquote"><span>}</span></span></span></span><span> 
  </span><span class="inner_quoted"><span>"Define function from refinement theorem"</span></span><span> 
  </span><span class="main"><span>(</span></span><span>Parse.binding</span><span> 
    </span><span>--</span><span> </span><span>Parse.opt_attribs</span><span>
    </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>for</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Args.var</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>uses</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>--</span><span> </span><span>Parse.thm</span><span>
    </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>is</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.embedded_inner_syntax</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>raw_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>raw_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Expecting exactly one theorem"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Refine_Automation.get_cd_patterns</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.read_term_pattern</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>#&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>#&gt;</span><span>
        </span><span class="entity"><span>Refine_Automation.prepare_cd_pattern</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
    </span><span class="entity"><span>Refine_Automation.define_concrete_fun</span></span><span> 
      </span><span>NONE</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>lthy</span></span><span> 
    </span><span>|&gt;</span><span> </span><span>snd</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  Command: 
    </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>concrete_definition name [attribs] for params uses thm is patterns›</span></span></span><span>
  where </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>attribs›</span></span></span><span>, </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>for›</span></span></span><span>, and </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>is›</span></span></span><span>-parts are optional.

  Declares a new constant </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>name›</span></span></span><span> by matching the theorem </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>thm›</span></span></span><span> 
  against a pattern.
  
  If the </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>for›</span></span></span><span> clause is given, it lists variables in the theorem, 
  and thus determines the order of parameters of the defined constant. Otherwise,
  parameters will be in order of occurrence.

  If the </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>is›</span></span></span><span> clause is given, it lists patterns. The conclusion of the
  theorem will be matched against each of these patterns. For the first matching
  pattern, the constant will be declared to be the term that matches the first
  non-dummy variable of the pattern. If no </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>is›</span></span></span><span>-clause is specified,
  the default patterns will be tried.

  Attribute: </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>cd_patterns pats›</span></span></span><span>. Declaration attribute. Declares
    default patterns for the </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>concrete_definition›</span></span></span><span> command.
  
›</span></span></span><span>


</span><span class="keyword1"><span class="command"><span>declare</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><a class="entity_ref" href="Refine_Automation.html#Refine_Automation.cd_patterns|attribute"><span class="operator"><span>cd_patterns</span></span></a><span> </span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span class="main"><span class="main"><span class="main"><span>(</span></span></span></span></span><span class="var"><span class="var"><span class="var"><span class="var"><span>?f</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span>,</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span>)</span></span></span></span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span></a></span></a></span></a></span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span>"</span></span></span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="command"><span>declare</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><a class="entity_ref" href="Refine_Automation.html#Refine_Automation.cd_patterns|attribute"><span class="operator"><span>cd_patterns</span></span></a><span> </span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Refine_Basic.html#Refine_Basic.RETURN|const"><a class="entity_ref" href="Refine_Basic.html#Refine_Basic.RETURN|const"><a class="entity_ref" href="Refine_Basic.html#Refine_Basic.RETURN|const"><a class="entity_ref" href="Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a></a></a></a><span> </span><span class="var"><span class="var"><span class="var"><span class="var"><span>?f</span></span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span></a></span></a></span></a></span><span> </span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span>"</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Refine_Transfer.html#Refine_Transfer.nres_of|const"><a class="entity_ref" href="Refine_Transfer.html#Refine_Transfer.nres_of|const"><a class="entity_ref" href="Refine_Transfer.html#Refine_Transfer.nres_of|const"><a class="entity_ref" href="Refine_Transfer.html#Refine_Transfer.nres_of|const"><span>nres_of</span></a></a></a></a><span> </span><span class="var"><span class="var"><span class="var"><span class="var"><span>?f</span></span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Orderings.html#Orderings.ord_class.less_eq|const"><span>≤</span></a></span></a></span></a></span></a></span><span> </span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span>"</span></span></span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="command"><span>declare</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><a class="entity_ref" href="Refine_Automation.html#Refine_Automation.cd_patterns|attribute"><span class="operator"><span>cd_patterns</span></span></a><span> </span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span class="main"><span class="main"><span class="main"><span>(</span></span></span></span></span><a class="entity_ref" href="Refine_Basic.html#Refine_Basic.RETURN|const"><a class="entity_ref" href="Refine_Basic.html#Refine_Basic.RETURN|const"><a class="entity_ref" href="Refine_Basic.html#Refine_Basic.RETURN|const"><a class="entity_ref" href="Refine_Basic.html#Refine_Basic.RETURN|const"><span>RETURN</span></a></a></a></a><span> </span><span class="var"><span class="var"><span class="var"><span class="var"><span>?f</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span>,</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span>)</span></span></span></span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span></a></span></a></span></a></span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span>"</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span class="main"><span class="main"><span class="main"><span>(</span></span></span></span></span><a class="entity_ref" href="Refine_Transfer.html#Refine_Transfer.nres_of|const"><a class="entity_ref" href="Refine_Transfer.html#Refine_Transfer.nres_of|const"><a class="entity_ref" href="Refine_Transfer.html#Refine_Transfer.nres_of|const"><a class="entity_ref" href="Refine_Transfer.html#Refine_Transfer.nres_of|const"><span>nres_of</span></a></a></a></a><span> </span><span class="var"><span class="var"><span class="var"><span class="var"><span>?f</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span>,</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span>)</span></span></span></span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.member|const"><span>∈</span></a></span></a></span></a></span></a></span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span>"</span></span></span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="command"><span>declare</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><a class="entity_ref" href="Refine_Automation.html#Refine_Automation.cd_patterns|attribute"><span class="operator"><span>cd_patterns</span></span></a><span> </span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span></a></span></a></span></a></span><span> </span><span class="var"><span class="var"><span class="var"><span class="var"><span>?f</span></span></span></span></span><span>"</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span class="main"><span class="main"><span class="main"><span>_</span></span></span></span></span><span> </span><span class="main"><span class="main"><span class="main"><span class="main"><span>==</span></span></span></span></span><span> </span><span class="var"><span class="var"><span class="var"><span class="var"><span>?f</span></span></span></span></span><span>"</span></span></span></span></span></span><span> </span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Scan.optional</span><span>
     </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>(</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|--</span><span> </span><span>Parse.list1</span><span> </span><span>Parse.name</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> "</span><span class="keyword2"><span>)</span></span><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> 
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> </span><span class="keyword1"><span>prepare_code_thms</span></span><span class="antiquote"><span>}</span></span></span></span><span> 
    </span><span class="inner_quoted"><span>"Refinement framework: Prepare theorems for code generation"</span></span><span> 
    </span><span class="main"><span>(</span></span><span class="entity"><span>modes</span></span><span> </span><span>--</span><span> </span><span>Parse.thms1</span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>modes</span></span><span class="main"><span>,</span></span><span class="entity"><span>raw_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>raw_thms</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Refine_Automation.prepare_code_thms_cmd</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  Command: 
    </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>prepare_code_thms (modes) thm›</span></span></span><span>
  where the </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>(mode)›</span></span></span><span>-part is optional.

  Set up code-equations for recursions in constant defined by </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>thm›</span></span></span><span>.
  The optional </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>modes›</span></span></span><span> is a comma-separated list of extraction modes.
›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Refine_Automation.gen_code_thm_RECT|fact"><span class="entity_def" id="Refine_Automation.gen_code_thm_RECT|thm"><span>gen_code_thm_RECT</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>fixes</span></span></span><span> </span><span class="free"><span>x</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_15918..15919">D</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="RefineG_Recursion.html#RefineG_Recursion.RECT|const"><span>RECT</span></a><span> </span><span class="free"><span>B</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_15944..15945">M</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="RefineG_Recursion.html#RefineG_Recursion.trimono|const"><span>trimono</span></a><span> </span><span class="free"><span>B</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>B</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Refine_Automation.html#offset_15918..15919"><span>D</span></a><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Tools/eqsubst.ML.html#HOL.subst|method"><span class="operator"><span>subst</span></span></a><span> </span><a class="entity_ref" href="RefineG_Recursion.html#RefineG_Recursion.RECT_unfold|fact"><span>RECT_unfold</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Refine_Automation.html#offset_15944..15945"><span>M</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Refine_Automation.gen_code_thm_REC|fact"><span class="entity_def" id="Refine_Automation.gen_code_thm_REC|thm"><span>gen_code_thm_REC</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>fixes</span></span></span><span> </span><span class="free"><span>x</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_16082..16083">D</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="RefineG_Recursion.html#RefineG_Recursion.REC|const"><span>REC</span></a><span> </span><span class="free"><span>B</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="entity_def" id="offset_16107..16108">M</span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="RefineG_Recursion.html#RefineG_Recursion.trimono|const"><span>trimono</span></a><span> </span><span class="free"><span>B</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>B</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Refine_Automation.html#offset_16082..16083"><span>D</span></a><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Tools/eqsubst.ML.html#HOL.subst|method"><span class="operator"><span>subst</span></span></a><span> </span><a class="entity_ref" href="RefineG_Recursion.html#RefineG_Recursion.REC_unfold|fact"><span>REC_unfold</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Refine_Automation.html#offset_16107..16108"><span>M</span></a><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="quoted"><span>‹
  </span><span class="entity"><span>Refine_Automation.add_extraction</span></span><span> </span><span class="inner_quoted"><span>"nres"</span></span><span> </span><span class="main"><span>{</span></span><span>
    pattern </span><span class="main"><span>=</span></span><span> </span><span>Logic.varify_global</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="RefineG_Recursion.html#RefineG_Recursion.REC|const"><span>REC</span></a><span> </span><span class="free"><span>x</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
    gen_thm </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Refine_Automation.html#Refine_Automation.gen_code_thm_REC|fact"><span>gen_code_thm_REC</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
    gen_tac </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Mono_Prover.mono_tac</span></span><span>
  </span><span class="main"><span>}</span></span><span>
  </span><span>#&gt;</span><span> 
  </span><span class="entity"><span>Refine_Automation.add_extraction</span></span><span> </span><span class="inner_quoted"><span>"nres"</span></span><span> </span><span class="main"><span>{</span></span><span>
    pattern </span><span class="main"><span>=</span></span><span> </span><span>Logic.varify_global</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="RefineG_Recursion.html#RefineG_Recursion.RECT|const"><span>RECT</span></a><span> </span><span class="free"><span>x</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span>
    gen_thm </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Refine_Automation.html#Refine_Automation.gen_code_thm_RECT|fact"><span>gen_code_thm_RECT</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
    gen_tac </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Refine_Mono_Prover.mono_tac</span></span><span>
  </span><span class="main"><span>}</span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹
  Method </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>vc_solve (no_pre) clasimp_modifiers
    rec (add/del): ... solve (add/del): ...›</span></span></span><span>
  Named theorems </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>vcs_rec›</span></span></span><span> and </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>vcs_solve›</span></span></span><span>.

  This method is specialized to
  solve verification conditions. It first clarsimps all goals, then
  it tries to apply a set of safe introduction rules (</span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>vcs_rec›</span></span></span><span>, </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>rec add›</span></span></span><span>).
  Finally, it applies introduction rules (</span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>vcs_solve›</span></span></span><span>, </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>solve add›</span></span></span><span>) and tries
  to discharge all emerging subgoals by auto. If this does not succeed, it
  backtracks over the application of the solve-rule.
›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Refine_Automation.vc_solve|method"><span>vc_solve</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="quoted"><span>‹</span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.mode</span><span> </span><span class="inner_quoted"><span>"nopre"</span></span><span class="main"><span>)</span></span><span> 
      </span><span>--|</span><span> </span><span class="entity"><span>Method.sections</span></span><span> </span><span class="entity"><span>Refine_Automation.vc_solve_modifiers</span></span><span> </span><span>&gt;&gt;</span><span>
  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nopre</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD</span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span>CHANGED</span><span> </span><span class="main"><span>(</span></span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Refine_Automation.vc_solve_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>nopre</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="quoted"><span>"Try to solve verification conditions"</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>